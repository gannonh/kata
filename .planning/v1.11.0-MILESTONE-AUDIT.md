---
milestone: v1.11.0
audited: 2026-02-14T19:15:00Z
status: gaps_found
scores:
  requirements: 15/15
  phases: 4/4
  integration: 7/7
  flows: 0/1
gaps:
  requirements: []
  integration: []
  flows:
    - name: "Post-merge cleanup"
      broken_at: "gh pr merge --delete-branch"
      reason: "--delete-branch triggers local checkout of main, which fails in bare repo worktree layout"
      severity: "critical"
    - name: "Workspace reset not in offer_next"
      broken_at: "offer_next sections (Routes A and B)"
      reason: "Claude has no awareness of workspace-base or cleanup-phase after PR merge"
      severity: "critical"
    - name: "Remote ref resolution in bare repo"
      broken_at: "git merge origin/main"
      reason: "Standard remote ref syntax fails in bare repo worktrees; needs git fetch + git merge FETCH_HEAD"
      severity: "minor"
tech_debt: []
---

# Milestone Audit: v1.11.0 Phase-Level Worktrees

## Requirements Coverage

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| WT-01 | 49 | Satisfied | create-phase-branch.sh creates worktree at project root |
| WT-02 | 49 | Satisfied | Naming: {branch-type}-v{milestone}-{phase-num}-{slug} |
| WT-03 | 49 | Satisfied | Resumption: outputs path without error if exists |
| WT-04 | 49 | Satisfied | Outputs WORKSPACE_PATH, BRANCH, plus 4 more key=value pairs |
| WT-05 | 49 | Satisfied | cleanup-phase resets workspace/ to workspace-base |
| MT-01 | 49 | Satisfied | cmd_merge accepts merge_target_dir parameter |
| MT-02 | 49 | Satisfied | resolve_base_branch removed; explicit base branch |
| MT-03 | 49 | Satisfied | cmd_create defaults to caller-passed base branch |
| OR-01 | 50 | Satisfied | SKILL.md step 1.5 creates phase worktree before plans |
| OR-02 | 50 | Satisfied | Two-case working directory injection |
| OR-03 | 50 | Satisfied | Plan worktree creation passes phase branch |
| OR-04 | 50 | Satisfied | Plan worktree merge passes phase branch |
| OR-05 | 50 | Satisfied | Phase branch becomes PR after waves complete |
| INV-01 | 50 | Satisfied | Zero git -C main references; main/ stays on main |
| DOC-01 | 52 | Satisfied | setup-worktrees.sh README shows workspace architecture |
| DOC-02 | 52 | Satisfied | git-integration.md branch flow updated |

**Score: 15/15 requirements satisfied**

## Phase Verification Summary

| Phase | Name | Status | Score |
|-------|------|--------|-------|
| 49 | Script Layer | passed | 8/8 |
| 50 | Orchestrator Integration | passed | 9/9 |
| 51 | Workspace Architecture | passed | 33/33 |
| 52 | Documentation | passed | 6/6 |

**Score: 4/4 phases passed**

## Integration Check

| Connection | Status |
|------------|--------|
| Script signatures → SKILL.md orchestrator (arg counts) | Connected |
| SKILL.md variable capture (WORKSPACE_PATH, PHASE_BRANCH) | Connected |
| Test suites → Phase 51 workspace model | Connected |
| phase-execute.md → implementation | Connected |
| git-integration.md → implementation | Connected |
| project-root.sh → all scripts (workspace/.planning) | Connected |
| Working directory injection (2-case logic) | Connected |

**Score: 7/7 connections verified**

## E2E Flow

**Phase execution with PR_WORKFLOW=true, WORKTREE_ENABLED=true:**

1. create-phase-branch.sh switches workspace/ to phase branch
2. manage-worktree.sh creates plan worktrees as siblings
3. Executor agents receive plan worktree paths
4. Plan branches merge into workspace/
5. Phase branch pushed, PR created
6. **BROKEN: Post-merge cleanup** (see UAT gaps below)

**Score: 0/1 flows complete**

## UAT Gaps (found 2026-02-14)

Discovered during live UAT against kata-cloud project (`/Users/gannonhall/dev/kata/kata-cloud`).

### Gap 1: `gh pr merge --merge --delete-branch` fails in bare repo worktrees

**6 occurrences across 4 skills:**

| Skill | File | Lines | Context |
|-------|------|-------|---------|
| kata-execute-phase | `skills/kata-execute-phase/SKILL.md` | 563, 598 | offer_next Routes A and B |
| kata-verify-work | `skills/kata-verify-work/SKILL.md` | 245, 305 | Post-verify merge (Routes A and B) |
| kata-complete-milestone | `skills/kata-complete-milestone/SKILL.md` | 400 | Release PR merge |
| kata-review-pull-requests | `skills/kata-review-pull-requests/SKILL.md` | 276 | Post-review merge |

All 6 locations use the same broken pattern:
```bash
gh pr merge "$PR_NUMBER" --merge --delete-branch
git checkout main && git pull
```

**Symptom:** `--delete-branch` triggers a local `git checkout main` after merge. In a bare repo with `main/` worktree, this fails:
```
fatal: 'main' is already used by worktree at '/path/to/project/main'
```
The subsequent `git checkout main && git pull` also fails for the same reason.

**Impact:** Critical. Every PR merge across all 4 skills breaks in worktree-enabled projects.

**Fix:** Replace with worktree-safe merge + cleanup:
1. `gh pr merge --merge` (no `--delete-branch`)
2. `git -C main pull` (update main/ worktree)
3. `bash manage-worktree.sh cleanup-phase workspace $PHASE_BRANCH` (reset workspace/, delete local branch)

### Gap 2: Post-merge cleanup not surfaced to Claude

**Same 4 skills affected.** After merge, none of the skills mention:
- Switching workspace/ back to workspace-base
- Running cleanup-phase
- Updating main/ via `git -C main pull`

Claude instances working in Kata projects have no awareness of workspace-base or the reset workflow. The kata-cloud session demonstrated this: Claude tried `git checkout main`, tried `gh api` merge, tried various wrong approaches, and the user had to explain workspace-base.

**Impact:** Critical. Every post-merge interaction requires user intervention to teach Claude the cleanup flow.

**Fix:** All 6 merge locations should use the worktree-safe pattern. The cleanup-phase script already exists and works correctly.

### Gap 3: Remote ref resolution in bare repos (minor)

**Symptom:** `git merge origin/main` fails in workspace/ worktree. Needs `git fetch origin main && git merge FETCH_HEAD`.

**Impact:** Minor. The cleanup-phase script uses local refs (`git reset --hard "$default_branch"`) and works correctly. This only affects manual git operations.

## Test Results

| Suite | Count | Status |
|-------|-------|--------|
| create-phase-branch.test.js | 9/9 | pass |
| manage-worktree.test.js | 13/13 | pass |
| setup-worktrees.test.js | 11/11 | pass |
| project-root.test.js | 10/10 | pass |
| Script tests total | 70/70 | pass |
| Build/migration tests | 44/44 | pass |

## Tech Debt

None identified.

## Anti-Patterns

None found across any phase verification.
