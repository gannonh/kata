# v1.8.0 Adaptive Workflows - Manual Testing Script

**Milestone:** v1.8.0 Adaptive Workflows  
**Tested:** _______  
**Tester:** _______

---

## Project Setup

### 1. Create Fresh Test Project

```bash
# Navigate to a temp directory
cd /tmp
mkdir kata-v180-test && cd kata-v180-test
git init

# Create minimal project structure
mkdir -p .planning/templates
echo '{}' > .planning/preferences.json
echo '{}' > .planning/config.json
```

### 2. Install Kata Plugin

Ensure kata-orchestrator is installed as a Claude Code plugin in the test project.

```bash
# If not already configured, link the development plugin:
cp -r /Users/gannonhall/dev/kata/kata-orchestrator/dist/plugin ~/.claude/extensions/kata-orchestrator
```

---

## Phase 37: Preferences Infrastructure & Progressive Capture

### PREF-01: Preferences Storage ✅/❌

**Test:** Verify preferences are stored in `.planning/preferences.json` with flat dot-notation keys.

```bash
# Set a preference in preferences.json
cat > .planning/preferences.json << 'EOF'
{
  "release.changelog_format": "keep-a-changelog",
  "docs.readme_on_milestone": "prompt"
}
EOF

# Verify structure
cat .planning/preferences.json | jq .
```

**Expected:** JSON file with flat dot-notation keys as shown above.

**Result:** [ PASS / FAIL ] _______

---

### PREF-02: read-pref.sh Resolution Chain ✅/❌

**Test:** Verify `read-pref.sh` resolves in order: preferences.json → config.json → defaults → fallback.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

# Test 1: Read from preferences.json (highest priority)
echo '{"release.changelog_format": "npm"}' > .planning/preferences.json
echo '{}' > .planning/config.json
RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "release.changelog_format")
echo "From prefs: $RESULT" # Should be: npm
[ "$RESULT" = "npm" ] && echo "✅ Prefs priority" || echo "❌ Prefs priority failed"

# Test 2: Fallback to config.json
echo '{}' > .planning/preferences.json
echo '{"release": {"changelog_format": "semantic"}}' > .planning/config.json
RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "release.changelog_format")
echo "From config: $RESULT" # Should be: semantic
[ "$RESULT" = "semantic" ] && echo "✅ Config fallback" || echo "❌ Config fallback failed"

# Test 3: Fallback to built-in default
echo '{}' > .planning/preferences.json
echo '{}' > .planning/config.json
RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "model_profile")
echo "From default: $RESULT" # Should be: balanced
[ "$RESULT" = "balanced" ] && echo "✅ Default fallback" || echo "❌ Default fallback failed"

# Test 4: Fallback to explicit fallback arg
RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "nonexistent.key" "my-fallback")
echo "From fallback arg: $RESULT" # Should be: my-fallback
[ "$RESULT" = "my-fallback" ] && echo "✅ Explicit fallback" || echo "❌ Explicit fallback failed"
```

**Result:** [ PASS / FAIL ] _______

---

### PREF-03: has-pref.sh Detection ✅/❌

**Test:** Verify `has-pref.sh` returns exit 0 when user has expressed preference, exit 1 otherwise.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

# Test 1: Key exists in preferences.json
echo '{"mode": "yolo"}' > .planning/preferences.json
echo '{}' > .planning/config.json
bash "$SCRIPT_DIR/has-pref.sh" "mode" && echo "✅ Found in prefs" || echo "❌ Should find in prefs"

# Test 2: Key exists in config.json (nested)
echo '{}' > .planning/preferences.json
echo '{"workflow": {"research": true}}' > .planning/config.json
bash "$SCRIPT_DIR/has-pref.sh" "workflow.research" && echo "✅ Found in config" || echo "❌ Should find in config"

# Test 3: Key does NOT exist anywhere
echo '{}' > .planning/preferences.json
echo '{}' > .planning/config.json
bash "$SCRIPT_DIR/has-pref.sh" "nonexistent.key" && echo "❌ Should NOT find" || echo "✅ Correctly not found"
```

**Result:** [ PASS / FAIL ] _______

---

### PREF-04: New Project Scaffolds preferences.json ✅/❌

**Test:** Verify `kata-new-project` skill scaffolds empty `preferences.json`.

**Steps:**
1. Start a new Claude Code chat in an empty directory
2. Invoke: "new project"
3. Complete onboarding questions

**Expected:** `.planning/preferences.json` created as empty object `{}`

**Result:** [ PASS / FAIL ] _______

---

### PREF-05: Built-in Defaults Coverage ✅/❌

**Test:** Verify all 23 known preference keys have defaults in `read-pref.sh`.

```bash
# List all default keys from read-pref.sh
grep -oP "'\K[^']+(?=': )" /Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts/read-pref.sh | sort

# Expected keys (23 total):
# commit_docs
# conventions.commit_format
# depth
# display.statusline
# docs.auto_update_files
# docs.readme_on_milestone
# github.enabled
# github.issueMode
# mode
# model_profile
# pr_workflow
# release.changelog
# release.changelog_format
# release.version_bump
# workflow.plan_check
# workflow.research
# workflow.verifier
# workflows.complete-milestone.pre_release_commands
# workflows.complete-milestone.version_files
# workflows.execute-phase.commit_scope_format
# workflows.execute-phase.commit_style
# workflows.execute-phase.post_task_command
# workflows.verify-work.extra_verification_commands
```

**Result:** [ PASS / FAIL ] _______

---

### CAP-01: Onboarding Reduced to 5 Questions ✅/❌

**Test:** Verify new project onboarding asks 5 base questions (+ conditional follow-ups).

**Steps:**
1. Start a new Claude Code chat
2. Invoke: "new project"
3. Count the questions asked

**Expected Questions:**
1. Project name
2. Project overview/description
3. Tech stack
4. Primary directory structure
5. GitHub integration (if applicable)

**Conditional:** Follow-ups for GitHub issue mode, repo creation (based on answers)

**Result:** [ PASS / FAIL ] _______

---

### CAP-02: model_profile Deferred via Check-or-Ask ✅/❌

**Test:** Verify `model_profile` is NOT asked during onboarding, but prompts on first `plan-phase`.

**Steps:**
1. Complete new project setup
2. Add a milestone
3. Invoke: "plan phase 1"
4. Observe check-or-ask prompt for model profile

**Expected:** User sees model profile selection on first plan, not during onboarding.

**Result:** [ PASS / FAIL ] _______

---

### CAP-03: Workflow Agent Toggles Default to True ✅/❌

**Test:** Verify workflow toggles (research, plan_check, verifier) default to true with first-run notice.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

# Clean slate
echo '{}' > .planning/preferences.json
echo '{}' > .planning/config.json

RESEARCH=$(bash "$SCRIPT_DIR/read-pref.sh" "workflow.research")
PLAN_CHECK=$(bash "$SCRIPT_DIR/read-pref.sh" "workflow.plan_check")
VERIFIER=$(bash "$SCRIPT_DIR/read-pref.sh" "workflow.verifier")

echo "workflow.research: $RESEARCH"     # Should be: true
echo "workflow.plan_check: $PLAN_CHECK" # Should be: true
echo "workflow.verifier: $VERIFIER"     # Should be: true
```

**Result:** [ PASS / FAIL ] _______

---

### CAP-04: set-config.sh Atomic Write ✅/❌

**Test:** Verify `set-config.sh` handles JSON parse, nested key set, type coercion, atomic write.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

# Start fresh
echo '{}' > .planning/config.json

# Test 1: Set nested key
bash "$SCRIPT_DIR/set-config.sh" "workflows.execute-phase.commit_style" "semantic"
cat .planning/config.json | jq '.workflows."execute-phase".commit_style'
# Should output: "semantic"

# Test 2: Boolean coercion
bash "$SCRIPT_DIR/set-config.sh" "pr_workflow" "true"
cat .planning/config.json | jq '.pr_workflow'
# Should output: true (boolean, not string)

# Test 3: Number coercion
bash "$SCRIPT_DIR/set-config.sh" "some.number" "42"
cat .planning/config.json | jq '.some.number'
# Should output: 42 (number, not string)

# Test 4: Atomic write (no partial writes on failure)
ls .planning/config.json.tmp 2>/dev/null && echo "❌ Temp file left behind" || echo "✅ Clean atomic write"
```

**Result:** [ PASS / FAIL ] _______

---

### CAP-05: Dead parallelization Key Removed ✅/❌

**Test:** Verify `parallelization` key removed from onboarding, config schema, and settings skill.

```bash
# Should NOT find parallelization in new-project skill
grep -r "parallelization" /Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-new-project/ && \
  echo "❌ Found in new-project" || echo "✅ Removed from new-project"

# Check if config-validator includes it (it may for deprecation warning)
grep "parallelization" /Users/gannonhall/dev/kata/kata-orchestrator/hooks/kata-config-validator.js
# Note: May still exist in KNOWN_KEYS for validation purposes
```

**Result:** [ PASS / FAIL ] _______

---

## Phase 38: Template Overrides

### TMPL-01: Five Templates Extracted ✅/❌

**Test:** Verify 5 standalone templates exist in skills with schema comments.

```bash
# Check for key templates with schema comments
for skill in kata-plan-phase kata-execute-phase kata-complete-milestone; do
  echo "=== $skill ==="
  ls /Users/gannonhall/dev/kata/kata-orchestrator/skills/$skill/references/*.md 2>/dev/null | head -5
done

# Verify schema comment exists
grep -l "kata-template-schema" /Users/gannonhall/dev/kata/kata-orchestrator/skills/*/references/*.md | wc -l
# Should have multiple templates with schema comments
```

**Result:** [ PASS / FAIL ] _______

---

### TMPL-02: resolve-template.sh Resolution ✅/❌

**Test:** Verify template resolution checks `.planning/templates/` first, then falls back to plugin.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-execute-phase/scripts"

# Test 1: Project override takes priority
mkdir -p .planning/templates
echo "# Custom Plan Template" > .planning/templates/plan-template.md
RESULT=$(bash "$SCRIPT_DIR/resolve-template.sh" "plan-template.md")
echo "Resolved: $RESULT"
[[ "$RESULT" == *".planning/templates/plan-template.md" ]] && \
  echo "✅ Override takes priority" || echo "❌ Override not prioritized"

# Test 2: Fallback to plugin default
rm -rf .planning/templates
RESULT=$(bash "$SCRIPT_DIR/resolve-template.sh" "plan-template.md")
echo "Fallback: $RESULT"
[[ "$RESULT" == *"/skills/kata-"* ]] && \
  echo "✅ Falls back to plugin" || echo "❌ Fallback failed"
```

**Result:** [ PASS / FAIL ] _______

---

### TMPL-03: Templates Include Schema Comments ✅/❌

**Test:** Verify each template includes schema comment listing required fields.

```bash
# Check plan-template.md for schema
head -20 /Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-plan-phase/references/plan-template.md

# Should show:
# <!-- kata-template-schema
# required-fields:
#   frontmatter: [phase, plan, type, wave, depends_on, files_modified, autonomous, must_haves]
#   body: [objective, execution_context, context, tasks, verification, success_criteria, output]
```

**Result:** [ PASS / FAIL ] _______

---

### TMPL-04: Session-Start Drift Detection ✅/❌

**Test:** Verify `kata-template-drift.js` hook detects missing required fields in override templates.

```bash
# Create override with missing required field
mkdir -p .planning/templates
cat > .planning/templates/plan-template.md << 'EOF'
---
phase: test
plan: 1
---
# Missing most required fields
EOF

# Run the drift detector manually
CLAUDE_PLUGIN_ROOT="/Users/gannonhall/dev/kata/kata-orchestrator" \
  echo '{"cwd": "'$(pwd)'"}' | node /Users/gannonhall/dev/kata/kata-orchestrator/hooks/kata-template-drift.js

# Should output warning about missing fields
```

**Expected:** `[kata] Template drift: plan-template.md missing required field(s): type, wave, depends_on...`

**Result:** [ PASS / FAIL ] _______

---

## Phase 39: Config Workflow Variants & Settings

### WKFL-01: config.json Workflows Section ✅/❌

**Test:** Verify `config.json` supports `workflows` section with per-skill keys.

```bash
cat > .planning/config.json << 'EOF'
{
  "mode": "yolo",
  "workflows": {
    "execute-phase": {
      "post_task_command": "npm test",
      "commit_style": "semantic",
      "commit_scope_format": "{phase}"
    },
    "verify-work": {
      "extra_verification_commands": ["npm run lint"]
    },
    "complete-milestone": {
      "version_files": ["package.json"],
      "pre_release_commands": ["npm run build"]
    }
  }
}
EOF

# Validate structure
cat .planning/config.json | jq '.workflows'
```

**Result:** [ PASS / FAIL ] _______

---

### WKFL-02: kata-execute-phase Reads Config ✅/❌

**Test:** Verify `kata-execute-phase` reads `workflows.execute-phase` config.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

echo '{"workflows": {"execute-phase": {"commit_style": "semantic"}}}' > .planning/config.json
echo '{}' > .planning/preferences.json

RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.execute-phase.commit_style")
echo "commit_style: $RESULT"  # Should be: semantic
```

**Result:** [ PASS / FAIL ] _______

---

### WKFL-03: kata-verify-work Reads Config ✅/❌

**Test:** Verify `kata-verify-work` reads `workflows.verify-work` config.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

echo '{"workflows": {"verify-work": {"extra_verification_commands": ["npm test", "npm run lint"]}}}' > .planning/config.json
echo '{}' > .planning/preferences.json

RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.verify-work.extra_verification_commands")
echo "extra_commands: $RESULT"  # Should be: ["npm test","npm run lint"]
```

**Result:** [ PASS / FAIL ] _______

---

### WKFL-04: kata-complete-milestone Reads Config ✅/❌

**Test:** Verify `kata-complete-milestone` reads `workflows.complete-milestone` config.

```bash
SCRIPT_DIR="/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts"

echo '{"workflows": {"complete-milestone": {"version_files": ["package.json", "VERSION"]}}}' > .planning/config.json
echo '{}' > .planning/preferences.json

RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.complete-milestone.version_files")
echo "version_files: $RESULT"  # Should be: ["package.json","VERSION"]
```

**Result:** [ PASS / FAIL ] _______

---

### WKFL-05: Schema Validation on Session Start ✅/❌

**Test:** Verify `kata-config-validator.js` warns on unknown keys, errors on invalid types.

```bash
# Create config with unknown key and invalid type
cat > .planning/config.json << 'EOF'
{
  "mode": "yolo",
  "unknown_key": "test",
  "pr_workflow": "yes"
}
EOF

# Run validator
echo '{"cwd": "'$(pwd)'"}' | node /Users/gannonhall/dev/kata/kata-orchestrator/hooks/kata-config-validator.js

# Expected output:
# [kata] Config warning: Unknown key 'unknown_key'
# [kata] Config error: Invalid value for 'pr_workflow': expected boolean, got 'yes'
```

**Result:** [ PASS / FAIL ] _______

---

### WKFL-06: kata-configure-settings Manages All Sections ✅/❌

**Test:** Verify `/kata:configure-settings` presents and updates all three sections.

**Steps:**
1. Open Claude Code chat in test project
2. Invoke: "settings"
3. Verify three sections presented:
   - Section A: Project-Lifetime Preferences (preferences.json)
   - Section B: Session Settings (config.json)
   - Section C: Workflow Variants (config.json workflows section)
4. Modify a setting in each section
5. Verify files updated correctly

**Expected:**
- All sections displayed with current values
- Changes saved to correct files
- Summary shown after update

**Result:** [ PASS / FAIL ] _______

---

## Cross-Phase Integration Tests

### INT-01: Resolution Pattern Consistency ✅/❌

**Test:** Both `read-pref.sh` and `resolve-template.sh` use project-override-first pattern.

```bash
# read-pref.sh: preferences.json → config.json → defaults
# resolve-template.sh: .planning/templates/ → plugin default

# Verify both honor project overrides first
echo '{"mode": "interactive"}' > .planning/preferences.json
RESULT=$(bash "$SCRIPT_DIR/read-pref.sh" "mode")
[ "$RESULT" = "interactive" ] && echo "✅ read-pref honors override" || echo "❌ Failed"

mkdir -p .planning/templates
echo "# Override" > .planning/templates/plan-template.md
RESULT=$(bash "/Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-execute-phase/scripts/resolve-template.sh" "plan-template.md")
[[ "$RESULT" == *".planning/templates"* ]] && echo "✅ resolve-template honors override" || echo "❌ Failed"
```

**Result:** [ PASS / FAIL ] _______

---

### INT-02: Three Hooks Fire on Session Start ✅/❌

**Test:** Verify all 3 SessionStart hooks registered and fire.

```bash
# Check hooks.json registration
cat /Users/gannonhall/dev/kata/kata-orchestrator/hooks/hooks.json | jq '.hooks.SessionStart'

# Should show 3 hooks:
# 1. kata-setup-statusline.js
# 2. kata-template-drift.js
# 3. kata-config-validator.js
```

**Result:** [ PASS / FAIL ] _______

---

### INT-03: DEFAULTS Table Coverage ✅/❌

**Test:** All 23 preference keys covered in DEFAULTS table.

```bash
# Count default keys
grep -c "'[^']*':" /Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts/read-pref.sh

# Verify the 6 workflow keys specifically
for key in \
  "workflows.execute-phase.post_task_command" \
  "workflows.execute-phase.commit_style" \
  "workflows.execute-phase.commit_scope_format" \
  "workflows.verify-work.extra_verification_commands" \
  "workflows.complete-milestone.version_files" \
  "workflows.complete-milestone.pre_release_commands"; do
  grep -q "'$key'" /Users/gannonhall/dev/kata/kata-orchestrator/skills/kata-configure-settings/scripts/read-pref.sh && \
    echo "✅ $key" || echo "❌ $key missing"
done
```

**Result:** [ PASS / FAIL ] _______

---

## E2E Flow Tests

### E2E-01: New Project → First Plan Flow ✅/❌

**Test:** Complete flow from new project to first plan.

**Steps:**
1. Create empty directory
2. Invoke "new project", complete onboarding
3. Verify `preferences.json` scaffolded (empty)
4. Verify `model_profile` NOT set in config
5. Add milestone, then invoke "plan phase 1"
6. Verify check-or-ask prompts for model_profile

**Result:** [ PASS / FAIL ] _______

---

### E2E-02: Template Override Flow ✅/❌

**Test:** Full template override lifecycle.

**Steps:**
1. Create `.planning/templates/plan-template.md` with custom content
2. Start new session (trigger drift detection)
3. Observe drift warning if fields missing
4. Invoke "plan phase" and verify custom template used

**Result:** [ PASS / FAIL ] _______

---

### E2E-03: Workflow Config Flow ✅/❌

**Test:** Configure and apply workflow settings.

**Steps:**
1. Invoke "settings"
2. Set `workflows.execute-phase.commit_style` to "semantic"
3. Execute a phase
4. Verify commits use semantic style

**Result:** [ PASS / FAIL ] _______

---

### E2E-04: Session Startup Flow ✅/❌

**Test:** All three hooks fire correctly on session start.

**Steps:**
1. Configure project with statusline, custom template, and workflow config
2. Start new Claude Code session
3. Verify statusline appears
4. Verify drift detection runs (if override exists)
5. Verify config validation runs

**Result:** [ PASS / FAIL ] _______

---

## Cleanup

```bash
# Remove test project
cd /tmp && rm -rf kata-v180-test
```

---

## Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Phase 37: Preferences Infrastructure | 10 | __ | __ |
| Phase 38: Template Overrides | 4 | __ | __ |
| Phase 39: Workflow Variants | 6 | __ | __ |
| Cross-Phase Integration | 3 | __ | __ |
| E2E Flows | 4 | __ | __ |
| **TOTAL** | **27** | **__** | **__** |

**Overall Result:** [ PASS / FAIL ]

**Notes:**
_________________________________________________________________________
_________________________________________________________________________
_________________________________________________________________________
