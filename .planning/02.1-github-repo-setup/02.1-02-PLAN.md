---
phase: 02.1-github-repo-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-starting-milestones/SKILL.md
  - tests/skills/starting-milestones.test.js
autonomous: true

must_haves:
  truths:
    - "When github.enabled=true, starting-milestones checks for GitHub remote before any gh api calls"
    - "If no remote exists, GitHub Milestone creation is skipped with warning"
    - "Local milestone initialization proceeds normally regardless of GitHub remote status"
    - "Warning message explains how to create repo and retry"
  artifacts:
    - path: "skills/kata-starting-milestones/SKILL.md"
      provides: "Remote validation guard in Phase 5.5"
      contains: "git remote -v"
    - path: "tests/skills/starting-milestones.test.js"
      provides: "Test for remote validation guard"
      contains: "remote"
  key_links:
    - from: "kata-starting-milestones Phase 5.5"
      to: "gh api /repos/:owner/:repo/milestones"
      via: "Remote validation guard before gh api calls"
      pattern: "HAS_GITHUB_REMOTE"
---

<objective>

Add GitHub remote validation guard to `/kata:starting-milestones` to prevent `gh api` failures when no remote exists.

**Purpose:** The `gh api /repos/:owner/:repo/milestones` command fails with "unable to expand placeholder" when no GitHub remote is configured. This plan adds a guard that checks for a remote before any GitHub operations and gracefully skips them with a helpful warning if missing.

**Output:**
- Modified `kata-starting-milestones/SKILL.md` with remote validation in Phase 5.5
- Test verifying remote validation guard is present

</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Phase research:
@.planning/phases/02.1-github-repo-setup/02.1-RESEARCH.md

Skill to modify:
@skills/kata-starting-milestones/SKILL.md

Existing tests:
@tests/skills/starting-milestones.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add remote validation guard to kata-starting-milestones</name>
  <files>skills/kata-starting-milestones/SKILL.md</files>
  <action>
Modify Phase 5.5 (Create GitHub Milestone) to add remote validation BEFORE any `gh api` calls.

Locate Phase 5.5 (around line 112) and modify the section. Replace the current implementation with:

```markdown
## Phase 5.5: Create GitHub Milestone (if enabled)

Read GitHub config:
```bash
GITHUB_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
```

**If `GITHUB_ENABLED=true`:**

**Step 1: Validate GitHub remote exists**

```bash
HAS_GITHUB_REMOTE=$(git remote -v 2>/dev/null | grep -q 'github\.com' && echo "true" || echo "false")
```

**If `HAS_GITHUB_REMOTE=false`:**

Display warning and skip GitHub operations:
```
Warning: GitHub tracking enabled but no GitHub remote found.
Skipping GitHub Milestone creation.

To enable GitHub Milestones:
1. Create a repository: gh repo create --source=. --public --push
2. Re-run milestone creation or manually create via: gh api --method POST /repos/:owner/:repo/milestones -f title="v${VERSION}"
```

Continue with local milestone initialization (do NOT set github.enabled=false in config - user may add remote later).

**If `HAS_GITHUB_REMOTE=true`:**

**Step 2: Check authentication (non-blocking)**

```bash
if ! gh auth status &>/dev/null; then
  echo "Warning: GitHub CLI not authenticated. Run 'gh auth login' to enable GitHub integration."
  # Continue without GitHub operations - local milestone still created
else
  # Proceed with milestone creation
fi
```

**Step 3: Check if milestone exists (idempotent)**

```bash
MILESTONE_EXISTS=$(gh api /repos/:owner/:repo/milestones 2>/dev/null | jq -r ".[] | select(.title==\"v${VERSION}\") | .number" 2>/dev/null)
```

**Step 4: Create milestone if doesn't exist**

```bash
if [ -z "$MILESTONE_EXISTS" ]; then
  # Extract milestone description (first paragraph of goal, truncated to 500 chars)
  MILESTONE_DESC=$(echo "$MILESTONE_GOALS" | head -1 | cut -c1-500)

  gh api \
    --method POST \
    -H "Accept: application/vnd.github.v3+json" \
    /repos/:owner/:repo/milestones \
    -f title="v${VERSION}" \
    -f state='open' \
    -f description="${MILESTONE_DESC}" \
    2>/dev/null && echo "GitHub Milestone v${VERSION} created" || echo "Warning: Failed to create GitHub Milestone (continuing)"
else
  echo "GitHub Milestone v${VERSION} already exists (#${MILESTONE_EXISTS})"
fi
```

**If `GITHUB_ENABLED=false`:**

Skip GitHub operations silently (no warning needed - user opted out).

**Error handling principle:**
- All GitHub operations are non-blocking
- Missing remote warns but does not stop milestone initialization
- Auth failures warn but do not stop milestone initialization
- Planning files always persist locally regardless of GitHub status
```

Key changes from current implementation:
1. Add `HAS_GITHUB_REMOTE` check BEFORE authentication check
2. Add explicit warning message with actionable instructions
3. Keep local milestone creation working regardless of GitHub remote status
4. Do NOT modify config.json - user made their choice, they may add remote later
  </action>
  <verify>Read the modified SKILL.md and verify:
1. `git remote -v` check appears BEFORE `gh auth status` check
2. Warning message displayed when no remote found
3. Instructions include `gh repo create` command
4. Local milestone creation still proceeds when remote missing
5. GitHub operations only run when both remote exists AND authenticated</verify>
  <done>SKILL.md Phase 5.5 validates remote existence before any gh api calls and gracefully skips GitHub operations with helpful warning when no remote configured</done>
</task>

<task type="auto">
  <name>Task 2: Add test for remote validation guard</name>
  <files>tests/skills/starting-milestones.test.js</files>
  <action>
Add a new test case to verify the remote validation guard exists in the skill.

Add after the existing `it('skips GitHub when disabled in config'` test:

```javascript
it('includes GitHub remote validation guard', () => {
  // This test verifies the skill content includes the remote validation pattern
  // Actual remote validation happens during interactive execution

  const skillPath = join(testDir, '.claude', 'skills', 'kata-starting-milestones', 'SKILL.md');
  const skillContent = readFileSync(skillPath, 'utf8');

  // Verify remote detection pattern exists
  const hasRemoteCheck = skillContent.includes('git remote -v') ||
                          skillContent.includes('HAS_GITHUB_REMOTE');

  if (!hasRemoteCheck) {
    throw new Error('Expected skill to include GitHub remote validation pattern');
  }

  // Verify warning message for missing remote
  const hasNoRemoteWarning = skillContent.includes('no GitHub remote') ||
                              skillContent.includes('Skipping GitHub Milestone');

  if (!hasNoRemoteWarning) {
    throw new Error('Expected skill to include warning for missing GitHub remote');
  }

  // Verify actionable instructions in warning
  const hasCreateInstructions = skillContent.includes('gh repo create');

  if (!hasCreateInstructions) {
    throw new Error('Expected skill to include gh repo create instructions in warning');
  }
});
```

Note: `readFileSync` should already be imported at line 2 in this file.
  </action>
  <verify>Run `node --test tests/skills/starting-milestones.test.js` and verify the new test passes</verify>
  <done>Test file contains new test case that verifies remote validation guard exists in skill</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Run the test suite for starting-milestones:
   ```bash
   node --test tests/skills/starting-milestones.test.js
   ```
   Expected: All tests pass including the new remote validation test

2. Read the modified SKILL.md and verify the flow:
   - Remote check happens at start of Phase 5.5
   - Missing remote triggers warning (not error)
   - Warning includes `gh repo create` instructions
   - Local operations proceed regardless of remote status
</verification>

<success_criteria>
- [ ] SKILL.md Phase 5.5 checks for GitHub remote before gh api calls
- [ ] Missing remote displays warning with actionable instructions
- [ ] Local milestone creation proceeds even when remote missing
- [ ] Test verifies remote validation pattern exists
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-github-repo-setup/02.1-02-SUMMARY.md`
</output>
