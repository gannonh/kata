# Phase 2.1: GitHub Repo Setup - Research

**Researched:** 2026-01-25
**Domain:** GitHub CLI (gh), git remotes, Kata skill modification
**Confidence:** HIGH

## Summary

This phase addresses a gap in the GitHub integration flow: `/kata:starting-milestones` attempts to create GitHub Milestones using `gh api /repos/:owner/:repo/milestones`, but this fails when no GitHub remote exists. The `gh` CLI cannot expand `:owner/:repo` placeholders without a remote.

The fix requires two modifications:
1. `/kata:starting-projects` must detect remotes and offer repo creation when `github.enabled=true`
2. `/kata:starting-milestones` must validate remote exists before attempting GitHub operations

**Primary recommendation:** Add `git remote -v | grep -q github.com` check in both skills, use `gh repo create --source=. --push` for repo creation, and update `github.enabled=false` in config.json when user declines.

## Standard Stack

### Core

| Tool | Version | Purpose | Why Standard |
| --- | --- | --- | --- |
| `gh` CLI | 2.x | GitHub operations | Official GitHub CLI, handles auth, placeholders |
| `git` | any | Remote detection | Built-in, reliable |
| `jq` | 1.6+ | JSON manipulation | Standard for config updates |
| `node -e` | any | JSON manipulation | Alternative when jq unavailable, consistent with existing patterns |

### Key Commands

| Command | Purpose | Notes |
| --- | --- | --- |
| `git remote -v` | List remotes with URLs | Detect if GitHub remote exists |
| `gh repo create --source=. --public` | Create repo from local | Push existing local repo to new GitHub repo |
| `gh repo create --source=. --private` | Create private repo | Same as above, private visibility |
| `gh auth status` | Check authentication | Verify gh CLI is authenticated |

## Architecture Patterns

### Remote Detection Pattern

```bash
# Check if any GitHub remote exists
HAS_GITHUB_REMOTE=$(git remote -v 2>/dev/null | grep -q 'github\.com' && echo "true" || echo "false")
```

**Why this pattern:**
- Uses `grep -q` for silent matching (exit code only)
- Handles both HTTPS (`https://github.com/`) and SSH (`git@github.com:`) URLs
- Returns `true`/`false` string for consistent bash comparisons

### Repo Creation Flow

**Where to add:** `/kata:starting-projects` Phase 5 (Workflow Preferences), AFTER GitHub Tracking question, BEFORE config.json creation.

```bash
# Only check if user enabled GitHub tracking
if [ "$GITHUB_ENABLED" = "true" ]; then
  # Check for existing GitHub remote
  HAS_GITHUB_REMOTE=$(git remote -v 2>/dev/null | grep -q 'github\.com' && echo "true" || echo "false")

  if [ "$HAS_GITHUB_REMOTE" = "false" ]; then
    # Check if gh CLI is authenticated
    if ! gh auth status &>/dev/null; then
      echo "Warning: GitHub CLI not authenticated. Run 'gh auth login' first."
      # Fall through to prompt user
    fi
    # Prompt user to create repo (handled by skill via AskUserQuestion)
  fi
fi
```

### Config Update Pattern

Use the existing node -e pattern from `kata-configuring-settings`:

```bash
node -e "
  const fs = require('fs');
  const config = JSON.parse(fs.readFileSync('.planning/config.json', 'utf8'));
  config.github.enabled = false;
  fs.writeFileSync('.planning/config.json', JSON.stringify(config, null, 2));
"
```

### Milestone Validation Guard

**Where to add:** `/kata:starting-milestones` Phase 5.5, BEFORE any `gh api` calls.

```bash
# Check for GitHub remote before any GitHub operations
HAS_GITHUB_REMOTE=$(git remote -v 2>/dev/null | grep -q 'github\.com' && echo "true" || echo "false")

if [ "$GITHUB_ENABLED" = "true" ] && [ "$HAS_GITHUB_REMOTE" = "false" ]; then
  echo "Warning: GitHub tracking enabled but no GitHub remote found. Skipping GitHub Milestone creation."
  echo "Run 'gh repo create --source=. --public' to create a repository, then retry."
  # Continue without GitHub operations
  GITHUB_ENABLED="false"  # Local override for this run only
fi
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
| --- | --- | --- | --- |
| GitHub authentication | Custom OAuth flow | `gh auth status` | Already handles tokens, SSO, 2FA |
| Remote URL parsing | Regex for user/repo | `gh api /repos/:owner/:repo` | gh expands placeholders automatically |
| Repo creation | Direct GitHub API | `gh repo create --source=.` | Handles all edge cases, sets up remote |

**Key insight:** The `gh` CLI handles authentication state, URL format differences (SSH vs HTTPS), organization vs personal repos, and remote setup. Let it do the work.

## Common Pitfalls

### Pitfall 1: Checking Origin Only

**What goes wrong:** Checking only `origin` remote misses repos with different remote names
**Why it happens:** Assumption that "origin" is always the GitHub remote
**How to avoid:** Check all remotes with `git remote -v | grep github.com`
**Warning signs:** Works in test repo, fails in user's repo with custom remote names

### Pitfall 2: Missing Auth Check

**What goes wrong:** `gh repo create` fails silently or with unclear error
**Why it happens:** gh CLI not authenticated
**How to avoid:** Check `gh auth status` before offering repo creation
**Warning signs:** "authentication required" errors during repo creation

### Pitfall 3: HTTPS vs SSH URL Patterns

**What goes wrong:** Remote detection misses one URL format
**Why it happens:** GitHub supports both `https://github.com/` and `git@github.com:`
**How to avoid:** Use `grep 'github\.com'` which matches both patterns
**Warning signs:** Detection works for some users but not others

### Pitfall 4: Config Update Race Condition

**What goes wrong:** Config written before user makes decision
**Why it happens:** Eager config creation in workflow
**How to avoid:** Create config.json AFTER all GitHub decisions are final
**Warning signs:** Config shows `github.enabled=true` but no remote exists

### Pitfall 5: Placeholder Expansion Failure

**What goes wrong:** `gh api /repos/:owner/:repo/...` returns "unable to expand placeholder"
**Why it happens:** No GitHub remote configured
**How to avoid:** Validate remote exists before any `gh api` call with `:owner/:repo`
**Warning signs:** Error message mentioning "no git remotes found"

## Code Examples

### Complete Remote Detection (Verified)

```bash
# Source: gh CLI behavior testing
# Check if authenticated
if ! gh auth status &>/dev/null; then
  echo "GitHub CLI not authenticated"
  exit 1
fi

# Check for GitHub remote
HAS_GITHUB_REMOTE=$(git remote -v 2>/dev/null | grep -q 'github\.com' && echo "true" || echo "false")
echo "Has GitHub remote: $HAS_GITHUB_REMOTE"
```

### Repo Creation with Visibility Choice

```bash
# Source: gh repo create --help
# Create public repo from current directory
gh repo create my-project --public --source=. --push

# Create private repo
gh repo create my-project --private --source=. --push

# Let user choose name (uses directory name by default)
gh repo create --public --source=. --push
```

### Config Update (Node Pattern from Kata)

```bash
# Source: kata-configuring-settings/SKILL.md
node -e "
  const fs = require('fs');
  const config = JSON.parse(fs.readFileSync('.planning/config.json', 'utf8'));
  config.github.enabled = false;
  fs.writeFileSync('.planning/config.json', JSON.stringify(config, null, 2));
"
```

### gh api Error When No Remote

```bash
# Source: Direct testing
$ cd /tmp && mkdir test && cd test && git init
$ gh api /repos/:owner/:repo/milestones
# Output: unable to expand placeholder in path: no git remotes found
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
| --- | --- | --- | --- |
| Assume remote exists | Validate before GitHub ops | This phase | Prevents cryptic gh CLI errors |
| Manual `curl` to GitHub API | `gh api` with placeholders | gh CLI 1.0 | Handles auth, org context |

**Note:** `gh repo create --source=.` is the modern way to create a GitHub repo from an existing local repo. It:
- Detects the directory name for repo name
- Sets up the remote automatically
- Optionally pushes existing commits with `--push`

## Integration Points

### Modification to `/kata:starting-projects`

**Location:** Phase 5 (Workflow Preferences), after "GitHub Tracking" question, before config.json creation

**Logic:**
1. If user selected "GitHub Tracking = Yes":
   a. Check `gh auth status`
   b. Check `git remote -v | grep github.com`
   c. If no remote: prompt with AskUserQuestion
      - "Create GitHub repo now" → `gh repo create --source=. --public/private --push`
      - "Create later" → Set `github.enabled=false`, explain why
   d. If remote exists: proceed normally

### Modification to `/kata:starting-milestones`

**Location:** Phase 5.5, before `gh api` calls

**Logic:**
1. If `github.enabled=true`:
   a. Check `git remote -v | grep github.com`
   b. If no remote: warn and skip GitHub operations
   c. If remote exists: proceed with milestone creation

## Open Questions

1. **Repo visibility default**
   - What we know: `gh repo create` requires `--public` or `--private`
   - What's unclear: Should we default to private (safer) or ask?
   - Recommendation: Ask user with AskUserQuestion, private as first option

2. **Organization repos**
   - What we know: `gh repo create org-name/repo-name` creates in org
   - What's unclear: Should we detect org context from gh config?
   - Recommendation: Let user specify name, gh handles org inference

## Sources

### Primary (HIGH confidence)
- `gh repo create --help` — Command syntax and options verified
- Direct testing of `gh api` without remote — Error message confirmed
- Existing Kata skill code — Config update patterns verified

### Secondary (MEDIUM confidence)
- gh CLI documentation — Standard patterns

## Metadata

**Confidence breakdown:**
- Remote detection: HIGH - Direct testing confirmed behavior
- gh repo create: HIGH - Official help verified
- Config update pattern: HIGH - Matches existing Kata patterns
- Integration points: HIGH - Skills read and understood

**Research date:** 2026-01-25
**Valid until:** Stable - gh CLI patterns don't change frequently
