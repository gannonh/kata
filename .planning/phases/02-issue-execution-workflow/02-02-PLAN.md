---
phase: 02-issue-execution-workflow
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - skills/check-issues/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Planned mode offers Create new phase option"
    - "Planned mode offers Link to existing phase option"
    - "Create new phase routes to /kata:add-phase with issue context"
    - "Link to existing phase shows matching phases"
  artifacts:
    - path: "skills/check-issues/SKILL.md"
      provides: "Planned mode execution options"
      contains: "Create new phase"
  key_links:
    - from: "skills/check-issues/SKILL.md"
      to: "/kata:add-phase"
      via: "planned mode routing"
      pattern: "add-phase"
---

<objective>
Implement planned execution mode with options to create a new phase or link to an existing phase.

Purpose: Enable issues requiring fuller treatment to be linked to the roadmap via phase creation or existing phase reference (EXEC-03).

Output: Modified check-issues skill with complete planned mode routing.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-issue-execution-workflow/02-RESEARCH.md
@.planning/phases/02-issue-execution-workflow/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement planned mode options</name>
  <files>skills/check-issues/SKILL.md</files>
  <action>
Expand the "Planned" mode handling in the `execute_action` step of check-issues/SKILL.md.

**When "Planned" mode is selected in the mode selection flow (from Plan 01):**

Present a second AskUserQuestion for planned execution options:

```markdown
**Planned mode selected:**

Use AskUserQuestion:
- header: "Planned Execution"
- question: "How should this issue be planned?"
- options:
  - "Create new phase" — Add a phase to the roadmap for this issue
  - "Link to existing phase" — Associate with an upcoming phase
  - "Put it back" — Return to issue list
```

**If "Create new phase" selected:**

1. Extract issue context for phase creation:
```bash
ISSUE_TITLE=$(grep "^title:" "$ISSUE_FILE" | cut -d':' -f2- | xargs)
PROVENANCE=$(grep "^provenance:" "$ISSUE_FILE" | cut -d' ' -f2)
ISSUE_NUMBER=""
if echo "$PROVENANCE" | grep -q "^github:"; then
  ISSUE_NUMBER=$(echo "$PROVENANCE" | grep -oE '#[0-9]+' | tr -d '#')
fi
```

2. Display routing guidance:
```
Creating phase from issue: ${ISSUE_TITLE}
${ISSUE_NUMBER:+GitHub Issue: #${ISSUE_NUMBER}}

The new phase will be linked to this issue.
When the phase PR merges, the issue will close automatically.

---

## ▶ Next Up

**Create Phase:** ${ISSUE_TITLE}

\`/kata:add-phase ${ISSUE_TITLE}\`

<sub>\`/clear\` first → fresh context window</sub>

---

Note: Issue remains in open/ until phase work begins.
When phase planning starts, move issue to in-progress manually
or use /kata:check-issues to update status.
```

3. Keep issue in open/ (do NOT move to in-progress yet).

**If "Link to existing phase" selected:**

1. Find upcoming phases that might match:
```bash
# Get phase directories that are not yet complete (no SUMMARY.md for all plans)
# This is a heuristic - phases with incomplete plans
UPCOMING_PHASES=""
for phase_dir in .planning/phases/*/; do
  phase_name=$(basename "$phase_dir")
  # Check if phase has at least one PLAN.md but missing at least one SUMMARY.md
  plan_count=$(ls "$phase_dir"/*-PLAN.md 2>/dev/null | wc -l)
  summary_count=$(ls "$phase_dir"/*-SUMMARY.md 2>/dev/null | wc -l)

  if [ "$plan_count" -gt 0 ] && [ "$plan_count" -gt "$summary_count" ]; then
    # Extract phase goal from roadmap
    phase_num=$(echo "$phase_name" | grep -oE '^[0-9]+')
    phase_goal=$(grep -A2 "### Phase ${phase_num}:" .planning/ROADMAP.md | grep "Goal:" | cut -d':' -f2- | xargs)
    UPCOMING_PHASES="${UPCOMING_PHASES}\n- ${phase_name}: ${phase_goal}"
  fi
done
```

2. If matching phases found, present selection:
```
Upcoming phases that could include this issue:

${UPCOMING_PHASES}

To link this issue to a phase:
1. Note the issue reference when planning that phase
2. Include issue context in the phase PLAN.md
3. The issue PR will close the issue when merged

Which phase? (Enter phase name or "none" to go back)
```

3. If phase selected:
   - Note the linkage in STATE.md under "### Pending Issues" with phase reference
   - Display confirmation: "Issue linked to phase ${PHASE_NAME}. Include in phase planning."
   - Keep issue in open/

4. If no phases found:
```
No upcoming phases found.

Options:
- /kata:add-phase ${ISSUE_TITLE} — Create a new phase
- /kata:track-progress — View current roadmap status
- Put it back — Return to issue list
```

**If "Put it back" selected:**
Return to list_issues step.
  </action>
  <verify>
grep -q "Create new phase" skills/check-issues/SKILL.md
grep -q "Link to existing phase" skills/check-issues/SKILL.md
grep -q "add-phase" skills/check-issues/SKILL.md
grep -q "UPCOMING_PHASES" skills/check-issues/SKILL.md
  </verify>
  <done>
- Planned mode presents "Create new phase" and "Link to existing phase" options
- "Create new phase" routes to /kata:add-phase with issue context
- "Link to existing phase" shows matching upcoming phases
- Issue remains in open/ until phase work begins
- Linkage noted for phase planning reference
  </done>
</task>

</tasks>

<verification>
After task completion:

```bash
# Verify planned mode options
grep -q "Create new phase" skills/check-issues/SKILL.md && echo "PASS: Create phase option" || echo "FAIL: Create phase option"
grep -q "Link to existing phase" skills/check-issues/SKILL.md && echo "PASS: Link option" || echo "FAIL: Link option"

# Verify add-phase routing
grep -q "add-phase" skills/check-issues/SKILL.md && echo "PASS: Phase routing" || echo "FAIL: Phase routing"

# Verify phase discovery
grep -q "UPCOMING_PHASES" skills/check-issues/SKILL.md && echo "PASS: Phase discovery" || echo "FAIL: Phase discovery"
```
</verification>

<success_criteria>
- [ ] EXEC-03: "Create new phase" option routes to /kata:add-phase with issue context
- [ ] EXEC-03: "Link to existing phase" option shows matching upcoming phases
- [ ] EXEC-03: Phase linkage tracked for planning reference
- [ ] Issue remains in open/ until phase work begins
- [ ] Clear guidance provided for next steps
- [ ] All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-issue-execution-workflow/02-02-SUMMARY.md`
</output>
