---
phase: 01-phase-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-new-project/SKILL.md
  - skills/kata-plan-phase/SKILL.md
  - skills/kata-execute-phase/SKILL.md
  - skills/kata-execute-phase/references/phase-execute.md
  - skills/kata-add-phase/SKILL.md
  - skills/kata-inserting-phases/SKILL.md
autonomous: true

must_haves:
  truths:
    - "New projects create pending/, active/, completed/ subdirectories under .planning/phases/"
    - "Phase planning finds phase directories regardless of which subdirectory they're in"
    - "Phase execution moves phases from pending/ to active/ at start"
    - "Phase execution validates completion artifacts before moving to completed/"
    - "Non-gap phases require VERIFICATION.md for completion"
    - "Existing flat-directory phases are found via fallback discovery"
  artifacts:
    - path: "skills/kata-new-project/SKILL.md"
      provides: "Creates pending/active/completed subdirectories at project init"
      contains: "mkdir -p .planning/phases/pending"
    - path: "skills/kata-plan-phase/SKILL.md"
      provides: "Universal phase discovery searching subdirectories"
      contains: "active pending completed"
    - path: "skills/kata-execute-phase/SKILL.md"
      provides: "Phase state transitions and completion validation"
      contains: "pending.*active.*completed"
    - path: "skills/kata-add-phase/SKILL.md"
      provides: "New phases created in pending/ subdirectory"
      contains: "phases/pending/"
  key_links:
    - from: "skills/kata-plan-phase/SKILL.md"
      to: ".planning/phases/{pending,active,completed}/"
      via: "universal phase discovery pattern"
      pattern: "for state in active pending completed"
    - from: "skills/kata-execute-phase/SKILL.md"
      to: ".planning/phases/active/"
      via: "state transition at execution start"
      pattern: "mv.*pending.*active"
---

<objective>
Update the core orchestrator skills with directory-based phase state management.

Purpose: Establish the foundation for phase organization by updating project initialization (create subdirectories), the two main orchestrators (plan-phase, execute-phase), and the phase creation skills (add-phase, insert-phase) with the universal phase discovery pattern and state transitions.

Output: 6 updated skill/reference files with universal phase discovery, state transitions, and completion validation.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-phase-organization/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update project init and phase creation skills</name>
  <files>
    skills/kata-new-project/SKILL.md,
    skills/kata-add-phase/SKILL.md,
    skills/kata-inserting-phases/SKILL.md
  </files>
  <action>
    **kata-new-project/SKILL.md:**
    Find the `mkdir -p .planning` line (around line 227). After it, add:
    ```bash
    mkdir -p .planning/phases/pending
    mkdir -p .planning/phases/active
    mkdir -p .planning/phases/completed
    ```
    This ensures new projects start with the subdirectory structure.

    **kata-add-phase/SKILL.md:**
    In the `create_phase_directory` step, change:
    ```bash
    phase_dir=".planning/phases/${phase_num}-${slug}"
    ```
    to:
    ```bash
    phase_dir=".planning/phases/pending/${phase_num}-${slug}"
    mkdir -p "$phase_dir"
    ```
    New phases always start in `pending/`.

    **kata-inserting-phases/SKILL.md:**
    Find the phase directory creation logic (where it creates the decimal phase directory). Change the path from `.planning/phases/${phase_num}-${slug}` to `.planning/phases/pending/${phase_num}-${slug}`. New inserted phases also go to `pending/`.

    **IMPORTANT:** Do NOT change the `update_roadmap` step in add-phase or the roadmap update in insert-phase. Those reference phase numbers, not directory paths.
  </action>
  <verify>
    grep -n "phases/pending" skills/kata-new-project/SKILL.md skills/kata-add-phase/SKILL.md skills/kata-inserting-phases/SKILL.md
    Confirm all three files reference `phases/pending/` for new phase creation.
  </verify>
  <done>
    New projects create pending/active/completed subdirectories.
    New phases (add-phase, insert-phase) are created in pending/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update plan-phase and execute-phase orchestrators with universal discovery and state transitions</name>
  <files>
    skills/kata-plan-phase/SKILL.md,
    skills/kata-execute-phase/SKILL.md,
    skills/kata-execute-phase/references/phase-execute.md
  </files>
  <action>
    **Universal Phase Discovery Pattern** â€” Use this exact pattern in both files wherever phase directories are looked up:
    ```bash
    # Find phase directory across state subdirectories
    PADDED=$(printf "%02d" "$PHASE" 2>/dev/null || echo "$PHASE")
    PHASE_DIR=""
    for state in active pending completed; do
      PHASE_DIR=$(ls -d .planning/phases/${state}/${PADDED}-* .planning/phases/${state}/${PHASE}-* 2>/dev/null | head -1)
      [ -n "$PHASE_DIR" ] && break
    done
    # Fallback: flat directory (backward compatibility for unmigrated projects)
    [ -z "$PHASE_DIR" ] && PHASE_DIR=$(ls -d .planning/phases/${PADDED}-* .planning/phases/${PHASE}-* 2>/dev/null | head -1)
    ```

    **kata-plan-phase/SKILL.md:**
    1. Step 2 (line ~94): Replace `ls .planning/phases/${PHASE}-*/*-RESEARCH.md` with the universal discovery pattern, then use `$PHASE_DIR`.
    2. Step 4 (line ~110-116): Replace the phase directory lookup and creation:
       - Discovery uses the universal pattern above
       - If no PHASE_DIR found, create in `pending/`: `mkdir -p ".planning/phases/pending/${PHASE}-${PHASE_NAME}"`
       - Set `PHASE_DIR=".planning/phases/pending/${PHASE}-${PHASE_NAME}"`

    **kata-execute-phase/SKILL.md:**
    1. Step 1 ("Validate phase exists"): Replace with universal discovery pattern.
    2. Step 1.5 (line ~204): Replace the `PHASE_DIR=$(ls -d .planning/phases/${PHASE_ARG:-00}* ...)` line with the universal discovery pattern.
    3. **Add state transition at execution start** (after step 1, before step 1.5):
       ```bash
       # Move from pending to active when execution begins
       CURRENT_STATE=$(echo "$PHASE_DIR" | grep -oE '(pending|active|completed)' | head -1)
       if [ "$CURRENT_STATE" = "pending" ]; then
         DIR_NAME=$(basename "$PHASE_DIR")
         mkdir -p ".planning/phases/active"
         mv "$PHASE_DIR" ".planning/phases/active/${DIR_NAME}"
         PHASE_DIR=".planning/phases/active/${DIR_NAME}"
         echo "Phase moved to active/"
       fi
       ```
    4. **Add completion validation** (after step 7 verification, before step 8):
       After the verifier passes, add validation before considering the phase complete:
       ```bash
       # Validate completion artifacts
       PLAN_COUNT=$(ls -1 "$PHASE_DIR"/*-PLAN.md 2>/dev/null | wc -l | tr -d ' ')
       MISSING=""
       if [ "$PLAN_COUNT" -eq 0 ]; then
         MISSING="${MISSING}\n- No PLAN.md files found"
       fi
       for plan in "$PHASE_DIR"/*-PLAN.md; do
         plan_id=$(basename "$plan" | sed 's/-PLAN\.md$//')
         [ ! -f "$PHASE_DIR/${plan_id}-SUMMARY.md" ] && MISSING="${MISSING}\n- Missing SUMMARY.md for ${plan_id}"
       done
       # Non-gap phases require VERIFICATION.md
       IS_GAP=$(grep -l "gap_closure: true" "$PHASE_DIR"/*-PLAN.md 2>/dev/null | head -1)
       if [ -z "$IS_GAP" ] && [ ! -f "$PHASE_DIR"/*-VERIFICATION.md ]; then
         MISSING="${MISSING}\n- Missing VERIFICATION.md (required for non-gap phases)"
       fi
       ```
       If MISSING is empty, move phase to completed:
       ```bash
       if [ -z "$MISSING" ]; then
         DIR_NAME=$(basename "$PHASE_DIR")
         mkdir -p ".planning/phases/completed"
         mv "$PHASE_DIR" ".planning/phases/completed/${DIR_NAME}"
         PHASE_DIR=".planning/phases/completed/${DIR_NAME}"
         echo "Phase validated and moved to completed/"
       else
         echo "Warning: Phase incomplete:${MISSING}"
       fi
       ```

    **kata-execute-phase/references/phase-execute.md:**
    Search for any `.planning/phases/${PHASE}-*` or `.planning/phases/*/` patterns and update them to use the universal discovery pattern or reference the state-aware paths. The patterns in this file should match the SKILL.md changes.

    **CRITICAL:** Preserve all existing functionality. Only change directory lookup patterns and add state transitions. Do not alter PR workflow, GitHub issue updates, wave execution, or checkpoint handling.
  </action>
  <verify>
    grep -c "for state in active pending completed" skills/kata-plan-phase/SKILL.md skills/kata-execute-phase/SKILL.md
    grep -c "phases/pending\|phases/active\|phases/completed" skills/kata-execute-phase/SKILL.md
    Confirm universal discovery pattern appears in both orchestrators.
    Confirm state transitions (pending->active, active->completed) appear in execute-phase.
  </verify>
  <done>
    plan-phase uses universal discovery to find phases in any subdirectory.
    execute-phase moves phases pending->active at start, active->completed after validation.
    Completion validation checks for PLAN.md, SUMMARY.md, and VERIFICATION.md (non-gap).
    Flat directory fallback provides backward compatibility.
  </done>
</task>

</tasks>

<verification>
1. All 6 files updated with consistent phase discovery patterns
2. New phase creation always targets pending/
3. Execute-phase has both state transitions (pending->active, active->completed)
4. Completion validation enforces PLAN+SUMMARY+VERIFICATION (non-gap) requirements
5. Backward compatibility fallback exists for flat directory structure
</verification>

<success_criteria>
- Universal phase discovery pattern searches active/pending/completed with flat fallback
- New projects create the three subdirectories
- New phases go to pending/
- Execution moves pending->active at start
- Validated phases move active->completed
- Non-gap phases require VERIFICATION.md for completion
</success_criteria>

<output>
After completion, create `.planning/phases/01-phase-organization/01-01-SUMMARY.md`
</output>
