---
phase: 06-pr-review-workflow-skill-agents
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/skills/reviewing-prs.test.js
autonomous: true

must_haves:
  truths:
    - "Skill test file exists and follows Kata test patterns"
    - "Tests verify skill invocation via natural language"
    - "Tests verify skill directory structure"
  artifacts:
    - path: "tests/skills/reviewing-prs.test.js"
      provides: "Skill integration tests"
      min_lines: 40
  key_links:
    - from: "tests/skills/reviewing-prs.test.js"
      to: "skills/kata-reviewing-prs/SKILL.md"
      via: "skill installation in test setup"
      pattern: "kata-reviewing-prs"
---

<objective>
Create integration tests for the kata-reviewing-prs skill following existing Kata test patterns.

Purpose: Ensure the skill is properly integrated and invokable via natural language prompts.
Output: Test file at tests/skills/reviewing-prs.test.js
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-pr-review-workflow-skill-agents/06-01-SUMMARY.md

Reference test patterns:
@tests/skills/providing-help.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skill test file</name>
  <files>tests/skills/reviewing-prs.test.js</files>
  <action>
    Create tests/skills/reviewing-prs.test.js following the existing test patterns:

    ```javascript
    /**
     * Tests for kata-reviewing-prs skill
     *
     * This skill provides comprehensive PR review using specialized agents
     * covering code quality, test coverage, error handling, type design,
     * comment accuracy, and code simplification.
     */

    import { describe, it, beforeEach, afterEach } from 'node:test';
    import { mkdtempSync, rmSync, cpSync, existsSync, writeFileSync, mkdirSync } from 'node:fs';
    import { tmpdir } from 'node:os';
    import { join, dirname } from 'node:path';
    import { fileURLToPath } from 'node:url';

    import { invokeClaude } from '../harness/claude-cli.js';
    import {
      assertSkillInvoked,
      assertNoError,
      assertResultContains
    } from '../harness/assertions.js';
    import { config } from '../harness/runner.js';

    const __dirname = dirname(fileURLToPath(import.meta.url));
    const FIXTURES_DIR = join(__dirname, '..', 'fixtures', 'kata-project');
    const KATA_ROOT = join(__dirname, '..', '..');

    describe('kata-reviewing-prs skill', () => {
      let testDir;

      beforeEach(() => {
        // Create isolated test environment
        testDir = mkdtempSync(join(tmpdir(), 'kata-test-'));
        cpSync(FIXTURES_DIR, testDir, { recursive: true });

        // Install skill being tested
        const skillSource = join(KATA_ROOT, 'skills', 'kata-reviewing-prs');
        const skillDest = join(testDir, '.claude', 'skills', 'kata-reviewing-prs');
        cpSync(skillSource, skillDest, { recursive: true });

        // Create a sample file with changes for the skill to review
        const srcDir = join(testDir, 'src');
        mkdirSync(srcDir, { recursive: true });
        writeFileSync(join(srcDir, 'example.js'), `
    function add(a, b) {
      return a + b;
    }

    module.exports = { add };
    `);
      });

      afterEach(() => {
        if (testDir && existsSync(testDir)) {
          rmSync(testDir, { recursive: true, force: true });
        }
      });

      it('responds to "review my code" prompt', () => {
        const result = invokeClaude('review my code', {
          cwd: testDir,
          maxBudget: config.budgets.standard,
          timeout: config.timeouts.standard
        });

        assertNoError(result);
        assertSkillInvoked(result);
      });

      it('responds to "check code quality" prompt', () => {
        const result = invokeClaude('check code quality', {
          cwd: testDir,
          maxBudget: config.budgets.standard,
          timeout: config.timeouts.standard
        });

        assertNoError(result);
        assertSkillInvoked(result);
      });

      it('lists review aspects when asked about PR review', () => {
        const result = invokeClaude('what can you review in my PR?', {
          cwd: testDir,
          maxBudget: config.budgets.quick,
          timeout: config.timeouts.quick
        });

        assertNoError(result);
        // The skill should mention review aspects
        assertResultContains(result, /code|tests|errors|types|comments|simplify/i);
      });
    });
    ```

    Key test patterns to follow:
    - Use node:test (describe, it, beforeEach, afterEach)
    - Create isolated temp directory
    - Copy kata-project fixture
    - Install skill from KATA_ROOT
    - Use config.budgets and config.timeouts from harness
    - Use assertion helpers from harness
  </action>
  <verify>node --test tests/skills/reviewing-prs.test.js (or npm test -- --grep reviewing-prs) passes or shows expected test structure</verify>
  <done>Test file exists with 3 tests following Kata patterns</done>
</task>

</tasks>

<verification>
- [ ] `ls tests/skills/reviewing-prs.test.js` shows test file exists
- [ ] `grep "kata-reviewing-prs" tests/skills/reviewing-prs.test.js` confirms skill reference
- [ ] `grep "describe.*kata-reviewing-prs" tests/skills/reviewing-prs.test.js` shows test suite
</verification>

<success_criteria>
- Test file exists at tests/skills/reviewing-prs.test.js
- Tests follow existing patterns from providing-help.test.js
- At least 3 test cases covering natural language invocation
- Tests use harness assertions (assertSkillInvoked, assertNoError, assertResultContains)
</success_criteria>

<output>
After completion, create `.planning/phases/06-pr-review-workflow-skill-agents/06-03-SUMMARY.md`
</output>
