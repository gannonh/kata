---
phase: 01-release-automation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - skills/completing-milestones/SKILL.md
  - skills/completing-milestones/references/milestone-complete.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can trigger release workflow during milestone completion"
    - "Changelog is auto-generated from commits and shown for approval"
    - "Version bump is auto-detected and shown for confirmation"
    - "User can dry-run release without side effects"
    - "GitHub Release creation triggers CI publish to marketplace"
  artifacts:
    - path: "skills/completing-milestones/SKILL.md"
      provides: "Updated skill with release workflow references"
      contains: "changelog-generator.md"
    - path: "skills/completing-milestones/references/milestone-complete.md"
      provides: "Release workflow steps integrated"
      contains: "release_workflow"
  key_links:
    - from: "milestone-complete.md"
      to: "changelog-generator.md"
      via: "@./references reference"
      pattern: "@./references/changelog-generator.md"
    - from: "milestone-complete.md"
      to: "version-detector.md"
      via: "@./references reference"
      pattern: "@./references/version-detector.md"
    - from: "SKILL.md"
      to: "gh release create"
      via: "GitHub CLI"
      pattern: "gh release"
    - from: "GitHub Release (tag vX.Y.Z)"
      to: "npm publish via marketplace"
      via: "GitHub Actions workflow"
      pattern: ".github/workflows/plugin-release.yml"
---

<objective>
Integrate release automation into the completing-milestones skill workflow.

Purpose: Enable users to trigger changelog generation, version detection, and GitHub Release creation during milestone completion (REL-01, REL-02, REL-03, REL-04).
Output: Updated completing-milestones skill that offers release workflow as optional step after milestone verification.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-release-automation/01-RESEARCH.md
@.planning/phases/01-release-automation/01-01-SUMMARY.md

@skills/completing-milestones/SKILL.md
@skills/completing-milestones/references/milestone-complete.md
@skills/completing-milestones/references/changelog-generator.md
@skills/completing-milestones/references/version-detector.md
@.github/workflows/plugin-release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SKILL.md execution_context</name>
  <files>skills/completing-milestones/SKILL.md</files>
  <action>
Update the execution_context section to include new reference files:

```xml
<execution_context>
**Load these files NOW (before proceeding):**

- @./references/milestone-complete.md (main workflow)
- @./references/milestone-archive-template.md (archive template)
- @./references/changelog-generator.md (release: changelog generation)
- @./references/version-detector.md (release: version detection)
</execution_context>
```

Also update the description to mention release workflow:
- Add "release automation" and "trigger release" to description triggers

Keep all other SKILL.md content unchanged.
  </action>
  <verify>grep "changelog-generator.md" skills/completing-milestones/SKILL.md</verify>
  <done>SKILL.md references new release workflow documentation</done>
</task>

<task type="auto">
  <name>Task 2: Add release workflow steps to milestone-complete.md</name>
  <files>skills/completing-milestones/references/milestone-complete.md</files>
  <action>
Insert a new `<step name="release_workflow">` between the existing `review_documentation` step (ends ~line 588) and `update_state` step (starts ~line 590).

**XML structure to add:**

```xml
<step name="release_workflow">

Offer release automation after documentation review.

**1. Load reference files:**

Read the changelog and version detection references:
- @./references/version-detector.md
- @./references/changelog-generator.md

**2. Detect version bump:**

Call the version detection logic from version-detector.md:
- Analyze commits since last tag using `git log`
- Detect conventional commit types (feat, fix, BREAKING CHANGE)
- Suggest version bump (major/minor/patch)

Present detected version:
```
Detected version bump: [patch|minor|major]
Current: v{{current_version}} → Suggested: v{{next_version}}

Based on commits:
- feat: [N] new features
- fix: [N] bug fixes
- BREAKING: [Y/N]
```

**3. Ask user for release decision:**

Use AskUserQuestion:
- header: "Release Automation"
- question: "Generate release artifacts for v{{next_version}}?"
- options:
  - "Yes, generate changelog and release" — Proceed with full release workflow
  - "Dry run first" — Show what would happen without executing
  - "Skip release" — Continue to milestone completion without release

**4. If "Dry run":**

Display all artifacts that WOULD be created/modified:
```
DRY RUN - No changes will be made

Files to modify:
- package.json: {{current}} → {{next_version}}
- .claude-plugin/plugin.json: {{current}} → {{next_version}}
- CHANGELOG.md: prepend entry for v{{next_version}}

Git operations:
- Commit: "chore: release v{{next_version}}"
- Tag: v{{next_version}} (if not exists)

GitHub Release:
- Title: v{{next_version}}
- Body: [changelog entry]
- Trigger: CI workflow publishes to marketplace
```

Return to release choice after dry run display.

**5. If "Yes" (proceed with release):**

Call changelog generation logic from changelog-generator.md:
- Group commits by type (Features, Fixes, Other)
- Format as markdown entry with date
- Present for approval/edits

Then execute release steps:

```bash
# Update version files
npm version {{next_version}} --no-git-tag-version
node -e "const f='.claude-plugin/plugin.json'; const p=require('./'+f); p.version='{{next_version}}'; require('fs').writeFileSync(f, JSON.stringify(p,null,2)+'\n')"

# Prepend changelog entry
# (Use Write tool to prepend generated entry to CHANGELOG.md)

# Stage version files
git add package.json package-lock.json .claude-plugin/plugin.json CHANGELOG.md
```

**6. If "Skip":**

```
Skipping release automation.
Continuing to milestone completion...
```

Proceed directly to update_state step.

**7. CI automation note:**

After GitHub Release creation, inform user:
```
✓ GitHub Release created: v{{next_version}}

CI Automation:
The plugin-release.yml workflow will automatically:
- Build the plugin
- Publish to kata-marketplace
- Update marketplace.json with new version

Monitor: https://github.com/[owner]/kata/actions
```

</step>
```

**Also update the `git_commit_milestone` step** (~line 656) to include release artifacts if release was triggered:

In the commit message section, add conditional handling:
```
{If release triggered:}
- Include version bump in commit message
- Reference the release tag

{If release not triggered:}
- Standard milestone commit (no version changes)
```

**Also update the `git_tag` step** (~line 624) to skip manual tagging if release workflow already created the tag:
- Add check: `gh release view v{{version}} &>/dev/null && echo "Tag already exists from release workflow"`
  </action>
  <verify>grep -l "release_workflow" skills/completing-milestones/references/milestone-complete.md && grep "version-detector.md" skills/completing-milestones/references/milestone-complete.md && grep "plugin-release.yml" skills/completing-milestones/references/milestone-complete.md</verify>
  <done>Release workflow step added with version detection, changelog generation, dry-run support, and CI automation documentation</done>
</task>

<task type="auto">
  <name>Task 3: Update success_criteria in milestone-complete.md</name>
  <files>skills/completing-milestones/references/milestone-complete.md</files>
  <action>
Update the success_criteria section (~line 781) to include release workflow outcomes:

Add to checklist:
- [ ] (Optional) Version bump detected and confirmed
- [ ] (Optional) Changelog entry generated and approved
- [ ] (Optional) Version bumped in package.json and plugin.json
- [ ] (Optional) GitHub Release created with changelog notes
- [ ] (Optional) CI publish triggered (plugin-release.yml)

Update the offer_next step (~line 712) to mention release status:
```
✅ Milestone v[X.Y] [Name] complete

{If release triggered:}
Released:
- GitHub Release: [URL]
- Changelog: Updated CHANGELOG.md
- Version: package.json and plugin.json updated to v[X.Y]
- CI: Marketplace publish triggered

{If release skipped:}
Note: Release artifacts not created. Run manually if needed:
- Update CHANGELOG.md
- Update version in package.json and plugin.json
- Create GitHub Release (triggers CI publish)
```
  </action>
  <verify>grep "GitHub Release" skills/completing-milestones/references/milestone-complete.md && grep "CI" skills/completing-milestones/references/milestone-complete.md</verify>
  <done>Success criteria updated with release workflow outcomes including CI automation</done>
</task>

</tasks>

<verification>
```bash
# Verify SKILL.md references new files
grep "changelog-generator.md" skills/completing-milestones/SKILL.md
grep "version-detector.md" skills/completing-milestones/SKILL.md

# Verify release_workflow step exists with required references
grep -l "release_workflow" skills/completing-milestones/references/milestone-complete.md
grep "version-detector.md" skills/completing-milestones/references/milestone-complete.md
grep "changelog-generator.md" skills/completing-milestones/references/milestone-complete.md

# Verify dry-run option exists
grep -l "Dry run" skills/completing-milestones/references/milestone-complete.md

# Verify GitHub Release integration
grep "gh release" skills/completing-milestones/references/milestone-complete.md

# Verify CI automation documentation
grep "plugin-release.yml" skills/completing-milestones/references/milestone-complete.md
```
</verification>

<success_criteria>
- [ ] SKILL.md execution_context includes changelog-generator.md and version-detector.md
- [ ] milestone-complete.md has release_workflow step between review_documentation and update_state
- [ ] release_workflow step references @./references/version-detector.md and @./references/changelog-generator.md
- [ ] Dry run mode shows artifacts without modifying files
- [ ] Release workflow updates package.json, plugin.json, CHANGELOG.md
- [ ] GitHub Release creation integrated with gh CLI
- [ ] CI automation (plugin-release.yml) documented as triggered by GitHub Release
- [ ] Success criteria and offer_next updated with release workflow outcomes
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-automation/01-02-SUMMARY.md`
</output>
