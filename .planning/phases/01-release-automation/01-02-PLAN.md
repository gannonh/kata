---
phase: 01-release-automation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - skills/completing-milestones/SKILL.md
  - skills/completing-milestones/references/milestone-complete.md
autonomous: true

must_haves:
  truths:
    - "User is offered release workflow during milestone completion"
    - "User can dry-run release before committing"
    - "User reviews suggested changelog before it's written"
    - "User confirms version bump before files are updated"
    - "Release creates GitHub Release via gh CLI"
    - "CI workflow publishes to marketplace after GitHub Release created"
  artifacts:
    - path: "skills/completing-milestones/SKILL.md"
      provides: "Release workflow integration point"
      contains: "release"
    - path: "skills/completing-milestones/references/milestone-complete.md"
      provides: "Release workflow steps"
      contains: "release_workflow"
  key_links:
    - from: "SKILL.md"
      to: "version-detector.md"
      via: "@-reference in execution_context"
      pattern: "@./references/version-detector.md"
    - from: "SKILL.md"
      to: "changelog-generator.md"
      via: "@-reference in execution_context"
      pattern: "@./references/changelog-generator.md"
    - from: "milestone-complete.md"
      to: "version-detector.md"
      via: "@-reference for progressive disclosure"
      pattern: "@./version-detector.md"
    - from: "milestone-complete.md"
      to: "changelog-generator.md"
      via: "@-reference for progressive disclosure"
      pattern: "@./changelog-generator.md"
    - from: "milestone-complete.md"
      to: "gh release create"
      via: "bash command"
      pattern: "gh release create"
---

<objective>
Integrate release workflow into the completing-milestones skill.

Purpose: Enable users to trigger release automation from milestone completion, satisfying REL-01 through REL-04.
Output: Updated skill files with release workflow integrated after milestone archive step.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-release-automation/01-RESEARCH.md

# From Plan 01 (must exist before executing this plan)
@skills/completing-milestones/references/version-detector.md
@skills/completing-milestones/references/changelog-generator.md

# Files to modify
@skills/completing-milestones/SKILL.md
@skills/completing-milestones/references/milestone-complete.md

# Existing CI workflow (REL-03 verification)
@.github/workflows/plugin-release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SKILL.md with release integration</name>
  <files>skills/completing-milestones/SKILL.md</files>
  <action>
Update `skills/completing-milestones/SKILL.md`:

1. **Add release references to execution_context section:**
   Add version-detector.md and changelog-generator.md to the list of files to load

2. **Update description to include release triggers:**
   Add "release version", "create release", "ship milestone" to trigger phrases

3. **Add step 0.5 (after pre-flight, before verify readiness):**
   - Offer release workflow via AskUserQuestion
   - Options: "Yes, run release workflow", "Yes, dry-run first", "No, just archive"
   - If yes/dry-run: Follow release_workflow step in milestone-complete.md
   - If no: Skip to verify_readiness

4. **Update success_criteria to include release outcomes:**
   - CHANGELOG.md updated (if release)
   - Version bumped in package.json and plugin.json (if release)
   - GitHub Release created OR instructions provided (based on pr_workflow)

Keep existing structure intact. Only add release integration points.
  </action>
  <verify>
grep -q "version-detector.md" skills/completing-milestones/SKILL.md && echo "OK: version-detector reference added"
grep -q "changelog-generator.md" skills/completing-milestones/SKILL.md && echo "OK: changelog-generator reference added"
grep -q "release workflow" skills/completing-milestones/SKILL.md && echo "OK: release workflow option added"
  </verify>
  <done>SKILL.md references new files and offers release workflow option during milestone completion</done>
</task>

<task type="auto">
  <name>Task 2: Add release_workflow step to milestone-complete.md</name>
  <files>skills/completing-milestones/references/milestone-complete.md</files>
  <action>
Add `<step name="release_workflow">` to `skills/completing-milestones/references/milestone-complete.md`.

Insert AFTER verify_readiness step but BEFORE gather_stats. This step executes when user opts into release.

**Step structure (uses @-references for progressive disclosure):**

```xml
<step name="release_workflow">

**This step executes when user selected "Yes" or "dry-run" in SKILL.md step 0.5**

**Load reference files:**
- Read @./version-detector.md for version detection functions
- Read @./changelog-generator.md for changelog generation functions

**Workflow:**
1. Detect version bump (REL-02) — Use detect_version_bump and calculate_next_version from version-detector.md
2. Generate changelog entry (REL-01) — Use get_commits_by_type and generate_changelog_entry from changelog-generator.md
3. Present for review (REL-04 dry-run) — Show preview with current version, bump type, next version, changelog entry, files to update
4. If dry-run mode: Stop and show "DRY RUN COMPLETE"
5. Confirm before proceeding — AskUserQuestion: "Yes, update files", "Edit changelog first", "Cancel"
6. Apply changes (if confirmed) — Use update_versions from version-detector.md, prepend changelog entry to CHANGELOG.md
7. Check pr_workflow mode (REL-03):
   - If pr_workflow=true: Show instructions to create GitHub Release after PR merge
   - If pr_workflow=false: Create GitHub Release directly via `gh release create`
8. Continue to gather_stats step

</step>
```

**Important:** The step @-references version-detector.md and changelog-generator.md for the actual bash functions. Do NOT duplicate the bash code inline — the reference files provide the implementation.

Also update `<step name="git_commit_milestone">` to:
- Stage release files (package.json, plugin.json, CHANGELOG.md) when release workflow was run
- Update commit message to mention release if applicable
  </action>
  <verify>
grep -q "release_workflow" skills/completing-milestones/references/milestone-complete.md && echo "OK: release_workflow step added"
grep -q "@./version-detector.md" skills/completing-milestones/references/milestone-complete.md && echo "OK: version-detector @-reference"
grep -q "@./changelog-generator.md" skills/completing-milestones/references/milestone-complete.md && echo "OK: changelog-generator @-reference"
grep -q "gh release create" skills/completing-milestones/references/milestone-complete.md && echo "OK: gh release command"
grep -q "DRY RUN" skills/completing-milestones/references/milestone-complete.md && echo "OK: dry run mode"
  </verify>
  <done>milestone-complete.md contains release_workflow step that @-references version-detector.md and changelog-generator.md for implementation</done>
</task>

<task type="auto">
  <name>Task 3: Verify CI publish trigger exists (REL-03)</name>
  <files></files>
  <action>
Verify that `.github/workflows/plugin-release.yml` handles REL-03 (milestone completion triggers CI publish):

1. **Check workflow trigger:** Confirm it triggers on push to main (which happens after PR merge)
2. **Check version detection:** Confirm it compares local plugin.json version to marketplace version
3. **Check publish step:** Confirm it publishes to marketplace when version changes
4. **Check GitHub Release creation:** Confirm CI creates release if version bumped

**Expected findings** (from existing workflow):
- Triggers on `push: branches: [main]`
- Gets local version from `.claude-plugin/plugin.json`
- Compares to marketplace version
- Creates GitHub Release if version changed
- Publishes to kata-marketplace repo

If workflow exists and covers these, no changes needed — just document that REL-03 is satisfied by existing CI.

**Add verification note to milestone-complete.md release_workflow step:**
```
Note: After GitHub Release is created (manually or via pr_workflow merge),
the existing `.github/workflows/plugin-release.yml` will automatically
publish to the marketplace.
```
  </action>
  <verify>
grep -q "push:" .github/workflows/plugin-release.yml && echo "OK: triggers on push"
grep -q "plugin.json" .github/workflows/plugin-release.yml && echo "OK: reads plugin version"
grep -q "gh release create" .github/workflows/plugin-release.yml && echo "OK: creates release"
grep -q "kata-marketplace" .github/workflows/plugin-release.yml && echo "OK: publishes to marketplace"
  </verify>
  <done>REL-03 satisfied by existing plugin-release.yml workflow — CI automatically publishes when version changes after merge to main</done>
</task>

</tasks>

<verification>
```bash
# SKILL.md has release references
grep "@./references/version-detector.md" skills/completing-milestones/SKILL.md
grep "@./references/changelog-generator.md" skills/completing-milestones/SKILL.md

# milestone-complete.md uses @-references (not inline duplication)
grep -A3 'step name="release_workflow"' skills/completing-milestones/references/milestone-complete.md
grep "@./version-detector.md" skills/completing-milestones/references/milestone-complete.md
grep "@./changelog-generator.md" skills/completing-milestones/references/milestone-complete.md

# All requirements covered
echo "REL-01: Changelog generation" && grep -q "changelog-generator.md" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
echo "REL-02: Version detection" && grep -q "version-detector.md" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
echo "REL-03: CI publish" && grep -q "plugin-release.yml" .github/workflows/plugin-release.yml && echo "  OK (existing workflow)"
echo "REL-04: Dry run" && grep -q "DRY RUN" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
```
</verification>

<success_criteria>
- [ ] SKILL.md references version-detector.md and changelog-generator.md
- [ ] SKILL.md offers release workflow option before verify_readiness step
- [ ] milestone-complete.md has release_workflow step
- [ ] release_workflow step uses @-references to version-detector.md and changelog-generator.md (no inline bash duplication)
- [ ] Dry-run mode shows preview without making changes
- [ ] User confirms before files are updated
- [ ] GitHub Release created via gh CLI (or instructions provided for pr_workflow mode)
- [ ] Release files staged in git commit step when release workflow was run
- [ ] REL-03 verified: existing plugin-release.yml handles CI publish after merge
- [ ] All four requirements (REL-01 through REL-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-automation/01-02-SUMMARY.md`
</output>
