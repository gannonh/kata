---
phase: 01-release-automation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - skills/completing-milestones/SKILL.md
  - skills/completing-milestones/references/milestone-complete.md
autonomous: true

must_haves:
  truths:
    - "User is offered release workflow during milestone completion"
    - "User can dry-run release before committing"
    - "User reviews suggested changelog before it's written"
    - "User confirms version bump before files are updated"
    - "Release creates GitHub Release via gh CLI"
  artifacts:
    - path: "skills/completing-milestones/SKILL.md"
      provides: "Release workflow integration point"
      contains: "release"
    - path: "skills/completing-milestones/references/milestone-complete.md"
      provides: "Release workflow steps"
      contains: "release_workflow"
  key_links:
    - from: "SKILL.md"
      to: "version-detector.md"
      via: "@-reference in execution_context"
      pattern: "@./references/version-detector.md"
    - from: "SKILL.md"
      to: "changelog-generator.md"
      via: "@-reference in execution_context"
      pattern: "@./references/changelog-generator.md"
    - from: "milestone-complete.md"
      to: "gh release create"
      via: "bash command"
      pattern: "gh release create"
---

<objective>
Integrate release workflow into the completing-milestones skill.

Purpose: Enable users to trigger release automation from milestone completion, satisfying REL-01 through REL-04.
Output: Updated skill files with release workflow integrated after milestone archive step.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-release-automation/01-RESEARCH.md

# From Plan 01 (must exist before executing this plan)
@skills/completing-milestones/references/version-detector.md
@skills/completing-milestones/references/changelog-generator.md

# Files to modify
@skills/completing-milestones/SKILL.md
@skills/completing-milestones/references/milestone-complete.md

# Existing release skill for reference patterns
@.claude/skills/releasing-kata/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SKILL.md with release integration</name>
  <files>skills/completing-milestones/SKILL.md</files>
  <action>
Update `skills/completing-milestones/SKILL.md`:

1. **Add release references to execution_context section:**
   ```xml
   <execution_context>
   **Load these files NOW (before proceeding):**

   - @./references/milestone-complete.md (main workflow)
   - @./references/milestone-archive-template.md (archive template)
   - @./references/version-detector.md (version detection)
   - @./references/changelog-generator.md (changelog generation)
   </execution_context>
   ```

2. **Update description to include release triggers:**
   Add to the description field: "release version", "create release", "ship milestone"

3. **Add step 0.5 (after pre-flight, before verify readiness) in process section:**
   ```xml
   0.5. **Offer release workflow:**

      Use AskUserQuestion:
      - header: "Release Workflow"
      - question: "Would you like to create a release for v{{version}}?"
      - options:
        - "Yes, run release workflow" — Proceed with version detection and changelog
        - "Yes, dry-run first" — Show what would happen, then confirm
        - "No, just archive" — Skip release, proceed to milestone archive

      **If "Yes" or "dry-run":**
      Follow release_workflow step in milestone-complete.md

      **If "No":**
      Skip to Step 1 (verify readiness)
   ```

4. **Update success_criteria to include release outcomes:**
   Add:
   - CHANGELOG.md updated with new version entry (if release)
   - Version bumped in package.json and plugin.json (if release)
   - GitHub Release created OR instructions provided (if release, based on pr_workflow)

Keep existing structure intact. Only add release integration points.
  </action>
  <verify>
grep -q "version-detector.md" skills/completing-milestones/SKILL.md && echo "OK: version-detector reference added"
grep -q "changelog-generator.md" skills/completing-milestones/SKILL.md && echo "OK: changelog-generator reference added"
grep -q "release workflow" skills/completing-milestones/SKILL.md && echo "OK: release workflow option added"
  </verify>
  <done>SKILL.md references new files and offers release workflow option during milestone completion</done>
</task>

<task type="auto">
  <name>Task 2: Add release_workflow step to milestone-complete.md</name>
  <files>skills/completing-milestones/references/milestone-complete.md</files>
  <action>
Add `<step name="release_workflow">` to `skills/completing-milestones/references/milestone-complete.md`.

Insert AFTER the `verify_readiness` step but BEFORE `gather_stats`. This step executes when user opts into release workflow.

```xml
<step name="release_workflow">

**This step executes when user selected "Yes" or "dry-run" in SKILL.md step 0.5**

**Load references:**
- Read @./version-detector.md for version detection functions
- Read @./changelog-generator.md for changelog generation functions

**1. Detect version bump (REL-02):**

```bash
# Get last release tag
LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

# Extract commits since last tag
if [ -n "$LAST_TAG" ]; then
  COMMITS=$(git log --oneline --format="%s" "$LAST_TAG"..HEAD)
else
  COMMITS=$(git log --oneline --format="%s")
fi

# Categorize by type
BREAKING=$(echo "$COMMITS" | grep -E "^[a-z]+(\(.+\))?!:|BREAKING CHANGE:" || true)
FEATURES=$(echo "$COMMITS" | grep -E "^feat(\(.+\))?:" || true)
FIXES=$(echo "$COMMITS" | grep -E "^fix(\(.+\))?:" || true)

# Determine bump type
if [ -n "$BREAKING" ]; then
  BUMP_TYPE="major"
elif [ -n "$FEATURES" ]; then
  BUMP_TYPE="minor"
elif [ -n "$FIXES" ]; then
  BUMP_TYPE="patch"
else
  BUMP_TYPE="none"
fi
```

**2. Calculate next version:**

```bash
# Get current version
CURRENT_VERSION=$(jq -r '.version' package.json)

# Calculate next version based on bump type
IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
case "$BUMP_TYPE" in
  major) NEXT_VERSION="$((major + 1)).0.0" ;;
  minor) NEXT_VERSION="${major}.$((minor + 1)).0" ;;
  patch) NEXT_VERSION="${major}.${minor}.$((patch + 1))" ;;
  *) NEXT_VERSION="$CURRENT_VERSION" ;;
esac
```

**3. Generate changelog entry (REL-01):**

```bash
TODAY=$(date +%Y-%m-%d)

# Generate entry
CHANGELOG_ENTRY="## [$NEXT_VERSION] - $TODAY

"

if [ -n "$FEATURES" ]; then
  CHANGELOG_ENTRY+="### Added
"
  while IFS= read -r line; do
    desc=$(echo "$line" | sed 's/^feat\([^:]*\): //')
    CHANGELOG_ENTRY+="- $desc
"
  done <<< "$FEATURES"
  CHANGELOG_ENTRY+="
"
fi

if [ -n "$FIXES" ]; then
  CHANGELOG_ENTRY+="### Fixed
"
  while IFS= read -r line; do
    desc=$(echo "$line" | sed 's/^fix\([^:]*\): //')
    CHANGELOG_ENTRY+="- $desc
"
  done <<< "$FIXES"
fi
```

**4. Present for review (REL-04 dry-run):**

Display to user:
```
## Release Preview

**Current version:** $CURRENT_VERSION
**Detected bump:** $BUMP_TYPE
**Next version:** $NEXT_VERSION

**Changelog entry:**
$CHANGELOG_ENTRY

**Files to update:**
- package.json (version)
- .claude-plugin/plugin.json (version)
- CHANGELOG.md (prepend entry)
```

<if mode="dry-run">
```
DRY RUN COMPLETE — No changes made.

To proceed with release:
- Run milestone completion again
- Select "Yes, run release workflow"
```
Stop here for dry-run.
</if>

**5. Confirm before proceeding:**

Use AskUserQuestion:
- header: "Confirm Release"
- question: "Proceed with v$NEXT_VERSION release?"
- options:
  - "Yes, update files" — Apply changes
  - "Edit changelog first" — Pause for user edits
  - "Cancel" — Skip release, continue to archive

**If "Edit changelog first":**
```
Edit the changelog entry above, then say "continue" with your edited version.
```
Wait for user input, use their edited version.

**6. Apply changes (if confirmed):**

```bash
# Update version files
jq --arg v "$NEXT_VERSION" '.version = $v' package.json > package.json.tmp
mv package.json.tmp package.json

jq --arg v "$NEXT_VERSION" '.version = $v' .claude-plugin/plugin.json > plugin.json.tmp
mv plugin.json.tmp .claude-plugin/plugin.json

# Prepend to CHANGELOG.md
EXISTING_CHANGELOG=$(cat CHANGELOG.md)
echo "$CHANGELOG_ENTRY

$EXISTING_CHANGELOG" > CHANGELOG.md
```

**7. Check PR workflow mode (REL-03):**

```bash
PR_WORKFLOW=$(cat .planning/config.json 2>/dev/null | grep -o '"pr_workflow"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
```

**If `PR_WORKFLOW=true`:**
```
✅ Release files updated

Next steps (after PR merge):
1. Create GitHub Release with tag v$NEXT_VERSION
2. CI will publish to marketplace

Use: gh release create v$NEXT_VERSION --title "v$NEXT_VERSION" --notes-file CHANGELOG.md
```

**If `PR_WORKFLOW=false`:**
```bash
# Create GitHub Release directly
gh release create "v$NEXT_VERSION" \
  --title "v$NEXT_VERSION" \
  --notes "$CHANGELOG_ENTRY" \
  --target main
```

Display: "✅ GitHub Release v$NEXT_VERSION created"

**8. Continue to milestone archive:**

Proceed to gather_stats step.

</step>
```

Also update the `<step name="git_commit_milestone">` section to include release files when release workflow was run:
- Add `git add package.json .claude-plugin/plugin.json CHANGELOG.md` before staging planning files
- Update commit message to mention release if applicable

Keep all existing steps intact. Only add the new release_workflow step and minor git staging updates.
  </action>
  <verify>
grep -q "release_workflow" skills/completing-milestones/references/milestone-complete.md && echo "OK: release_workflow step added"
grep -q "detect_version_bump\|BUMP_TYPE" skills/completing-milestones/references/milestone-complete.md && echo "OK: version detection logic"
grep -q "generate_changelog_entry\|CHANGELOG_ENTRY" skills/completing-milestones/references/milestone-complete.md && echo "OK: changelog generation logic"
grep -q "gh release create" skills/completing-milestones/references/milestone-complete.md && echo "OK: gh release command"
grep -q "DRY RUN" skills/completing-milestones/references/milestone-complete.md && echo "OK: dry run mode"
  </verify>
  <done>milestone-complete.md contains full release_workflow step with version detection, changelog generation, dry-run support, and GitHub Release creation</done>
</task>

</tasks>

<verification>
```bash
# SKILL.md has release references
grep "@./references/version-detector.md" skills/completing-milestones/SKILL.md
grep "@./references/changelog-generator.md" skills/completing-milestones/SKILL.md

# milestone-complete.md has release workflow
grep -A5 'step name="release_workflow"' skills/completing-milestones/references/milestone-complete.md

# All requirements covered
echo "REL-01: Changelog generation" && grep -q "CHANGELOG_ENTRY" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
echo "REL-02: Version detection" && grep -q "BUMP_TYPE" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
echo "REL-03: Release trigger" && grep -q "gh release create" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
echo "REL-04: Dry run" && grep -q "DRY RUN" skills/completing-milestones/references/milestone-complete.md && echo "  OK"
```
</verification>

<success_criteria>
- [ ] SKILL.md references version-detector.md and changelog-generator.md
- [ ] SKILL.md offers release workflow option before verify_readiness step
- [ ] milestone-complete.md has release_workflow step with full implementation
- [ ] Version detection logic parses commits and determines bump type
- [ ] Changelog generation creates Keep a Changelog format entry
- [ ] Dry-run mode shows preview without making changes
- [ ] User confirms before files are updated
- [ ] GitHub Release created via gh CLI (or instructions provided for pr_workflow mode)
- [ ] Release files staged in git commit step when release workflow was run
- [ ] All four requirements (REL-01 through REL-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-automation/01-02-SUMMARY.md`
</output>
