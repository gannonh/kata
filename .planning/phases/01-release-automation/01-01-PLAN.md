---
phase: 01-release-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/completing-milestones/references/version-detector.md
  - skills/completing-milestones/references/changelog-generator.md
autonomous: true

must_haves:
  truths:
    - "Version detector parses git log for conventional commit types"
    - "Version detector returns major/minor/patch/none based on commit analysis"
    - "Changelog generator formats commits into Keep a Changelog structure"
    - "Both reference files are self-contained with verified bash patterns"
  artifacts:
    - path: "skills/completing-milestones/references/version-detector.md"
      provides: "Semantic version detection from conventional commits"
      contains: "detect_version_bump"
    - path: "skills/completing-milestones/references/changelog-generator.md"
      provides: "Changelog entry generation from git history"
      contains: "generate_changelog_entry"
  key_links:
    - from: "version-detector.md"
      to: "git log"
      via: "bash command extraction"
      pattern: "git log.*format"
    - from: "changelog-generator.md"
      to: "CHANGELOG.md"
      via: "Keep a Changelog format"
      pattern: "\\[.*\\] - \\d{4}"
---

<objective>
Create reference files for version detection and changelog generation.

Purpose: Provide reusable logic that the completing-milestones skill can use to automate release artifact creation.
Output: Two reference files with verified bash patterns from 01-RESEARCH.md.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-release-automation/01-RESEARCH.md

# Existing skill structure
@skills/completing-milestones/SKILL.md
@skills/completing-milestones/references/milestone-complete.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version-detector.md reference</name>
  <files>skills/completing-milestones/references/version-detector.md</files>
  <action>
Create `skills/completing-milestones/references/version-detector.md` with:

1. **Purpose section** explaining semantic version detection from conventional commits

2. **Commit parsing patterns** — Extract from 01-RESEARCH.md:
   - Get last release tag: `git describe --tags --abbrev=0`
   - Get commits since tag: `git log --oneline --format="%s" "$LAST_TAG"..HEAD`
   - Filter by type: `grep -E "^(feat|fix|docs|chore)(\(.+\))?:"`
   - Detect breaking changes: `grep -E "^[a-z]+(\(.+\))?!:|BREAKING CHANGE:"`

3. **Version bump detection function** (from research):
   ```bash
   detect_version_bump() {
     local breaking="$1"
     local features="$2"
     local fixes="$3"

     if [ -n "$breaking" ]; then
       echo "major"
     elif [ -n "$features" ]; then
       echo "minor"
     elif [ -n "$fixes" ]; then
       echo "patch"
     else
       echo "none"
     fi
   }
   ```

4. **Version calculation function** (from research):
   ```bash
   calculate_next_version() {
     local current="$1"
     local bump_type="$2"

     local major minor patch
     IFS='.' read -r major minor patch <<< "$current"

     case "$bump_type" in
       major) echo "$((major + 1)).0.0" ;;
       minor) echo "${major}.$((minor + 1)).0" ;;
       patch) echo "${major}.${minor}.$((patch + 1))" ;;
       *) echo "$current" ;;
     esac
   }
   ```

5. **Version file update function** using jq (from research):
   ```bash
   update_versions() {
     local version="$1"
     jq --arg v "$version" '.version = $v' package.json > package.json.tmp
     mv package.json.tmp package.json
     jq --arg v "$version" '.version = $v' .claude-plugin/plugin.json > plugin.json.tmp
     mv plugin.json.tmp .claude-plugin/plugin.json
   }
   ```

6. **Dry run mode** — Show what would happen without executing

7. **Pitfall warnings** from research:
   - Version mismatch between package.json and plugin.json
   - Missing `!` suffix for breaking changes
   - Empty release (only docs/chore commits)

Format as XML-structured reference file following Kata conventions.
  </action>
  <verify>
File exists at skills/completing-milestones/references/version-detector.md
File contains "detect_version_bump" function
File contains "calculate_next_version" function
File contains "update_versions" function
  </verify>
  <done>version-detector.md contains complete version detection logic with all bash functions from research</done>
</task>

<task type="auto">
  <name>Task 2: Create changelog-generator.md reference</name>
  <files>skills/completing-milestones/references/changelog-generator.md</files>
  <action>
Create `skills/completing-milestones/references/changelog-generator.md` with:

1. **Purpose section** explaining changelog generation from conventional commits

2. **Keep a Changelog format** template:
   ```markdown
   ## [X.Y.Z] - YYYY-MM-DD

   ### Added
   - feat: descriptions

   ### Fixed
   - fix: descriptions

   ### Changed
   - refactor/perf: descriptions
   ```

3. **Commit extraction by type** (from research):
   ```bash
   get_commits_by_type() {
     local since="$1"
     local type="$2"

     if [ -n "$since" ]; then
       git log --oneline --format="%s" "$since"..HEAD | grep -E "^${type}(\(.+\))?:" || true
     else
       git log --oneline --format="%s" | grep -E "^${type}(\(.+\))?:" || true
     fi
   }
   ```

4. **Changelog entry generation function** (from research):
   ```bash
   generate_changelog_entry() {
     local version="$1"
     local date="$2"
     local features="$3"
     local fixes="$4"

     echo "## [$version] - $date"
     echo ""

     if [ -n "$features" ]; then
       echo "### Added"
       echo "$features" | while read -r line; do
         desc=$(echo "$line" | sed 's/^feat\([^:]*\): //')
         echo "- $desc"
       done
       echo ""
     fi

     if [ -n "$fixes" ]; then
       echo "### Fixed"
       echo "$fixes" | while read -r line; do
         desc=$(echo "$line" | sed 's/^fix\([^:]*\): //')
         echo "- $desc"
       done
       echo ""
     fi
   }
   ```

5. **Commit type mapping**:
   - `feat` → "Added"
   - `fix` → "Fixed"
   - `refactor`, `perf`, `docs` → "Changed"
   - `chore`, `test`, `ci` → Typically omitted from user-facing changelog

6. **Review gate emphasis** — Changelog is generated as suggestion, requires human approval before writing

7. **Pitfall warnings** from research:
   - Auto-generation should not overwrite manual curation
   - Present for approval, don't auto-write

Format as XML-structured reference file following Kata conventions.
  </action>
  <verify>
File exists at skills/completing-milestones/references/changelog-generator.md
File contains "get_commits_by_type" function
File contains "generate_changelog_entry" function
File contains Keep a Changelog format template
  </verify>
  <done>changelog-generator.md contains complete changelog generation logic with review gate pattern</done>
</task>

</tasks>

<verification>
```bash
# Both reference files exist
ls -la skills/completing-milestones/references/version-detector.md
ls -la skills/completing-milestones/references/changelog-generator.md

# Version detector has required functions
grep -q "detect_version_bump" skills/completing-milestones/references/version-detector.md && echo "OK: detect_version_bump"
grep -q "calculate_next_version" skills/completing-milestones/references/version-detector.md && echo "OK: calculate_next_version"
grep -q "update_versions" skills/completing-milestones/references/version-detector.md && echo "OK: update_versions"

# Changelog generator has required functions
grep -q "get_commits_by_type" skills/completing-milestones/references/changelog-generator.md && echo "OK: get_commits_by_type"
grep -q "generate_changelog_entry" skills/completing-milestones/references/changelog-generator.md && echo "OK: generate_changelog_entry"
```
</verification>

<success_criteria>
- [ ] version-detector.md created with semantic version detection logic
- [ ] version-detector.md contains detect_version_bump, calculate_next_version, update_versions functions
- [ ] changelog-generator.md created with Keep a Changelog formatting
- [ ] changelog-generator.md contains get_commits_by_type, generate_changelog_entry functions
- [ ] Both files follow Kata XML reference conventions
- [ ] Dry run mode documented in version-detector.md
- [ ] Review gate pattern documented in changelog-generator.md
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-automation/01-01-SUMMARY.md`
</output>
