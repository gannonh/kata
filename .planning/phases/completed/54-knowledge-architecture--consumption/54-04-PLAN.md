---
phase: 54-knowledge-architecture--consumption
plan: 04
type: execute
wave: 2
depends_on: [54-01]
files_modified:
  - skills/kata-execute-phase/references/verifier-instructions.md
  - KATA-STYLE.md
autonomous: true
must_haves:
  truths:
    - "Verifier agents receive codebase conventions for compliance checking"
    - "KATA-STYLE.md documents the implemented codebase intelligence architecture"
  artifacts:
    - skills/kata-execute-phase/references/verifier-instructions.md
    - KATA-STYLE.md
  key_links:
    - "kata-execute-phase SKILL.md step 7 verifier spawn -> includes intel summary in verifier prompt"
    - "verifier-instructions.md convention check -> uses conventions from prompt context"
---

<objective>
Wire codebase intelligence into the verifier workflow and update KATA-STYLE.md to document the implemented architecture. The verifier gains convention compliance checking. KATA-STYLE.md replaces the unimplemented hook-based intel description with the actual generate-and-consume architecture.

Purpose: Verifiers can check that executor output follows codebase conventions. Documentation reflects reality. Satisfies INTEG-03 and updates KATA-STYLE.md.

Output: Updated verifier-instructions.md and KATA-STYLE.md
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Architecture research
@.planning/research/ARCHITECTURE.md

# Files to modify
@skills/kata-execute-phase/references/verifier-instructions.md
@KATA-STYLE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add convention compliance checking to verifier instructions and orchestrator</name>
  <files>skills/kata-execute-phase/references/verifier-instructions.md, skills/kata-execute-phase/SKILL.md</files>
  <action>
Two changes needed:

**1. Update kata-execute-phase/SKILL.md step 7** (Verify phase goal):

The verifier is spawned as a Task() subagent in step 7. Add intel summary reading and injection to the verifier prompt. After the existing `verifier_instructions_content = Read("references/verifier-instructions.md")` line, add:

```
# Read intel summary for convention compliance checking
intel_summary_content = Read(".planning/intel/summary.md") if exists, else ""
```

In the verifier Task() prompt, add the intel section after the plan summaries:

```
Codebase conventions (if available):
{intel_summary_content}
```

This follows the same pattern used for executor and planner injection. The verifier prompt already contains phase goal and summary contents; conventions add one more context section.

**2. Update verifier-instructions.md:**

Add a new step in the `<verification_process>` section. Place it in Step 7 (Scan for Anti-Patterns), as a subsection at the end:

```markdown
### Convention Compliance Check

If codebase conventions were provided in your prompt context (under "Codebase conventions"):

For each file modified in this phase:
1. **Naming:** Check file names match codebase naming conventions (e.g., kebab-case for files, PascalCase for components)
2. **Directory placement:** Verify new files are in the expected directories per project structure
3. **Import patterns:** Check imports follow established conventions (aliases, ordering)

Convention violations are categorized as:
- **Warning:** Inconsistent naming or placement (not blocking)
- **Info:** Minor style differences

Convention checks are informational. They do NOT affect the pass/fail status of verification. The verifier's primary job remains goal-backward verification (truths, artifacts, wiring). Convention compliance is supplementary.

If no conventions provided: skip this check entirely.
```

This is a lightweight addition. Convention violations produce warnings, not blockers. The verifier's core responsibility (goal verification) is unchanged.
  </action>
  <verify>
Read both modified files. Verify:
1. kata-execute-phase SKILL.md step 7 reads intel/summary.md and includes it in verifier prompt
2. verifier-instructions.md has a Convention Compliance Check subsection
3. Convention violations are categorized as Warning/Info (not blocking)
4. Missing intel handled gracefully in both files
  </verify>
  <done>
Verifier agents receive codebase conventions and check file naming, directory placement, and import patterns. Violations produce warnings, not failures. Missing conventions cause no error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update KATA-STYLE.md Codebase Intelligence section</name>
  <files>KATA-STYLE.md</files>
  <action>
Update the "Codebase Intelligence" section in KATA-STYLE.md (currently around lines 516-570) to reflect the implemented architecture. Replace the entire section with:

```markdown
## Codebase Intelligence

Kata includes a codebase knowledge system that captures project conventions and injects them into agent contexts.

### Pipeline

```
Capture: /kata-map-codebase -> mapper agents -> .planning/codebase/ (7 docs)
                             -> generate-intel.js -> .planning/intel/ (3 artifacts)

Consume: kata-plan-phase orchestrator -> reads intel/summary.md -> inlines into planner prompt
         kata-execute-phase orchestrator -> reads intel/summary.md -> inlines into executor prompts
         kata-execute-phase verifier -> reads intel/summary.md -> convention compliance checks
```

### Files

| File | Purpose | Updated By |
|------|---------|------------|
| `.planning/intel/index.json` | File registry (exports, imports, types, layers) | generate-intel.js |
| `.planning/intel/conventions.json` | Detected patterns (naming, directories, testing) | generate-intel.js |
| `.planning/intel/summary.md` | Compressed agent-readable summary (~80-150 lines) | generate-intel.js |

### Summary Schema

```markdown
# Codebase Intelligence Summary
Generated: YYYY-MM-DD | Source: .planning/codebase/
## Stack
[One-liner: language + framework + database + UI]
## Architecture
[Layers, entry points, data flow]
## Conventions
[Naming patterns, import rules, directory placement]
## Key Patterns
[Error handling, state management, testing approach]
## Concerns
[Outstanding issues, tech debt]
```

Target: 80-150 lines (~2-3k tokens). Hard cap at 150 lines.

### Index Schema

```json
{
  "version": 1,
  "generated": "ISO-8601",
  "source": "kata-map-codebase",
  "files": {
    "path/to/file.ts": {
      "exports": ["name1"],
      "imports": ["pkg"],
      "type": "component|service|util",
      "layer": "ui|api|data"
    }
  },
  "stats": { "total_files": 42, "by_type": {}, "by_layer": {} }
}
```

### Convention Detection

Naming conventions (detected from code, requires 5+ exports, 70%+ match rate):
- camelCase, PascalCase, snake_case, SCREAMING_SNAKE

Directory purposes (lookup table from project structure):
- components, hooks, utils, lib, services, api, routes, types, models, tests

### Consumption Pattern

Agents consume intel via orchestrator injection. The orchestrator reads `.planning/intel/summary.md` and inlines it as a `<codebase_intelligence>` section in the agent's prompt. No agent reads intel files directly.

Graceful degradation: if `.planning/intel/` does not exist, agents proceed without convention guidance. No errors, no prompts.

### Commands

**`/kata-map-codebase`** â€” Full codebase scan for brownfield projects:
- Spawns 4 parallel mapper agents to write .planning/codebase/
- Runs generate-intel.js to produce .planning/intel/
- Works standalone (no /kata-new-project required)
```

Remove the old references to PostToolUse hooks, SessionStart hooks, and entity-generator-instructions.md. Those were documented but never implemented. The new section reflects the actual architecture.
  </action>
  <verify>
Read the modified KATA-STYLE.md. Verify:
1. Codebase Intelligence section documents the generate-intel.js pipeline
2. No references to PostToolUse or SessionStart hooks for intel
3. Summary, index, and conventions schemas are documented
4. Consumption pattern describes orchestrator injection
5. No references to entity-generator-instructions.md
  </verify>
  <done>
KATA-STYLE.md documents the implemented codebase intelligence architecture. Hook-based references removed. Pipeline, schemas, and consumption patterns are accurate.
  </done>
</task>

</tasks>

<verification>
1. Verifier receives intel summary in its prompt context
2. Verifier checks convention compliance (naming, directories, imports)
3. Convention violations produce warnings not failures
4. KATA-STYLE.md Codebase Intelligence section reflects actual architecture
5. No references to unimplemented hooks or orphaned agents in documentation
</verification>

<success_criteria>
- Verifier agents receive codebase conventions for compliance checking (INTEG-03)
- Convention checking is informational (warnings), not blocking
- KATA-STYLE.md accurately documents the generate-and-consume pipeline
- Old hook-based intel documentation replaced with actual architecture
- Missing intel causes no errors anywhere
</success_criteria>

<output>
After completion, create `.planning/phases/54-knowledge-architecture--consumption/54-04-SUMMARY.md`
</output>
