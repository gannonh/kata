---
phase: 54-knowledge-architecture--consumption
plan: 02
type: execute
wave: 2
depends_on: [54-01]
files_modified:
  - skills/kata-plan-phase/SKILL.md
  - skills/kata-plan-phase/references/planner-instructions.md
autonomous: true
must_haves:
  truths:
    - "Planner agents receive codebase intelligence summary in their context when spawned"
    - "Planner instructions reference codebase intelligence for naming, directory, and pattern decisions"
    - "Missing intel is gracefully handled (no error when .planning/intel/summary.md absent)"
  artifacts:
    - skills/kata-plan-phase/SKILL.md
    - skills/kata-plan-phase/references/planner-instructions.md
  key_links:
    - "kata-plan-phase SKILL.md step 7 -> reads .planning/intel/summary.md"
    - "kata-plan-phase SKILL.md step 8 -> inlines <codebase_intelligence> into planner prompt"
    - "planner-instructions.md load_codebase_intelligence step -> applies conventions from prompt context"
---

<objective>
Wire codebase intelligence consumption into the planner workflow. The planner orchestrator reads .planning/intel/summary.md and inlines it into the planner agent's prompt. The planner instructions replace the brittle keyword-based codebase doc loading with a single summary consumption step.

Purpose: Planners produce better plans when they know the codebase conventions. This replaces loading 2 full codebase docs (~400-600 lines, ~8-12k tokens) with one compressed summary (~80-150 lines, ~2-3k tokens). Satisfies INTEG-01.

Output: Updated kata-plan-phase SKILL.md and planner-instructions.md
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Architecture research with integration point details
@.planning/research/ARCHITECTURE.md

# Current skill and instructions to modify
@skills/kata-plan-phase/SKILL.md
@skills/kata-plan-phase/references/planner-instructions.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add intel summary reading to kata-plan-phase orchestrator</name>
  <files>skills/kata-plan-phase/SKILL.md</files>
  <action>
Modify skills/kata-plan-phase/SKILL.md in two places:

**Step 7 (Read Context Files):** Add to the list of files read using the Read tool:
```
- `.planning/intel/summary.md` (if exists) â€” store as `intel_summary_content`
```

Add this AFTER the existing context file reads (STATE.md, ROADMAP.md, REQUIREMENTS.md, etc.) and BEFORE the "Store all content" instruction. Use the same conditional pattern as other optional files: read it, store content, skip silently if not found.

**Step 8 (Spawn kata-planner Agent):** Add a `<codebase_intelligence>` section to the planning_context in the planner prompt template. Add it AFTER the existing `**Brainstorm Context (if exists):**` section and BEFORE the `**Gap Closure (if --gaps mode):**` section:

```markdown
**Codebase Intelligence (if exists):**
{intel_summary_content}
```

The prompt assembly already handles empty/null content for optional sections. If intel_summary_content is empty (file did not exist), this section is simply omitted from the prompt.

Do NOT change the Task() call signature, model selection, or any other orchestrator logic. Only add the read and the prompt section.
  </action>
  <verify>
Read the modified SKILL.md. Verify:
1. Step 7 includes `.planning/intel/summary.md` in the read list
2. Step 8 planning_context includes `**Codebase Intelligence (if exists):**` section
3. No other steps or logic changed
  </verify>
  <done>
kata-plan-phase orchestrator reads intel summary and passes it to the planner agent via prompt injection. Missing summary handled gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace keyword-based codebase loading with intel summary consumption</name>
  <files>skills/kata-plan-phase/references/planner-instructions.md</files>
  <action>
Modify skills/kata-plan-phase/references/planner-instructions.md:

**Replace the `load_codebase_context` step** (lines ~1130-1149) with a new `load_codebase_intelligence` step. The current step has a keyword-to-document lookup table that selects 2 codebase docs based on phase keywords. Replace it with:

```xml
<step name="load_codebase_intelligence">
If the orchestrator included a `**Codebase Intelligence (if exists):**` section in your planning context, apply it when creating plans:

- Use naming conventions when specifying file paths in tasks (match existing codebase style)
- Use directory conventions when determining where new files should be created
- Reference existing patterns in task `<action>` elements (e.g., "Follow the existing error handling pattern using AppError")
- Consider listed concerns when planning (avoid introducing more tech debt)
- Match testing patterns in `<verify>` elements (use the project's test runner and conventions)
- Reference architecture layers when assigning files to plans (understand which layer each file belongs to)

If no codebase intelligence section exists in your context: skip this step. Plans are still valid without it. Do not attempt to load .planning/codebase/ documents directly.
</step>
```

This replaces the entire keyword-matching table and the `find .planning/codebase` bash block. The new step is simpler: the orchestrator already inlined the summary, so the planner just needs to apply it.

Keep the step in the same position in the execution_flow (between `load_project_state` and `identify_phase`).
  </action>
  <verify>
Read the modified planner-instructions.md. Verify:
1. `load_codebase_context` step no longer exists (no keyword table)
2. `load_codebase_intelligence` step exists in its place
3. The step references "Codebase Intelligence" section from planning context
4. No bash commands to read .planning/codebase/ directly
  </verify>
  <done>
Planner instructions consume the inlined summary instead of loading full codebase docs. Keyword-based document selection removed. Missing intel is a no-op.
  </done>
</task>

</tasks>

<verification>
1. kata-plan-phase SKILL.md step 7 includes intel/summary.md in read list
2. kata-plan-phase SKILL.md step 8 includes codebase_intelligence in planner prompt
3. planner-instructions.md has load_codebase_intelligence step (not load_codebase_context)
4. No direct references to .planning/codebase/ remain in planner-instructions.md execution flow
</verification>

<success_criteria>
- Planner orchestrator reads .planning/intel/summary.md when it exists
- Planner orchestrator inlines summary into the planner agent's prompt as <codebase_intelligence>
- Planner instructions apply conventions from the inlined summary
- Missing intel file causes no error (graceful degradation)
- Context cost reduced from ~8-12k tokens (2 full docs) to ~2-3k tokens (summary)
</success_criteria>

<output>
After completion, create `.planning/phases/54-knowledge-architecture--consumption/54-02-SUMMARY.md`
</output>
