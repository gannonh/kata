---
phase: 46-execution-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/references/executor-instructions.md
  - skills/kata-execute-phase/references/phase-execute.md
autonomous: true
must_haves:
  truths:
    - executor-instructions.md contains <working_directory> section explaining how executors operate in worktree paths
    - phase-execute.md documents worktree lifecycle (create, execute, merge, cleanup) in the wave execution step
    - Existing non-worktree behavior remains default and unchanged
  artifacts:
    - skills/kata-execute-phase/references/executor-instructions.md (updated)
    - skills/kata-execute-phase/references/phase-execute.md (updated)
  key_links:
    - executor-instructions.md <working_directory> section -> SKILL.md Task() prompt injection (Plan 02)
    - phase-execute.md worktree lifecycle docs -> SKILL.md wave execution logic (Plan 02)
---

<objective>
Add worktree awareness to the executor agent instructions and phase execution reference documentation.

Purpose: Executor agents need to understand how to operate when spawned into an isolated worktree directory. The phase-execute reference doc needs to describe the worktree lifecycle so the orchestrator logic (Plan 02) has a documented pattern to follow.

Output: Updated executor-instructions.md with `<working_directory>` handling, updated phase-execute.md with worktree lifecycle documentation in the wave execution flow.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@skills/kata-execute-phase/references/executor-instructions.md
@skills/kata-execute-phase/references/phase-execute.md
@skills/kata-execute-phase/scripts/manage-worktree.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add working_directory awareness to executor-instructions.md</name>
  <files>skills/kata-execute-phase/references/executor-instructions.md</files>
  <action>
Add a `<working_directory>` section to executor-instructions.md between the `<execution_flow>` opening and the first step. This section teaches executor agents how to handle worktree paths.

Content to add:
- When `<working_directory>` is present in the executor prompt, the agent MUST `cd` to that path before any file or git operations
- All relative file paths in the plan resolve from the working directory, not the repo root
- Git operations (commit, status, add) work normally inside worktrees since git auto-detects
- The `.planning/` directory exists in the worktree (linked from bare repo) so STATE.md updates work
- When `<working_directory>` is absent (default), behavior is unchanged (current working directory)

Also update the `<step name="load_plan">` section to note that if `<working_directory>` is provided, the executor should cd into it before reading context files or executing tasks.

Update the `<task_commit_protocol>` section to note that git add/commit works identically in worktrees since git handles worktree-aware operations transparently.

Do NOT change any existing behavior or remove any content. Only ADD worktree awareness as additive sections/paragraphs.
  </action>
  <verify>
grep -c "working_directory" skills/kata-execute-phase/references/executor-instructions.md
# Should return 3+ matches (section header, load_plan reference, commit protocol note)
  </verify>
  <done>executor-instructions.md contains working_directory section, load_plan mentions cd to working directory, task_commit_protocol notes worktree transparency</done>
</task>

<task type="auto">
  <name>Task 2: Document worktree lifecycle in phase-execute.md</name>
  <files>skills/kata-execute-phase/references/phase-execute.md</files>
  <action>
Add a `<step name="worktree_lifecycle">` section to phase-execute.md. Place it between the `resolve_model_profile` step and the `load_project_state` step.

This step documents the worktree decision and lifecycle:

1. **Detection**: Read `worktree.enabled` from config using read-config.sh. Store as WORKTREE_ENABLED variable.
2. **Create phase (per wave)**: Before spawning agents in a wave, call `manage-worktree.sh create {phase} {plan}` for each plan. Store WORKTREE_PATH from output.
3. **Inject path**: Add `<working_directory>{worktree_path}</working_directory>` to each executor agent's Task() prompt.
4. **Merge (per wave)**: After all agents in a wave complete, call `manage-worktree.sh merge {phase} {plan}` for each plan in the wave. This fast-forward merges the plan branch back to base and removes the worktree.
5. **Cleanup on failure**: If an agent fails, the worktree remains for debugging. User can manually inspect and then run `manage-worktree.sh merge` or `git worktree remove`.

Also update the existing `<step name="execute_waves">` section to add a conditional note:
- "If WORKTREE_ENABLED=true, see worktree_lifecycle step for pre-spawn and post-wave operations."

Add a `<worktree_context>` subsection inside the `<context_efficiency>` section explaining that worktrees add ~2% orchestrator context overhead (config check + per-wave create/merge calls) but give each agent a clean working directory.

Do NOT restructure or remove existing content. Add the new step and notes as additive content.
  </action>
  <verify>
grep -c "worktree_lifecycle\|WORKTREE_ENABLED\|manage-worktree" skills/kata-execute-phase/references/phase-execute.md
# Should return 5+ matches
  </verify>
  <done>phase-execute.md has worktree_lifecycle step documenting create/execute/merge/cleanup flow, execute_waves references worktree lifecycle, context_efficiency explains overhead</done>
</task>

</tasks>

<verification>
- Both reference docs updated with worktree content
- No existing behavior changed (non-worktree paths remain default)
- `grep "working_directory" skills/kata-execute-phase/references/executor-instructions.md` finds matches
- `grep "worktree_lifecycle" skills/kata-execute-phase/references/phase-execute.md` finds matches
</verification>

<success_criteria>
- [ ] executor-instructions.md has `<working_directory>` section with cd-first behavior
- [ ] executor-instructions.md load_plan step mentions working directory
- [ ] executor-instructions.md task_commit_protocol notes worktree transparency
- [ ] phase-execute.md has worktree_lifecycle step with full create/execute/merge/cleanup docs
- [ ] phase-execute.md execute_waves references worktree_lifecycle conditionally
- [ ] phase-execute.md context_efficiency explains worktree overhead
- [ ] No existing non-worktree behavior altered
</success_criteria>

<output>
After completion, create `.planning/phases/46-execution-integration/46-01-SUMMARY.md`
</output>
