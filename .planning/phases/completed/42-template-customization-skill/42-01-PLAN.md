---
phase: 42-template-customization-skill
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-customize-template/scripts/list-templates.sh
  - skills/kata-customize-template/SKILL.md
  - skills/kata-help/SKILL.md
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "list-templates.sh discovers all 5 schema-backed templates: summary-template.md, plan-template.md, UAT-template.md, verification-report.md, changelog-entry.md"
    - "list-templates.sh outputs valid JSON with filename, skill, description, hasOverride, required, and optional fields per template"
    - "list-templates.sh uses sibling discovery (two levels up from scripts/ to skills/) with no CLAUDE_PLUGIN_ROOT references"
    - "list-templates.sh exits 0 always, even when no templates are found"
    - "SKILL.md frontmatter name is kata-customize-template and description includes trigger phrases: customize template, override template, edit template, list templates, show templates, template overrides, manage templates, template customization, template schema"
    - "SKILL.md has four operations: list, copy, edit, validate"
    - "SKILL.md list operation runs list-templates.sh and displays a table of templates with override status"
    - "SKILL.md copy operation uses resolve-template.sh to find the default template and copies to .planning/templates/"
    - "SKILL.md copy operation checks for existing override and asks user to confirm overwrite via AskUserQuestion"
    - "SKILL.md edit operation reads current override content, accepts user modifications, writes changes, then runs validation"
    - "SKILL.md validate operation runs check-template-drift.sh and displays results"
    - "SKILL.md does not spawn subagents (no references/ directory needed)"
    - "SKILL.md is under 500 lines"
    - "kata-help/SKILL.md includes a /kata-customize-template entry in the Configuration section"
  artifacts:
    - skills/kata-customize-template/scripts/list-templates.sh
    - skills/kata-customize-template/SKILL.md
    - skills/kata-help/SKILL.md
  key_links:
    - "list-templates.sh parses the same kata-template-schema comment format used by check-template-drift.sh"
    - "SKILL.md copy operation calls resolve-template.sh from kata-execute-phase/scripts/ via ${SKILL_BASE_DIR}/../kata-execute-phase/scripts/resolve-template.sh"
    - "SKILL.md validate operation calls check-template-drift.sh from kata-doctor/scripts/ via ${SKILL_BASE_DIR}/../kata-doctor/scripts/check-template-drift.sh"
    - "SKILL.md follows the kata-configure-settings pattern: read state, present options via AskUserQuestion, execute choice, display confirmation"
    - "kata-help Configuration section lists /kata-customize-template alongside /kata-configure-settings and /kata-set-profile"
---

<objective>
Create the `/kata-customize-template` skill with a helper script for template discovery. Add a help entry to kata-help.

Purpose: Give users a self-service interface for listing available templates, copying defaults to project override locations, editing overrides, and validating them against schemas. This completes requirements UI-01 through UI-05.
Output: New skill directory with SKILL.md and scripts/list-templates.sh, updated kata-help/SKILL.md.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/42-template-customization-skill/42-RESEARCH.md

@skills/kata-configure-settings/SKILL.md
@skills/kata-execute-phase/scripts/resolve-template.sh
@skills/kata-doctor/scripts/check-template-drift.sh
@skills/kata-help/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create list-templates.sh helper script</name>
  <files>skills/kata-customize-template/scripts/list-templates.sh</files>
  <action>
Create the directory structure and helper script.

```bash
mkdir -p skills/kata-customize-template/scripts
```

Create `skills/kata-customize-template/scripts/list-templates.sh`:

**Script contract:**
- Input: None (discovers templates from sibling skill directories)
- Output: JSON array of template metadata to stdout
- Exit: Always 0

**Implementation:**
1. Shebang: `#!/usr/bin/env bash` with `set -euo pipefail`
2. Use sibling discovery pattern:
   ```bash
   SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd -P)"
   SKILLS_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd -P)"
   ```
   This navigates: `scripts/` -> `kata-customize-template/` -> `skills/`
3. Pass `SKILLS_DIR` as environment variable to inline Node.js block using `SKILLS_DIR="$SKILLS_DIR" node << 'NODE_EOF'` (single-quoted to prevent expansion)
4. In the Node.js block:
   a. Read all `kata-*` directories from SKILLS_DIR
   b. For each, scan `references/*.md` files for `kata-template-schema` comment
   c. Parse the schema: extract required-fields (frontmatter + body) and optional-fields (frontmatter + body)
   d. Extract description from the first `# Heading` line in the file
   e. Check if `.planning/templates/{filename}` exists (override status)
   f. Build an object: `{ filename, skill, description, hasOverride, required: { frontmatter: [], body: [] }, optional: { frontmatter: [], body: [] } }`
5. Output `JSON.stringify(templates, null, 2)` to stdout
6. Wrap in try/catch that outputs `[]` on error
7. End with `exit 0` after the heredoc

**Reference code for schema parsing** (match the regex patterns from check-template-drift.sh):
```javascript
const schemaMatch = content.match(/<!--\s*kata-template-schema\n([\s\S]*?)-->/);
const reqFm = schema.match(/required-fields:\s*\n\s*frontmatter:\s*\[([^\]]*)\]/);
const reqBody = schema.match(/required-fields:[\s\S]*?body:\s*\[([^\]]*)\]/);
const optFm = schema.match(/optional-fields:\s*\n\s*frontmatter:\s*\[([^\]]*)\]/);
const optBody = schema.match(/optional-fields:[\s\S]*?body:\s*\[([^\]]*)\]/);
```

Make the script executable: `chmod +x skills/kata-customize-template/scripts/list-templates.sh`

**Do NOT:**
- Reference CLAUDE_PLUGIN_ROOT anywhere
- Hardcode the list of templates (discover dynamically)
- Output anything to stderr
  </action>
  <verify>
```bash
# Script exists and is executable
[ -x skills/kata-customize-template/scripts/list-templates.sh ] && echo "OK: executable" || echo "FAIL: not executable"

# No CLAUDE_PLUGIN_ROOT references
grep -c "CLAUDE_PLUGIN_ROOT" skills/kata-customize-template/scripts/list-templates.sh && echo "FAIL" || echo "OK: no CLAUDE_PLUGIN_ROOT"

# Uses sibling discovery
grep -c 'SCRIPT_DIR/../..' skills/kata-customize-template/scripts/list-templates.sh | grep -q "[1-9]" && echo "OK: sibling discovery" || echo "FAIL: no sibling discovery"

# Discovers all 5 schema-backed templates
cd /Users/gannonhall/dev/kata/kata-orchestrator
bash skills/kata-customize-template/scripts/list-templates.sh | node -e "
  const t = JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
  console.log('Found:', t.length, 'templates');
  console.log('Names:', t.map(x => x.filename).join(', '));
  const expected = ['summary-template.md','plan-template.md','UAT-template.md','verification-report.md','changelog-entry.md'];
  const found = t.map(x => x.filename).sort();
  const missing = expected.filter(e => !found.includes(e));
  if (missing.length) { console.log('FAIL: missing', missing); process.exit(1); }
  console.log('OK: all 5 templates found');
"

# JSON output is valid and has expected fields
bash skills/kata-customize-template/scripts/list-templates.sh | node -e "
  const t = JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));
  const first = t[0];
  const fields = ['filename','skill','description','hasOverride','required','optional'];
  const missing = fields.filter(f => !(f in first));
  if (missing.length) { console.log('FAIL: missing fields', missing); process.exit(1); }
  console.log('OK: all fields present');
"
```
  </verify>
  <done>list-templates.sh exists, is executable, discovers all 5 schema-backed templates dynamically, outputs valid JSON with all metadata fields, uses sibling discovery, and has no CLAUDE_PLUGIN_ROOT references.</done>
</task>

<task type="auto">
  <name>Task 2: Create kata-customize-template SKILL.md</name>
  <files>skills/kata-customize-template/SKILL.md</files>
  <action>
Create `skills/kata-customize-template/SKILL.md` as a single-file orchestrator (no subagents, no references/ directory).

**YAML frontmatter:**
```yaml
---
name: kata-customize-template
description: Manage template overrides for customizing Kata output formats. List available templates, copy defaults for local editing, edit overrides, validate template schemas. Triggers include "customize template", "override template", "edit template", "template overrides", "list templates", "show templates", "template customization", "manage templates", "what templates can I customize", "template schema".
metadata:
  version: "1.9.0"
---
```

**Skill structure (follow kata-configure-settings pattern):**

```markdown
<objective>
Manage template overrides for customizing Kata output formats.

Templates control the structure of planning artifacts (plans, summaries, UAT sessions, verification reports, changelogs). Override a template to change how Kata generates these files for your project.

Operations: list, copy, edit, validate.
</objective>

<context>
$ARGUMENTS
</context>

<process>

## 1. Validate Environment

```bash
ls .planning/ 2>/dev/null
```

**If not found:** Error — run `/kata-new-project` first.

## 2. Determine Operation

Parse `$ARGUMENTS` for the operation:

- If contains "list" or "show" or no arguments → **list** operation
- If contains "copy" → **copy** operation (extract template name from remaining args)
- If contains "edit" or "modify" or "change" → **edit** operation (extract template name)
- If contains "validate" or "check" or "drift" → **validate** operation

If unclear, present AskUserQuestion:

```
What would you like to do?

1. **List templates** — See all customizable templates and their override status
2. **Copy a template** — Copy a default template for local customization
3. **Edit a template** — Modify an existing template override
4. **Validate overrides** — Check all overrides for missing required fields
```

## 3. List Operation (UI-02)

Run the discovery script:

```bash
bash "${SKILL_BASE_DIR}/scripts/list-templates.sh"
```

Parse the JSON output. Display:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Kata > CUSTOMIZABLE TEMPLATES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

| Template | Used By | Controls | Status |
| --- | --- | --- | --- |
| summary-template.md | kata-execute-phase | Phase completion docs | {✅ override / default} |
| plan-template.md | kata-plan-phase | Phase plan structure | {✅ override / default} |
| UAT-template.md | kata-verify-work | UAT session format | {✅ override / default} |
| verification-report.md | kata-verify-work | Verification report format | {✅ override / default} |
| changelog-entry.md | kata-complete-milestone | Changelog entry format | {✅ override / default} |

Override location: `.planning/templates/`

To customize a template:
  `/kata-customize-template copy summary-template.md`
```

After displaying the list, stop. Do not proceed to another operation.

## 4. Copy Operation (UI-03)

Requires a template name argument. If not provided, run list operation first, then ask user to select.

**Step 4a: Resolve the default template path**

```bash
RESOLVE_SCRIPT="${SKILL_BASE_DIR}/../kata-execute-phase/scripts/resolve-template.sh"
DEFAULT_PATH=$(bash "$RESOLVE_SCRIPT" "$TEMPLATE_NAME" 2>&1)
```

If the resolve script exits non-zero, the template name is invalid. Display the error and stop.

**Step 4b: Check for existing override**

```bash
[ -f ".planning/templates/$TEMPLATE_NAME" ] && echo "EXISTS" || echo "NEW"
```

If EXISTS, ask user via AskUserQuestion:

```
An override for `{TEMPLATE_NAME}` already exists at `.planning/templates/{TEMPLATE_NAME}`.

1. **Overwrite** — Replace with default (your customizations will be lost)
2. **Cancel** — Keep current override
```

If user selects Cancel, stop.

**Step 4c: Copy the default**

```bash
mkdir -p .planning/templates
cp "$DEFAULT_PATH" ".planning/templates/$TEMPLATE_NAME"
```

**Step 4d: Confirm**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Kata > TEMPLATE COPIED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Copied default to: `.planning/templates/{TEMPLATE_NAME}`

Edit the file to customize, then validate:
  `/kata-customize-template validate`
```

## 5. Edit Operation (UI-04)

Requires a template name argument. If not provided, run list operation to show overrides, then ask which to edit.

**Step 5a: Check override exists**

```bash
[ -f ".planning/templates/$TEMPLATE_NAME" ] && echo "EXISTS" || echo "MISSING"
```

If MISSING, ask user via AskUserQuestion:

```
No override exists for `{TEMPLATE_NAME}`.

1. **Copy and edit** — Copy the default first, then edit
2. **Cancel** — Do nothing
```

If user selects "Copy and edit", run step 4c first.

**Step 5b: Read current content**

Read `.planning/templates/{TEMPLATE_NAME}` and display the current content to the user.

**Step 5c: Accept modifications**

Ask the user what they want to change. Two paths:

- If user describes specific changes ("change heading X to Y", "add field Z"), apply the edits to the file using Edit tool and write the updated content.
- If user says they will edit externally ("let me edit it", "I'll do it in my editor"), acknowledge and offer to validate when they return.

**Step 5d: Validate after edit**

After writing changes (or when user returns from external editing), run single-template validation:

```bash
bash "${SKILL_BASE_DIR}/../kata-doctor/scripts/check-template-drift.sh"
```

If drift warnings mention the edited template, display them. If clean, display:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Kata > TEMPLATE VALID
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

`{TEMPLATE_NAME}` has all required fields. Override is active.
```

## 6. Validate Operation (UI-05)

Run validation on all overrides:

```bash
DRIFT_OUTPUT=$(bash "${SKILL_BASE_DIR}/../kata-doctor/scripts/check-template-drift.sh" 2>/dev/null)
```

If `DRIFT_OUTPUT` is empty and `.planning/templates/` exists with .md files:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Kata > ALL TEMPLATES VALID
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

All template overrides pass schema validation.
```

If `DRIFT_OUTPUT` is empty and no overrides exist:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Kata > NO OVERRIDES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

No template overrides found at `.planning/templates/`.

To create an override:
  `/kata-customize-template copy summary-template.md`
```

If `DRIFT_OUTPUT` has content (warnings):

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Kata > TEMPLATE DRIFT DETECTED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

{DRIFT_OUTPUT}

To fix, edit the override or reset to default:
  `/kata-customize-template edit {template-name}`
  `/kata-customize-template copy {template-name}` (resets to default)
```

</process>

<success_criteria>
- [ ] Templates listed with descriptions and override status (UI-02)
- [ ] Default copied to .planning/templates/ with overwrite protection (UI-03)
- [ ] Edit operation reads current content and applies user changes (UI-04)
- [ ] Validation runs after edit and reports missing fields (UI-05)
- [ ] All operations use existing infrastructure (resolve-template.sh, check-template-drift.sh)
- [ ] Skill responds to natural language triggers
</success_criteria>
```

Keep SKILL.md under 500 lines. The structure above should produce approximately 200-250 lines.

**Do NOT:**
- Create a `references/` directory (no subagents)
- Exceed 500 lines in SKILL.md
- Hardcode template paths or names
- Reference CLAUDE_PLUGIN_ROOT
- Add a pre-flight validation step (this skill IS the validation interface)
  </action>
  <verify>
```bash
# SKILL.md exists
[ -f skills/kata-customize-template/SKILL.md ] && echo "OK: SKILL.md exists" || echo "FAIL: no SKILL.md"

# Under 500 lines
LINES=$(wc -l < skills/kata-customize-template/SKILL.md)
[ "$LINES" -lt 500 ] && echo "OK: ${LINES} lines (under 500)" || echo "FAIL: ${LINES} lines (over 500)"

# Frontmatter has correct name
grep -q "name: kata-customize-template" skills/kata-customize-template/SKILL.md && echo "OK: correct name" || echo "FAIL: wrong name"

# Description includes key triggers
grep -q "customize template" skills/kata-customize-template/SKILL.md && echo "OK: has trigger" || echo "FAIL: missing trigger"
grep -q "list templates" skills/kata-customize-template/SKILL.md && echo "OK: has trigger" || echo "FAIL: missing trigger"

# References resolve-template.sh
grep -q "resolve-template.sh" skills/kata-customize-template/SKILL.md && echo "OK: uses resolve-template.sh" || echo "FAIL: missing resolve-template.sh"

# References check-template-drift.sh
grep -q "check-template-drift.sh" skills/kata-customize-template/SKILL.md && echo "OK: uses check-template-drift.sh" || echo "FAIL: missing check-template-drift.sh"

# References list-templates.sh
grep -q "list-templates.sh" skills/kata-customize-template/SKILL.md && echo "OK: uses list-templates.sh" || echo "FAIL: missing list-templates.sh"

# No references/ directory
[ -d skills/kata-customize-template/references ] && echo "FAIL: references/ exists (shouldn't)" || echo "OK: no references/ dir"

# No CLAUDE_PLUGIN_ROOT
grep -c "CLAUDE_PLUGIN_ROOT" skills/kata-customize-template/SKILL.md && echo "FAIL" || echo "OK: no CLAUDE_PLUGIN_ROOT"
```
  </verify>
  <done>SKILL.md created with four operations (list, copy, edit, validate), correct frontmatter with exhaustive triggers, references all three helper scripts (list-templates.sh, resolve-template.sh, check-template-drift.sh), is under 500 lines, and has no references/ directory.</done>
</task>

<task type="auto">
  <name>Task 3: Add kata-customize-template to kata-help reference</name>
  <files>skills/kata-help/SKILL.md</files>
  <action>
Add an entry for `/kata-customize-template` to the Configuration section of `skills/kata-help/SKILL.md`.

Find the Configuration section (contains `/kata-configure-settings` and `/kata-set-profile`). Add the new entry BEFORE the existing `/kata-configure-settings` entry since template customization is more specific and should appear first alphabetically.

Insert this block before the `**\`/kata-configure-settings\`**` line:

```markdown
**`/kata-customize-template`**
Manage template overrides for customizing Kata output formats.

- List all customizable templates with override status
- Copy a default template for local editing
- Edit an override with conversational changes
- Validate overrides against required schemas

Usage: `/kata-customize-template`
Usage: `/kata-customize-template list`
Usage: `/kata-customize-template copy summary-template.md`
Usage: `/kata-customize-template validate`

```

Also add the `.planning/templates/` directory to the Files & Structure tree. Find the `├── config.json` line and add after it:

```
├── templates/            # Template overrides (customized output formats)
```

**Do NOT:**
- Modify any other entries in the help file
- Change the structure or formatting of existing entries
  </action>
  <verify>
```bash
# kata-help includes the new skill
grep -q "kata-customize-template" skills/kata-help/SKILL.md && echo "OK: help has entry" || echo "FAIL: missing from help"

# templates/ directory listed in file structure
grep -q "templates/" skills/kata-help/SKILL.md && echo "OK: templates/ in structure" || echo "FAIL: templates/ missing from structure"

# Entry is in the Configuration section
grep -A2 "kata-customize-template" skills/kata-help/SKILL.md | head -3
```
  </verify>
  <done>kata-help/SKILL.md includes a /kata-customize-template entry in the Configuration section with usage examples, and .planning/templates/ is listed in the Files & Structure tree.</done>
</task>

</tasks>

<verification>
- list-templates.sh discovers all 5 schema-backed templates dynamically via sibling discovery
- list-templates.sh outputs valid JSON with complete metadata per template
- SKILL.md has four operations: list, copy, edit, validate
- SKILL.md uses resolve-template.sh for copy, check-template-drift.sh for validate, list-templates.sh for list
- SKILL.md follows the kata-configure-settings pattern (read state, present options, execute, confirm)
- SKILL.md is under 500 lines with no references/ directory
- kata-help/SKILL.md includes the new skill entry with usage examples
- No CLAUDE_PLUGIN_ROOT references in any new files
- All scripts use sibling discovery pattern
- Build system picks up new skill directory automatically (no build.js changes needed)
</verification>

<success_criteria>
- UI-01: /kata-customize-template skill exists and responds to natural language triggers
- UI-02: User can list available templates with descriptions of what each controls
- UI-03: User can copy plugin default to project override location
- UI-04: User can edit template override with validation feedback after save
- UI-05: Template validation checks required fields and reports missing/malformed sections
</success_criteria>

<output>
After completion, create `.planning/phases/active/42-template-customization-skill/42-01-SUMMARY.md`
</output>
