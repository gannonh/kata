---
phase: 57-knowledge-maintenance
plan: 03
type: execute
wave: 1
depends_on: [57-02]
files_modified:
  - skills/kata-execute-phase/SKILL.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Scan decision tree is a unified three-way if-elif-else: greenfield (TOTAL_FILES==0), staleness (STALE_COUNT>0 && OLDEST_COMMIT), phase-start incremental (else)"
    - "No double-scanning occurs when stale files exist"
    - "SCAN_RAN flag gates summary update (update-intel-summary.cjs only runs when a scan executed)"
    - "Doc gardening warning still fires when stalePct > 0.3 and .planning/codebase/ exists"
    - "Convention enforcement still runs after summary update"
    - "All operations remain non-blocking (|| true)"
  artifacts:
    - skills/kata-execute-phase/SKILL.md (modified step 7.25)
  key_links:
    - "Fixes gap from 57-VERIFICATION.md: separate if blocks replaced with unified elif chain"
    - "SCAN_RAN flag prevents unconditional summary regeneration"
---

<objective>
Fix scan decision tree in kata-execute-phase step 7.25 to use a unified three-way branch instead of separate if blocks, eliminating double-scanning when stale files exist. Add SCAN_RAN flag to guard summary update.

Purpose: The current implementation runs staleness-triggered scan in one if block, then unconditionally runs the greenfield/incremental scan in a separate if block. When stale files exist, both scans execute. The plan specified a mutually exclusive elif chain.

Output: Modified `skills/kata-execute-phase/SKILL.md` step 7.25 with unified scan decision tree and SCAN_RAN guard.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unify scan decision tree and add SCAN_RAN guard</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Read `skills/kata-execute-phase/SKILL.md` and locate step 7.25 (starts at line 414 with `7.25. **Update codebase index (smart scan)**`). The bash code block runs from line 418 (`\`\`\`bash`) through line 497 (`\`\`\``).

Replace the ENTIRE bash code block content (lines 418-497) with this unified version:

```bash
if [ -f ".planning/intel/index.json" ]; then
  # Locate scan script
  SCAN_SCRIPT=""
  [ -f "scripts/scan-codebase.cjs" ] && SCAN_SCRIPT="scripts/scan-codebase.cjs"
  [ -z "$SCAN_SCRIPT" ] && SCAN_SCRIPT=$(find skills/kata-map-codebase/scripts -name "scan-codebase.cjs" -type f 2>/dev/null | head -1)

  # --- Staleness detection (MAINT-01) ---
  STALE_SCRIPT=""
  [ -f "scripts/detect-stale-intel.cjs" ] && STALE_SCRIPT="scripts/detect-stale-intel.cjs"
  [ -z "$STALE_SCRIPT" ] && STALE_SCRIPT=$(find skills/kata-map-codebase/scripts -name "detect-stale-intel.cjs" -type f 2>/dev/null | head -1)

  STALE_COUNT=0
  STALE_PCT="0"
  OLDEST_COMMIT=""
  if [ -n "$STALE_SCRIPT" ]; then
    STALE_JSON=$(node "$STALE_SCRIPT" 2>/dev/null || echo "{}")
    STALE_COUNT=$(echo "$STALE_JSON" | grep -o '"staleCount"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*' || echo "0")
    STALE_PCT=$(echo "$STALE_JSON" | grep -o '"stalePct"[[:space:]]*:[[:space:]]*[0-9.]*' | grep -o '[0-9.]*' || echo "0")
    if [ "${STALE_COUNT:-0}" -gt 0 ] 2>/dev/null; then
      OLDEST_COMMIT=$(echo "$STALE_JSON" | grep -o '"oldestStaleCommit"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"oldestStaleCommit"[[:space:]]*:[[:space:]]*"//; s/"$//')
    fi
  fi

  # --- Unified scan decision tree (greenfield / staleness / incremental) ---
  TOTAL_FILES=$(node -e "const j=JSON.parse(require('fs').readFileSync('.planning/intel/index.json','utf8')); console.log(j.stats?.totalFiles ?? j.stats?.total_files ?? 0)")

  SCAN_RAN="false"
  if [ -n "$SCAN_SCRIPT" ]; then
    if [ "$TOTAL_FILES" -eq 0 ]; then
      # Greenfield first population: full scan
      node "$SCAN_SCRIPT" 2>/dev/null || true
      SCAN_RAN="true"
    elif [ "${STALE_COUNT:-0}" -gt 0 ] 2>/dev/null && [ -n "$OLDEST_COMMIT" ]; then
      # Staleness-triggered incremental re-scan (MAINT-02)
      echo "Detected $STALE_COUNT stale intel entries, re-scanning from $OLDEST_COMMIT..." >&2
      node "$SCAN_SCRIPT" --incremental --since "$OLDEST_COMMIT" 2>/dev/null || true
      SCAN_RAN="true"
    else
      # Phase-start incremental scan
      PHASE_START_COMMIT=$(git log --oneline --all --grep="activate phase" --grep="${PHASE_NUM}" --all-match --format="%H" | tail -1)
      if [ -n "$PHASE_START_COMMIT" ]; then
        node "$SCAN_SCRIPT" --incremental --since "$PHASE_START_COMMIT" 2>/dev/null || true
        SCAN_RAN="true"
      fi
    fi
  fi

  # --- Summary update (only when a scan ran) ---
  if [ "$SCAN_RAN" = "true" ]; then
    SUMMARY_SCRIPT=""
    [ -f "scripts/update-intel-summary.cjs" ] && SUMMARY_SCRIPT="scripts/update-intel-summary.cjs"
    [ -z "$SUMMARY_SCRIPT" ] && SUMMARY_SCRIPT=$(find skills/kata-execute-phase/scripts -name "update-intel-summary.cjs" -type f 2>/dev/null | head -1)
    if [ -n "$SUMMARY_SCRIPT" ]; then
      node "$SUMMARY_SCRIPT" 2>/dev/null || true
    fi
  fi

  # --- Doc gardening warning (MAINT-02) ---
  if [ -d ".planning/codebase/" ] && [ -n "$STALE_PCT" ]; then
    STALE_HIGH=$(node -e "console.log(Number('${STALE_PCT}') > 0.3 ? 'yes' : 'no')" 2>/dev/null || echo "no")
    if [ "$STALE_HIGH" = "yes" ]; then
      echo "Warning: >30% of intel is stale (stalePct=$STALE_PCT). Recommend running /kata-map-codebase to refresh codebase knowledge." >&2
    fi
  fi

  # --- Convention enforcement (MAINT-03) ---
  CONV_SCRIPT=""
  [ -f "scripts/check-conventions.cjs" ] && CONV_SCRIPT="scripts/check-conventions.cjs"
  [ -z "$CONV_SCRIPT" ] && CONV_SCRIPT=$(find skills/kata-execute-phase/scripts -name "check-conventions.cjs" -type f 2>/dev/null | head -1)

  if [ -n "$CONV_SCRIPT" ]; then
    PHASE_START_COMMIT=${PHASE_START_COMMIT:-$(git log --oneline --all --grep="activate phase" --grep="${PHASE_NUM}" --all-match --format="%H" | tail -1)}
    if [ -n "$PHASE_START_COMMIT" ]; then
      CHANGED_FILES=$(git diff --name-only "$PHASE_START_COMMIT..HEAD" 2>/dev/null | tr '\n' ' ')
      if [ -n "$CHANGED_FILES" ]; then
        CONV_JSON=$(node "$CONV_SCRIPT" --files $CHANGED_FILES 2>/dev/null || echo "{}")
        CONV_VIOLATIONS=$(echo "$CONV_JSON" | node -e "try{const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log((d.violations||[]).length)}catch{console.log(0)}" 2>/dev/null || echo "0")
        if [ "${CONV_VIOLATIONS:-0}" -gt 0 ] 2>/dev/null; then
          echo "Convention violations detected ($CONV_VIOLATIONS):" >&2
          echo "$CONV_JSON" | node -e "try{const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));(d.violations||[]).forEach(v=>console.error('  - '+v.file+': '+v.export+' (found '+v.found+', expected '+v.expected+')'))}catch{}" 2>/dev/null || true
        fi
      fi
    fi
  fi
fi
```

**Changes from current implementation:**

1. **Staleness detection moved before scan decision tree, without its own scan call.** The current code runs `node "$SCAN_SCRIPT" --incremental --since "$OLDEST_COMMIT"` inside the staleness if block (line 440). The fix captures STALE_COUNT and OLDEST_COMMIT but defers scanning to the unified decision tree.

2. **Unified three-way if-elif-else replaces separate if blocks.** Current code: staleness if block (430-451) runs its own scan, then greenfield if block (456-467) runs unconditionally. Fix: single decision tree where greenfield/staleness/incremental are mutually exclusive branches.

3. **SCAN_RAN flag added.** Set to "true" in each scan branch. Summary update is conditional on `SCAN_RAN="true"`. Current code runs summary update unconditionally (line 473-474).

4. **Doc gardening and convention enforcement preserved unchanged.** These blocks work correctly in the current implementation.

**DO NOT modify any other steps in kata-execute-phase SKILL.md.** Only the bash code block within step 7.25 changes. The step header, description text, and closing "Non-blocking:" line remain the same. Step 7.5 follows immediately after.
  </action>
  <verify>
Read `skills/kata-execute-phase/SKILL.md` step 7.25 and verify:
1. Staleness detection captures STALE_COUNT and OLDEST_COMMIT but does NOT call scan-codebase.cjs
2. Scan decision tree is a single if-elif-else chain with three branches: greenfield (TOTAL_FILES==0), staleness (STALE_COUNT>0 && OLDEST_COMMIT), phase-start incremental (else)
3. SCAN_RAN flag is set in each scan branch
4. Summary update is conditional on `SCAN_RAN = "true"`
5. Doc gardening warning block preserved (stalePct > 0.3 check)
6. Convention enforcement block preserved (check-conventions.cjs call)
7. All operations use `|| true` or `2>/dev/null`
8. No other steps modified
9. Step 7.5 follows immediately after step 7.25
  </verify>
  <done>Step 7.25 scan decision tree is a unified three-way branch with no double-scanning and SCAN_RAN-guarded summary update</done>
</task>

</tasks>

<verification>
1. Step 7.25 bash block is syntactically valid (matched if-fi, elif chain, no unclosed quotes)
2. Three scan branches are mutually exclusive: greenfield OR staleness OR phase-start incremental
3. SCAN_RAN flag prevents unnecessary summary regeneration
4. Staleness detection runs before the decision tree (captures data only, no scan call)
5. Doc gardening threshold check preserved at 0.3 (30%)
6. Convention enforcement preserved with PHASE_START_COMMIT fallback
7. All operations non-blocking
</verification>

<success_criteria>
- [ ] Scan decision tree is a unified if-elif-else (no separate staleness scan block)
- [ ] When stale files exist, only the staleness-triggered scan runs (no double-scan with phase-start incremental)
- [ ] When no stale files exist, phase-start incremental scan runs as before
- [ ] Greenfield full scan still runs when TOTAL_FILES==0
- [ ] Summary update only runs when SCAN_RAN is true
- [ ] Doc gardening warning preserved
- [ ] Convention enforcement preserved
- [ ] All operations non-blocking
- [ ] No other SKILL.md steps modified
</success_criteria>

<output>
After completion, create `.planning/phases/completed/57-knowledge-maintenance/57-03-SUMMARY.md`
</output>
