---
phase: 57-knowledge-maintenance
plan: 02
type: execute
wave: 2
depends_on: [57-01]
files_modified:
  - skills/kata-execute-phase/SKILL.md
autonomous: true
must_haves:
  truths:
    - Step 7.25 runs detect-stale-intel.cjs before the existing smart scan gate
    - When stale files are found, scan-codebase.cjs --incremental --since runs targeting stale files
    - When .planning/codebase/ exists and stalePct > 0.3, a warning is logged recommending /kata-map-codebase
    - Summary.md is regenerated after staleness-triggered re-scan
    - Step 7.25 runs check-conventions.cjs after all plans complete, passing files changed during the phase
    - Convention violations are logged as warnings, never blocking phase completion
    - All new operations use || true (non-blocking)
    - Existing smart scan gate logic (greenfield full scan, incremental scan) is preserved unchanged
  artifacts:
    - skills/kata-execute-phase/SKILL.md (modified step 7.25)
  key_links:
    - Step 7.25 staleness detection calls detect-stale-intel.cjs from plan 01
    - Step 7.25 convention check calls check-conventions.cjs from plan 01
    - Staleness-triggered re-scan reuses existing scan-codebase.cjs --incremental --since
    - Summary regeneration reuses existing update-intel-summary.cjs
---

<objective>
Integrate staleness detection (MAINT-01), doc gardening triggers (MAINT-02), and convention enforcement (MAINT-03) into kata-execute-phase SKILL.md step 7.25.

Purpose: The two scripts from plan 01 exist but are not called during execution. This plan extends step 7.25 to run staleness detection before the smart scan gate, trigger partial re-analysis when stale files are found, and run convention checks after plan completion.

Output: Modified `skills/kata-execute-phase/SKILL.md` with extended step 7.25
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/57-knowledge-maintenance/57-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend step 7.25 with staleness detection and doc gardening</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Read `skills/kata-execute-phase/SKILL.md` and locate step 7.25 ("Update codebase index (smart scan)"). The current step runs from the `7.25.` header through the `Non-blocking:` closing line (approximately lines 414-451).

Replace the ENTIRE step 7.25 section with the extended version below. The replacement preserves all existing logic and adds staleness detection + doc gardening + convention enforcement.

New step 7.25 content:

```markdown
7.25. **Update codebase index (smart scan)**

If `.planning/intel/index.json` exists, run staleness detection, smart scan, and convention enforcement. All operations are non-blocking (`|| true`).

```bash
if [ -f ".planning/intel/index.json" ]; then

  # --- Phase 57: Staleness detection (MAINT-01) ---
  STALE_SCRIPT=""
  [ -f "scripts/detect-stale-intel.cjs" ] && STALE_SCRIPT="scripts/detect-stale-intel.cjs"

  STALE_COUNT=0
  OLDEST_STALE=""
  HAS_DOC_ENTRIES="false"

  if [ -n "$STALE_SCRIPT" ]; then
    STALE_OUTPUT=$(node "$STALE_SCRIPT" 2>/dev/null || echo '{}')
    STALE_COUNT=$(node -e "try{const o=JSON.parse(process.argv[1]);console.log(o.staleCount||0)}catch{console.log(0)}" "$STALE_OUTPUT")
    OLDEST_STALE=$(node -e "try{const o=JSON.parse(process.argv[1]);console.log(o.oldestStaleCommit||'')}catch{console.log('')}" "$STALE_OUTPUT")
    HAS_DOC_ENTRIES=$(node -e "try{const o=JSON.parse(process.argv[1]);console.log(o.hasDocBasedEntries?'true':'false')}catch{console.log('false')}" "$STALE_OUTPUT")
    STALE_PCT=$(node -e "try{const o=JSON.parse(process.argv[1]);console.log(o.stalePct||0)}catch{console.log(0)}" "$STALE_OUTPUT")
  fi

  # --- Smart scan gate (existing logic) ---
  TOTAL_FILES=$(node -e "const j=JSON.parse(require('fs').readFileSync('.planning/intel/index.json','utf8')); console.log(j.stats?.totalFiles ?? j.stats?.total_files ?? 0)")

  SCAN_SCRIPT=""
  [ -f "scripts/scan-codebase.cjs" ] && SCAN_SCRIPT="scripts/scan-codebase.cjs"
  [ -z "$SCAN_SCRIPT" ] && SCAN_SCRIPT=$(find skills/kata-map-codebase/scripts -name "scan-codebase.cjs" -type f 2>/dev/null | head -1)

  SCAN_RAN="false"
  if [ -n "$SCAN_SCRIPT" ]; then
    if [ "$TOTAL_FILES" -eq 0 ]; then
      # Greenfield first population: full scan
      node "$SCAN_SCRIPT" 2>/dev/null || true
      SCAN_RAN="true"
    elif [ "$STALE_COUNT" -gt 0 ] && [ -n "$OLDEST_STALE" ]; then
      # Phase 57: Staleness-triggered incremental re-scan (MAINT-01 + MAINT-02)
      echo "Detected $STALE_COUNT stale intel entries, triggering re-scan from $OLDEST_STALE..."
      node "$SCAN_SCRIPT" --incremental --since "$OLDEST_STALE" 2>/dev/null || true
      SCAN_RAN="true"
    else
      # Existing codebase: incremental scan from phase start
      PHASE_START_COMMIT=$(git log --oneline --all --grep="activate phase" --grep="${PHASE_NUM}" --all-match --format="%H" | tail -1)
      if [ -n "$PHASE_START_COMMIT" ]; then
        node "$SCAN_SCRIPT" --incremental --since "$PHASE_START_COMMIT" 2>/dev/null || true
        SCAN_RAN="true"
      fi
    fi

    # Update summary.md after any scan
    if [ "$SCAN_RAN" = "true" ]; then
      SUMMARY_SCRIPT=""
      [ -f "scripts/update-intel-summary.cjs" ] && SUMMARY_SCRIPT="scripts/update-intel-summary.cjs"
      [ -z "$SUMMARY_SCRIPT" ] && SUMMARY_SCRIPT=$(find skills/kata-execute-phase/scripts -name "update-intel-summary.cjs" -type f 2>/dev/null | head -1)
      if [ -n "$SUMMARY_SCRIPT" ]; then
        node "$SUMMARY_SCRIPT" 2>/dev/null || true
      fi
    fi
  fi

  # --- Phase 57: Doc gardening warning (MAINT-02) ---
  if [ "$HAS_DOC_ENTRIES" = "true" ] && [ -d ".planning/codebase" ]; then
    DOC_STALE_THRESHOLD=$(node -e "console.log(Number(${STALE_PCT:-0}) > 0.3 ? 'true' : 'false')")
    if [ "$DOC_STALE_THRESHOLD" = "true" ]; then
      echo "Warning: .planning/codebase/ docs may be stale (${STALE_PCT}% drift). Consider running /kata-map-codebase to refresh."
    fi
  fi

  # --- Phase 57: Convention enforcement (MAINT-03) ---
  CONV_SCRIPT=""
  [ -f "scripts/check-conventions.cjs" ] && CONV_SCRIPT="scripts/check-conventions.cjs"

  if [ -n "$CONV_SCRIPT" ] && [ -f ".planning/intel/conventions.json" ]; then
    PHASE_START_COMMIT_CONV=$(git log --oneline --all --grep="activate phase" --grep="${PHASE_NUM}" --all-match --format="%H" | tail -1)
    if [ -n "$PHASE_START_COMMIT_CONV" ]; then
      CHANGED_CODE_FILES=$(git diff --name-only "$PHASE_START_COMMIT_CONV..HEAD" -- '*.js' '*.mjs' '*.cjs' '*.ts' '*.mts' '*.cts' '*.jsx' '*.tsx' '*.py' '*.go' '*.rs' '*.java' 2>/dev/null || true)
      if [ -n "$CHANGED_CODE_FILES" ]; then
        echo "Checking conventions on $(echo "$CHANGED_CODE_FILES" | wc -l | tr -d ' ') changed files..."
        CONV_OUTPUT=$(node "$CONV_SCRIPT" --files $CHANGED_CODE_FILES 2>/dev/null || echo '{}')
        VIOLATION_COUNT=$(node -e "try{const o=JSON.parse(process.argv[1]);console.log((o.violations||[]).length)}catch{console.log(0)}" "$CONV_OUTPUT")
        if [ "$VIOLATION_COUNT" -gt 0 ]; then
          echo "Convention check: $VIOLATION_COUNT naming violation(s) detected (warnings only)"
          echo "$CONV_OUTPUT"
        fi
      fi
    fi
  fi

fi
```

Non-blocking: all staleness detection, scan, doc gardening, and convention operations use `|| true`. Failures never block phase completion.
```

**Specific changes from the current step 7.25:**

1. Added staleness detection block at the top: runs detect-stale-intel.cjs, captures staleCount/oldestStaleCommit/hasDocBasedEntries/stalePct
2. Modified scan decision tree: staleness-triggered re-scan takes priority over phase-start incremental scan. If stale files found AND oldest stale commit known, scan from that commit. Otherwise fall back to existing phase-start incremental logic.
3. Wrapped summary update in `SCAN_RAN` guard so it only runs when a scan actually executed
4. Added doc gardening warning: when .planning/codebase/ exists AND stale percentage > 30%, log a warning recommending /kata-map-codebase
5. Added convention enforcement block at the bottom: gets files changed during the phase, runs check-conventions.cjs, logs violation count and details

**DO NOT modify any other steps in kata-execute-phase SKILL.md.** Only step 7.25 changes.

**Preserve the step numbering:** Step 7.25 still comes after step 7 (verification) and before step 7.5 (completion validation). The step header remains `7.25.`
  </action>
  <verify>
Read `skills/kata-execute-phase/SKILL.md` and verify:
1. Step 7.25 contains the staleness detection block (detect-stale-intel.cjs call)
2. Step 7.25 contains the modified scan decision tree with three branches: greenfield, staleness-triggered, phase-start incremental
3. Step 7.25 contains the doc gardening warning (checks .planning/codebase/ + stalePct > 0.3)
4. Step 7.25 contains the convention enforcement block (check-conventions.cjs call)
5. All operations use `|| true` for non-blocking
6. Script discovery uses the same pattern as before: check `scripts/` first, then `find` fallback for scan-codebase.cjs
7. No other steps in SKILL.md were modified
8. Step 7.5 still follows immediately after step 7.25
  </verify>
  <done>kata-execute-phase step 7.25 runs staleness detection, triggers re-scan for stale files, logs doc gardening warning at >30% drift, and enforces conventions on phase-changed files</done>
</task>

</tasks>

<verification>
1. Step 7.25 bash block is syntactically valid (no unclosed quotes, brackets, or if-fi mismatches)
2. Staleness detection uses node process.argv for JSON parsing (not grep, which is brittle for JSON)
3. Scan decision tree has three branches: greenfield (totalFiles==0), staleness-triggered (staleCount>0), phase-start incremental (fallback)
4. Summary update is conditional on SCAN_RAN (avoids unnecessary regeneration)
5. Doc gardening threshold is 0.3 (30%), matching research recommendation
6. Convention check filters to code extensions via git diff `--` pathspec (no .md/.json/.sh)
7. All new blocks use `|| true` pattern
8. No cross-skill script references: detect-stale-intel.cjs uses `scripts/` local path, check-conventions.cjs uses `scripts/` local path
</verification>

<success_criteria>
- [ ] Step 7.25 runs detect-stale-intel.cjs and captures stale file count
- [ ] Staleness-triggered re-scan uses scan-codebase.cjs --incremental --since oldestStaleCommit
- [ ] Doc gardening logs warning when .planning/codebase/ stale percentage > 30%
- [ ] Summary.md is regenerated after any scan (staleness-triggered or greenfield or incremental)
- [ ] Convention check runs check-conventions.cjs on code files changed during phase
- [ ] Convention violations logged as warnings (non-blocking, no exit code change)
- [ ] All operations use || true
- [ ] Existing greenfield and incremental scan logic preserved
- [ ] No other steps in SKILL.md modified
</success_criteria>

<output>
After completion, create `.planning/phases/pending/57-knowledge-maintenance/57-02-SUMMARY.md`
</output>
