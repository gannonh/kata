---
phase: 59-brownfield-intel-gap-closure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/scripts/update-intel-summary.cjs
  - skills/kata-map-codebase/scripts/generate-intel.js
  - skills/kata-execute-phase/SKILL.md
  - KATA-STYLE.md
autonomous: true
must_haves:
  truths:
    - update-intel-summary.cjs no longer early-returns when .planning/codebase/ exists
    - update-intel-summary.cjs shows source label "code-scan (brownfield enrichment)" when codebase dir present
    - generate-intel.js emits v2 schema (version 2, camelCase stats fields totalFiles/byType/byLayer)
    - v1 fallback expressions removed from kata-execute-phase SKILL.md and update-intel-summary.cjs
    - KATA-STYLE.md Index Schema section shows v2 camelCase fields
  artifacts:
    - skills/kata-execute-phase/scripts/update-intel-summary.cjs (guard removed, source label conditional)
    - skills/kata-map-codebase/scripts/generate-intel.js (v2 schema in buildIndex)
    - skills/kata-execute-phase/SKILL.md (v1 fallback removed)
    - KATA-STYLE.md (Index Schema updated to v2)
  key_links:
    - update-intel-summary.cjs enriches brownfield projects after scan
    - generate-intel.js buildIndex returns version 2 with camelCase stats
---

<objective>
Fix GAP-2 (update-intel-summary.cjs brownfield guard) and resolve Issue 2 (generate-intel.js v2 schema migration).

Purpose: GAP-2: `update-intel-summary.cjs` has a guard that early-returns when `.planning/codebase/` exists, blocking scan-data enrichment for brownfield projects. Issue 2: `generate-intel.js` emits v1 schema with snake_case stats fields (`total_files`, `by_type`, `by_layer`); migrate to v2 camelCase (`totalFiles`, `byType`, `byLayer`) and clean up v1 fallback code in consumers.

Output: Patched `update-intel-summary.cjs`, `generate-intel.js`, `SKILL.md`, and `KATA-STYLE.md`.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Remove brownfield guard from update-intel-summary.cjs and add conditional source label</name>
  <files>skills/kata-execute-phase/scripts/update-intel-summary.cjs</files>
  <action>
Two changes to `update-intel-summary.cjs`:

**Change 1:** Remove lines 52-54 (the early-return guard that blocks brownfield enrichment):
```javascript
  // Guard: if .planning/codebase/ exists, generate-intel.js handles summary.md
  // Do not overwrite its richer output
  if (dirExists(codebaseDir)) return;
```
Delete these 3 lines entirely.

**Change 2:** At line 86 (the `Generated:` header line), replace the hardcoded greenfield source label with a conditional:

Replace:
```javascript
  lines.push(`Generated: ${new Date().toISOString().slice(0, 10)} | Source: code-scan (greenfield)`);
```

With:
```javascript
  const source = dirExists(codebaseDir) ? 'code-scan (brownfield enrichment)' : 'code-scan (greenfield)';
  lines.push(`Generated: ${new Date().toISOString().slice(0, 10)} | Source: ${source}`);
```

**Change 3:** Remove the v1 fallback on line 66. Replace:
```javascript
  const totalFiles = index.stats?.totalFiles ?? index.stats?.total_files ?? 0;
```

With:
```javascript
  const totalFiles = index.stats?.totalFiles ?? 0;
```

After these changes, `update-intel-summary.cjs` will:
- Run for both greenfield and brownfield projects
- Show the correct source label in the generated summary.md header
- Read only v2 camelCase stats fields
  </action>
  <verify>Read `update-intel-summary.cjs` and confirm: (1) no `if (dirExists(codebaseDir)) return;` guard exists, (2) the source label uses a conditional based on codebaseDir, (3) the totalFiles line has no `total_files` fallback.</verify>
  <done>update-intel-summary.cjs allows brownfield enrichment, shows correct source label, reads v2 stats only.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate generate-intel.js to v2 schema and clean up v1 fallbacks</name>
  <files>skills/kata-map-codebase/scripts/generate-intel.js, skills/kata-execute-phase/SKILL.md, KATA-STYLE.md</files>
  <action>
Three files need changes:

**File 1: `skills/kata-map-codebase/scripts/generate-intel.js`**

In the `buildIndex()` function (around lines 253-264), change the return object:

Replace:
```javascript
  return {
    version: 1,
    generated: generatedIso,
    source: SOURCE_LABEL,
    commitHash: getCurrentCommitHash(projectRoot),
    files,
    stats: {
      total_files: Object.keys(files).length,
      by_type: byType,
      by_layer: byLayer,
    },
  };
```

With:
```javascript
  return {
    version: 2,
    generated: generatedIso,
    source: SOURCE_LABEL,
    commitHash: getCurrentCommitHash(projectRoot),
    files,
    stats: {
      totalFiles: Object.keys(files).length,
      byType,
      byLayer,
    },
  };
```

**File 2: `skills/kata-execute-phase/SKILL.md`**

At line ~497, the inline Node.js expression reads index.json stats with a v1 fallback. Replace:
```javascript
j.stats?.totalFiles ?? j.stats?.total_files ?? 0
```

With:
```javascript
j.stats?.totalFiles ?? 0
```

The full line should read:
```bash
  TOTAL_FILES=$(node -e "try{const j=JSON.parse(require('fs').readFileSync('.planning/intel/index.json','utf8')); console.log(j.stats?.totalFiles ?? 0)}catch{console.log(0)}" 2>/dev/null || echo "0")
```

**File 3: `KATA-STYLE.md`**

In the Index Schema section (around line 569), update the stats field from v1 snake_case to v2 camelCase:

Replace:
```json
  "stats": { "total_files": 42, "by_type": {}, "by_layer": {} }
```

With:
```json
  "stats": { "totalFiles": 42, "byType": {}, "byLayer": {} }
```
  </action>
  <verify>
1. Read `generate-intel.js` buildIndex return and confirm `version: 2` with camelCase stats fields
2. Read `SKILL.md` line ~497 and confirm no `total_files` fallback
3. Read `KATA-STYLE.md` Index Schema and confirm camelCase stats fields
  </verify>
  <done>generate-intel.js emits v2 schema. All v1 fallback expressions removed from consumers. KATA-STYLE.md documents v2 format.</done>
</task>
</tasks>

<verification>
1. `update-intel-summary.cjs` runs without early return when `.planning/codebase/` exists
2. `generate-intel.js` buildIndex returns `version: 2` with `totalFiles`, `byType`, `byLayer`
3. No remaining `total_files`, `by_type`, or `by_layer` references in SKILL.md or update-intel-summary.cjs
4. KATA-STYLE.md Index Schema section shows v2 camelCase fields
5. `npm run test:scripts` passes (no regressions)
</verification>

<success_criteria>
- update-intel-summary.cjs enriches summary.md for both greenfield and brownfield projects
- Source label reads "code-scan (brownfield enrichment)" when .planning/codebase/ exists
- generate-intel.js emits version 2 with camelCase stats fields
- All v1 fallback expressions removed from consumers
- KATA-STYLE.md documents the v2 schema
- npm run test:scripts passes
</success_criteria>

<output>
After completion, create `.planning/phases/pending/59-brownfield-intel-gap-closure/59-02-SUMMARY.md`
</output>
