---
phase: 03-issue-roadmap-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/kata-planner.md
  - skills/execute-phase/SKILL.md
autonomous: true

must_haves:
  truths:
    - "PLAN.md can reference its source issue number"
    - "Phase execution PRs include Closes #X when plan has source_issue"
    - "source_issue format documented in planner agent"
  artifacts:
    - path: "agents/kata-planner.md"
      provides: "source_issue field documentation"
      contains: "source_issue"
    - path: "skills/execute-phase/SKILL.md"
      provides: "source_issue reading for PR body"
      contains: "source_issue"
  key_links:
    - from: "agents/kata-planner.md"
      to: "PLAN.md frontmatter"
      via: "source_issue field spec"
      pattern: "source_issue.*github:#"
    - from: "skills/execute-phase/SKILL.md"
      to: "gh pr create"
      via: "Closes #X in PR body"
      pattern: "source_issue"
---

<objective>
Add source_issue field to PLAN.md frontmatter specification and update execute-phase to read it for PR body.

Purpose: Enable traceability from plans to their source issues, with automatic GitHub Issue closure when PRs merge.
Output: Updated planner agent with source_issue field, execute-phase reading source_issue for PR creation.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-issue-roadmap-integration/03-RESEARCH.md

@agents/kata-planner.md
@skills/execute-phase/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source_issue to PLAN.md specification</name>
  <files>agents/kata-planner.md</files>
  <action>
Update the PLAN.md specification in the `<plan_format>` section.

1. Add `source_issue` to the frontmatter example:
```yaml
---
phase: XX-name
plan: NN
type: execute
wave: N
depends_on: []
files_modified: []
autonomous: true
user_setup: []              # Optional
source_issue: ""            # Optional: github:#N or local file path

must_haves:
  truths: []
  artifacts: []
  key_links: []
---
```

2. Add to the Frontmatter Fields table:
| Field          | Required | Purpose                                              |
| -------------- | -------- | ---------------------------------------------------- |
| `source_issue` | No       | Source issue reference (github:#N or local path)     |

3. Add a new subsection after "User Setup Frontmatter" documenting source_issue:

## Source Issue Frontmatter

When a plan originates from an issue (via "Link to existing phase" or quick task from issue):

```yaml
source_issue: github:#76  # GitHub Issue reference
```

Or for local-only issues:

```yaml
source_issue: .planning/issues/open/2026-01-18-fix-auth-bug.md
```

The `source_issue` field enables:
- PRs include `Closes #N` automatically (GitHub issues only)
- Audit trail from plan to originating issue
- Issue status tracking when plans complete

**Format:** `github:#N` for GitHub Issues, local file path for local-only issues.
**When to use:** Set automatically when plan is created from an issue via check-issues flow.
  </action>
  <verify>
Read agents/kata-planner.md and confirm:
- source_issue in frontmatter example
- source_issue in Frontmatter Fields table
- "Source Issue Frontmatter" section documenting format
  </verify>
  <done>kata-planner documents source_issue field in PLAN.md specification</done>
</task>

<task type="auto">
  <name>Task 2: Read source_issue in execute-phase for PR body</name>
  <files>skills/execute-phase/SKILL.md</files>
  <action>
Update the draft PR creation logic (step 4, after first wave completion) to include `Closes #X` for plans with source_issue.

Find the section that builds PR body (around line 241 where CLOSES_LINE is set). Currently it only checks for phase issues. Extend to also check for source_issue from plans.

1. Before PR body creation, collect source_issue references from all plans:
```bash
# Collect source_issue references from all plans in this phase
SOURCE_ISSUES=""
for plan in ${PHASE_DIR}/*-PLAN.md; do
  source_issue=$(grep -m1 "^source_issue:" "$plan" | cut -d':' -f2- | xargs)
  if echo "$source_issue" | grep -q "^github:#"; then
    issue_num=$(echo "$source_issue" | grep -oE '#[0-9]+')
    [ -n "$issue_num" ] && SOURCE_ISSUES="${SOURCE_ISSUES} Closes ${issue_num}"
  fi
done
SOURCE_ISSUES=$(echo "$SOURCE_ISSUES" | xargs)  # Trim whitespace
```

2. Update the PR body template to include source issues:
```bash
cat > /tmp/pr-body.md << PR_EOF
## Phase Goal

${PHASE_GOAL}

## Plans

${PLANS_CHECKLIST}
${CLOSES_LINE}
${SOURCE_ISSUES:+
## Source Issues

${SOURCE_ISSUES}}
PR_EOF
```

This ensures:
- Phase issue gets closed (existing CLOSES_LINE logic)
- Any plans with source_issue also close their issues
- Multiple source issues are handled (one Closes #X per line)

3. Also update the merge path (step 10.6 "Merge PR") to explicitly close source issues if GitHub's auto-close didn't trigger:
```bash
# Close source issues (backup in case Closes #X didn't trigger)
for plan in ${PHASE_DIR}/*-PLAN.md; do
  source_issue=$(grep -m1 "^source_issue:" "$plan" | cut -d':' -f2- | xargs)
  if echo "$source_issue" | grep -q "^github:#"; then
    issue_num=$(echo "$source_issue" | grep -oE '[0-9]+')
    gh issue close "$issue_num" --comment "Closed by PR #${PR_NUMBER} merge (source issue for plan)" 2>/dev/null || true
  fi
done
```
  </action>
  <verify>
Read skills/execute-phase/SKILL.md and confirm:
- source_issue extraction from plan frontmatter
- SOURCE_ISSUES variable built from plans
- PR body includes "Source Issues" section when applicable
- Merge path closes source issues
  </verify>
  <done>execute-phase reads source_issue from plans and includes Closes #X in PR body</done>
</task>

</tasks>

<verification>
1. Read agents/kata-planner.md — confirm source_issue documented
2. Read skills/execute-phase/SKILL.md — confirm source_issue reading logic
3. Pattern check: grep for "source_issue" in both files
4. Pattern check: grep for "SOURCE_ISSUES" in execute-phase
</verification>

<success_criteria>
- [ ] kata-planner.md documents source_issue field format and usage
- [ ] execute-phase reads source_issue from all plans
- [ ] PR body includes Closes #X for plans with source_issue
- [ ] Merge path has backup source issue closure
- [ ] Both files remain functional with existing features
</success_criteria>

<output>
After completion, create `.planning/phases/03-issue-roadmap-integration/03-02-SUMMARY.md`
</output>
