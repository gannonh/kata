---
phase: 48-test-coverage-of-new-functionality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/scripts/read-config.test.js
  - tests/scripts/find-phase.test.js
autonomous: true
must_haves:
  truths:
    - "read-config.sh tests cover: key lookup, nested key, fallback, missing config file, object output"
    - "find-phase.sh tests cover: found in active/pending/completed, not found (exit 1), no plans (exit 2), collision (exit 3), key=value output parsing"
    - "All tests pass with npm run test:scripts after wiring (done in plan 3)"
  artifacts:
    - path: "tests/scripts/read-config.test.js"
      provides: "Script tests for read-config.sh"
    - path: "tests/scripts/find-phase.test.js"
      provides: "Script tests for find-phase.sh"
  key_links:
    - from: "tests/scripts/read-config.test.js"
      to: "dist/plugin/skills/kata-configure-settings/scripts/read-config.sh"
      via: "execSync invocation of built artifact"
    - from: "tests/scripts/find-phase.test.js"
      to: "dist/plugin/skills/kata-execute-phase/scripts/find-phase.sh"
      via: "execSync invocation of built artifact"
---

<objective>
Write fast script tests for `read-config.sh` and `find-phase.sh`. Both are pure functions (no git, no network). Tests create temp directories with fixture data, invoke scripts via `execSync`, and assert on stdout and exit codes.

Purpose: Cover the 2 simplest untested scripts with thorough edge-case tests.
Output: Two test files following the existing `template-system.test.js` pattern.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing test pattern to follow
@tests/scripts/template-system.test.js

# Scripts under test (source — tests run against dist/plugin/ built copies)
@skills/kata-configure-settings/scripts/read-config.sh
@skills/kata-execute-phase/scripts/find-phase.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tests for read-config.sh</name>
  <files>tests/scripts/read-config.test.js</files>
  <action>
Create `tests/scripts/read-config.test.js` using node:test + node:assert + execSync pattern from template-system.test.js.

Setup: beforeEach creates tmpDir with `.planning/config.json` and copies built skills from `dist/plugin/skills`.

Test cases:
1. Reads a top-level key (`"pr_workflow"` → `"true"`)
2. Reads a nested key (`"worktree.enabled"` → `"true"`)
3. Returns fallback when key is missing (`"nonexistent" "mydefault"` → `"mydefault"`)
4. Returns empty string when key missing and no fallback
5. Returns JSON string for object values (`"worktree"` → `{"enabled":"true"}`)
6. Returns empty string when config.json does not exist (script handles missing file gracefully)
7. Exits non-zero when no arguments provided (usage error)

Config fixture:
```json
{
  "pr_workflow": "true",
  "worktree": { "enabled": "true" },
  "depth": "standard"
}
```

Script path: `${tmpDir}/skills/kata-configure-settings/scripts/read-config.sh`
Run with cwd=tmpDir (script reads `.planning/config.json` relative to cwd).
  </action>
  <verify>node --test tests/scripts/read-config.test.js</verify>
  <done>All 7 test cases pass. Tests run in under 5 seconds.</done>
</task>

<task type="auto">
  <name>Task 2: Tests for find-phase.sh</name>
  <files>tests/scripts/find-phase.test.js</files>
  <action>
Create `tests/scripts/find-phase.test.js` using the same pattern.

Setup: beforeEach creates tmpDir with `.planning/phases/` structure and copies built skills.

Test cases:
1. Finds phase in `pending/` state — creates `.planning/phases/pending/05-auth/48-01-PLAN.md`, runs `find-phase.sh 5`, asserts `PHASE_DIR=`, `PHASE_STATE=pending`, `PLAN_COUNT=1`
2. Finds phase in `active/` state — same but `active/`
3. Finds phase in `completed/` state — same but `completed/`
4. Exit 1 when phase not found — `find-phase.sh 99`, assert exit code 1, stderr contains "No phase directory"
5. Exit 2 when phase found but no plans — create `pending/05-auth/` (empty dir), assert exit code 2
6. Exit 3 on collision — create `active/05-auth/` AND `pending/05-login/` both starting with `05-`, assert exit code 3, output contains "COLLISION"
7. Handles zero-padded lookup — `find-phase.sh 5` finds `05-auth`
8. Flat directory fallback — create `.planning/phases/05-auth/` (no state subdir), assert `PHASE_STATE=flat`

Parse key=value output by splitting on `=` to validate each field.
Script path: `${tmpDir}/skills/kata-execute-phase/scripts/find-phase.sh`
Run with cwd=tmpDir.

Note: The collision test creates directories under different state dirs with the same `05-` prefix. The flat directory test puts the phase dir directly under `.planning/phases/` without active/pending/completed.
  </action>
  <verify>node --test tests/scripts/find-phase.test.js</verify>
  <done>All 8 test cases pass. Tests run in under 5 seconds.</done>
</task>

</tasks>

<verification>
```bash
node --test tests/scripts/read-config.test.js tests/scripts/find-phase.test.js
```
Both files run, all tests pass, total time under 5 seconds.
</verification>

<success_criteria>
- read-config.test.js covers key lookup, nesting, fallback, missing file, object output, usage error
- find-phase.test.js covers all 4 exit codes (0, 1, 2, 3), all 3 states + flat, zero-padding
- Tests follow existing template-system.test.js conventions
- No external dependencies (no git, no network, no Claude invocation)
</success_criteria>

<output>
After completion, create `.planning/phases/48-test-coverage-of-new-functionality/48-01-SUMMARY.md`
</output>
