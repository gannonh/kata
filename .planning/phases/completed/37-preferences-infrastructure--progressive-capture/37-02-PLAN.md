---
phase: 37-preferences-infrastructure--progressive-capture
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - skills/kata-new-project/SKILL.md
  - skills/kata-plan-phase/SKILL.md
  - skills/kata-configure-settings/SKILL.md
  - skills/kata-execute-phase/references/planning-config.md
  - README.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "kata-new-project asks exactly 5 questions (mode, depth, commit_docs, pr_workflow, github) and scaffolds empty preferences.json"
    - "First kata-plan-phase invocation triggers model_profile check-or-ask with set-config.sh write"
    - "First kata-plan-phase displays agent defaults notice box on first run"
    - "parallelization key removed from onboarding, config schema, settings skill, planning-config reference, and README"
  artifacts:
    - "Modified skills/kata-new-project/SKILL.md with 5-question onboarding + preferences.json scaffold"
    - "Modified skills/kata-plan-phase/SKILL.md with step 3.5 check-or-ask"
    - "Modified skills/kata-configure-settings/SKILL.md without parallelization"
    - "Modified skills/kata-execute-phase/references/planning-config.md without parallelization"
    - "Modified README.md without parallelization"
  key_links:
    - "kata-new-project omits model_profile and workflow toggles from config.json — their absence triggers check-or-ask in kata-plan-phase"
    - "set-config.sh referenced via KATA_SCRIPTS path from kata-plan-phase step 3.5"
    - "preferences.json scaffolded as empty {} by kata-new-project"
---

<objective>
Wire preferences infrastructure into skills: reduce onboarding, add progressive capture, remove dead parallelization key.

Purpose: Connect the accessor scripts (Plan 01) to the skill workflows. Onboarding drops from 11 questions to 5. Deferred settings captured at first use via check-or-ask pattern.
Output: Five modified skill/reference files implementing progressive capture.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/37-preferences-infrastructure--progressive-capture/37-RESEARCH.md
@.planning/phases/pending/37-preferences-infrastructure--progressive-capture/37-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce kata-new-project onboarding and scaffold preferences.json</name>
  <files>skills/kata-new-project/SKILL.md</files>
  <action>
Modify `skills/kata-new-project/SKILL.md` Phase 5 (Workflow Preferences):

**Round 1 changes — reduce from 6 to 5 questions:**
1. KEEP: Mode (yolo/interactive)
2. KEEP: Depth (quick/standard/comprehensive)
3. REMOVE: Execution/Parallelization question entirely
4. KEEP: Git Tracking (commit_docs)
5. KEEP: PR Workflow
6. KEEP: GitHub Tracking + conditional follow-up (issueMode, repo creation)

**Round 2 changes — remove entirely:**
Remove the entire Round 2 block (Researcher, Plan Checker, Verifier, Model Profile, Statusline questions). These are deferred to progressive capture:
- `model_profile` captured at first `/kata-plan-phase` (step 3.5)
- `workflow.research`, `workflow.plan_check`, `workflow.verifier` silent-default to `true`
- `display.statusline` silent-defaults to `true`

**Config.json template change:**
Remove `"parallelization"` key from the JSON template. Remove `"model_profile"` key. Add silent defaults for workflow and display blocks. The output config.json should be:
```json
{
  "mode": "yolo|interactive",
  "depth": "quick|standard|comprehensive",
  "commit_docs": true|false,
  "pr_workflow": true|false,
  "display": {
    "statusline": true
  },
  "workflow": {
    "research": true,
    "plan_check": true,
    "verifier": true
  },
  "github": {
    "enabled": true|false,
    "issueMode": "auto|ask|never"
  }
}
```

Note: `model_profile` is ABSENT — its absence triggers check-or-ask in kata-plan-phase. Workflow and display values are hardcoded `true` (not user-selected).

**Add preferences.json scaffold:**
After writing config.json, add:
```bash
echo '{}' > .planning/preferences.json
```

Update the git add/commit to include preferences.json:
```bash
git add .planning/config.json .planning/preferences.json
```

**Update commit message:** Remove `Parallelization: [enabled/disabled]` line. Add `Preferences: scaffolded (empty)` line.

**Update Phase 5.5 (Resolve Model Profile):**
This step stays. It reads model_profile with the existing grep pattern (defaults to "balanced" when absent from new config.json).

**Update success_criteria:** Replace `parallelization` with `preferences.json scaffolded`. Update commit message format to remove parallelization.

**Self-validation (Phase 6):** Add preferences.json to the validation check:
```bash
[ ! -f .planning/preferences.json ] && MISSING="${MISSING}\n- .planning/preferences.json"
```

**Update completion banner:** Add preferences.json to the artifacts table.

**Statusline handling:** Keep the existing conditional statusline setup code, but move it to execute unconditionally (since display.statusline defaults to true). Or simplify: since we always set `display.statusline: true`, always run the statusline setup.
  </action>
  <verify>
Read the modified SKILL.md. Verify:
1. Round 1 has exactly 5 questions (Mode, Depth, Git Tracking, PR Workflow, GitHub Tracking)
2. No Round 2 section exists
3. No mention of `parallelization` in the file
4. Config.json template has no `parallelization` or `model_profile` keys
5. `preferences.json` is scaffolded and committed
6. Self-validation checks for preferences.json
  </verify>
  <done>kata-new-project asks exactly 5 questions. Config.json omits model_profile (triggers progressive capture). preferences.json scaffolded as `{}`. parallelization removed.</done>
</task>

<task type="auto">
  <name>Task 2: Add check-or-ask to kata-plan-phase and remove parallelization from 3 files</name>
  <files>skills/kata-plan-phase/SKILL.md, skills/kata-configure-settings/SKILL.md, skills/kata-execute-phase/references/planning-config.md, README.md</files>
  <action>
**kata-plan-phase/SKILL.md — Add step 3.5 between steps 3 and 4:**

Insert new step "3.5. Check-or-Ask Model Profile" after step 3 (Validate Phase) and before step 4 (Ensure Phase Directory):

```markdown
## 3.5. Check-or-Ask Model Profile

Check if model_profile has been set in config:

\`\`\`bash
KATA_SCRIPTS="${SKILL_BASE_DIR}/../kata-configure-settings/scripts"
MODEL_PROFILE_SET=$(cat .planning/config.json 2>/dev/null | grep -o '"model_profile"' | head -1)
\`\`\`

**If model_profile is absent (empty MODEL_PROFILE_SET):**

This is the first plan-phase run. Ask the user for model_profile.

Use AskUserQuestion:
- header: "Model Profile"
- question: "Which AI models for planning agents?"
- options:
  - "Balanced (Recommended)" — Sonnet for most agents — good quality/cost ratio
  - "Quality" — Opus for research/roadmap — higher cost, deeper analysis
  - "Budget" — Haiku where possible — fastest, lowest cost

After user responds, write to config:

\`\`\`bash
# Map selection to value
# Balanced -> balanced, Quality -> quality, Budget -> budget
bash "${KATA_SCRIPTS}/set-config.sh" "model_profile" "$CHOSEN_PROFILE"
\`\`\`

Display first-run agent defaults notice:

\`\`\`
+--------------------------------------------------+
| Agent defaults active: Research, Plan Check,     |
| Verification. Run /kata-configure-settings to    |
| customize agent preferences.                     |
+--------------------------------------------------+
\`\`\`

**If model_profile exists:** No-op. Continue to step 4.
```

Also update step 1 to resolve KATA_SCRIPTS path and use it for the model profile grep, so the step 3.5 KATA_SCRIPTS variable is available.

**kata-configure-settings/SKILL.md:**
- Remove `parallelization` from step 2 (the "Parse current values" list)
- Remove `"parallelization": true|false` from the JSON template in step 4
- Remove mention of "parallelization" from step 4's "preserving existing keys" comment

**kata-execute-phase/references/planning-config.md:**
- Remove `"parallelization": true|false` from the config_schema JSON block
- Remove the `parallelization` row from the schema table
- Remove any grep pattern examples for parallelization

**README.md:**
- Remove the `parallelization` row from the Execution settings table (around line 429)
- Leave the `commit_docs` row intact
  </action>
  <verify>
1. `grep -n "3.5" skills/kata-plan-phase/SKILL.md` — step 3.5 exists
2. `grep -r "parallelization" skills/kata-configure-settings/SKILL.md skills/kata-execute-phase/references/planning-config.md README.md` — returns no results
3. `grep "set-config.sh" skills/kata-plan-phase/SKILL.md` — references the script
4. `grep "Agent defaults active" skills/kata-plan-phase/SKILL.md` — first-run notice exists
  </verify>
  <done>kata-plan-phase has step 3.5 with check-or-ask for model_profile using set-config.sh, plus first-run agent defaults notice. parallelization removed from kata-configure-settings, planning-config.md, and README.md.</done>
</task>

</tasks>

<verification>
1. `grep -c "parallelization" skills/kata-new-project/SKILL.md skills/kata-configure-settings/SKILL.md skills/kata-execute-phase/references/planning-config.md README.md` — all return 0
2. `grep "preferences.json" skills/kata-new-project/SKILL.md` — scaffold and commit present
3. `grep "3.5" skills/kata-plan-phase/SKILL.md` — check-or-ask step exists
4. `grep "set-config.sh" skills/kata-plan-phase/SKILL.md` — script reference present
5. `grep "Agent defaults active" skills/kata-plan-phase/SKILL.md` — notice present
6. Count questions in kata-new-project Round 1 — exactly 5
</verification>

<success_criteria>
- [ ] kata-new-project asks exactly 5 questions (mode, depth, commit_docs, pr_workflow, github)
- [ ] kata-new-project scaffolds empty preferences.json and includes in commit
- [ ] kata-new-project config.json omits model_profile (triggers progressive capture)
- [ ] kata-plan-phase step 3.5 check-or-ask for model_profile using set-config.sh
- [ ] kata-plan-phase displays agent defaults notice on first run
- [ ] parallelization removed from all 5 files (new-project, configure-settings, planning-config, README, plan-phase)
- [ ] Workflow toggles silent-default to true in config.json
</success_criteria>

<output>
After completion, create `.planning/phases/pending/37-preferences-infrastructure--progressive-capture/37-02-SUMMARY.md`
</output>
