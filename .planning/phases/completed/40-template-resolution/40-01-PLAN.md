---
phase: 40-template-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/scripts/resolve-template.sh
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "resolve-template.sh uses $(cd \"$(dirname \"$0\")/../..\" && pwd -P) to find the skills/ directory (two levels up from scripts/)"
    - "resolve-template.sh does not reference CLAUDE_PLUGIN_ROOT"
    - "resolve-template.sh does not use ../../.. (three levels up)"
    - "Missing template error message lists both search paths: project override and sibling skills"
    - "All five templates resolve from source repo: summary-template.md, plan-template.md, UAT-template.md, verification-report.md, changelog-entry.md"
    - "All five templates resolve from dist/plugin/ layout"
    - "All five templates resolve from dist/skills-sh/ layout"
    - "Project override in .planning/templates/ takes precedence over sibling skill template"
  artifacts:
    - skills/kata-execute-phase/scripts/resolve-template.sh
  key_links:
    - "Four caller skills (kata-execute-phase, kata-plan-phase, kata-verify-work, kata-complete-milestone) continue to resolve templates without modification"
---

<objective>
Rewrite resolve-template.sh to use relative sibling discovery instead of CLAUDE_PLUGIN_ROOT and absolute path traversal. The script navigates two levels up from its own location (scripts/ -> kata-execute-phase/ -> skills/) to find sibling skill directories, then globs for the requested template. Error messages list all search paths tried.

Purpose: Make template resolution work identically for plugin installations, skills-only installations (npx skills add), and manual copies. Satisfies TMPL-01 (sibling discovery), TMPL-02 (no absolute paths), TMPL-03 (clear error messages).
Output: One rewritten script.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/40-template-resolution/40-RESEARCH.md

@skills/kata-execute-phase/scripts/resolve-template.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite resolve-template.sh with sibling discovery and improved error messages</name>
  <files>skills/kata-execute-phase/scripts/resolve-template.sh</files>
  <action>
Rewrite `skills/kata-execute-phase/scripts/resolve-template.sh` to replace the CLAUDE_PLUGIN_ROOT-based fallback with sibling discovery.

**Changes (3 lines changed in the fallback section, lines 17-24):**

1. Remove the `PLUGIN_ROOT` line that references `CLAUDE_PLUGIN_ROOT` and `../../..`
2. Add `SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd -P)"` to resolve the script's physical directory (handles symlinks via `-P` flag)
3. Add `SKILLS_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd -P)"` to navigate two levels up: `scripts/` -> `kata-execute-phase/` -> `skills/`
4. Update the glob to use `${SKILLS_DIR}/kata-*/references/${TEMPLATE_NAME}` instead of `${PLUGIN_ROOT}/skills/kata-*/references/${TEMPLATE_NAME}`

**Error message improvement (line 31):**

Replace the single-line error with a multi-line message listing search paths:
```
ERROR: Template not found: {name}
  Searched:
    {cwd}/.planning/templates/{name} (project override)
    {skills_dir}/kata-*/references/{name} (sibling skills)
```

**Keep unchanged:**
- The shebang, `set -euo pipefail`, and `TEMPLATE_NAME` arg parsing (lines 1-8)
- The project override check (lines 10-15): `.planning/templates/` relative path is correct because Claude Code skills always execute from project root
- The `-f` check inside the glob loop (handles no-match case without needing nullglob)
- Exit codes: 0 on success, 1 on not found

**Do NOT:**
- Add CLAUDE_PLUGIN_ROOT as an optional fast path. One code path is simpler to test and maintain.
- Move the script to a different location. Four callers reference it at its current path.
- Change the script's interface (args, stdout path, exit codes). Callers depend on this contract.
  </action>
  <verify>
```bash
# Verify no CLAUDE_PLUGIN_ROOT reference
grep -c "CLAUDE_PLUGIN_ROOT" skills/kata-execute-phase/scripts/resolve-template.sh && echo "FAIL: still references CLAUDE_PLUGIN_ROOT" || echo "OK: no CLAUDE_PLUGIN_ROOT"

# Verify uses pwd -P for symlink safety
grep -c "pwd -P" skills/kata-execute-phase/scripts/resolve-template.sh | grep -q "[1-9]" && echo "OK: uses pwd -P" || echo "FAIL: missing pwd -P"

# Verify navigates two levels up (not three)
grep -c '\.\./\.\.\.' skills/kata-execute-phase/scripts/resolve-template.sh && echo "FAIL: still uses ../../.." || echo "OK: no ../../.."

# Test all 5 templates resolve from source repo
for t in summary-template.md plan-template.md UAT-template.md verification-report.md changelog-entry.md; do
  result=$(bash skills/kata-execute-phase/scripts/resolve-template.sh "$t" 2>&1) && echo "OK: $t -> $result" || echo "FAIL: $t"
done

# Test project override takes precedence
mkdir -p .planning/templates
echo "# Override" > .planning/templates/summary-template.md
result=$(bash skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md)
echo "$result" | grep -q ".planning/templates/summary-template.md" && echo "OK: project override wins" || echo "FAIL: project override not used"
rm .planning/templates/summary-template.md
rmdir .planning/templates 2>/dev/null || true

# Test missing template produces clear error with search paths
error_output=$(bash skills/kata-execute-phase/scripts/resolve-template.sh nonexistent-template.md 2>&1; true)
echo "$error_output" | grep -q "Searched:" && echo "OK: error lists search paths" || echo "FAIL: error missing search paths"
echo "$error_output" | grep -q "project override" && echo "OK: error mentions project override" || echo "FAIL: error missing project override path"
echo "$error_output" | grep -q "sibling skills" && echo "OK: error mentions sibling skills" || echo "FAIL: error missing sibling skills path"

# Test from dist/plugin/ layout
bash dist/plugin/skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md && echo "OK: plugin dist resolves" || echo "FAIL: plugin dist"

# Test from dist/skills-sh/ layout
bash dist/skills-sh/skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md && echo "OK: skills-sh dist resolves" || echo "FAIL: skills-sh dist"
```
  </verify>
  <done>resolve-template.sh uses sibling discovery via two-level dirname traversal with pwd -P, does not reference CLAUDE_PLUGIN_ROOT, and produces error messages listing both search paths. All 5 templates resolve from source, dist/plugin, and dist/skills-sh layouts. Project overrides take precedence.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify template resolution works end-to-end</name>
  <what-built>Rewrote resolve-template.sh to use relative sibling discovery instead of CLAUDE_PLUGIN_ROOT. The script now finds templates by navigating two levels up from its own location to the skills/ directory, then globbing across sibling skill directories. Error messages list all search paths tried.</what-built>
  <how-to-verify>
1. Run the resolution script for each of the 5 templates and confirm paths are correct:
   ```bash
   for t in summary-template.md plan-template.md UAT-template.md verification-report.md changelog-entry.md; do
     echo "=== $t ==="
     bash skills/kata-execute-phase/scripts/resolve-template.sh "$t"
   done
   ```
2. Confirm error output for a missing template shows search paths:
   ```bash
   bash skills/kata-execute-phase/scripts/resolve-template.sh does-not-exist.md
   ```
3. Build and verify dist copies work:
   ```bash
   npm run build:plugin
   bash dist/plugin/skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md
   bash dist/skills-sh/skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md
   ```
  </how-to-verify>
  <resume-signal>Say "verified" to continue or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- resolve-template.sh uses SCRIPT_DIR/SKILLS_DIR pattern with pwd -P (no CLAUDE_PLUGIN_ROOT)
- All 5 templates resolve from source, dist/plugin, and dist/skills-sh layouts
- Project override at .planning/templates/ takes precedence
- Missing template error names the template and lists both search paths
- No caller changes needed (4 skills continue to work)
</verification>

<success_criteria>
- TMPL-01: resolve-template.sh discovers templates via sibling skill directories (not absolute paths)
- TMPL-02: Template resolution works identically for plugin and skills-only installations
- TMPL-03: Missing templates produce clear error messages naming the template and search paths
</success_criteria>

<output>
After completion, create `.planning/phases/active/40-template-resolution/40-01-SUMMARY.md`
</output>
