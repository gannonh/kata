---
phase: 02-full-conversion
plan: 07
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03", "02-04", "02-05", "02-06"]
files_modified:
  - tests/migration-validation.test.js
  - skills/kata-execute-phase/SKILL.md
  - skills/kata-execute-phase/references/phase-execute.md
autonomous: true

must_haves:
  truths:
    - "Automated migration validation test passes in npm test"
    - "Test verifies all 19 agents have corresponding instruction files"
    - "Test verifies zero remaining subagent_type=\"kata:kata-*\" patterns in skills"
    - "kata-execute-phase runs project test suite between wave completion and verification"
  artifacts:
    - path: "tests/migration-validation.test.js"
      provides: "Automated validation of agent-to-skill migration completeness"
    - path: "skills/kata-execute-phase/SKILL.md"
      provides: "Updated orchestrator with test suite step before verification"
  key_links:
    - from: "tests/migration-validation.test.js"
      to: "agents/"
      via: "Reads agent files and checks for matching instruction files"
      pattern: "agents/"
    - from: "tests/migration-validation.test.js"
      to: "skills/"
      via: "Scans SKILL.md files for custom subagent_type patterns"
      pattern: "skills/"
---

<objective>
Create migration validation test (CONV-04) and add test suite step to kata-execute-phase (CONV-05).

Purpose: Two requirements that validate and protect the migration:
1. CONV-04: Automated test that verifies every agent has a corresponding instruction file, bodies match, and no custom subagent types remain
2. CONV-05: kata-execute-phase runs `npm test` (or detected test runner) after all execution waves complete, before spawning the verifier

Depends on all other plans since the validation test checks the complete migration.
Output: 1 test file + updated execute-phase skill
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/02-full-conversion/02-RESEARCH.md

Source files:
@tests/build.test.js (existing test pattern reference)
@skills/kata-execute-phase/SKILL.md
@skills/kata-execute-phase/references/phase-execute.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration validation test (CONV-04)</name>
  <files>tests/migration-validation.test.js</files>
  <action>
Create `tests/migration-validation.test.js` using Node.js built-in test runner (consistent with existing tests in `tests/build.test.js`).

The test should validate:

**Test 1: Each agent has a corresponding instruction file**

Define the complete agent-to-skill mapping (all 19 agents):

```javascript
const AGENT_MAPPINGS = {
  // POC agents
  'kata-planner': 'kata-plan-phase',
  'kata-executor': 'kata-execute-phase',
  // Phase 2 agents
  'kata-plan-checker': 'kata-plan-phase',
  'kata-phase-researcher': 'kata-plan-phase',
  'kata-project-researcher': 'kata-add-milestone',
  'kata-research-synthesizer': 'kata-add-milestone',
  'kata-roadmapper': 'kata-add-milestone',
  'kata-integration-checker': 'kata-audit-milestone',
  'kata-debugger': 'kata-debug',
  'kata-verifier': 'kata-verify-work',
  'kata-codebase-mapper': 'kata-track-progress',
  'kata-code-reviewer': 'kata-review-pull-requests',
  'kata-code-simplifier': 'kata-review-pull-requests',
  'kata-comment-analyzer': 'kata-review-pull-requests',
  'kata-pr-test-analyzer': 'kata-review-pull-requests',
  'kata-type-design-analyzer': 'kata-review-pull-requests',
  'kata-failure-finder': 'kata-review-pull-requests',
  'kata-silent-failure-hunter': 'kata-review-pull-requests',
  'kata-entity-generator': 'kata-review-pull-requests'
};
```

For each mapping:
- Verify instruction file exists at `skills/{skillName}/references/{agentNameWithoutKataPrefix}-instructions.md`
- Read agent file, extract body (after YAML frontmatter)
- Read instruction file
- Assert instruction file content matches agent body (trimmed)

**Test 2: No remaining custom subagent types in skills**

Recursively scan all `skills/*/SKILL.md` and `skills/*/references/*.md` files. Assert zero matches for the regex pattern `subagent_type="kata:kata-[^"]*"` AND `subagent_type="kata-[^"]*"` (both formats). Exclude the validation test file itself from the scan.

**Test 3: Skills with agents read instruction files**

For skills that spawn agents via Task(): verify SKILL.md contains references to `-instructions.md` files AND uses `subagent_type="general-purpose"` AND includes `agent-instructions` wrapper tags.

Skills to check: kata-plan-phase, kata-add-milestone, kata-audit-milestone, kata-debug, kata-execute-quick-task, kata-research-phase, kata-execute-phase.

Use the same test patterns as existing `tests/build.test.js` (imports from `node:test` and `node:assert`, path resolution via `process.cwd()`).
  </action>
  <verify>
1. `node --test tests/migration-validation.test.js` passes all tests
2. `npm test` includes and passes the migration validation tests
3. Test catches intentional regression (e.g., temporarily renaming an instruction file causes test failure)
  </verify>
  <done>
- migration-validation.test.js created with 3 test categories
- All tests pass when run via `npm test`
- Tests validate complete agent-to-skill migration
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test suite step to kata-execute-phase (CONV-05)</name>
  <files>skills/kata-execute-phase/SKILL.md, skills/kata-execute-phase/references/phase-execute.md</files>
  <action>
**Step A: Update kata-execute-phase SKILL.md**

Between step 6 ("Aggregate results") and step 7 ("Verify phase goal"), insert a new step 6.5:

```markdown
6.5. **Run project test suite**

   Before verification, run the project's test suite to catch regressions early:

   ```bash
   # Detect test runner from package.json
   TEST_SCRIPT=$(cat package.json 2>/dev/null | grep -o '"test"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1)
   ```

   **If package.json has a test script:**
   - Run `npm test`
   - If tests pass: proceed to step 7
   - If tests fail: report test failures, still proceed to step 7 (verifier will catch failures as goal mismatches)

   **If no test script detected:**
   - Skip this step, proceed to step 7

   **Skip for gap phases:** If mode is `gap_closure`, skip test suite (gaps may not have test coverage yet)
```

**Step B: Update phase-execute.md reference file**

Add corresponding documentation for the test suite step in the reference file. Insert between the wave execution completion and verification spawn sections. Keep it brief and consistent with the reference file's existing style.

Do NOT renumber existing steps (use 6.5 to avoid cascading changes).
  </action>
  <verify>
1. `grep 'test suite' skills/kata-execute-phase/SKILL.md` returns at least 1 match
2. `grep 'npm test' skills/kata-execute-phase/SKILL.md` returns at least 1 match
3. `grep 'gap_closure' skills/kata-execute-phase/SKILL.md` returns at least 1 match (skip condition)
4. `grep 'test suite' skills/kata-execute-phase/references/phase-execute.md` returns at least 1 match
5. `npm run build:plugin` succeeds
  </verify>
  <done>
- Step 6.5 added to kata-execute-phase between wave completion and verification
- Test runner detection from package.json
- Skip for gap phases
- Reference file updated consistently
- Build passes
  </done>
</task>

</tasks>

<verification>
- `npm test` passes (includes new migration validation tests)
- `grep 'test suite' skills/kata-execute-phase/SKILL.md` confirms step exists
- `grep -rn 'subagent_type="kata-' skills/` returns empty (final confirmation)
- `npm run build:plugin` succeeds
</verification>

<success_criteria>
1. `tests/migration-validation.test.js` exists and passes in `npm test`
2. Migration test validates all 19 agent-to-instruction-file mappings
3. Migration test asserts zero custom subagent types across all skills
4. kata-execute-phase has test suite step (6.5) before verification
5. Plugin build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/pending/02-full-conversion/02-07-SUMMARY.md`
</output>
