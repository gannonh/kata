---
phase: 01-pr-issue-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/complete-milestone/SKILL.md
  - skills/complete-milestone/references/milestone-complete.md
autonomous: true

must_haves:
  truths:
    - "Phase execution PRs include Closes #X for the phase GitHub Issue"
    - "Milestone completion PRs include Closes #X for all completed phase issues"
    - "Issue execution PR pattern documented for Phase 2"
  artifacts:
    - path: "skills/execute-phase/SKILL.md"
      provides: "CLOSES_LINE construction and PR body inclusion"
      contains: "Closes #${PHASE_ISSUE}"
    - path: "skills/complete-milestone/SKILL.md"
      provides: "Multi-issue Closes #X in milestone PR body"
      contains: "Closes #"
    - path: "skills/complete-milestone/references/milestone-complete.md"
      provides: "Multi-issue closure implementation"
      contains: "CLOSES_LINES"
  key_links:
    - from: "skills/execute-phase/SKILL.md"
      to: "gh pr create --body-file"
      via: "CLOSES_LINE variable in PR body template"
      pattern: "CLOSES_LINE.*Closes #"
    - from: "skills/complete-milestone/references/milestone-complete.md"
      to: "gh pr create"
      via: "CLOSES_LINES variable in PR body"
      pattern: "CLOSES_LINES"
---

<objective>
Ensure all PR-creating workflows properly close their associated GitHub Issues via `Closes #X` in PR body.

Purpose: Complete the PR-to-Issue lifecycle so merging PRs automatically closes the related GitHub Issues.
Output: execute-phase verified, complete-milestone enhanced, issue execution pattern documented.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pr-issue-closure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify CLOSE-01 (execute-phase PR closure)</name>
  <files>skills/execute-phase/SKILL.md</files>
  <action>
    Verify the existing implementation for phase execution PRs:

    1. Read skills/execute-phase/SKILL.md
    2. Confirm CLOSES_LINE is built at lines 225-231:
       - Checks GITHUB_ENABLED and ISSUE_MODE
       - Queries phase issue via `gh issue list --label phase --milestone`
       - Sets CLOSES_LINE="Closes #${PHASE_ISSUE}" when found
    3. Confirm CLOSES_LINE is included in PR body template (around line 249)
    4. Confirm backup explicit closure at step 10.6 (lines 417-420) handles edge cases

    Create a verification note documenting:
    - Location of CLOSES_LINE construction
    - Location of PR body inclusion
    - Location of backup closure logic
    - Assessment: "Implementation complete - no changes needed"

    NO CODE CHANGES needed for this task - verification only.
  </action>
  <verify>grep -n "CLOSES_LINE" skills/execute-phase/SKILL.md shows construction (lines ~225-229) and usage (line ~249)</verify>
  <done>Verification note confirms execute-phase already implements CLOSE-01 correctly</done>
</task>

<task type="auto">
  <name>Task 2: Implement CLOSE-02 (complete-milestone multi-issue closure)</name>
  <files>skills/complete-milestone/SKILL.md, skills/complete-milestone/references/milestone-complete.md</files>
  <action>
    Add multi-issue `Closes #X` support to milestone completion PRs:

    **In skills/complete-milestone/references/milestone-complete.md:**

    Find the `git_commit_milestone` step (around line 902) where the PR is created.
    Before the `gh pr create` command, add issue collection logic:

    ```bash
    # Collect all phase issues for this milestone
    GITHUB_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"enabled"[[:space:]]*:[[:space:]]*[^,}]*' | head -1 | grep -o 'true\|false' || echo "false")
    ISSUE_MODE=$(cat .planning/config.json 2>/dev/null | grep -o '"issueMode"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "never")

    CLOSES_LINES=""
    if [ "$GITHUB_ENABLED" = "true" ] && [ "$ISSUE_MODE" != "never" ]; then
      # Get all phase issue numbers for this milestone
      PHASE_ISSUES=$(gh issue list --label phase --milestone "v${VERSION}" \
        --state all --json number --jq '.[].number' 2>/dev/null)

      # Build multi-line closes section
      for num in $PHASE_ISSUES; do
        CLOSES_LINES="${CLOSES_LINES}Closes #${num}
    "
      done
    fi
    ```

    **Update PR body template** to include CLOSES_LINES:

    Find the `gh pr create` heredoc and add a "## Closes" section at the end:

    ```markdown
    ## Closes

    ${CLOSES_LINES}
    ```

    Only add the section if CLOSES_LINES is non-empty.

    **In skills/complete-milestone/SKILL.md:**

    Update step 7 documentation to mention the issue closure feature:
    - Add comment noting that PR body will include `Closes #X` for all phase issues
    - Reference the milestone-complete.md implementation

    **Why --state all:** Phase issues may already be closed by their individual phase PRs. Include them anyway - GitHub ignores `Closes #X` for already-closed issues.
  </action>
  <verify>grep -n "CLOSES_LINES" skills/complete-milestone/references/milestone-complete.md shows variable construction and PR body inclusion</verify>
  <done>Milestone completion PRs include `Closes #X` for all phase issues in the milestone</done>
</task>

<task type="auto">
  <name>Task 3: Document CLOSE-03 pattern for Phase 2</name>
  <files>skills/complete-milestone/references/milestone-complete.md</files>
  <action>
    Add a reference section documenting the pattern for issue execution PRs (Phase 2 scope).

    At the end of milestone-complete.md (before closing tags), add:

    ```markdown
    <reference name="issue_execution_pr_pattern">

    **Pattern for Issue Execution PRs (Phase 2 implementation)**

    When the issue execution workflow creates a PR for completing a backlog issue:

    1. Query the source issue number from the issue being worked on
    2. Build CLOSES_LINE: `Closes #${ISSUE_NUMBER}`
    3. Include in PR body

    ```bash
    # Pattern for issue execution PRs
    ISSUE_NUMBER="${SOURCE_ISSUE_NUMBER}"  # From issue being executed
    CLOSES_LINE=""
    if [ -n "$ISSUE_NUMBER" ]; then
      CLOSES_LINE="Closes #${ISSUE_NUMBER}"
    fi
    ```

    **PR body template:**
    ```markdown
    ## Summary

    Completes issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

    ## Changes

    [Implementation details]

    ${CLOSES_LINE}
    ```

    **Notes:**
    - Source issue is a backlog issue (label: issue), not a phase issue (label: phase)
    - Single issue closure (unlike milestone completion which closes multiple)
    - Issue execution creates its own branch and PR

    </reference>
    ```

    This documents the pattern so Phase 2 implementers have a clear template to follow.
  </action>
  <verify>grep -n "issue_execution_pr_pattern" skills/complete-milestone/references/milestone-complete.md shows the reference section exists</verify>
  <done>CLOSE-03 pattern documented in milestone-complete.md for Phase 2 implementation</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **CLOSE-01 verified:**
   ```bash
   grep -A5 "CLOSES_LINE=" skills/execute-phase/SKILL.md | head -10
   ```
   Shows CLOSES_LINE construction with phase issue lookup.

2. **CLOSE-02 implemented:**
   ```bash
   grep -B2 -A5 "CLOSES_LINES" skills/complete-milestone/references/milestone-complete.md
   ```
   Shows multi-issue collection and PR body inclusion.

3. **CLOSE-03 documented:**
   ```bash
   grep "issue_execution_pr_pattern" skills/complete-milestone/references/milestone-complete.md
   ```
   Shows reference section exists.
</verification>

<success_criteria>
- [ ] CLOSE-01: Verification confirms execute-phase implements `Closes #X` correctly
- [ ] CLOSE-02: complete-milestone PR body includes `Closes #X` for all phase issues
- [ ] CLOSE-03: Pattern documented for Phase 2's issue execution workflow
- [ ] All verification commands pass
- [ ] No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-pr-issue-closure/01-01-SUMMARY.md`
</output>
