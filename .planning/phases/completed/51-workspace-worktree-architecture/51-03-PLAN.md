---
phase: 51-workspace-worktree-architecture
plan: 03
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - tests/scripts/setup-worktrees.test.js
  - tests/scripts/create-phase-branch.test.js
  - tests/scripts/manage-worktree.test.js
  - tests/scripts/project-root.test.js
autonomous: true
must_haves:
  truths:
    - setup-worktrees.test.js verifies workspace/ worktree is created alongside main/
    - create-phase-branch.test.js verifies workspace branch checkout (not worktree add)
    - manage-worktree.test.js verifies cleanup-phase switches workspace back to workspace-base
    - project-root.test.js verifies workspace/.planning detection at priority 3
    - All tests pass with npm run test:scripts
  artifacts:
    - tests/scripts/setup-worktrees.test.js
    - tests/scripts/create-phase-branch.test.js
    - tests/scripts/manage-worktree.test.js
    - tests/scripts/project-root.test.js
  key_links:
    - Tests validate the script changes from plan 01
    - Test helpers (createBareRepo, createBareRepoWithRoadmap) updated for workspace layout
---

<objective>
Update test suites for the workspace worktree architecture scripts.

Purpose: Tests from v1.10.0 and v1.11.0 phases 49-50 validate the old architecture (ephemeral phase worktrees as siblings to main/). These tests must be updated to validate the workspace model where workspace/ is persistent, create-phase-branch.sh does checkout-b instead of worktree-add, and cleanup-phase switches workspace/ back to workspace-base.

Output: Four updated test files that pass against the workspace architecture scripts.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Test infrastructure notes:
- Tests run against dist/plugin/skills/ (built output), not source
- Tests use real git repos in tmpDir (no mocking)
- Each test creates a fresh bare repo layout via createBareRepo() or createBareRepoWithRoadmap() helper
- Tests must pass with: npm run build:plugin && node --test tests/scripts/{file}.test.js
- The build must happen first (plan 01 scripts are in skills/ source, tests run against dist/plugin/skills/)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update setup-worktrees.test.js for workspace/ creation</name>
  <files>tests/scripts/setup-worktrees.test.js</files>
  <action>
Read the current test file first.

Update the existing tests and add new ones for workspace/ creation:

1. **Update "full conversion creates bare repo + worktree layout" test:**
   - Add assertion: `workspace/` directory exists after conversion.
   - Add assertion: workspace/ worktree is on `workspace-base` branch (not main).
   - Update README assertion: check for "cd workspace" instead of "cd main" (or both).

2. **Add new test: "workspace/ worktree created on workspace-base branch":**
   ```javascript
   test('workspace/ worktree created on workspace-base branch', () => {
     createGitRepo(tmpDir);
     runScript(tmpDir);

     // workspace/ directory exists
     assert.ok(
       fs.existsSync(path.join(tmpDir, 'workspace')),
       'workspace/ directory should exist'
     );

     // workspace/ is on workspace-base branch
     const branch = execSync('git branch --show-current', {
       cwd: path.join(tmpDir, 'workspace'),
       env: GIT_ENV,
       encoding: 'utf8'
     }).trim();
     assert.strictEqual(branch, 'workspace-base',
       `workspace/ should be on workspace-base branch, got: ${branch}`);
   });
   ```

3. **Add new test: "workspace/ added to .gitignore":**
   ```javascript
   test('workspace/ added to .gitignore', () => {
     createGitRepo(tmpDir);
     runScript(tmpDir);

     const gitignore = fs.readFileSync(path.join(tmpDir, '.gitignore'), 'utf8');
     assert.ok(
       gitignore.includes('workspace/'),
       '.gitignore should include workspace/'
     );
   });
   ```

4. **Update "works with master branch" test:**
   - Add workspace/ existence check.
   - Verify workspace-base branch tracks master (or is based on master).

5. **Ensure existing tests still pass** — main/ creation, .bare/ directory, .git pointer file, remote URL preservation, upstream tracking.
  </action>
  <verify>Run `npm run build:plugin && node --test tests/scripts/setup-worktrees.test.js` and confirm all tests pass.</verify>
  <done>setup-worktrees.test.js validates workspace/ creation alongside main/ during bare repo conversion.</done>
</task>

<task type="auto">
  <name>Task 2: Update create-phase-branch.test.js for workspace checkout model</name>
  <files>tests/scripts/create-phase-branch.test.js</files>
  <action>
Read the current test file first.

The test helper createBareRepoWithRoadmap() creates a bare repo layout with main/ worktree. This must also create workspace/ worktree for the new architecture.

Update:

1. **Update createBareRepoWithRoadmap() helper:**
   After the main worktree is created (step 4), add workspace/ worktree:
   ```javascript
   // 4b. Add workspace worktree (on workspace-base branch)
   execSync('GIT_DIR=.bare git worktree add workspace -b workspace-base main', {
     cwd: dir, env: GIT_ENV, stdio: 'pipe'
   });
   ```

2. **Update "creates worktree with correct branch name format" test:**
   - Branch name assertion stays the same.
   - The test now runs from within workspace/ or main/ (project-root.sh cd's into workspace/).

3. **Update "WORKTREE_PATH points to phase worktree directory" test:**
   - Rename test to "WORKSPACE_PATH points to workspace directory" (or equivalent).
   - Assert WORKSPACE_PATH output instead of WORKTREE_PATH.
   - The WORKSPACE_PATH should point to the workspace/ directory (not a new sibling worktree).
   - Assert workspace/ is now on the phase branch (not workspace-base).

4. **Update branch type inference tests** (fix, docs, refactor, feat):
   - These test the branch type logic which hasn't changed.
   - Just verify the output variables still contain the correct values.

5. **Update "idempotent: resumes on existing worktree" test:**
   - Rename to "idempotent: resumes when workspace already on phase branch".
   - First run switches workspace to phase branch. Second run detects it and outputs same values.

6. **Update "main/ stays on main branch after worktree creation" test:**
   - Keep this invariant test unchanged (main/ must still be on main branch).
   - Add: workspace/ is on the phase branch after script runs.

7. **Update "outputs all 6 key=value pairs" test:**
   - Check for WORKSPACE_PATH instead of WORKTREE_PATH in the expected keys.
   - Keep BRANCH, BRANCH_TYPE, MILESTONE, PHASE_NUM, SLUG.

8. **Update runScript() if needed** — the script may need to run from workspace/ directory (or project root containing workspace/). Check that project-root.sh correctly resolves.
  </action>
  <verify>Run `npm run build:plugin && node --test tests/scripts/create-phase-branch.test.js` and confirm all tests pass.</verify>
  <done>create-phase-branch.test.js validates workspace checkout model with updated helper and assertions.</done>
</task>

<task type="auto">
  <name>Task 3: Update manage-worktree.test.js and project-root.test.js</name>
  <files>tests/scripts/manage-worktree.test.js, tests/scripts/project-root.test.js</files>
  <action>
Read both test files first.

**manage-worktree.test.js:**

1. **Update createBareRepo() helper:**
   Add workspace/ worktree creation after main/ worktree:
   ```javascript
   // Add workspace worktree
   execSync('GIT_DIR=.bare git worktree add workspace -b workspace-base main', {
     cwd: dir, env: GIT_ENV, stdio: 'pipe'
   });
   ```

2. **Update "merges plan branch into phase worktree" test:**
   - Instead of creating a phase-wt worktree, use workspace/ directory.
   - Switch workspace to a phase branch: `git -C workspace checkout -b feat/test`
   - Create plan worktree forking from feat/test.
   - Merge into workspace (not phase-wt).
   - Assert file exists in workspace/ after merge.
   - Rename test to "merges plan branch into workspace".

3. **Update "merges when untracked files..." test:**
   - Same pattern: use workspace/ instead of phase-wt.
   - Switch workspace to phase branch, create plan worktree, merge back.

4. **Update cleanup-phase tests:**
   - "removes phase worktree and branch" -> "switches workspace back to workspace-base and deletes phase branch"
   - Instead of creating phase-wt worktree, switch workspace/ to a phase branch.
   - After cleanup, assert workspace/ is on workspace-base branch (not that a directory was removed).
   - Assert phase branch is deleted.

   - "exits 1 when phase worktree directory does not exist" -> "exits 1 when workspace directory does not exist"
   - Pass a nonexistent path. Same behavior.

   - "exits 1 when phase worktree has uncommitted changes" -> "exits 1 when workspace has uncommitted changes"
   - Write uncommitted file to workspace/, run cleanup-phase, expect error.

**project-root.test.js:**

Read the existing test file first. Add a test for workspace/.planning detection:

1. **Add test: "prefers workspace/.planning over main/.planning when both exist":**
   ```javascript
   test('prefers workspace/.planning over main/.planning', () => {
     // Create directory with both workspace/.planning and main/.planning
     fs.mkdirSync(path.join(tmpDir, 'workspace/.planning'), { recursive: true });
     fs.mkdirSync(path.join(tmpDir, 'main/.planning'), { recursive: true });

     // Run script from tmpDir (bare repo root)
     // project-root.sh should cd into workspace/
     const result = runScript(tmpDir);
     assert.ok(
       result.includes('workspace'),
       'Should resolve to workspace/ directory'
     );
   });
   ```
   The exact assertion depends on how the test harness works. Read the existing test pattern and follow it.

2. **Ensure existing tests still pass** — KATA_PROJECT_ROOT, CWD .planning/, CWD main/.planning.
  </action>
  <verify>
Run `npm run build:plugin && node --test tests/scripts/manage-worktree.test.js` and confirm all tests pass.
Run `npm run build:plugin && node --test tests/scripts/project-root.test.js` and confirm all tests pass.
  </verify>
  <done>manage-worktree.test.js and project-root.test.js validate workspace architecture. All script tests pass.</done>
</task>

</tasks>

<verification>
- All four test files updated for workspace architecture
- npm run build:plugin && npm run test:scripts passes
- Test helpers create workspace/ in bare repo layouts
- create-phase-branch tests assert WORKSPACE_PATH output
- manage-worktree merge tests use workspace/ as merge target
- cleanup-phase tests verify workspace branch switch (not directory removal)
- project-root tests verify workspace/.planning priority
</verification>

<success_criteria>
- [ ] setup-worktrees.test.js: workspace/ creation verified
- [ ] create-phase-branch.test.js: checkout-b model verified, WORKSPACE_PATH output
- [ ] manage-worktree.test.js: merge into workspace/ verified, cleanup-phase branch switch
- [ ] project-root.test.js: workspace/.planning detection at priority 3
- [ ] npm run test:scripts passes with all updated tests
</success_criteria>

<output>
After completion, create `.planning/phases/pending/51-workspace-worktree-architecture/51-03-SUMMARY.md`
</output>
