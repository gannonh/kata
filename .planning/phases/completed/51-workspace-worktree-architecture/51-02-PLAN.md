---
phase: 51-workspace-worktree-architecture
plan: 02
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - skills/kata-execute-phase/SKILL.md
  - skills/kata-execute-phase/references/phase-execute.md
  - skills/kata-execute-phase/references/git-integration.md
autonomous: true
must_haves:
  truths:
    - SKILL.md step 1.5 calls create-phase-branch.sh and stores WORKSPACE_PATH (not PHASE_WORKTREE_PATH)
    - SKILL.md removes GIT_DIR_FLAG pattern from step 10 (orchestrator runs from workspace/, no -C needed)
    - SKILL.md working directory injection has two cases instead of three (plan worktree OR omitted)
    - SKILL.md steps 10.5 push/PR operations run without git -C (already in workspace)
    - phase-execute.md worktree_lifecycle step describes workspace model
    - git-integration.md branch_flow section describes workspace architecture
  artifacts:
    - skills/kata-execute-phase/SKILL.md
    - skills/kata-execute-phase/references/phase-execute.md
    - skills/kata-execute-phase/references/git-integration.md
  key_links:
    - SKILL.md step 1.5 consumes WORKSPACE_PATH from create-phase-branch.sh
    - SKILL.md step 4 passes WORKSPACE_PATH to manage-worktree.sh merge
    - phase-execute.md worktree_lifecycle references the same scripts
---

<objective>
Update the orchestrator layer (SKILL.md and references) for workspace worktree architecture.

Purpose: The orchestrator currently uses GIT_DIR_FLAG and git -C to bridge the gap between its position (main/) and the phase worktree. With the workspace model, the orchestrator runs FROM workspace/, eliminating this indirection. Working directory injection simplifies from three cases to two.

Output: Updated SKILL.md, phase-execute.md, and git-integration.md reflecting the workspace model.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

The scripts from plan 01 now:
- create-phase-branch.sh outputs WORKSPACE_PATH (the workspace/ directory) instead of WORKTREE_PATH
- manage-worktree.sh merge takes workspace path as the merge target directory
- manage-worktree.sh cleanup-phase switches workspace/ back to workspace-base branch

Key simplifications for the orchestrator:
1. No GIT_DIR_FLAG needed. The orchestrator IS in workspace/. git add, git commit, git push all work directly.
2. Working directory injection reduces from 3 cases to 2:
   - Case 1: WORKTREE_ENABLED=true AND PR_WORKFLOW=true -> plan worktree path
   - Case 2: Everything else -> omitted (agent works in workspace/ or project root)
   The old Case 2 (PR_WORKFLOW=true, WORKTREE_ENABLED=false -> phase worktree path) disappears because the orchestrator already runs from workspace/.
3. git -C "$PHASE_WORKTREE_PATH" commands become plain git commands.
4. Step 10.5 push/PR: `git push` replaces `git -C "$PHASE_WORKTREE_PATH" push`.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SKILL.md for workspace architecture</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Read the current SKILL.md carefully before making changes. Apply these specific modifications:

**Step 0.7 (Check Worktree and PR Config):**
- Keep as-is. Still reads WORKTREE_ENABLED and PR_WORKFLOW.

**Step 1.5 (Create phase branch and commit activation changes):**
- Change variable names: PHASE_WORKTREE_PATH -> WORKSPACE_PATH, PHASE_BRANCH stays.
- The script now outputs WORKSPACE_PATH instead of WORKTREE_PATH from create-phase-branch.sh.
- Update the eval block:
  ```bash
  WORKSPACE_PATH=$WORKSPACE_PATH  # from create-phase-branch.sh output
  PHASE_BRANCH=$BRANCH
  ```
- The activation commit changes from `git -C "$PHASE_WORKTREE_PATH"` to plain `git` (already in workspace/).
  Replace:
  ```bash
  if [ -n "$(git -C "$PHASE_WORKTREE_PATH" status --porcelain .planning/)" ]; then
    git -C "$PHASE_WORKTREE_PATH" add .planning/ && git -C "$PHASE_WORKTREE_PATH" commit -m "docs(${PHASE_NUM}): activate phase"
  fi
  ```
  With:
  ```bash
  if [ -n "$(git status --porcelain .planning/)" ]; then
    git add .planning/ && git commit -m "docs(${PHASE_NUM}): activate phase"
  fi
  ```

**Step 4 (Execute waves):**
- Plan worktree creation: Replace PHASE_WORKTREE_PATH with WORKSPACE_PATH in the merge call.
  The create call stays the same (passes PHASE_BRANCH).
  ```bash
  MERGE_OUTPUT=$(bash "./scripts/manage-worktree.sh" merge "$PHASE_NUM" "$plan_num" "$PHASE_BRANCH" "$WORKSPACE_PATH")
  ```
- Draft PR (first wave): Remove git -C from push and status commands:
  ```bash
  if [ -n "$(git status --porcelain .planning/)" ]; then
    git add .planning/ && git commit -m "docs(${PHASE_NUM}): update planning state"
  fi
  ```
  Push becomes:
  ```bash
  git push -u origin "$PHASE_BRANCH" 2>/dev/null || \
    git push -u --force-with-lease origin "$PHASE_BRANCH" 2>/dev/null
  ```

**Step 6 (Commit orchestrator corrections):**
- Remove any git -C usage. Plain git commands work (already in workspace/).

**Step 10 (Commit phase completion):**
- Remove the entire GIT_DIR_FLAG pattern:
  ```bash
  # DELETE these lines:
  if [ "$PR_WORKFLOW" = "true" ]; then
    GIT_DIR_FLAG=(-C "$PHASE_WORKTREE_PATH")
  else
    GIT_DIR_FLAG=()
  fi
  ```
- Replace all `git "${GIT_DIR_FLAG[@]}"` with plain `git`:
  ```bash
  git add ".planning/phases/pending/${DIR_NAME}" 2>/dev/null || true
  git add ".planning/phases/active/${DIR_NAME}" 2>/dev/null || true
  git add "$PHASE_DIR"
  git add .planning/ROADMAP.md .planning/STATE.md
  git add .planning/REQUIREMENTS.md 2>/dev/null || true
  git commit -m "docs(${PHASE_NUM}): complete ${PHASE_NAME} phase"
  ```

**Step 10.5 (Push and ensure PR exists):**
- Replace `git -C "$PHASE_WORKTREE_PATH"` with plain `git`:
  ```bash
  if [ -n "$(git status --porcelain .planning/)" ]; then
    git add .planning/
    git commit -m "docs(${PHASE_NUM}): update planning state"
  fi
  git push -u origin "$PHASE_BRANCH"
  ```
- Replace PHASE_WORKTREE_PATH references in comments with "workspace".
- Update the cleanup note at the end: workspace cleanup happens after PR merge via:
  ```bash
  bash "./scripts/manage-worktree.sh" cleanup-phase "$WORKSPACE_PATH" "$PHASE_BRANCH"
  ```

**Wave execution section:**
- Simplify working directory injection from 3 cases to 2:
  ```bash
  WORKING_DIR_BLOCK=""
  if [ "$PR_WORKFLOW" = "true" ] && [ "$WORKTREE_ENABLED" = "true" ]; then
    # Case 1: Plan has its own worktree
    PLAN_WT_PATH="WORKTREE_PATH_${plan_num}"
    WORKING_DIR_BLOCK="\n<working_directory>${!PLAN_WT_PATH}</working_directory>"
  fi
  # Case 2: No plan worktrees — agent works in workspace/ (or project root if no PR workflow)
  # No working_directory block needed — default behavior
  ```
- Remove the old Case 2 comment and logic (PHASE_WORKTREE_PATH injection for PR_WORKFLOW=true, WORKTREE_ENABLED=false).

**Throughout the file:**
- Replace all remaining PHASE_WORKTREE_PATH references with WORKSPACE_PATH.
- Update comments mentioning "phase worktree" to say "workspace" where appropriate.
- Keep PHASE_BRANCH references unchanged.

Do NOT change steps 0, 0.5, 0.6, 1, 1.1, 1.25, 2, 3, 3.5, 5, 6.5, 7, 7.5, 8, 9, 11, or any of the offer_next/deviation_rules/checkpoint_handling/commit_rules sections (unless they reference PHASE_WORKTREE_PATH, in which case update the variable name).
  </action>
  <verify>
Read the updated SKILL.md and verify:
- No remaining references to PHASE_WORKTREE_PATH (replaced with WORKSPACE_PATH)
- No remaining GIT_DIR_FLAG pattern
- No remaining git -C "$PHASE_WORKTREE_PATH" or git -C "$WORKSPACE_PATH" commands (plain git instead)
- Working directory injection has exactly 2 cases (plan worktree or omitted)
- Step 1.5 reads WORKSPACE_PATH from create-phase-branch.sh output
- Step 10.5 cleanup note references manage-worktree.sh with WORKSPACE_PATH
  </verify>
  <done>SKILL.md uses workspace model. No GIT_DIR_FLAG. No git -C for workspace operations. Working directory injection simplified to 2 cases.</done>
</task>

<task type="auto">
  <name>Task 2: Update phase-execute.md and git-integration.md references</name>
  <files>skills/kata-execute-phase/references/phase-execute.md, skills/kata-execute-phase/references/git-integration.md</files>
  <action>
**phase-execute.md — Update worktree_lifecycle step:**

Replace the current worktree_lifecycle step content with workspace-based lifecycle:

1. Detection (step 0): Unchanged — still reads WORKTREE_ENABLED and PR_WORKFLOW.

2. Create phase branch (step 1): Replace worktree add with workspace checkout.
   - Current: `eval "$(bash scripts/create-phase-branch.sh "$PHASE_DIR")"` followed by `PHASE_WORKTREE_PATH=$WORKTREE_PATH`
   - New: Same eval call, but store `WORKSPACE_PATH=$WORKSPACE_PATH` (script now outputs WORKSPACE_PATH).
   - Update description: "Switches workspace/ to a new phase branch. The workspace/ directory persists across phases. main/ stays on the main branch."

3. Create plan worktrees (step 2): Update to reference workspace's branch.
   - The code is functionally unchanged (manage-worktree.sh create still takes phase branch).
   - Update description to note plan worktrees fork from workspace/'s current branch.

4. Inject working directory (step 3): Simplify the table from 3 cases to 2:
   | PR_WORKFLOW | WORKTREE_ENABLED | Working Directory | Why |
   |-------------|------------------|-------------------|-----|
   | true | true | Plan worktree path | Agent works in isolated plan branch |
   | (any) | false or PR_WORKFLOW=false | (omitted) | Agent works in workspace/ or project root |

5. Merge plan worktrees (step 4): Update merge target from phase worktree to workspace/:
   - `bash scripts/manage-worktree.sh merge "$PHASE" "$PLAN" "$PHASE_BRANCH" "$WORKSPACE_PATH"`
   - "Plan branches merge into workspace/, not into a separate phase worktree."

6. Phase completion (step 5): Update push commands.
   - Remove git -C. Plain git push from workspace/.
   - "The orchestrator runs from workspace/, so git operations work directly."

7. Cleanup (step 6): Update cleanup semantics.
   - `bash scripts/manage-worktree.sh cleanup-phase "$WORKSPACE_PATH" "$PHASE_BRANCH"`
   - "Switches workspace/ back to workspace-base branch and deletes the phase branch. No directory removal — workspace/ persists."

8. Cleanup on failure (step 7): Update for workspace context.
   - Plan worktrees still remain for inspection.
   - Workspace stays on the phase branch for debugging.

Update the worktree_context section inside context_efficiency to reflect workspace model: "Phase branch creation adds one git checkout -b at startup (create-phase-branch.sh). Plan worktree isolation (when worktree.enabled=true) adds per-wave manage-worktree.sh create and merge calls."

**git-integration.md — Update branch_flow section:**

Replace the current branch_flow content with workspace architecture:

```
## Two-Tier Branch Model

Kata uses a two-tier branching model within a bare repo + worktree layout. The first tier always exists. The second tier activates when worktree.enabled=true.

**Layout:**
```
project-root/
  .bare/                    # shared git object store
  main/                     # read-only, always on main branch
  workspace/                # active working directory, switches to phase branch
  plan-01-01/               # plan worktree (temporary, during plan execution)
  plan-01-02/               # plan worktree (temporary, during plan execution)
```

**Tier 1: Workspace + Phase Branches**

workspace/ tracks the active phase branch during execution. Between phases, workspace/ sits on workspace-base (tracking main). When phase execution starts, workspace/ switches to a new phase branch via `git checkout -b feat/v1.0-01-phase-name`. main/ stays on the main branch at all times. After phase completion, workspace/ switches back to workspace-base.

**Tier 2: Plan Branches per Worktree (when worktree.enabled=true)**

During phase execution, each plan agent gets its own worktree on a plan/{phase}-{plan} branch. Plan branches fork from the phase branch (workspace/'s current branch), provide isolation for parallel plan agents, and merge back into workspace/ after plan completion. manage-worktree.sh handles creation, merge, and cleanup.
```

Update the configuration variants table and plan branch lifecycle to match workspace model.
  </action>
  <verify>
Read the updated phase-execute.md and verify:
- worktree_lifecycle step uses workspace model throughout
- No references to PHASE_WORKTREE_PATH (now WORKSPACE_PATH)
- Working directory injection table has 2 cases (not 3)
- worktree_context section updated

Read the updated git-integration.md and verify:
- branch_flow section describes workspace architecture
- Layout diagram shows workspace/ alongside main/
- Plan branch lifecycle references workspace/ as merge target
  </verify>
  <done>phase-execute.md and git-integration.md describe workspace worktree architecture. No phase worktree references remain. Working directory model simplified.</done>
</task>

</tasks>

<verification>
- SKILL.md has no remaining PHASE_WORKTREE_PATH or GIT_DIR_FLAG references
- phase-execute.md worktree_lifecycle describes workspace model
- git-integration.md branch_flow shows workspace architecture
- Working directory injection is 2 cases everywhere (SKILL.md, phase-execute.md)
- All git operations from orchestrator use plain git (no -C needed)
</verification>

<success_criteria>
- [ ] SKILL.md: PHASE_WORKTREE_PATH replaced with WORKSPACE_PATH throughout
- [ ] SKILL.md: GIT_DIR_FLAG pattern removed from step 10
- [ ] SKILL.md: git -C removed for all workspace operations
- [ ] SKILL.md: Working directory injection has 2 cases (plan worktree or omitted)
- [ ] phase-execute.md: worktree_lifecycle step describes workspace model
- [ ] git-integration.md: branch_flow section shows workspace architecture
- [ ] All three files are internally consistent
</success_criteria>

<output>
After completion, create `.planning/phases/pending/51-workspace-worktree-architecture/51-02-SUMMARY.md`
</output>
