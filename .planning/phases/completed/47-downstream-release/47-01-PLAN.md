---
phase: 47-downstream-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/references/git-integration.md
  - skills/kata-complete-milestone/SKILL.md
  - skills/kata-complete-milestone/references/milestone-complete.md
autonomous: true
user_setup: []
source_issue: ""

must_haves:
  truths:
    - git-integration.md documents two-tier branch flow (main + release vs worktree + plan branches)
    - kata-complete-milestone step 0 reads worktree.enabled config
    - When worktree.enabled=true AND pr_workflow=true, release branch created via manage-worktree.sh instead of git checkout -b
    - When worktree.enabled=false, existing release branch creation unchanged
  artifacts:
    - skills/kata-execute-phase/references/git-integration.md with new branch_flow section
    - skills/kata-complete-milestone/SKILL.md with worktree-conditional release branch logic
    - skills/kata-complete-milestone/references/milestone-complete.md with worktree-conditional ensure_release_branch step
  key_links:
    - DOWN-01 and DOWN-02 from REQUIREMENTS.md
---

<objective>
Document two-tier branch flow in git-integration.md and make kata-complete-milestone worktree-aware for release branch creation.

Purpose: The worktree model adds a second branching tier (plan branches per worktree) on top of the existing model (main + release branches). The git-integration reference needs to document this so executor agents understand the full picture. The milestone completion skill needs to create release branches via worktree when the feature is enabled.

Output: Updated git-integration.md with branch flow documentation. Updated SKILL.md and milestone-complete.md with worktree-conditional release branch logic.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@skills/kata-execute-phase/references/git-integration.md
@skills/kata-complete-milestone/SKILL.md
@skills/kata-complete-milestone/references/milestone-complete.md
@skills/kata-execute-phase/scripts/manage-worktree.sh
@skills/kata-execute-phase/references/phase-execute.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add two-tier branch flow documentation to git-integration.md</name>
  <files>skills/kata-execute-phase/references/git-integration.md</files>
  <action>
Add a new `<branch_flow>` section to git-integration.md after the existing `<commit_strategy_rationale>` section. Document the two-tier branching model:

**Tier 1 (existing):** Main branch + release branches. This is the standard flow: development on main (or feature branches), release branches for milestone completion (release/vX.Y.Z). Managed by kata-complete-milestone.

**Tier 2 (worktree, when worktree.enabled=true):** Plan branches per worktree. During phase execution, each plan agent gets its own worktree on a `plan/{phase}-{plan}` branch. These branches fork from the base branch (main or release/vX.Y.Z) and merge back after plan completion. Managed by manage-worktree.sh via kata-execute-phase.

Include a table showing which branches exist in each configuration:

| Config | Branches | Managed By |
| worktree.enabled=false | main, release/vX.Y.Z | git checkout -b |
| worktree.enabled=true | main, release/vX.Y.Z, plan/{phase}-{plan} | manage-worktree.sh |

Document the lifecycle: base branch -> plan branches fork -> agents work in isolation -> wave completes -> plan branches merge back to base -> worktrees removed.

Use imperative voice. Keep it concise. Match the existing XML tag style in the file (semantic containers with markdown content inside).
  </action>
  <verify>grep -q "branch_flow" skills/kata-execute-phase/references/git-integration.md && grep -q "two-tier" skills/kata-execute-phase/references/git-integration.md</verify>
  <done>git-integration.md contains a branch_flow section documenting both tiers of the branching model with configuration variants and lifecycle.</done>
</task>

<task type="auto">
  <name>Task 2: Add worktree-aware release branch creation to kata-complete-milestone</name>
  <files>skills/kata-complete-milestone/SKILL.md, skills/kata-complete-milestone/references/milestone-complete.md</files>
  <action>
Update SKILL.md step 0 and milestone-complete.md `ensure_release_branch` step to read worktree.enabled config and conditionally use manage-worktree.sh for release branch creation.

**In SKILL.md step 0 ("CRITICAL: Branch setup"):**

After the existing PR_WORKFLOW and CURRENT_BRANCH checks, add worktree config read:

```bash
WORKTREE_ENABLED=$(bash ../kata-configure-settings/scripts/read-config.sh "worktree.enabled" "false")
```

In the "If PR_WORKFLOW=true AND on main" block, add a conditional:

When `WORKTREE_ENABLED=true`:
- Instead of `git checkout -b release/v$VERSION`, use:
  ```bash
  # Create release worktree (manage-worktree.sh is in kata-execute-phase)
  eval "$(bash ../kata-execute-phase/scripts/manage-worktree.sh create release "v$VERSION")"
  echo "Created release worktree at $WORKTREE_PATH on branch $WORKTREE_BRANCH"
  ```
- Note: manage-worktree.sh create expects (phase, plan) args but we repurpose with ("release", "v$VERSION") to get branch `plan/release-v$VERSION` and worktree `plan-release-v$VERSION`. This follows the same convention.
- Display should mention worktree path.

When `WORKTREE_ENABLED=false` (default):
- Keep existing `git checkout -b release/v$VERSION` behavior unchanged.

**In milestone-complete.md `ensure_release_branch` step:**

Mirror the same conditional logic. Add the worktree config read and conditional branch creation. Keep the existing non-worktree path as the default/fallback.

Do NOT change any other steps. The rest of the milestone completion workflow operates on files in the current directory regardless of whether a worktree is used, since worktrees share the .planning/ directory.
  </action>
  <verify>grep -q "WORKTREE_ENABLED" skills/kata-complete-milestone/SKILL.md && grep -q "worktree" skills/kata-complete-milestone/references/milestone-complete.md</verify>
  <done>SKILL.md step 0 reads worktree.enabled and conditionally creates release branch via manage-worktree.sh. milestone-complete.md ensure_release_branch step mirrors the same conditional. Non-worktree behavior unchanged.</done>
</task>

</tasks>

<verification>
1. git-integration.md has a `<branch_flow>` section with two-tier documentation
2. SKILL.md step 0 contains worktree.enabled config read and conditional logic
3. milestone-complete.md ensure_release_branch step has worktree conditional
4. Non-worktree code paths are preserved unchanged
5. No changes to any other steps in either file
</verification>

<success_criteria>
- git-integration.md documents both branch tiers with configuration table and lifecycle
- kata-complete-milestone creates release branch via manage-worktree.sh when worktree.enabled=true
- Existing non-worktree release branch creation preserved as default
- DOWN-01 and DOWN-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/pending/47-downstream-release/47-01-SUMMARY.md`
</output>
