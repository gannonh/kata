---
phase: 02-full-conversion
plan: 06
type: execute
wave: 2
depends_on: ["02-01", "02-05"]
files_modified:
  - skills/kata-research-phase/references/phase-researcher-instructions.md
  - skills/kata-research-phase/SKILL.md
  - skills/kata-verify-work/references/verify-work.md
  - skills/kata-execute-phase/references/phase-execute.md
  - skills/kata-map-codebase/references/project-analyze.md
autonomous: true

must_haves:
  truths:
    - "kata-research-phase spawns general-purpose subagents for phase-researcher with inlined instructions"
    - "kata-verify-work verify-work.md reference file uses general-purpose for all Task() calls"
    - "kata-execute-phase phase-execute.md reference file uses general-purpose for verifier Task() call"
    - "kata-map-codebase project-analyze.md reference file uses general-purpose for codebase-mapper Task() calls"
    - "Zero remaining subagent_type=\"kata-*\" patterns in ANY reference file across all skills"
  artifacts:
    - path: "skills/kata-research-phase/SKILL.md"
      provides: "Updated orchestrator using general-purpose for phase-researcher"
      contains: "subagent_type=\"general-purpose\""
    - path: "skills/kata-research-phase/references/phase-researcher-instructions.md"
      provides: "Copy of phase-researcher instructions for kata-research-phase"
    - path: "skills/kata-verify-work/references/verify-work.md"
      provides: "Updated reference with general-purpose subagent types"
    - path: "skills/kata-execute-phase/references/phase-execute.md"
      provides: "Updated reference with general-purpose for verifier"
  key_links:
    - from: "skills/kata-research-phase/SKILL.md"
      to: "skills/kata-research-phase/references/phase-researcher-instructions.md"
      via: "Read instruction file before Task() calls"
      pattern: "phase-researcher-instructions\\.md"
---

<objective>
Update shared-agent consumers and reference files across remaining skills.

Purpose: Handles cross-skill references and reference file updates that depend on Wave 1 migrations:
1. kata-research-phase uses kata-phase-researcher (shared with kata-plan-phase, extracted in 02-01)
2. kata-verify-work/references/verify-work.md has Task() calls still using kata-planner and kata-plan-checker
3. kata-execute-phase/references/phase-execute.md has a Task() call still using kata-verifier (extracted in 02-05)
4. kata-map-codebase/references/project-analyze.md has Task() calls still using kata-codebase-mapper (extracted in 02-05)

Depends on 02-01 (phase-researcher instruction file) and 02-05 (verifier/codebase-mapper instruction files).
Output: Updated SKILL.md + 4 reference files
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/02-full-conversion/02-RESEARCH.md

Source files:
@skills/kata-research-phase/SKILL.md
@skills/kata-verify-work/references/verify-work.md
@skills/kata-execute-phase/references/phase-execute.md
@skills/kata-map-codebase/references/project-analyze.md
@skills/kata-plan-phase/references/phase-researcher-instructions.md (created by 02-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update kata-research-phase to use general-purpose with inlined phase-researcher instructions</name>
  <files>skills/kata-research-phase/SKILL.md, skills/kata-research-phase/references/phase-researcher-instructions.md</files>
  <action>
**Shared agent resolution:** kata-phase-researcher instructions were extracted to `skills/kata-plan-phase/references/phase-researcher-instructions.md` in plan 02-01. For kata-research-phase, COPY the instruction file to `skills/kata-research-phase/references/phase-researcher-instructions.md` (create references/ directory if needed). This avoids cross-skill @-reference fragility.

**Step A: Copy instruction file**

Copy `skills/kata-plan-phase/references/phase-researcher-instructions.md` to `skills/kata-research-phase/references/phase-researcher-instructions.md`.

Verify the copy matches the source byte-for-byte.

**Step B: Add Read call for instruction file in SKILL.md**

Before the first Task() call (line ~169), add a read instruction for `references/phase-researcher-instructions.md` storing as `phase_researcher_instructions_content`.

**Step C: Update 2 phase-researcher Task() calls (lines ~169, ~203)**

Both currently have `subagent_type="kata-phase-researcher"`. For each:
1. Change `subagent_type="kata-phase-researcher"` to `subagent_type="general-purpose"`
2. Prepend `<agent-instructions>\n{phase_researcher_instructions_content}\n</agent-instructions>\n\n` to the prompt

Do NOT change model selection logic.
  </action>
  <verify>
1. `diff skills/kata-plan-phase/references/phase-researcher-instructions.md skills/kata-research-phase/references/phase-researcher-instructions.md` returns empty (identical)
2. `grep -c 'subagent_type="kata-' skills/kata-research-phase/SKILL.md` returns 0
3. `grep -c 'subagent_type="general-purpose"' skills/kata-research-phase/SKILL.md` returns 2
4. `grep -c 'agent-instructions' skills/kata-research-phase/SKILL.md` returns at least 2
  </verify>
  <done>
- phase-researcher-instructions.md copied to kata-research-phase/references/
- Zero remaining custom subagent types in kata-research-phase
- 2 Task() calls use general-purpose with inlined instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update reference files in kata-verify-work, kata-execute-phase, and kata-map-codebase</name>
  <files>skills/kata-verify-work/references/verify-work.md, skills/kata-execute-phase/references/phase-execute.md, skills/kata-map-codebase/references/project-analyze.md</files>
  <action>
**Step A: Update verify-work.md reference file**

`skills/kata-verify-work/references/verify-work.md` has 3 Task() calls that reference agents migrated in POC (kata-planner) and plan 02-01 (kata-plan-checker):

1. Line ~420: `subagent_type="kata-planner"` → `subagent_type="general-purpose"`
   Add `<agent-instructions>\n{planner_instructions_content}\n</agent-instructions>\n\n` prepended to the prompt
2. Line ~466: `subagent_type="kata-plan-checker"` → `subagent_type="general-purpose"`
   Add `<agent-instructions>\n{plan_checker_instructions_content}\n</agent-instructions>\n\n` prepended to the prompt
3. Line ~507: `subagent_type="kata-planner"` → `subagent_type="general-purpose"`
   Add `<agent-instructions>\n{planner_instructions_content}\n</agent-instructions>\n\n` prepended to the prompt

Add a note before the gap-closure Task() calls indicating instructions are read from skill references/ at runtime.

**Step B: Update phase-execute.md reference file**

`skills/kata-execute-phase/references/phase-execute.md` has 1 Task() call at line ~433:

`subagent_type="kata-verifier"` → `subagent_type="general-purpose"`

Add `<agent-instructions>\n{verifier_instructions_content}\n</agent-instructions>\n\n` prepended to the prompt.

Add a note that verifier instructions are read from `references/verifier-instructions.md` at runtime. Note: the verifier instruction file lives in kata-verify-work/references/ (extracted in plan 02-05). The execute-phase should read from its own local copy or cross-reference. For consistency, copy `skills/kata-verify-work/references/verifier-instructions.md` to `skills/kata-execute-phase/references/verifier-instructions.md` as well, and reference it in the SKILL.md step 7 Read calls.

Do NOT modify kata-execute-phase/SKILL.md itself (the verifier mention at line 340 is a prose description, not a Task() call with subagent_type).

**Step C: Update kata-map-codebase/references/project-analyze.md**

`skills/kata-map-codebase/references/project-analyze.md` has multiple references to `subagent_type="kata-codebase-mapper"` (line ~94 and Task() call examples at line ~102+).

Update ALL occurrences of `subagent_type="kata-codebase-mapper"` and `subagent_type: "kata-codebase-mapper"` to `subagent_type="general-purpose"` and `subagent_type: "general-purpose"` respectively.

Add `<agent-instructions>\n{codebase_mapper_instructions_content}\n</agent-instructions>\n\n` wrapper to the prompt examples.

Add a note that codebase-mapper instructions are read from `references/codebase-mapper-instructions.md` at runtime. The instruction file was extracted in plan 02-05 to kata-track-progress/references/. Copy it to kata-map-codebase/references/ as well (or cross-reference).
  </action>
  <verify>
1. `grep -c 'subagent_type="kata-planner"' skills/kata-verify-work/references/verify-work.md` returns 0
2. `grep -c 'subagent_type="kata-plan-checker"' skills/kata-verify-work/references/verify-work.md` returns 0
3. `grep -c 'subagent_type="general-purpose"' skills/kata-verify-work/references/verify-work.md` returns 3
4. `grep -c 'subagent_type="kata-verifier"' skills/kata-execute-phase/references/phase-execute.md` returns 0
5. `grep -c 'subagent_type="general-purpose"' skills/kata-execute-phase/references/phase-execute.md` returns at least 4 (3 executor from POC + 1 verifier)
6. `grep -c 'subagent_type="kata-codebase-mapper"' skills/kata-map-codebase/references/project-analyze.md` returns 0
7. `grep -c 'kata-codebase-mapper' skills/kata-map-codebase/references/project-analyze.md` — verify no subagent_type references remain (agent name may still appear in prose descriptions)
8. `npm run build:plugin` succeeds
  </verify>
  <done>
- verify-work.md: all 3 Task() calls updated to general-purpose with agent-instructions wrapper
- phase-execute.md: verifier Task() call updated to general-purpose with agent-instructions wrapper
- project-analyze.md: all codebase-mapper Task() calls updated to general-purpose with agent-instructions wrapper
- Build passes
  </done>
</task>

</tasks>

<verification>
- `grep -r 'subagent_type="kata-' skills/kata-research-phase/` returns empty
- `grep -r 'subagent_type="kata-' skills/kata-verify-work/references/` returns empty
- `grep -r 'subagent_type="kata-' skills/kata-execute-phase/references/` returns empty
- `grep -r 'subagent_type="kata-' skills/kata-map-codebase/references/` returns empty
- Full codebase check: `grep -rn 'subagent_type="kata-' skills/` (excluding node_modules) returns empty
- `npm run build:plugin` succeeds
</verification>

<success_criteria>
1. kata-research-phase uses general-purpose with inlined instructions
2. verify-work.md has zero custom subagent types
3. phase-execute.md has zero custom subagent types
4. project-analyze.md has zero custom subagent types
5. No remaining `subagent_type="kata-*"` patterns in ANY skills/ file
5. Plugin build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/pending/02-full-conversion/02-06-SUMMARY.md`
</output>
