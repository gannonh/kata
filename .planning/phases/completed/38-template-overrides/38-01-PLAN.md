---
phase: 38-template-overrides
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-complete-milestone/references/changelog-entry.md
  - skills/kata-complete-milestone/references/changelog-generator.md
  - skills/kata-plan-phase/references/plan-template.md
  - skills/kata-plan-phase/references/planner-instructions.md
  - skills/kata-verify-work/references/verification-report.md
  - skills/kata-verify-work/references/verifier-instructions.md
  - skills/kata-execute-phase/references/summary-template.md
  - skills/kata-verify-work/references/UAT-template.md
  - skills/kata-execute-phase/scripts/resolve-template.sh
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "Five template files exist as standalone files in their owning skill's references/ directory"
    - "Each template file has a kata-template-schema HTML comment with required-fields and optional-fields"
    - "resolve-template.sh returns project override path when .planning/templates/{name}.md exists"
    - "resolve-template.sh returns plugin default path when no project override exists"
    - "Existing @-references to summary-template.md and UAT-template.md still resolve"
  artifacts:
    - skills/kata-complete-milestone/references/changelog-entry.md
    - skills/kata-plan-phase/references/plan-template.md
    - skills/kata-verify-work/references/verification-report.md
    - skills/kata-execute-phase/scripts/resolve-template.sh
  key_links:
    - "changelog-generator.md references changelog-entry.md instead of containing the template inline"
    - "planner-instructions.md references plan-template.md instead of containing the template inline"
    - "verifier-instructions.md references verification-report.md instead of containing the template inline"
---

<objective>
Extract three inline templates into standalone files, add schema comments to all five templates, and create the resolve-template.sh resolution script.

Purpose: Establish the template file infrastructure that enables project-level overrides and drift detection. This is the foundation for TMPL-01 (standalone templates), TMPL-02 (resolution logic), and TMPL-03 (schema comments).
Output: 3 new template files extracted, 5 templates with schema comments, 1 resolution script.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/38-template-overrides/38-RESEARCH.md

@skills/kata-complete-milestone/references/changelog-generator.md
@skills/kata-plan-phase/references/planner-instructions.md
@skills/kata-verify-work/references/verifier-instructions.md
@skills/kata-execute-phase/references/summary-template.md
@skills/kata-verify-work/references/UAT-template.md
@skills/kata-configure-settings/scripts/read-pref.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract three inline templates into standalone files and add schema comments to all five</name>
  <files>
    skills/kata-complete-milestone/references/changelog-entry.md,
    skills/kata-complete-milestone/references/changelog-generator.md,
    skills/kata-plan-phase/references/plan-template.md,
    skills/kata-plan-phase/references/planner-instructions.md,
    skills/kata-verify-work/references/verification-report.md,
    skills/kata-verify-work/references/verifier-instructions.md,
    skills/kata-execute-phase/references/summary-template.md,
    skills/kata-verify-work/references/UAT-template.md
  </files>
  <action>
**Extract changelog-entry.md:**
Create `skills/kata-complete-milestone/references/changelog-entry.md` containing the `<format>` section (Keep a Changelog format template) and `<commit_type_mapping>` section extracted from `changelog-generator.md`. Add a kata-template-schema HTML comment at the top. In `changelog-generator.md`, replace the inline `<format>` and `<commit_type_mapping>` sections with a reference: `@./changelog-entry.md`.

**Extract plan-template.md:**
Create `skills/kata-plan-phase/references/plan-template.md` containing the PLAN.md structure (the markdown code block from lines 379-440 of planner-instructions.md). Add a kata-template-schema HTML comment at the top. In `planner-instructions.md`, replace the inline template code block inside `<plan_format>` with a reference: `@./plan-template.md`. Keep the surrounding Frontmatter Fields table, Context Section Rules, and User Setup Frontmatter guidance in planner-instructions.md since those are planning rules, not template content.

**Extract verification-report.md:**
Create `skills/kata-verify-work/references/verification-report.md` containing the VERIFICATION.md template (the markdown code block from lines 535-615 of verifier-instructions.md). Add a kata-template-schema HTML comment at the top. In `verifier-instructions.md`, replace the inline template code block inside `<output>` with a reference: `@./verification-report.md`. Keep the "Return to Orchestrator" guidance below the template in verifier-instructions.md.

**Add schema comments to existing standalone templates:**
Add `<!-- kata-template-schema ... -->` HTML comments to the top of:
- `skills/kata-execute-phase/references/summary-template.md`
- `skills/kata-verify-work/references/UAT-template.md`

**Schema comment format (consistent across all five):**
```
<!-- kata-template-schema
required-fields:
  frontmatter: [field1, field2, ...]
  body: [Section1, Section2, ...]
optional-fields:
  frontmatter: [field1, field2, ...]
  body: [Section1, Section2, ...]
version: 1
-->
```

**Required fields for each template (from research):**
- summary-template.md: frontmatter [phase, plan, subsystem, tags, duration, completed], body [Performance, Accomplishments, Task Commits, Files Created/Modified, Decisions Made]
- changelog-entry.md: frontmatter [], body [Added, Fixed, Changed]
- plan-template.md: frontmatter [phase, plan, type, wave, depends_on, files_modified, autonomous, must_haves], body [objective, execution_context, context, tasks, verification, success_criteria, output]
- UAT-template.md: frontmatter [status, phase, source, started, updated], body [Current Test, Tests, Summary, Gaps]
- verification-report.md: frontmatter [phase, verified, status, score], body [Goal Achievement, Observable Truths, Required Artifacts, Key Link Verification, Requirements Coverage]

Do NOT move template files to a central directory. Templates stay in their owning skill's references/ directory.
  </action>
  <verify>
Confirm all 5 template files exist with schema comments:
```bash
for f in skills/kata-complete-milestone/references/changelog-entry.md skills/kata-plan-phase/references/plan-template.md skills/kata-verify-work/references/verification-report.md skills/kata-execute-phase/references/summary-template.md skills/kata-verify-work/references/UAT-template.md; do
  echo "=== $f ==="
  head -10 "$f" | grep "kata-template-schema" && echo "  schema: OK" || echo "  schema: MISSING"
done
```

Confirm inline templates replaced with references:
```bash
grep -c "@./changelog-entry.md" skills/kata-complete-milestone/references/changelog-generator.md
grep -c "@./plan-template.md" skills/kata-plan-phase/references/planner-instructions.md
grep -c "@./verification-report.md" skills/kata-verify-work/references/verifier-instructions.md
```

Confirm existing @-references to summary-template.md and UAT-template.md still work (files still exist at same paths):
```bash
test -f skills/kata-execute-phase/references/summary-template.md && echo "summary-template: OK"
test -f skills/kata-verify-work/references/UAT-template.md && echo "UAT-template: OK"
```
  </verify>
  <done>Five standalone template files exist in their owning skill's references/ directories, each with a kata-template-schema HTML comment. Three source files (changelog-generator.md, planner-instructions.md, verifier-instructions.md) reference their extracted templates via @-reference instead of containing them inline.</done>
</task>

<task type="auto">
  <name>Task 2: Create resolve-template.sh resolution script</name>
  <files>skills/kata-execute-phase/scripts/resolve-template.sh</files>
  <action>
Create `skills/kata-execute-phase/scripts/resolve-template.sh` following the read-pref.sh resolution pattern from Phase 37.

**Script behavior:**
- Usage: `resolve-template.sh <template-name>`
- Returns: absolute path to the resolved template file (stdout)
- Resolution order: `.planning/templates/{name}.md` first, plugin default second
- Plugin default discovery: glob `skills/kata-*/references/{name}` across all skills using `CLAUDE_PLUGIN_ROOT` or script location discovery
- Exit 0 on success, exit 1 if template not found (with error to stderr)
- Use `set -euo pipefail`

**Key implementation details:**
- Check `.planning/templates/${TEMPLATE_NAME}` first. If exists, echo path and exit 0.
- For plugin default, derive `PLUGIN_ROOT` from `CLAUDE_PLUGIN_ROOT` env var or from script location: `$(cd "$(dirname "$0")/../.." && pwd)` (scripts/ -> kata-execute-phase/ -> skills/ is wrong; use `$(cd "$(dirname "$0")/../../.." && pwd)` to reach plugin root from skills/kata-execute-phase/scripts/)
- Glob `${PLUGIN_ROOT}/skills/kata-*/references/${TEMPLATE_NAME}` and return first match
- On no match: `echo "ERROR: Template not found: ${TEMPLATE_NAME}" >&2; exit 1`
- Make executable: `chmod +x`

Place in `skills/kata-execute-phase/scripts/` alongside existing `find-phase.sh`. Although this script is used by multiple skills, placing it in execute-phase keeps it co-located with the existing scripts directory pattern. Other skills will reference it by full path.
  </action>
  <verify>
```bash
# Test resolution with no project override (should find plugin default)
chmod +x skills/kata-execute-phase/scripts/resolve-template.sh
CLAUDE_PLUGIN_ROOT="$(pwd)" bash skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md

# Test resolution with project override
mkdir -p .planning/templates
echo "# Override" > .planning/templates/summary-template.md
CLAUDE_PLUGIN_ROOT="$(pwd)" bash skills/kata-execute-phase/scripts/resolve-template.sh summary-template.md
rm .planning/templates/summary-template.md
rmdir .planning/templates 2>/dev/null || true

# Test missing template (should exit 1)
CLAUDE_PLUGIN_ROOT="$(pwd)" bash skills/kata-execute-phase/scripts/resolve-template.sh nonexistent.md 2>/dev/null; echo "exit: $?"
```
  </verify>
  <done>resolve-template.sh exists, is executable, resolves project overrides first and plugin defaults second, and exits 1 for missing templates.</done>
</task>

</tasks>

<verification>
- All 5 template files exist as standalone files with schema comments
- 3 source files reference their extracted templates via @-reference
- resolve-template.sh resolves project override first, plugin default second
- No existing @-references broken (summary-template.md and UAT-template.md unchanged paths)
</verification>

<success_criteria>
- TMPL-01: Five templates exist as standalone files in skill references/ directories
- TMPL-03: Each template has kata-template-schema comment with required-fields
- TMPL-02 (partial): resolve-template.sh implements project-override-first, plugin-default-second resolution
</success_criteria>

<output>
After completion, create `.planning/phases/38-template-overrides/38-01-SUMMARY.md`
</output>
