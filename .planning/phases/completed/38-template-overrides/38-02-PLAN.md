---
phase: 38-template-overrides
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - skills/kata-execute-phase/references/phase-execute.md
  - skills/kata-complete-milestone/references/milestone-complete.md
  - skills/kata-verify-work/references/verify-work.md
  - skills/kata-plan-phase/SKILL.md
  - hooks/kata-template-drift.js
  - hooks/hooks.json
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "Placing a file at .planning/templates/summary-template.md causes kata-execute-phase to use the override instead of the plugin default"
    - "Placing a file at .planning/templates/changelog-entry.md causes kata-complete-milestone to use the override"
    - "Placing a file at .planning/templates/UAT-template.md causes kata-verify-work to use the override"
    - "Placing a file at .planning/templates/verification-report.md causes kata-verify-work to use the override"
    - "Session-start hook detects missing required fields in a project template override and emits a warning line"
    - "Session-start hook emits nothing when no .planning/templates/ directory exists"
    - "Session-start hook emits nothing when all required fields are present in project overrides"
  artifacts:
    - hooks/kata-template-drift.js
  key_links:
    - "phase-execute.md resolves summary-template.md via resolve-template.sh before spawning subagent"
    - "milestone-complete.md resolves changelog-entry.md via resolve-template.sh"
    - "verify-work.md resolves UAT-template.md and verification-report.md via resolve-template.sh"
    - "hooks.json registers kata-template-drift.js alongside existing statusline hook"
---

<objective>
Wire template resolution into the four orchestrator skills and create the session-start drift detection hook.

Purpose: Complete TMPL-02 (resolution wiring) and TMPL-04 (drift detection). After this plan, skills resolve templates through the override chain and users get warnings when their project template overrides are missing required fields.
Output: 4 skill reference files updated with resolution logic, 1 drift detection hook, hooks.json updated.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/38-template-overrides/38-RESEARCH.md

@skills/kata-execute-phase/references/phase-execute.md
@skills/kata-execute-phase/SKILL.md
@skills/kata-complete-milestone/references/milestone-complete.md
@skills/kata-complete-milestone/SKILL.md
@skills/kata-verify-work/references/verify-work.md
@skills/kata-verify-work/SKILL.md
@skills/kata-plan-phase/SKILL.md
@hooks/hooks.json
@hooks/kata-setup-statusline.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire template resolution into orchestrator skills</name>
  <files>
    skills/kata-execute-phase/references/phase-execute.md,
    skills/kata-complete-milestone/references/milestone-complete.md,
    skills/kata-verify-work/references/verify-work.md,
    skills/kata-plan-phase/SKILL.md
  </files>
  <action>
Update each orchestrator skill to resolve templates via `resolve-template.sh` BEFORE spawning subagents, then inline the resolved template content into the subagent prompt.

This follows the existing Kata subagent inlining pattern: orchestrators read reference files and inline their content into `Task()` prompts because `@` references don't work across Task() boundaries. Template resolution adds one step: resolve the path first (checking `.planning/templates/` override, then plugin default), then read and inline.

**kata-execute-phase (phase-execute.md):**

Modification point: `<step name="execute_waves">`, substep 2 "Read files and spawn all autonomous agents in wave simultaneously" (around line 226).

The current "Read files" block reads plan content, STATE, and config. Add template resolution to this block:

```bash
# Existing reads
PLAN_CONTENT=$(cat "{plan_path}")
STATE_CONTENT=$(cat .planning/STATE.md)
CONFIG_CONTENT=$(cat .planning/config.json 2>/dev/null)

# NEW: Resolve summary template (project override → plugin default)
SUMMARY_TEMPLATE_PATH=$(bash "${SKILL_BASE_DIR}/scripts/resolve-template.sh" "summary-template.md")
SUMMARY_TEMPLATE_CONTENT=$(cat "$SUMMARY_TEMPLATE_PATH")
```

Then in the subagent prompt template (lines 246-251), replace:
```
<execution_context>
@./execute-plan.md
@./summary-template.md
@./checkpoints.md
@./tdd.md
</execution_context>
```

With:
```
<execution_context>
@./execute-plan.md
@./checkpoints.md
@./tdd.md
</execution_context>

<summary_template>
{summary_template_content}
</summary_template>
```

The `@./execute-plan.md`, `@./checkpoints.md`, and `@./tdd.md` references stay as-is because those are NOT overridable templates. Only `summary-template.md` gets resolved and inlined.

**kata-complete-milestone (milestone-complete.md):**

Modification point: `<required_reading>` section (line 9) where `@./changelog-generator.md` is listed.

The changelog-generator.md reference itself references `@./changelog-entry.md`. Add a step BEFORE the changelog generation step in the `<process>`:

Add a new substep at the start of the changelog generation step:
```bash
# Resolve changelog entry template (project override → plugin default)
CHANGELOG_TEMPLATE_PATH=$(bash "${SKILL_BASE_DIR}/scripts/resolve-template.sh" "changelog-entry.md")
CHANGELOG_TEMPLATE_CONTENT=$(cat "$CHANGELOG_TEMPLATE_PATH")
```

Then where the changelog generator is invoked (the orchestrator reads changelog-generator.md and constructs a prompt), include the resolved template content in a `<changelog_template>` section of the subagent prompt instead of relying on the subagent's `@./changelog-entry.md` reference.

**kata-verify-work (verify-work.md):**

Two modification points:

1. **UAT template** — `<template>` section at line 17-19 where `@./UAT-template.md` appears.
   Add template resolution BEFORE the step that creates {phase}-UAT.md:
   ```bash
   UAT_TEMPLATE_PATH=$(bash "${SKILL_BASE_DIR}/scripts/resolve-template.sh" "UAT-template.md")
   UAT_TEMPLATE_CONTENT=$(cat "$UAT_TEMPLATE_PATH")
   ```
   Replace `@./UAT-template.md` reference in `<template>` with a note that the template content is resolved at runtime and available as `{uat_template_content}`.

2. **Verification report template** — Used by the verifier subagent spawned in phase-execute.md's `verify_phase_goal` step.
   Add resolution in the `resolve_model_profile` step of verify-work.md:
   ```bash
   VERIFICATION_TEMPLATE_PATH=$(bash "${SKILL_BASE_DIR}/scripts/resolve-template.sh" "verification-report.md")
   VERIFICATION_TEMPLATE_CONTENT=$(cat "$VERIFICATION_TEMPLATE_PATH")
   ```
   Inline into the verifier subagent prompt as `<verification_template>{verification_template_content}</verification_template>`.

**kata-plan-phase (SKILL.md):**

Modification point: Step 7 "Read Context Files" (line 310), where the orchestrator reads files for the planner subagent.

Add to the file read list:
```bash
# Resolve plan template (project override → plugin default)
PLAN_TEMPLATE_PATH=$(bash "${SKILL_BASE_DIR}/scripts/resolve-template.sh" "plan-template.md")
PLAN_TEMPLATE_CONTENT=$(cat "$PLAN_TEMPLATE_PATH")
```

Then in Step 8 "Spawn kata-planner Agent", add a `<plan_template>` section to the prompt that inlines the resolved content. The planner-instructions.md currently tells the planner to use the plan template format. The inlined content ensures the planner gets the project override if one exists.

**Variable resolution:**
- `SKILL_BASE_DIR` — Available in all skill contexts, points to the skill's directory (e.g., `skills/kata-execute-phase/`). The resolve-template.sh script is in `kata-execute-phase/scripts/` so all skills reference it via that path.
- `CLAUDE_PLUGIN_ROOT` — Env var set by plugin runtime. Used inside resolve-template.sh itself.

Do NOT change the template file locations. Do NOT remove the template files from references/. The resolution script handles finding them.
  </action>
  <verify>
Grep each modified file for the resolve-template.sh call:
```bash
grep -l "resolve-template.sh" skills/kata-execute-phase/references/phase-execute.md skills/kata-complete-milestone/references/milestone-complete.md skills/kata-verify-work/references/verify-work.md skills/kata-plan-phase/SKILL.md
# Expected: all 4 files listed
```

Confirm the static @-references to overridable templates are replaced with resolution patterns:
```bash
# Should NOT have bare @./summary-template.md in the subagent prompt section
grep -c "@./summary-template.md" skills/kata-execute-phase/references/phase-execute.md
# Expected: 0
# Should NOT have @./UAT-template.md as a bare reference in the template section
grep -c "@./UAT-template.md" skills/kata-verify-work/references/verify-work.md
# Expected: 0
```

Targeted resolution test (verify override chain works):
```bash
mkdir -p .planning/templates
echo "# Custom Summary" > .planning/templates/summary-template.md
RESOLVED=$(bash skills/kata-execute-phase/scripts/resolve-template.sh "summary-template.md")
echo "$RESOLVED" | grep -q ".planning/templates/summary-template.md" && echo "PASS: override resolved" || echo "FAIL: override not resolved"
rm .planning/templates/summary-template.md
rmdir .planning/templates 2>/dev/null || true
```
  </verify>
  <done>Four orchestrator skills resolve templates via resolve-template.sh before spawning subagents. Project template overrides at .planning/templates/{name}.md take precedence over plugin defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Create kata-template-drift.js session-start hook and register in hooks.json</name>
  <files>hooks/kata-template-drift.js, hooks/hooks.json</files>
  <action>
**Create hooks/kata-template-drift.js:**

Node.js session-start hook following the same pattern as `kata-setup-statusline.js`:
- Read JSON from stdin (SessionStart hook input with `cwd` field)
- Wrap all logic in try/catch with empty catch (silent failure)
- Use `import` syntax (ESM, matching existing hooks)

**Hook logic:**
1. Get `cwd` from stdin JSON. Get `CLAUDE_PLUGIN_ROOT` from env.
2. Check if `.planning/templates/` directory exists in cwd. If not, exit 0 silently (no overrides, no drift to check).
3. For each `.md` file in `.planning/templates/`:
   a. Find the corresponding plugin default by globbing `${PLUGIN_ROOT}/skills/kata-*/references/${filename}`
   b. Read the plugin default and parse its `<!-- kata-template-schema ... -->` comment
   c. Extract `required-fields.frontmatter` and `required-fields.body` arrays
   d. Read the project override file content
   e. For frontmatter required fields: check if each field name appears in the override's YAML frontmatter section (between `---` delimiters)
   f. For body required fields: check if each section name appears as a markdown heading or XML tag in the override content
   g. Collect missing fields
4. For each template with missing fields, emit one warning line to stdout:
   `[kata] Template drift: {filename} missing required field(s): {comma-separated fields}. Run resolve-template.sh for defaults.`
5. Emit nothing if no drift detected. At most one line per drifted template.

**Schema comment parsing (regex, not YAML parser):**
```javascript
function parseSchemaComment(content) {
  const match = content.match(/<!--\s*kata-template-schema\n([\s\S]*?)-->/);
  if (!match) return null;
  const schema = match[1];
  const required = { frontmatter: [], body: [] };

  // Match frontmatter required fields
  const fmSection = schema.match(/required-fields:\s*\n\s*frontmatter:\s*\[([^\]]*)\]/);
  if (fmSection) {
    required.frontmatter = fmSection[1].split(',').map(f => f.trim()).filter(Boolean);
  }

  // Match body required fields
  const bodySection = schema.match(/body:\s*\[([^\]]*)\]/);
  if (bodySection) {
    required.body = bodySection[1].split(',').map(f => f.trim()).filter(Boolean);
  }

  return required;
}
```

**Field presence checking:**
- Frontmatter: Parse content between first `---` pair, check if field name appears as a key
- Body: Check if section name appears anywhere in the content after the frontmatter (as heading, XML tag, or text)

**Update hooks/hooks.json:**
Add the drift detection hook as a second entry in the SessionStart hooks array:

```json
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          { "type": "command", "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/kata-setup-statusline.js" },
          { "type": "command", "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/kata-template-drift.js" }
        ]
      }
    ]
  }
}
```

Keep the existing description field in hooks.json.
  </action>
  <verify>
```bash
# Verify hook file exists and has correct structure
test -f hooks/kata-template-drift.js && echo "hook: EXISTS" || echo "hook: MISSING"
grep -c "kata-template-schema" hooks/kata-template-drift.js

# Verify hooks.json has both hooks
grep -c "kata-template-drift" hooks/hooks.json
grep -c "kata-setup-statusline" hooks/hooks.json

# Test hook with no .planning/templates/ (should emit nothing)
echo '{"cwd":"'"$(pwd)"'"}' | CLAUDE_PLUGIN_ROOT="$(pwd)" node hooks/kata-template-drift.js

# Test hook with a project override missing fields
mkdir -p .planning/templates
echo "# My Override" > .planning/templates/summary-template.md
echo '{"cwd":"'"$(pwd)"'"}' | CLAUDE_PLUGIN_ROOT="$(pwd)" node hooks/kata-template-drift.js
rm .planning/templates/summary-template.md
rmdir .planning/templates 2>/dev/null || true
```
  </verify>
  <done>kata-template-drift.js detects missing required fields in project template overrides and emits per-template warning lines. hooks.json registers the hook alongside the existing statusline hook. Hook is silent when no overrides exist or when all required fields are present.</done>
</task>

</tasks>

<verification>
- All four orchestrator skills contain resolve-template.sh calls:
  ```bash
  grep -l "resolve-template.sh" skills/kata-execute-phase/references/phase-execute.md skills/kata-complete-milestone/references/milestone-complete.md skills/kata-verify-work/references/verify-work.md skills/kata-plan-phase/SKILL.md
  # Expected: 4 files listed
  ```
- Static @-references to overridable templates are replaced with inlined resolved content:
  ```bash
  # summary-template.md should NOT appear as a bare @-reference in the subagent prompt section
  grep -c "@./summary-template.md" skills/kata-execute-phase/references/phase-execute.md
  # Expected: 0 (replaced with {summary_template_content} inline)
  ```
- Targeted resolution test (override chain works end-to-end):
  ```bash
  # Create a project override
  mkdir -p .planning/templates
  echo "# Custom Summary" > .planning/templates/summary-template.md
  # Resolve — should return the override path
  RESOLVED=$(bash skills/kata-execute-phase/scripts/resolve-template.sh "summary-template.md")
  echo "$RESOLVED" | grep -q ".planning/templates/summary-template.md" && echo "PASS: override resolved" || echo "FAIL: override not resolved"
  # Clean up
  rm .planning/templates/summary-template.md
  rmdir .planning/templates 2>/dev/null || true
  ```
- Session-start hook warns when a project override is missing required fields from the schema comment
- Hook emits nothing when no `.planning/templates/` exists
- Hook emits nothing when all fields are present
- hooks.json has both SessionStart hooks registered
</verification>

<success_criteria>
- TMPL-02: Template resolution checks .planning/templates/{name}.md first, falls back to plugin default
- TMPL-04: Session-start hook detects drift and emits warnings for missing required fields
- Skills that use templates resolve project-override-first, plugin-default-second
</success_criteria>

<output>
After completion, create `.planning/phases/38-template-overrides/38-02-SUMMARY.md`
</output>
