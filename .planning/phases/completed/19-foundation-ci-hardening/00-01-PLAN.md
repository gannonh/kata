---
phase: 00-foundation-ci-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/artifact-validation.test.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Built artifacts contain correctly transformed subagent_type references"
    - "No stale @~/.claude/ patterns exist in built plugin"
    - "@./references/ paths in skills resolve to existing files"
    - "Skill and agent frontmatter is valid in built artifacts"
  artifacts:
    - path: "tests/artifact-validation.test.js"
      provides: "Comprehensive artifact validation test suite"
      min_lines: 100
  key_links:
    - from: "tests/artifact-validation.test.js"
      to: "dist/plugin/"
      via: "fs.existsSync and content assertions"
      pattern: "dist/plugin"
---

<objective>
Create a dedicated artifact validation test suite that runs against the built `dist/plugin/` directory.

Purpose: Current tests validate source files or run partial checks on built output. We need comprehensive validation that the actual artifacts users install are correct.

Output: New test file `tests/artifact-validation.test.js` with complete validation of plugin artifacts.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Key files to reference:
- scripts/build.js (lines 157-162 show the subagent_type transform)
- tests/build.test.js (existing build tests for patterns)
- tests/smoke.test.js (existing smoke tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create artifact-validation.test.js</name>
  <files>tests/artifact-validation.test.js</files>
  <action>
Create a new test file that validates the built plugin artifacts:

1. **Structure validation**
   - dist/plugin/ exists
   - Required directories: .claude-plugin, skills, agents, commands, hooks
   - VERSION file exists and matches package.json version
   - plugin.json exists with name, version, description

2. **Path transformation validation**
   - All subagent_type attributes have "kata:" prefix (kata:kata-planner, etc.)
   - No @~/.claude/ references in any .md file (except CHANGELOG.md)
   - No @$KATA_BASE/ patterns (Claude cannot substitute variables)

3. **Reference resolution validation**
   - For each skill, @./references/ paths resolve to existing files in that skill's directory
   - Agents don't have broken @./ references

4. **Frontmatter validation**
   - All SKILL.md files have name and description in frontmatter
   - All agent .md files have description in frontmatter

Use pattern from build.test.js for recursive directory scanning. Tests must run AFTER build (use before() hook to run npm run build:plugin).

Test file should be standalone (not mixed with build.test.js) to make CI ordering clear.
  </action>
  <verify>
Run: `node --test tests/artifact-validation.test.js`
All tests pass.
  </verify>
  <done>artifact-validation.test.js exists with 4+ test sections covering structure, paths, references, and frontmatter</done>
</task>

<task type="auto">
  <name>Task 2: Add test:artifacts script to package.json</name>
  <files>package.json</files>
  <action>
Add a new script to package.json:

```json
"test:artifacts": "node --test --test-reporter spec ./tests/artifact-validation.test.js"
```

This script runs only the artifact validation tests. It assumes build has already been run.

Also update test:all to include artifact validation:
```json
"test:all": "node --test --test-reporter spec ./tests/build.test.js ./tests/smoke.test.js ./tests/artifact-validation.test.js"
```

The artifact tests must run AFTER build, so they're separate from the main test script.
  </action>
  <verify>
Run: `npm run build:plugin && npm run test:artifacts`
Tests execute and pass.
  </verify>
  <done>package.json has test:artifacts script and test:all includes artifact validation</done>
</task>

</tasks>

<verification>
- [ ] `npm run build:plugin` succeeds
- [ ] `npm run test:artifacts` runs and passes
- [ ] Tests fail if a subagent_type is missing kata: prefix
- [ ] Tests fail if @~/.claude/ reference exists in built plugin
- [ ] Tests fail if @./references/ path doesn't resolve
</verification>

<success_criteria>
Artifact validation test suite exists and validates:
1. Plugin structure (directories, VERSION, plugin.json)
2. Path transformations (subagent_type kata: prefix)
3. No stale path patterns (@~/.claude/, @$KATA_BASE/)
4. Reference resolution (@./references/ paths exist)
5. Frontmatter presence (name, description)
</success_criteria>

<output>
After completion, create `.planning/phases/00-foundation-ci-hardening/00-01-SUMMARY.md`
</output>
