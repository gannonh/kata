---
phase: 00-foundation-ci-hardening
plan: 02
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - .github/workflows/plugin-release.yml
autonomous: true

must_haves:
  truths:
    - "CI runs artifact validation BEFORE creating GitHub Release"
    - "Build failures block release creation"
    - "Artifact validation failures block release creation"
  artifacts:
    - path: ".github/workflows/plugin-release.yml"
      provides: "CI workflow with correct step ordering"
      contains: "test:artifacts"
  key_links:
    - from: ".github/workflows/plugin-release.yml"
      to: "tests/artifact-validation.test.js"
      via: "npm run test:artifacts"
      pattern: "test:artifacts"
---

<objective>
Reorder the plugin-release.yml workflow to validate artifacts BEFORE creating the GitHub Release.

Purpose: Currently the workflow creates a GitHub Release before running full validation. If validation fails after release, we have a bad release in the wild. We need: tests -> build -> validate artifacts -> create release -> publish.

Output: Updated .github/workflows/plugin-release.yml with correct step ordering.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/00-foundation-ci-hardening/00-01-PLAN.md

Current workflow order (from plugin-release.yml):
1. Get versions
2. Check if should publish
3. **Create GitHub Release** (too early!)
4. Run tests
5. Build plugin distribution
6. Validate plugin build (basic)
7. Checkout marketplace
8. Update marketplace
9. Commit and push
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder workflow steps</name>
  <files>.github/workflows/plugin-release.yml</files>
  <action>
Reorder the plugin-release.yml workflow steps to:

1. Checkout kata
2. Setup Node.js
3. Get plugin version
4. Get marketplace version
5. Check if should publish
6. **Run tests** (npm test - source validation)
7. **Build hooks** (npm run build:hooks)
8. **Build plugin** (node scripts/build.js plugin)
9. **Run artifact validation** (npm run test:artifacts)
10. Create GitHub Release (NOW safe - artifacts validated)
11. Checkout marketplace
12. Update marketplace with plugin files
13. Commit and push to marketplace

Key changes:
- Move "Run tests" before build
- Add "Run artifact validation" step after build
- Move "Create GitHub Release" to AFTER artifact validation passes
- Combine build:hooks and build:plugin into logical sequence

The artifact validation step should:
```yaml
- name: Validate plugin artifacts
  if: steps.check.outputs.should_publish == 'true'
  run: npm run test:artifacts
```

Keep the basic validation step as a quick sanity check, but the comprehensive artifact tests are the gate before release.
  </action>
  <verify>
Review the workflow file. Steps should be in order:
tests -> build:hooks -> build:plugin -> test:artifacts -> create release -> publish

Verify with: `cat .github/workflows/plugin-release.yml | grep -E "^\s+- name:"`
  </verify>
  <done>Workflow steps are reordered with artifact validation before release creation</done>
</task>

<task type="auto">
  <name>Task 2: Ensure build failures block release</name>
  <files>.github/workflows/plugin-release.yml</files>
  <action>
Verify that all steps have proper `if` conditions and that failures cascade correctly:

1. All test/build/validate steps should have `if: steps.check.outputs.should_publish == 'true'`
2. If any step fails, subsequent steps (including Create GitHub Release) should NOT run

GitHub Actions default behavior: if a step fails, subsequent steps don't run. But verify:
- No `continue-on-error: true` on critical steps
- The release step depends on all prior steps succeeding

This is mostly verification that the reordering from Task 1 is correct and no error-suppression is present.
  </action>
  <verify>
Grep for continue-on-error: `grep -n "continue-on-error" .github/workflows/plugin-release.yml`
Should return empty (no error suppression on critical steps).
  </verify>
  <done>No continue-on-error on critical steps, failures properly cascade</done>
</task>

</tasks>

<verification>
- [ ] Workflow steps are in correct order: tests -> build -> validate -> release
- [ ] "Validate plugin artifacts" step exists and runs test:artifacts
- [ ] No continue-on-error on test/build/validate steps
- [ ] Create GitHub Release step comes AFTER artifact validation
</verification>

<success_criteria>
The plugin-release.yml workflow:
1. Runs source tests first (npm test)
2. Builds hooks and plugin
3. Validates artifacts (npm run test:artifacts)
4. Creates GitHub Release only after all validation passes
5. Build or validation failures prevent release creation
</success_criteria>

<output>
After completion, create `.planning/phases/00-foundation-ci-hardening/00-02-SUMMARY.md`
</output>
