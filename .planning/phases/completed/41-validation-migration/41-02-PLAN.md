---
phase: 41-validation-migration
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - skills/kata-execute-phase/SKILL.md
  - skills/kata-plan-phase/SKILL.md
  - skills/kata-complete-milestone/SKILL.md
  - skills/kata-add-milestone/SKILL.md
  - skills/kata-verify-work/SKILL.md
  - scripts/build.js
  - package.json
  - hooks/hooks.json
  - hooks/kata-template-drift.js
  - hooks/kata-config-validator.js
  - scripts/build-hooks.cjs
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "kata-execute-phase SKILL.md pre-flight calls check-config.sh and check-template-drift.sh after the roadmap format check"
    - "kata-plan-phase SKILL.md pre-flight calls check-config.sh and check-template-drift.sh after the roadmap format check"
    - "kata-complete-milestone SKILL.md pre-flight calls check-config.sh and check-template-drift.sh after the roadmap format check"
    - "kata-add-milestone SKILL.md pre-flight calls check-config.sh after the roadmap format check"
    - "kata-verify-work SKILL.md has a new pre-flight step calling check-config.sh and check-template-drift.sh"
    - "hooks/hooks.json is deleted"
    - "hooks/kata-template-drift.js is deleted"
    - "hooks/kata-config-validator.js is deleted"
    - "hooks/ directory is deleted"
    - "scripts/build-hooks.cjs is deleted"
    - "scripts/build.js INCLUDES array no longer contains 'hooks'"
    - "package.json scripts no longer contain build:hooks or prepublishOnly"
    - "npm run build:plugin succeeds without errors"
    - "dist/plugin/ does not contain a hooks/ directory"
  artifacts:
    - skills/kata-execute-phase/SKILL.md
    - skills/kata-plan-phase/SKILL.md
    - skills/kata-complete-milestone/SKILL.md
    - skills/kata-add-milestone/SKILL.md
    - skills/kata-verify-work/SKILL.md
  key_links:
    - "Pre-flight calls use ${SKILL_BASE_DIR}/../kata-doctor/scripts/check-config.sh pattern (same as check-roadmap-format.sh)"
    - "Template drift check added only to skills that resolve templates: kata-execute-phase, kata-plan-phase, kata-complete-milestone, kata-verify-work"
    - "Config check added to all 5 orchestrator skills that read config values"
---

<objective>
Wire the validation scripts from Plan 01 into skill pre-flight sections, then remove the SessionStart hooks and associated build infrastructure.

Purpose: Complete the migration by connecting the new scripts to skills that need them and removing the old hook system. After this plan, validation runs inside skills (universally) and the hooks system is gone.
Output: Modified SKILL.md files with pre-flight calls, deleted hooks directory and build-hooks script.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/41-validation-migration/41-RESEARCH.md

@skills/kata-execute-phase/SKILL.md
@skills/kata-plan-phase/SKILL.md
@skills/kata-complete-milestone/SKILL.md
@skills/kata-add-milestone/SKILL.md
@skills/kata-verify-work/SKILL.md
@scripts/build.js
@package.json
@hooks/hooks.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation pre-flight calls to 5 skills</name>
  <files>skills/kata-execute-phase/SKILL.md, skills/kata-plan-phase/SKILL.md, skills/kata-complete-milestone/SKILL.md, skills/kata-add-milestone/SKILL.md, skills/kata-verify-work/SKILL.md</files>
  <action>
Add validation script calls to the pre-flight sections of 5 skills. Use the same calling pattern as the existing `check-roadmap-format.sh` calls.

**For skills WITH existing roadmap format check (4 skills):**

Add two lines after the `fi` that closes the roadmap format check block, before the next step. The exact lines to add:

```bash
# Validate config and template overrides
bash "${SKILL_BASE_DIR}/../kata-doctor/scripts/check-config.sh" 2>/dev/null || true
bash "${SKILL_BASE_DIR}/../kata-doctor/scripts/check-template-drift.sh" 2>/dev/null || true
```

The `|| true` ensures the pre-flight never fails even if the script itself has an unexpected error (belt and suspenders with the script's own `exit 0`).

Skills and what they get:

1. **kata-execute-phase/SKILL.md** — Add both `check-config.sh` and `check-template-drift.sh` after the roadmap format check block (this skill reads config and resolves templates)

2. **kata-plan-phase/SKILL.md** — Add both `check-config.sh` and `check-template-drift.sh` after the roadmap format check block (this skill reads config and resolves templates)

3. **kata-complete-milestone/SKILL.md** — Add both `check-config.sh` and `check-template-drift.sh` after the roadmap format check block (this skill reads config and resolves templates)

4. **kata-add-milestone/SKILL.md** — Add only `check-config.sh` after the roadmap format check block (this skill reads config but does not resolve templates)

**For kata-verify-work/SKILL.md (no existing pre-flight):**

Add a new step between the existing `<context>` section end and `<process>` start. Insert a pre-flight section:

```markdown
<pre_flight>
Run validation checks before starting verification:

```bash
# Validate config and template overrides
bash "${SKILL_BASE_DIR}/../kata-doctor/scripts/check-config.sh" 2>/dev/null || true
bash "${SKILL_BASE_DIR}/../kata-doctor/scripts/check-template-drift.sh" 2>/dev/null || true
```

If warnings are printed, relay them to the user before proceeding with verification.
</pre_flight>
```

Insert this block between `</context>` and `<process>`.

**Do NOT:**
- Modify any other part of the skill files
- Change the roadmap format check logic
- Add `check-template-drift.sh` to kata-add-milestone (it doesn't resolve templates)
  </action>
  <verify>
```bash
# Verify all 5 skills have check-config.sh calls
for skill in kata-execute-phase kata-plan-phase kata-complete-milestone kata-add-milestone kata-verify-work; do
  grep -q "check-config.sh" "skills/${skill}/SKILL.md" && echo "OK: ${skill} has config check" || echo "FAIL: ${skill} missing config check"
done

# Verify 4 template-using skills have check-template-drift.sh calls
for skill in kata-execute-phase kata-plan-phase kata-complete-milestone kata-verify-work; do
  grep -q "check-template-drift.sh" "skills/${skill}/SKILL.md" && echo "OK: ${skill} has drift check" || echo "FAIL: ${skill} missing drift check"
done

# Verify kata-add-milestone does NOT have template drift check
grep -q "check-template-drift.sh" "skills/kata-add-milestone/SKILL.md" && echo "FAIL: kata-add-milestone has drift check (shouldn't)" || echo "OK: kata-add-milestone correctly omits drift check"

# Verify kata-verify-work has pre_flight section
grep -q "pre_flight" "skills/kata-verify-work/SKILL.md" && echo "OK: verify-work has pre_flight" || echo "FAIL: verify-work missing pre_flight"
```
  </verify>
  <done>All 5 skills call check-config.sh. The 4 template-using skills also call check-template-drift.sh. kata-add-milestone omits the drift check. kata-verify-work has a new pre_flight section. All calls use the ${SKILL_BASE_DIR}/../kata-doctor/scripts/ pattern with 2>/dev/null || true.</done>
</task>

<task type="auto">
  <name>Task 2: Remove hooks and clean up build infrastructure</name>
  <files>hooks/hooks.json, hooks/kata-template-drift.js, hooks/kata-config-validator.js, scripts/build-hooks.cjs, scripts/build.js, package.json</files>
  <action>
Remove the SessionStart hooks and all associated build infrastructure.

**Step 1: Delete hook files**
```bash
rm hooks/kata-template-drift.js
rm hooks/kata-config-validator.js
rm hooks/hooks.json
rmdir hooks
```

Delete the entire `hooks/` directory and all three files.

**Step 2: Delete build-hooks script**
```bash
rm scripts/build-hooks.cjs
```

This script only copied a file that doesn't exist (`kata-check-update.js`). Dead code.

**Step 3: Update scripts/build.js**

Remove `'hooks'` from the INCLUDES array. Change:
```js
const INCLUDES = [
  'skills',
  'hooks',
  'CHANGELOG.md',
];
```
To:
```js
const INCLUDES = [
  'skills',
  'CHANGELOG.md',
];
```

Also remove the hooks-specific exclusion comment and logic at line 113:
```js
    // Skip hooks/dist - it's for npm publishing only
    if (entry.name === 'dist' && src.includes('hooks')) continue;
```
Remove these two lines since the hooks directory no longer exists.

**Step 4: Update package.json**

Remove `"build:hooks"` and `"prepublishOnly"` from the scripts section. Change:
```json
"build:hooks": "node scripts/build-hooks.cjs",
"prepublishOnly": "npm run build:hooks"
```
To: (delete both lines entirely)

**Do NOT:**
- Remove any other scripts from package.json
- Modify any other lines in build.js
- Leave any hooks/ references in the codebase
  </action>
  <verify>
```bash
# Verify hooks directory is gone
[ -d hooks ] && echo "FAIL: hooks/ still exists" || echo "OK: hooks/ removed"

# Verify build-hooks.cjs is gone
[ -f scripts/build-hooks.cjs ] && echo "FAIL: build-hooks.cjs still exists" || echo "OK: build-hooks.cjs removed"

# Verify build.js doesn't reference hooks
grep -c "'hooks'" scripts/build.js && echo "FAIL: build.js still has hooks" || echo "OK: build.js clean"

# Verify package.json doesn't reference build:hooks
grep -c "build:hooks" package.json && echo "FAIL: package.json still has build:hooks" || echo "OK: package.json clean"
grep -c "prepublishOnly" package.json && echo "FAIL: package.json still has prepublishOnly" || echo "OK: package.json clean"

# Build succeeds
npm run build:plugin && echo "OK: build succeeds" || echo "FAIL: build broken"

# dist/plugin/ has no hooks directory
[ -d dist/plugin/hooks ] && echo "FAIL: dist has hooks/" || echo "OK: dist clean"

# dist/plugin/ has the new validation scripts
[ -f dist/plugin/skills/kata-doctor/scripts/check-config.sh ] && echo "OK: config script in dist" || echo "FAIL: missing config script in dist"
[ -f dist/plugin/skills/kata-doctor/scripts/check-template-drift.sh ] && echo "OK: drift script in dist" || echo "FAIL: missing drift script in dist"
```
  </verify>
  <done>hooks/ directory deleted. scripts/build-hooks.cjs deleted. build.js INCLUDES no longer contains 'hooks'. package.json no longer contains build:hooks or prepublishOnly. npm run build:plugin succeeds. dist/plugin/ contains no hooks directory. dist/plugin/ contains both new validation scripts.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full validation migration works end-to-end</name>
  <what-built>Wired check-config.sh and check-template-drift.sh into 5 skills' pre-flight sections. Deleted the SessionStart hooks directory, hooks.json, and build-hooks.cjs. Updated build.js and package.json to remove hooks references. Validation now runs inside skills universally for plugin and skills-only users.</what-built>
  <how-to-verify>
1. Confirm build succeeds and dist is clean:
   ```bash
   npm run build:plugin
   ls dist/plugin/hooks 2>/dev/null && echo "FAIL" || echo "OK: no hooks in dist"
   ls dist/plugin/skills/kata-doctor/scripts/check-*.sh
   ```
2. Confirm no CLAUDE_PLUGIN_ROOT references in new scripts:
   ```bash
   grep -r "CLAUDE_PLUGIN_ROOT" skills/kata-doctor/scripts/check-*.sh && echo "FAIL" || echo "OK"
   ```
3. Confirm hooks directory is fully removed:
   ```bash
   [ -d hooks ] && echo "FAIL" || echo "OK"
   ```
4. Run existing tests to check for regressions:
   ```bash
   npm test
   ```
  </how-to-verify>
  <resume-signal>Say "verified" to continue or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- 5 skills have validation pre-flight calls using ${SKILL_BASE_DIR}/../kata-doctor/scripts/ pattern
- 4 template-using skills call both check-config.sh and check-template-drift.sh
- kata-add-milestone calls only check-config.sh (does not resolve templates)
- kata-verify-work has a new pre_flight section (did not have one before)
- hooks/ directory fully deleted (3 files + directory)
- scripts/build-hooks.cjs deleted
- build.js INCLUDES cleaned of 'hooks' entry
- package.json scripts cleaned of build:hooks and prepublishOnly
- npm run build:plugin produces clean dist without hooks/
- dist/plugin/ includes both validation scripts via kata-doctor/scripts/
</verification>

<success_criteria>
- VAL-01: Template drift detection runs in skills (not SessionStart hooks)
- VAL-02: Config validation runs in skills (not SessionStart hooks)
- VAL-03: Validation works universally for plugin + skills-only users
- VAL-04: SessionStart hooks removed after validation migration complete
</success_criteria>

<output>
After completion, create `.planning/phases/active/41-validation-migration/41-02-SUMMARY.md`
</output>
