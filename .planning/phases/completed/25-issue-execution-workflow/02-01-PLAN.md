---
phase: 02-issue-execution-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/check-issues/SKILL.md
  - skills/execute-quick-task/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Work on it now presents mode selection (Quick task vs Planned)"
    - "Quick task mode accepts issue context and threads it through execution"
    - "Quick task PR includes Closes #X for the source issue"
    - "pr_workflow=false closes issue directly via gh issue close"
  artifacts:
    - path: "skills/check-issues/SKILL.md"
      provides: "Mode selection in Work on it now action"
      contains: "Quick task"
    - path: "skills/execute-quick-task/SKILL.md"
      provides: "Issue context acceptance and PR creation"
      contains: "ISSUE_NUMBER"
  key_links:
    - from: "skills/check-issues/SKILL.md"
      to: "skills/execute-quick-task/SKILL.md"
      via: "issue file path parameter"
      pattern: "ISSUE_FILE"
    - from: "skills/execute-quick-task/SKILL.md"
      to: "gh pr create"
      via: "PR body with Closes #X"
      pattern: "Closes #"
---

<objective>
Add execution mode selection to "Work on it now" and enhance quick task execution with issue context threading and PR creation.

Purpose: Enable direct issue execution via quick task mode with automatic PR creation that closes the source issue (EXEC-01, EXEC-02).

Output: Modified check-issues and execute-quick-task skills supporting issue-driven quick task workflow.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-issue-execution-workflow/02-RESEARCH.md
@.planning/phases/01-pr-issue-closure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode selection to "Work on it now" action</name>
  <files>skills/check-issues/SKILL.md</files>
  <action>
Modify the "Work on it now" actions in the `offer_actions` step of check-issues/SKILL.md.

**For open local issues and GitHub-only issues**, replace the current "Work on it now" option with a mode selection flow:

1. When user selects "Work on it now", present mode selection via AskUserQuestion:
   - header: "Execution Mode"
   - question: "How would you like to work on this issue?"
   - options:
     - "Quick task" — Small fix, execute now with commits + PR
     - "Planned" — Create phase or link to existing phase
     - "Put it back" — Return to issue list

2. Store the selected mode for use in execute_action step.

**In the `execute_action` step**, add handling for the mode selection:

**If "Quick task" mode selected:**
- Move issue to in-progress (existing behavior)
- Add in-progress label to GitHub (existing behavior)
- Store issue file path as `$ISSUE_FILE`
- Display: "Starting quick task execution for issue..."
- Route to `/kata:execute-quick-task --issue "$ISSUE_FILE"` (next task will implement this)

**If "Planned" mode selected:**
- Keep issue in current state (do NOT move to in-progress yet)
- Display message:
  ```
  ## Planned Execution

  This issue will be addressed through phase planning.

  **Next steps:**
  - Use `/kata:plan-phase` to create a phase that includes this issue
  - Or link this issue to an existing phase in ROADMAP.md

  Full planned execution workflow coming in Plan 02-02.
  ```
- Do NOT route anywhere yet (Plan 02-02 will implement full planned mode flow)
- Return to issue list or end gracefully

**Why this approach:** Mode selection happens BEFORE moving to in-progress. Quick task moves immediately, planned mode waits for phase linkage. The planned mode stub provides clear guidance while Plan 02-02 is pending.
  </action>
  <verify>
# Check AskUserQuestion structure exists for mode selection
grep -A10 "Work on it now" skills/check-issues/SKILL.md | grep -q "AskUserQuestion" && echo "PASS: AskUserQuestion structure" || echo "FAIL: AskUserQuestion structure"

# Check header text
grep -q "Execution Mode" skills/check-issues/SKILL.md && echo "PASS: Execution Mode header" || echo "FAIL: Execution Mode header"

# Check both mode options present
grep -A20 "Execution Mode" skills/check-issues/SKILL.md | grep -q "Quick task" && echo "PASS: Quick task option" || echo "FAIL: Quick task option"
grep -A20 "Execution Mode" skills/check-issues/SKILL.md | grep -q "Planned" && echo "PASS: Planned option" || echo "FAIL: Planned option"

# Check routing to execute-quick-task
grep -q "execute-quick-task" skills/check-issues/SKILL.md && echo "PASS: Quick task routing" || echo "FAIL: Quick task routing"

# Check planned mode stub message
grep -q "Planned Execution" skills/check-issues/SKILL.md && echo "PASS: Planned mode stub" || echo "FAIL: Planned mode stub"
  </verify>
  <done>
- "Work on it now" presents mode selection with Quick task vs Planned options via AskUserQuestion
- Quick task mode routes to execute-quick-task with issue file path
- Planned mode displays guidance message and returns gracefully (stub for Plan 02-02)
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance execute-quick-task with issue context and PR creation</name>
  <files>skills/execute-quick-task/SKILL.md</files>
  <action>
Modify execute-quick-task/SKILL.md to accept optional issue context and create PRs.

**Step 1.5 (NEW): Parse issue argument**

Add after Step 1 (Pre-flight validation):

```markdown
**Step 1.5: Parse issue argument (optional)**

Check for issue file path argument:

```bash
ISSUE_FILE=""
ISSUE_NUMBER=""
ISSUE_TITLE=""

# Check for --issue flag
if echo "$ARGUMENTS" | grep -q -- "--issue"; then
  ISSUE_FILE=$(echo "$ARGUMENTS" | grep -oE '\-\-issue [^ ]+' | cut -d' ' -f2)

  if [ -f "$ISSUE_FILE" ]; then
    # Extract issue metadata
    ISSUE_TITLE=$(grep "^title:" "$ISSUE_FILE" | cut -d':' -f2- | xargs)
    PROVENANCE=$(grep "^provenance:" "$ISSUE_FILE" | cut -d' ' -f2)

    if echo "$PROVENANCE" | grep -q "^github:"; then
      ISSUE_NUMBER=$(echo "$PROVENANCE" | grep -oE '#[0-9]+' | tr -d '#')
    fi

    # Extract problem section for context
    ISSUE_PROBLEM=$(sed -n '/^## Problem/,/^## /p' "$ISSUE_FILE" | tail -n +2 | head -n -1)
  fi
fi
```

If `ISSUE_FILE` provided but file not found: error and exit.
If `ISSUE_FILE` provided and valid: Use issue title as description (skip Step 2 prompt).
```

**Step 2: Conditional description prompt**

Modify Step 2 to skip the prompt if issue context provided:

```markdown
**Step 2: Get task description**

**If `$ISSUE_FILE` is set:**
```
DESCRIPTION="$ISSUE_TITLE"
echo "Using issue title: $DESCRIPTION"
```

Skip the AskUserQuestion prompt.

**If no issue context:**
[existing prompt behavior]
```

**Step 5: Pass issue context to planner**

Add issue context to the planner Task prompt (inside the planning_context section):

```markdown
**Issue Context (if from issue):**
${ISSUE_FILE:+Issue: $ISSUE_FILE}
${ISSUE_NUMBER:+GitHub Issue: #$ISSUE_NUMBER}
${ISSUE_PROBLEM:+Problem:\n$ISSUE_PROBLEM}
```

**Step 7.5 (NEW): Create PR with issue closure**

Add after Step 7 (Update STATE.md) and before Step 8:

```markdown
**Step 7.5: Create PR with issue closure (if issue-driven)**

**Check pr_workflow config:**
```bash
PR_WORKFLOW=$(cat .planning/config.json 2>/dev/null | grep -o '"pr_workflow"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
```

**If `$ISSUE_NUMBER` is set (issue-driven quick task):**

**If `PR_WORKFLOW=true`:**
```bash
# Create branch for this quick task
BRANCH="fix/quick-${next_num}-${slug}"
git checkout -b "$BRANCH"

# Push branch
git push -u origin "$BRANCH"

# Build PR body
cat > /tmp/quick-pr-body.md << PR_EOF
## Summary

Completes issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

## Changes

Quick task ${next_num}: ${DESCRIPTION}

See: ${QUICK_DIR}/${next_num}-SUMMARY.md

Closes #${ISSUE_NUMBER}
PR_EOF

# Create PR
gh pr create \
  --title "fix: ${ISSUE_TITLE}" \
  --body-file /tmp/quick-pr-body.md

echo "PR created with Closes #${ISSUE_NUMBER}"
```

**If `PR_WORKFLOW=false`:**
```bash
# Close issue directly (no PR workflow)
gh issue close "$ISSUE_NUMBER" --comment "Completed via quick task ${next_num}"
echo "Issue #${ISSUE_NUMBER} closed directly (pr_workflow=false)"
```

**If no `$ISSUE_NUMBER`:**
Skip PR creation (standard quick task, not issue-driven).
```

**Update success_criteria:**
Add:
- [ ] Issue context parsed from --issue flag (if provided)
- [ ] PR created with `Closes #X` (if issue-driven and pr_workflow=true)
- [ ] Issue closed directly (if issue-driven and pr_workflow=false)
  </action>
  <verify>
grep -q "ISSUE_FILE" skills/execute-quick-task/SKILL.md
grep -q "ISSUE_NUMBER" skills/execute-quick-task/SKILL.md
grep -q "Closes #" skills/execute-quick-task/SKILL.md
grep -q "PR_WORKFLOW" skills/execute-quick-task/SKILL.md
grep -q "gh issue close" skills/execute-quick-task/SKILL.md
  </verify>
  <done>
- execute-quick-task accepts --issue flag with issue file path
- Issue metadata (title, number, problem) extracted and used
- PR created with `Closes #X` when pr_workflow=true
- Issue closed directly when pr_workflow=false
- Non-issue quick tasks unchanged (backward compatible)
  </done>
</task>

</tasks>

<verification>
After both tasks:

```bash
# Verify mode selection added with proper structure
grep -A10 "Work on it now" skills/check-issues/SKILL.md | grep -q "AskUserQuestion" && echo "PASS: Mode selection structure" || echo "FAIL: Mode selection structure"
grep -q "Execution Mode" skills/check-issues/SKILL.md && echo "PASS: Mode header" || echo "FAIL: Mode header"
grep -q "execute-quick-task" skills/check-issues/SKILL.md && echo "PASS: Quick task routing" || echo "FAIL: Quick task routing"

# Verify issue context handling
grep -q "ISSUE_FILE" skills/execute-quick-task/SKILL.md && echo "PASS: Issue context" || echo "FAIL: Issue context"

# Verify PR closure pattern
grep -q "Closes #" skills/execute-quick-task/SKILL.md && echo "PASS: PR closure" || echo "FAIL: PR closure"

# Verify pr_workflow=false handling
grep -q "gh issue close" skills/execute-quick-task/SKILL.md && echo "PASS: Direct closure" || echo "FAIL: Direct closure"
```
</verification>

<success_criteria>
- [ ] EXEC-01: "Work on it now" offers Quick task vs Planned mode selection via AskUserQuestion
- [ ] EXEC-01: Planned mode displays guidance message (stub for Plan 02-02)
- [ ] EXEC-02: Quick task accepts issue context via --issue flag
- [ ] EXEC-02: Issue metadata threaded through planner/executor
- [ ] EXEC-02: PR created with `Closes #X` (pr_workflow=true)
- [ ] EXEC-02: Issue closed directly (pr_workflow=false)
- [ ] Backward compatible: Non-issue quick tasks work unchanged
- [ ] All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-issue-execution-workflow/02-01-SUMMARY.md`
</output>
