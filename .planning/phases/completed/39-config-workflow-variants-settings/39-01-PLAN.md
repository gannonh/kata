---
phase: 39-config-workflow-variants-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-configure-settings/scripts/read-pref.sh
  - hooks/kata-config-validator.js
  - hooks/hooks.json
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "DEFAULTS table in read-pref.sh contains entries for all workflow config keys"
    - "kata-config-validator.js validates config.json on session start"
    - "Unknown config keys produce warnings, not errors"
    - "Invalid value types produce errors"
    - "Validator always exits 0 (never blocks session start)"
    - "hooks.json registers kata-config-validator.js as SessionStart hook"
  artifacts:
    - hooks/kata-config-validator.js
    - hooks/hooks.json
    - skills/kata-configure-settings/scripts/read-pref.sh
  key_links:
    - "Validator KNOWN_KEYS map matches the full config schema including new workflows section"
    - "DEFAULTS table entries for workflow keys return sensible fallback values via read-pref.sh"
---

<objective>
Define the `workflows` config schema in the DEFAULTS table and create a session-start config validator hook.

Purpose: Establish the schema foundation that Plan 02 (skill wiring) and Plan 03 (settings UI) depend on. After this plan, `read-pref.sh` can resolve all workflow config keys, and session-start validation catches typos and invalid types.
Output: Updated DEFAULTS table, new kata-config-validator.js hook, updated hooks.json registration.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/39-config-workflow-variants-settings/39-RESEARCH.md

@skills/kata-configure-settings/scripts/read-pref.sh
@hooks/hooks.json
@hooks/kata-template-drift.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workflow config keys to DEFAULTS table in read-pref.sh</name>
  <files>skills/kata-configure-settings/scripts/read-pref.sh</files>
  <action>
Add the following entries to the DEFAULTS object in `read-pref.sh`, after the existing `github.issueMode` entry:

```javascript
'workflows.execute-phase.post_task_command': '',
'workflows.execute-phase.commit_style': 'conventional',
'workflows.execute-phase.commit_scope_format': '{phase}-{plan}',
'workflows.verify-work.extra_verification_commands': '[]',
'workflows.complete-milestone.version_files': '[]',
'workflows.complete-milestone.pre_release_commands': '[]'
```

Key design decisions:
- `post_task_command` defaults to empty string (no post-task hook by default)
- `commit_style` defaults to `conventional` (current hardcoded behavior)
- `commit_scope_format` defaults to `{phase}-{plan}` (current hardcoded behavior)
- Array values default to `'[]'` as JSON strings (parsed downstream by Node.js)
- Do NOT change any existing DEFAULTS entries or any other part of the script

Keep the existing resolution chain logic (preferences.json -> config.json -> DEFAULTS -> fallback) unchanged. The new keys follow the same `dot.notation.path` convention as existing keys like `display.statusline` and `workflow.research`.
  </action>
  <verify>
Test that new keys resolve through read-pref.sh:

```bash
cd /Users/gannonhall/dev/kata/kata-orchestrator
bash skills/kata-configure-settings/scripts/read-pref.sh "workflows.execute-phase.commit_style" "FAIL"
bash skills/kata-configure-settings/scripts/read-pref.sh "workflows.execute-phase.post_task_command" "FAIL"
bash skills/kata-configure-settings/scripts/read-pref.sh "workflows.verify-work.extra_verification_commands" "FAIL"
bash skills/kata-configure-settings/scripts/read-pref.sh "workflows.complete-milestone.version_files" "FAIL"
```

Expected: `conventional`, empty string, `[]`, `[]` respectively. None should output `FAIL`.

Verify existing keys still work:
```bash
bash skills/kata-configure-settings/scripts/read-pref.sh "mode" "FAIL"
```
Expected: `yolo` (from DEFAULTS).
  </verify>
  <done>DEFAULTS table contains 6 new workflow config keys. read-pref.sh resolves them with correct defaults. Existing key resolution unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Create kata-config-validator.js SessionStart hook and register it</name>
  <files>hooks/kata-config-validator.js, hooks/hooks.json</files>
  <action>
Create `hooks/kata-config-validator.js` following the same pattern as `hooks/kata-template-drift.js`.

**Hook behavior:**
1. Read JSON from stdin (SessionStart hook input with `cwd`)
2. Read `.planning/config.json` from cwd. If file doesn't exist, exit 0 silently.
3. Flatten config into dot-notation keys via recursive descent
4. Validate each key against KNOWN_KEYS schema map
5. Unknown keys produce warning messages: `[kata] Config warning: Unknown key 'key.path'`
6. Invalid value types produce error messages: `[kata] Config error: Invalid value for 'key.path': expected {type}, got {actual}`
7. Always exit 0 (never block session start)
8. Wrap entire logic in try/catch, exit 0 on any exception

**KNOWN_KEYS schema map (covers full config.json schema):**

```javascript
const KNOWN_KEYS = {
  'mode': { type: 'enum', values: ['yolo', 'interactive'] },
  'depth': { type: 'enum', values: ['quick', 'standard', 'comprehensive'] },
  'model_profile': { type: 'enum', values: ['quality', 'balanced', 'budget'] },
  'commit_docs': { type: 'boolean' },
  'pr_workflow': { type: 'boolean' },
  'display.statusline': { type: 'boolean' },
  'workflow.research': { type: 'boolean' },
  'workflow.plan_check': { type: 'boolean' },
  'workflow.verifier': { type: 'boolean' },
  'github.enabled': { type: 'boolean' },
  'github.issueMode': { type: 'enum', values: ['auto', 'never'] },
  'workflows.execute-phase.post_task_command': { type: 'string' },
  'workflows.execute-phase.commit_style': { type: 'enum', values: ['conventional', 'semantic', 'simple'] },
  'workflows.execute-phase.commit_scope_format': { type: 'string' },
  'workflows.verify-work.extra_verification_commands': { type: 'array' },
  'workflows.complete-milestone.version_files': { type: 'array' },
  'workflows.complete-milestone.pre_release_commands': { type: 'array' }
};
```

**Validation logic:**
- Recursive `flattenConfig(obj, prefix)` function that yields `{key, value}` pairs
- For each flattened key: if not in KNOWN_KEYS, push warning
- For each known key: validate type matches (boolean check via `typeof`, enum check via `values.includes()`, array check via `Array.isArray()`, string check via `typeof`)
- Use `import fs from 'fs'` and `import path from 'path'` (ESM, matching kata-template-drift.js)

**Register in hooks.json:**
Add a third entry to the `hooks` array inside `SessionStart[0].hooks`:

```json
{
  "type": "command",
  "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/kata-config-validator.js"
}
```

Keep the existing two hooks (kata-setup-statusline.js and kata-template-drift.js) unchanged.

Do NOT remove the `parallelization` key from KNOWN_KEYS. The dead key removal happens in Plan 03 (WKFL-06). For now, the validator should NOT flag `parallelization` as unknown. Add it to KNOWN_KEYS as `{ type: 'boolean' }` so existing configs don't produce spurious warnings.
  </action>
  <verify>
Test validator with a valid config:
```bash
cd /Users/gannonhall/dev/kata/kata-orchestrator
echo '{"cwd":"'$(pwd)'"}' | node hooks/kata-config-validator.js
```
Expected: no output (valid config).

Test validator with unknown key:
```bash
echo '{"cwd":"/tmp"}' > /tmp/test-validator-input.json
mkdir -p /tmp/test-validator/.planning
echo '{"mode":"yolo","unknownKey":"test"}' > /tmp/test-validator/.planning/config.json
echo '{"cwd":"/tmp/test-validator"}' | node hooks/kata-config-validator.js
rm -rf /tmp/test-validator /tmp/test-validator-input.json
```
Expected: `[kata] Config warning: Unknown key 'unknownKey'`

Test validator with invalid type:
```bash
mkdir -p /tmp/test-validator2/.planning
echo '{"mode":"invalid_mode"}' > /tmp/test-validator2/.planning/config.json
echo '{"cwd":"/tmp/test-validator2"}' | node hooks/kata-config-validator.js
rm -rf /tmp/test-validator2
```
Expected: `[kata] Config error: Invalid value for 'mode': expected one of yolo, interactive; got 'invalid_mode'`

Verify hooks.json has 3 entries:
```bash
grep -c "kata-config-validator" hooks/hooks.json
```
Expected: 1
  </verify>
  <done>kata-config-validator.js exists, validates config.json on session start (warns on unknown keys, errors on invalid types, always exits 0). hooks.json registers the new hook alongside the two existing hooks.</done>
</task>

</tasks>

<verification>
- read-pref.sh DEFAULTS table has 23 entries (17 existing + 6 new workflow keys)
- kata-config-validator.js handles valid config, unknown keys, and invalid types
- hooks.json registers all 3 SessionStart hooks
- Validator never blocks session start (always exits 0)
</verification>

<success_criteria>
- WKFL-01 (partial): Workflow config keys defined in DEFAULTS table with proper defaults
- WKFL-05: Session-start schema validation warns on unknown keys and errors on invalid value types
</success_criteria>

<output>
After completion, create `.planning/phases/pending/39-config-workflow-variants-settings/39-01-SUMMARY.md`
</output>
