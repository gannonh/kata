---
phase: 39-config-workflow-variants-settings
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - skills/kata-execute-phase/SKILL.md
  - skills/kata-execute-phase/references/executor-instructions.md
  - skills/kata-verify-work/SKILL.md
  - skills/kata-verify-work/references/verify-work.md
  - skills/kata-complete-milestone/SKILL.md
  - skills/kata-complete-milestone/references/milestone-complete.md
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "kata-execute-phase reads workflows.execute-phase config keys via read-pref.sh and passes them to executor subagents"
    - "Executor subagent applies commit_style and commit_scope_format when creating commits"
    - "Executor subagent runs post_task_command after each task if configured"
    - "kata-verify-work reads workflows.verify-work.extra_verification_commands and runs them after UAT"
    - "kata-complete-milestone reads workflows.complete-milestone.version_files and uses them to override auto-detection"
    - "kata-complete-milestone reads workflows.complete-milestone.pre_release_commands and runs them before archive"
    - "All skills fall back to defaults when workflow config is not set (backward compatible)"
  artifacts:
    - skills/kata-execute-phase/SKILL.md
    - skills/kata-execute-phase/references/executor-instructions.md
    - skills/kata-verify-work/references/verify-work.md
    - skills/kata-complete-milestone/references/milestone-complete.md
  key_links:
    - "Orchestrators read config via read-pref.sh and inject values into subagent prompts"
    - "Subagents receive workflow config via inlined prompt context, not via file reads"
---

<objective>
Wire workflow config reads into kata-execute-phase, kata-verify-work, and kata-complete-milestone.

Purpose: Enable project-specific customization of commit format, post-task hooks, extra verification commands, version file overrides, and pre-release hooks. After this plan, users can configure workflow variants in config.json and skills apply them.
Output: Three skills updated to read and apply workflow config from `workflows.*` section.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/39-config-workflow-variants-settings/39-RESEARCH.md

@skills/kata-execute-phase/SKILL.md
@skills/kata-execute-phase/references/executor-instructions.md
@skills/kata-verify-work/SKILL.md
@skills/kata-verify-work/references/verify-work.md
@skills/kata-complete-milestone/SKILL.md
@skills/kata-complete-milestone/references/milestone-complete.md
@skills/kata-configure-settings/scripts/read-pref.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire workflow config into kata-execute-phase orchestrator and executor</name>
  <files>
    skills/kata-execute-phase/SKILL.md,
    skills/kata-execute-phase/references/executor-instructions.md
  </files>
  <action>
**In SKILL.md step 0 (Resolve Model Profile), add workflow config reads after the model profile read:**

Add a new sub-step "0.5 Read Workflow Config" after step 0:

```bash
# Read workflow config for executor injection
EXEC_POST_TASK_CMD=$(bash "${SKILL_BASE_DIR}/../kata-configure-settings/scripts/read-pref.sh" "workflows.execute-phase.post_task_command" "")
EXEC_COMMIT_STYLE=$(bash "${SKILL_BASE_DIR}/../kata-configure-settings/scripts/read-pref.sh" "workflows.execute-phase.commit_style" "conventional")
EXEC_COMMIT_SCOPE_FMT=$(bash "${SKILL_BASE_DIR}/../kata-configure-settings/scripts/read-pref.sh" "workflows.execute-phase.commit_scope_format" "{phase}-{plan}")
```

Store these three variables for injection into executor prompts.

**In SKILL.md `<wave_execution>` section, update the Task() prompt template:**

After the existing `<project_state>` block in the Task prompt template, add a `<workflow_config>` block:

```
<workflow_config>
post_task_command: {EXEC_POST_TASK_CMD}
commit_style: {EXEC_COMMIT_STYLE}
commit_scope_format: {EXEC_COMMIT_SCOPE_FMT}
</workflow_config>
```

This inlines the config into the executor prompt. The executor does NOT read config files directly.

**In executor-instructions.md, update the `commit_task` step (or create one if embedded in task execution):**

Add workflow config parsing near the top of the execution flow, after `load_plan`:

```xml
<step name="parse_workflow_config">
Parse workflow config from `<workflow_config>` block in prompt context:

- `post_task_command` — shell command to run after each task completes (empty = skip)
- `commit_style` — commit message format: conventional (default), semantic, or simple
- `commit_scope_format` — scope template, supports `{phase}` and `{plan}` placeholders

**Commit style formats:**
- `conventional`: `{type}({scope}): {message}` (current default)
- `semantic`: `{type}: {message}` (no scope)
- `simple`: `{message}` (no type or scope)

Where `{scope}` is produced by replacing `{phase}` and `{plan}` in `commit_scope_format`.

If `<workflow_config>` block is missing (backward compat), use defaults: commit_style=conventional, commit_scope_format={phase}-{plan}, post_task_command=empty.
</step>
```

Update the commit logic in executor-instructions.md to use these variables:
- Replace any hardcoded `{type}({phase}-{plan}): {message}` pattern with dynamic format based on commit_style
- After each task's commit, if `post_task_command` is non-empty, run it via bash

Do NOT change any other behavior in SKILL.md or executor-instructions.md. The changes are additive, preserving all existing orchestration logic.
  </action>
  <verify>
```bash
cd /Users/gannonhall/dev/kata/kata-orchestrator
# Verify SKILL.md has workflow config reads
grep -c "read-pref.sh.*workflows.execute-phase" skills/kata-execute-phase/SKILL.md

# Verify workflow_config block appears in wave_execution
grep -c "workflow_config" skills/kata-execute-phase/SKILL.md

# Verify executor-instructions.md has workflow config parsing
grep -c "workflow_config" skills/kata-execute-phase/references/executor-instructions.md

# Verify commit_style reference exists
grep -c "commit_style" skills/kata-execute-phase/references/executor-instructions.md
```
Expected: all counts >= 1.
  </verify>
  <done>kata-execute-phase orchestrator reads 3 workflow config keys via read-pref.sh, injects them into executor prompt via workflow_config block. Executor parses workflow_config and applies commit_style, commit_scope_format, and post_task_command.</done>
</task>

<task type="auto">
  <name>Task 2: Wire extra verification commands into kata-verify-work</name>
  <files>
    skills/kata-verify-work/SKILL.md,
    skills/kata-verify-work/references/verify-work.md
  </files>
  <action>
**In verify-work.md, add a new step after step 7 (completion/commit) and before step 7.5 (finalize):**

Add step `7.1 Run Extra Verification Commands`:

```markdown
<step name="run_extra_verification">
## 7.1. Run Extra Verification Commands

After UAT tests complete and UAT.md is committed, check for project-specific verification commands:

```bash
EXTRA_CMDS_JSON=$(bash "${SKILL_BASE_DIR}/../kata-configure-settings/scripts/read-pref.sh" "workflows.verify-work.extra_verification_commands" "[]")
```

**If `EXTRA_CMDS_JSON` is `[]` or empty:** Skip this step.

**Otherwise:** Parse JSON array and execute each command:

```bash
EXTRA_CMDS_JSON="$EXTRA_CMDS_JSON" node -e "
const cmds = JSON.parse(process.env.EXTRA_CMDS_JSON);
if (cmds.length === 0) { process.exit(0); }
cmds.forEach((cmd, i) => console.log('CMD_' + i + '=' + cmd));
" > /tmp/kata-extra-cmds.sh

if [ -s /tmp/kata-extra-cmds.sh ]; then
  echo ""
  echo "## Extra Verification"
  echo ""
  source /tmp/kata-extra-cmds.sh
  # Run each CMD_N
  i=0
  while true; do
    eval "CMD=\${CMD_${i}:-}"
    [ -z "$CMD" ] && break
    echo "Running: $CMD"
    eval "$CMD" 2>&1 || echo "  ⚠ Command failed (non-blocking)"
    i=$((i + 1))
  done
  rm -f /tmp/kata-extra-cmds.sh
fi
```

Append command outputs to UAT.md under a `## Extra Verification` section. Non-blocking: command failures are logged but do not stop the workflow.
</step>
```

**In SKILL.md process section, add a brief note about step 7.1** between steps 7 and 7.5 so the orchestrator flow is documented:

```markdown
7.1. Run extra verification commands (if configured in workflows.verify-work)
```

Do NOT change any existing steps. The new step slots in between existing 7 and 7.5.
  </action>
  <verify>
```bash
cd /Users/gannonhall/dev/kata/kata-orchestrator
# Verify verify-work.md has extra verification step
grep -c "extra_verification" skills/kata-verify-work/references/verify-work.md

# Verify read-pref.sh call for extra commands
grep -c "workflows.verify-work.extra_verification_commands" skills/kata-verify-work/references/verify-work.md

# Verify SKILL.md references step 7.1
grep -c "7.1" skills/kata-verify-work/SKILL.md
```
Expected: all counts >= 1.
  </verify>
  <done>kata-verify-work reads extra_verification_commands from config, executes each after UAT, appends results to UAT.md. Failures are non-blocking. Skips gracefully when no commands configured.</done>
</task>

<task type="auto">
  <name>Task 3: Wire version files and pre-release commands into kata-complete-milestone</name>
  <files>
    skills/kata-complete-milestone/SKILL.md,
    skills/kata-complete-milestone/references/milestone-complete.md
  </files>
  <action>
**In milestone-complete.md step `ensure_release_branch` (or a new step immediately after), add config reads:**

```bash
# Read workflow config for milestone completion
VERSION_FILES_JSON=$(bash "${SKILL_BASE_DIR}/../kata-configure-settings/scripts/read-pref.sh" "workflows.complete-milestone.version_files" "[]")
PRE_RELEASE_CMDS_JSON=$(bash "${SKILL_BASE_DIR}/../kata-configure-settings/scripts/read-pref.sh" "workflows.complete-milestone.pre_release_commands" "[]")
```

**Wire version_files into the release workflow:**

In the step where version-detector.md is used to find version files (the `release_workflow` step), add a check:

```bash
VERSION_FILES_JSON="$VERSION_FILES_JSON" node -e "
const files = JSON.parse(process.env.VERSION_FILES_JSON);
if (files.length > 0) {
  files.forEach(f => console.log(f));
}
" > /tmp/kata-version-files.txt

if [ -s /tmp/kata-version-files.txt ]; then
  echo "Using configured version files (skipping auto-detection):"
  cat /tmp/kata-version-files.txt
  # Use these files instead of version-detector.md results
else
  # Fall back to version-detector.md auto-detection (existing behavior)
fi
rm -f /tmp/kata-version-files.txt
```

When `version_files` is configured, skip version-detector.md heuristics and use the explicit list. When empty, fall back to current auto-detection. This is an override, not a merge.

**Wire pre_release_commands into the workflow:**

Add a new sub-step between version bump and archive creation:

```bash
PRE_RELEASE_CMDS_JSON="$PRE_RELEASE_CMDS_JSON" node -e "
const cmds = JSON.parse(process.env.PRE_RELEASE_CMDS_JSON);
if (cmds.length === 0) { process.exit(0); }
cmds.forEach((cmd, i) => console.log('CMD_' + i + '=' + cmd));
" > /tmp/kata-pre-release-cmds.sh

if [ -s /tmp/kata-pre-release-cmds.sh ]; then
  echo "Running pre-release commands:"
  source /tmp/kata-pre-release-cmds.sh
  i=0
  while true; do
    eval "CMD=\${CMD_${i}:-}"
    [ -z "$CMD" ] && break
    echo "  Running: $CMD"
    eval "$CMD" 2>&1
    if [ $? -ne 0 ]; then
      echo "  ⚠ Pre-release command failed: $CMD"
      echo "  Stopping pre-release sequence."
      break
    fi
    i=$((i + 1))
  done
  rm -f /tmp/kata-pre-release-cmds.sh
fi
```

Pre-release command failures ARE blocking (unlike extra verification). If a pre-release command fails, stop and report. This protects against releasing with a broken build.

**In SKILL.md, add brief references to the new config reads** in the process section (step 0.1 area) so the orchestrator flow mentions workflow config.

Do NOT change any other milestone-complete behavior. The changes are additive overrides.
  </action>
  <verify>
```bash
cd /Users/gannonhall/dev/kata/kata-orchestrator
# Verify milestone-complete.md has version_files read
grep -c "workflows.complete-milestone.version_files" skills/kata-complete-milestone/references/milestone-complete.md

# Verify milestone-complete.md has pre_release_commands read
grep -c "workflows.complete-milestone.pre_release_commands" skills/kata-complete-milestone/references/milestone-complete.md

# Verify SKILL.md mentions workflow config
grep -c "workflow" skills/kata-complete-milestone/SKILL.md
```
Expected: first two counts >= 1.
  </verify>
  <done>kata-complete-milestone reads version_files to override auto-detection and pre_release_commands to run before archive. Falls back to existing behavior when config not set. Pre-release failures are blocking.</done>
</task>

</tasks>

<verification>
- kata-execute-phase reads 3 config keys and injects them into executor prompts
- kata-verify-work reads extra_verification_commands and runs them after UAT
- kata-complete-milestone reads version_files and pre_release_commands
- All three skills fall back to defaults when workflow config absent
- No existing skill behavior changes when config not set
</verification>

<success_criteria>
- WKFL-01 (complete): config.json accepts workflows section with per-skill keys
- WKFL-02: kata-execute-phase reads and applies workflows.execute-phase config
- WKFL-03: kata-verify-work reads and runs extra_verification_commands
- WKFL-04: kata-complete-milestone reads version_files and pre_release_commands
</success_criteria>

<output>
After completion, create `.planning/phases/pending/39-config-workflow-variants-settings/39-02-SUMMARY.md`
</output>
