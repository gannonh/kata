---
phase: 01-phase-organization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - skills/kata-track-progress/SKILL.md
  - skills/kata-verify-work/SKILL.md
  - skills/kata-research-phase/SKILL.md
  - skills/kata-remove-phase/SKILL.md
  - skills/kata-pause-work/SKILL.md
  - skills/kata-check-issues/SKILL.md
  - skills/kata-audit-milestone/SKILL.md
  - skills/kata-plan-milestone-gaps/SKILL.md
  - skills/kata-discuss-phase/references/context-template.md
  - skills/kata-discuss-phase/references/phase-discuss.md
  - skills/kata-verify-work/references/verify-work.md
  - skills/kata-verify-work/references/UAT-template.md
  - skills/kata-execute-phase/references/summary-template.md
  - skills/kata-execute-phase/references/execute-plan.md
  - skills/kata-resume-work/references/resume-project.md
  - skills/kata-complete-milestone/references/milestone-complete.md
  - agents/kata-planner.md
  - agents/kata-plan-checker.md
  - agents/kata-phase-researcher.md
  - agents/kata-integration-checker.md
  - CLAUDE.md
  - .planning/codebase/ARCHITECTURE.md
autonomous: true

must_haves:
  truths:
    - "All skills that look up phase directories use the universal discovery pattern"
    - "All agents that look up phase directories use the universal discovery pattern"
    - "All skill references use state-aware phase paths"
    - "No file uses the old flat .planning/phases/${PHASE}-* pattern without fallback"
  artifacts:
    - path: "skills/kata-track-progress/SKILL.md"
      provides: "Phase scanning across state subdirectories"
      contains: "active pending completed"
    - path: "agents/kata-planner.md"
      provides: "Phase directory lookup with universal discovery"
      contains: "active pending completed"
    - path: "agents/kata-plan-checker.md"
      provides: "Phase directory lookup with universal discovery"
      contains: "active pending completed"
    - path: "skills/kata-complete-milestone/references/milestone-complete.md"
      provides: "Phase scanning across state subdirectories"
      contains: "active pending completed"
    - path: ".planning/codebase/ARCHITECTURE.md"
      provides: "Updated architecture documentation reflecting subdirectory structure"
      contains: "pending.*active.*completed"
  key_links:
    - from: "skills/kata-track-progress/SKILL.md, skills/kata-check-issues/SKILL.md, skills/kata-audit-milestone/SKILL.md, skills/kata-plan-milestone-gaps/SKILL.md"
      to: ".planning/phases/{pending,active,completed}/"
      via: "phase scanning pattern (iterates all phases across subdirectories)"
      pattern: "for state in active pending completed.*ALL_PHASE_DIRS"
    - from: "skills/kata-verify-work/SKILL.md, skills/kata-research-phase/SKILL.md, skills/kata-remove-phase/SKILL.md, skills/kata-pause-work/SKILL.md"
      to: ".planning/phases/{pending,active,completed}/"
      via: "single-phase lookup (finds one phase by number)"
      pattern: "for state in active pending completed.*PHASE_DIR"
    - from: "agents/kata-planner.md, agents/kata-plan-checker.md, agents/kata-phase-researcher.md"
      to: ".planning/phases/{pending,active,completed}/"
      via: "single-phase lookup (finds one phase by number)"
      pattern: "for state in active pending completed.*PHASE_DIR"
    - from: "agents/kata-integration-checker.md"
      to: ".planning/phases/{pending,active,completed}/"
      via: "phase scanning pattern (cross-phase analysis)"
      pattern: "for state in active pending completed.*ALL_PHASE_DIRS"
---

<objective>
Propagate the universal phase discovery pattern to all remaining skills, skill references, and agents.

Purpose: After Plan 01 establishes the pattern in core orchestrators, this plan updates the remaining 22 files that reference `.planning/phases/` so the entire system uses consistent state-aware phase discovery. Without this, some skills would find phases and others would not.

Output: 22 updated files, all using the universal phase discovery pattern with flat-directory fallback.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-phase-organization/01-RESEARCH.md
@.planning/phases/01-phase-organization/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update remaining skills with universal phase discovery</name>
  <files>
    skills/kata-track-progress/SKILL.md,
    skills/kata-verify-work/SKILL.md,
    skills/kata-research-phase/SKILL.md,
    skills/kata-remove-phase/SKILL.md,
    skills/kata-pause-work/SKILL.md,
    skills/kata-check-issues/SKILL.md,
    skills/kata-audit-milestone/SKILL.md,
    skills/kata-plan-milestone-gaps/SKILL.md
  </files>
  <action>
    For each of these 8 skills, find every instance where phase directories are looked up using flat patterns like:
    - `ls .planning/phases/${PHASE}-*`
    - `ls -d .planning/phases/${PADDED}-*`
    - `ls .planning/phases/*/`
    - `for phase_dir in .planning/phases/*/`

    Replace each with the **universal phase discovery pattern**:

    **For single-phase lookups** (finding a specific phase by number — used by kata-verify-work, kata-research-phase, kata-remove-phase, kata-pause-work):
    ```bash
    PADDED=$(printf "%02d" "$PHASE" 2>/dev/null || echo "$PHASE")
    PHASE_DIR=""
    for state in active pending completed; do
      PHASE_DIR=$(ls -d .planning/phases/${state}/${PADDED}-* .planning/phases/${state}/${PHASE}-* 2>/dev/null | head -1)
      [ -n "$PHASE_DIR" ] && break
    done
    [ -z "$PHASE_DIR" ] && PHASE_DIR=$(ls -d .planning/phases/${PADDED}-* .planning/phases/${PHASE}-* 2>/dev/null | head -1)
    ```

    **For phase scanning** (listing all phases — used by kata-track-progress, kata-check-issues, kata-audit-milestone, kata-plan-milestone-gaps):
    ```bash
    # Scan all phase directories across states
    ALL_PHASE_DIRS=""
    for state in active pending completed; do
      [ -d ".planning/phases/${state}" ] && ALL_PHASE_DIRS="${ALL_PHASE_DIRS} $(ls -d .planning/phases/${state}/*/ 2>/dev/null)"
    done
    # Fallback: include flat directories (backward compatibility)
    FLAT_DIRS=$(ls -d .planning/phases/[0-9]*/ 2>/dev/null)
    [ -n "$FLAT_DIRS" ] && ALL_PHASE_DIRS="${ALL_PHASE_DIRS} ${FLAT_DIRS}"
    ```

    **Per-file specifics:**

    - **kata-track-progress:** Uses phase dir listing to show progress. Update the "position" and "route" steps to scan across subdirectories using the phase scanning pattern.
    - **kata-verify-work:** Uses phase directory lookup to find SUMMARY files. Update to single-phase universal discovery.
    - **kata-research-phase:** Uses phase directory lookup for research output. Update to single-phase universal discovery.
    - **kata-remove-phase:** Finds and deletes a phase directory. Update to single-phase discovery, but deletion logic stays the same (just deletes from whichever subdirectory it's in). Also update the renumbering logic to handle phases in subdirectories.
    - **kata-pause-work:** Looks up phase directory. Update to single-phase universal discovery.
    - **kata-check-issues:** Scans all phases. Update to phase scanning pattern across subdirectories.
    - **kata-audit-milestone:** Scans all phases for milestone audit. Update to phase scanning pattern across subdirectories.
    - **kata-plan-milestone-gaps:** Scans all phases. Update to phase scanning pattern across subdirectories.

    **CRITICAL:** Read each file BEFORE modifying it. Preserve all existing functionality. Only change directory lookup patterns.
  </action>
  <verify>
    Run this to confirm no flat phase lookups remain:
    ```bash
    grep -rn 'ls.*\.planning/phases/\${' skills/kata-track-progress/SKILL.md skills/kata-verify-work/SKILL.md skills/kata-research-phase/SKILL.md skills/kata-remove-phase/SKILL.md skills/kata-pause-work/SKILL.md skills/kata-check-issues/SKILL.md skills/kata-audit-milestone/SKILL.md skills/kata-plan-milestone-gaps/SKILL.md | grep -v 'phases/\${state}' | grep -v 'phases/pending\|phases/active\|phases/completed'
    ```
    Should return no results (all flat lookups replaced with state-aware ones).
  </verify>
  <done>
    All 8 remaining skills use universal phase discovery.
    Phase scanning skills (track-progress, check-issues, audit-milestone, plan-milestone-gaps) search across active/pending/completed subdirectories.
    Single-phase lookup skills (verify-work, research-phase, remove-phase, pause-work) find phases by number across subdirectories.
    Flat directory fallback preserved for backward compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update skill references with state-aware phase paths</name>
  <files>
    skills/kata-discuss-phase/references/context-template.md,
    skills/kata-discuss-phase/references/phase-discuss.md,
    skills/kata-verify-work/references/verify-work.md,
    skills/kata-verify-work/references/UAT-template.md,
    skills/kata-execute-phase/references/summary-template.md,
    skills/kata-execute-phase/references/execute-plan.md,
    skills/kata-resume-work/references/resume-project.md,
    skills/kata-complete-milestone/references/milestone-complete.md
  </files>
  <action>
    For each of these 8 skill reference files, find every instance where phase directories are referenced using flat patterns and update them.

    These files contain phase directory references in templates, examples, and instructions. For each:
    1. Read the file
    2. Find all `.planning/phases/${PHASE}-*` or `.planning/phases/*/` patterns
    3. Replace with the universal discovery pattern (for lookups) or state-aware path references (for path examples)

    Key files and what to look for:
    - **context-template.md, phase-discuss.md:** Phase dir references for discussion context. Update path patterns.
    - **verify-work.md:** Phase dir lookup for verification. Update to universal discovery.
    - **UAT-template.md:** Path references in templates. Update to show state-aware paths.
    - **summary-template.md:** Path references. Update examples.
    - **execute-plan.md:** Phase dir references. This is a large file (~1874 lines). Focus on bash snippets that do `ls .planning/phases/` lookups. Update to universal discovery.
    - **resume-project.md:** Phase dir lookup for project resume. Update to universal discovery.
    - **milestone-complete.md:** Phase scanning for milestone completion. Update to scan across subdirectories. IMPORTANT: This file manages `.archive/` which is SEPARATE from `completed/`. The archive moves phases to `.planning/phases/.archive/` for cross-milestone historical records. Update the scanning to find phases in `completed/` (and `active/` and `pending/` for incomplete phases), but do NOT change the archive destination.

    **CRITICAL:** Read each file BEFORE modifying it. These are large files. Preserve all existing functionality. Only change directory lookup and path reference patterns.
  </action>
  <verify>
    Run check for remaining flat phase lookups in skill references:
    ```bash
    grep -rn 'ls.*\.planning/phases/\${' skills/kata-discuss-phase/references/ skills/kata-verify-work/references/ skills/kata-execute-phase/references/ skills/kata-resume-work/references/ skills/kata-complete-milestone/references/ | grep -v 'phases/\${state}' | grep -v 'phases/pending\|phases/active\|phases/completed\|phases/\.archive'
    ```
    Should return no results.
  </verify>
  <done>
    All 8 skill reference files updated with state-aware phase directory patterns.
    milestone-complete.md preserves .archive/ as separate from completed/.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update agents, CLAUDE.md, and ARCHITECTURE.md</name>
  <files>
    agents/kata-planner.md,
    agents/kata-plan-checker.md,
    agents/kata-phase-researcher.md,
    agents/kata-integration-checker.md,
    CLAUDE.md,
    .planning/codebase/ARCHITECTURE.md
  </files>
  <action>
    **Agents (4 files):**
    - **kata-planner.md:** Update phase directory lookup patterns (find existing plans, create new plans). Plans are created in the phase dir which is already resolved by the orchestrator, so mainly update any independent lookups. Uses single-phase discovery.
    - **kata-plan-checker.md:** Update phase directory lookup for plan verification. Uses single-phase discovery.
    - **kata-phase-researcher.md:** Update phase directory lookup for research output. Uses single-phase discovery.
    - **kata-integration-checker.md:** Update cross-phase scanning patterns. Uses phase scanning pattern (iterates all phases).

    For each agent, replace flat `.planning/phases/${PHASE}-*` patterns with the universal discovery pattern appropriate to the file's use case (single-phase lookup for planner/checker/researcher, phase scanning for integration-checker).

    **CLAUDE.md:**
    Update the phase directory reference examples in the "Working with Planning Files" section. Show the new subdirectory structure:
    ```bash
    # Current phase plans
    ls .planning/phases/active/
    ls .planning/phases/pending/
    ls .planning/phases/completed/
    ```

    **.planning/codebase/ARCHITECTURE.md:**
    Update the architecture documentation to reflect the new `.planning/phases/` subdirectory structure (pending/active/completed). Add or update the directory structure section to show the state-based organization. If phase directory references appear in architecture descriptions, update them to reflect state-aware paths.

    **CRITICAL:** Read each file BEFORE modifying it. Preserve all existing functionality. Only change directory lookup and path reference patterns.
  </action>
  <verify>
    Check agents for remaining flat lookups:
    ```bash
    grep -rn 'ls.*\.planning/phases/\${' agents/kata-planner.md agents/kata-plan-checker.md agents/kata-phase-researcher.md agents/kata-integration-checker.md | grep -v 'phases/\${state}' | grep -v 'phases/pending\|phases/active\|phases/completed'
    ```
    Should return no results.

    Verify CLAUDE.md updated:
    ```bash
    grep -c 'phases/active\|phases/pending\|phases/completed' CLAUDE.md
    ```
    Should return at least 1.

    Verify ARCHITECTURE.md updated:
    ```bash
    grep -c 'phases/active\|phases/pending\|phases/completed' .planning/codebase/ARCHITECTURE.md
    ```
    Should return at least 1.
  </verify>
  <done>
    All 4 agents updated with universal phase discovery (3 single-phase, 1 scanning).
    CLAUDE.md shows new directory structure.
    ARCHITECTURE.md documents the state-based phase organization.
    Zero flat phase lookups remain across the entire codebase (except flat fallback).
  </done>
</task>

</tasks>

<verification>
1. Full-codebase grep for unpatched flat phase lookups:
   ```bash
   grep -rn 'ls.*\.planning/phases/\${' skills/ agents/ CLAUDE.md .planning/codebase/ARCHITECTURE.md | grep -v 'phases/\${state}' | grep -v 'phases/pending\|phases/active\|phases/completed\|phases/\.archive'
   ```
   Must return zero results.
2. All 27 files from the research inventory have been updated (5 in Plan 01, 22 in Plan 02).
3. .archive/ handling in milestone-complete is preserved and separate from completed/.
</verification>

<success_criteria>
- Every skill, agent, and reference that references phase directories uses the universal discovery pattern
- Phase scanning (track-progress, check-issues, audit-milestone, plan-milestone-gaps, integration-checker) searches across all subdirectories
- Single-phase lookup (verify-work, research-phase, remove-phase, pause-work, planner, plan-checker, phase-researcher) finds phases by number across subdirectories
- Backward compatibility fallback (flat directory) present in all discovery patterns
- milestone-complete.md archive handling unchanged (archive != completed)
- CLAUDE.md documentation reflects new structure
- ARCHITECTURE.md documents the state-based phase organization
</success_criteria>

<output>
After completion, create `.planning/phases/01-phase-organization/01-02-SUMMARY.md`
</output>
