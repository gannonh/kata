---
phase: 58-brownfield-doc-auto-refresh
plan: 04
type: execute
wave: 3
depends_on: [02, 03]
files_modified: []
autonomous: true
must_haves:
  truths:
    - All tests pass (npm test, npm run test:scripts)
    - Build succeeds (npm run build:plugin)
    - detect-stale-intel.cjs CLI output includes brownfield fields when .planning/codebase/ exists
    - Step 7.25 in built output contains brownfield auto-refresh path
  artifacts: []
  key_links:
    - Build artifact includes updated detect-stale-intel.cjs in plugin output
    - Built SKILL.md for kata-execute-phase includes brownfield auto-refresh logic
---

<objective>
Validate the build and run integration tests to confirm brownfield auto-refresh works end-to-end.

Purpose: Confirm that the detection logic (plan 01), tests (plan 02), and orchestrator integration (plan 03) work together. Verify the build system correctly distributes the updated scripts and SKILL.md.

Output: Build validation and integration test confirmation.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Run test suite and validate all tests pass</name>
  <files></files>
  <action>
Run the test suites in order:

1. Run script tests (includes the new brownfield detection tests):
```bash
npm run test:scripts
```
All tests must pass, including the 5 new brownfield staleness tests in `tests/scripts/detect-stale-intel.test.js`.

2. Run the full test suite:
```bash
npm test
```
This validates build, artifact structure, and skill validation alongside script tests.

If any tests fail, fix the issues:
- If brownfield detection tests fail: check detect-stale-intel.cjs for logic errors in the new function
- If build tests fail: check SKILL.md for syntax issues in the new step 7.25 content
- If artifact tests fail: check build output includes updated files

Report pass/fail status for each test suite.
  </action>
  <verify>Both `npm run test:scripts` and `npm test` exit with code 0.</verify>
  <done>All test suites pass including new brownfield detection tests.</done>
</task>

<task type="auto">
  <name>Task 2: Build plugin and validate artifact contents</name>
  <files></files>
  <action>
1. Build the plugin:
```bash
npm run build:plugin
```

2. Verify the built detect-stale-intel.cjs includes brownfield detection:
```bash
grep -c "detectBrownfieldDocStaleness" dist/plugin/skills/kata-map-codebase/scripts/detect-stale-intel.cjs
```
Must return >= 1 (function definition exists in built output).

3. Verify the built SKILL.md for kata-execute-phase includes brownfield auto-refresh:
```bash
grep -c "brownfieldDocStale\|brownfield.*auto-refresh\|Brownfield doc" dist/plugin/skills/kata-execute-phase/SKILL.md
```
Must return >= 1 (brownfield auto-refresh content exists in built output).

4. Verify the built detect-stale-intel.cjs works standalone:
```bash
node dist/plugin/skills/kata-map-codebase/scripts/detect-stale-intel.cjs 2>/dev/null || true
```
Should output valid JSON (or exit 0 with empty output if no .planning/intel/ in CWD).

5. Run artifact validation if available:
```bash
npm run test:artifacts 2>/dev/null || true
```

Report all verification results.
  </action>
  <verify>Build succeeds. Built artifacts contain brownfield detection function and SKILL.md auto-refresh content.</verify>
  <done>Plugin builds successfully with brownfield auto-refresh artifacts distributed correctly.</done>
</task>
</tasks>

<verification>
1. `npm run test:scripts` passes all tests including 5 new brownfield tests
2. `npm test` passes (build + artifact + skill validation)
3. `npm run build:plugin` succeeds
4. Built dist/ contains updated detect-stale-intel.cjs with brownfield function
5. Built dist/ contains updated SKILL.md with brownfield auto-refresh path
</verification>

<success_criteria>
- All test suites pass (zero failures)
- Build produces valid plugin artifacts
- Built detect-stale-intel.cjs exports detectBrownfieldDocStaleness
- Built kata-execute-phase SKILL.md includes brownfield auto-refresh logic in step 7.25
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/pending/58-brownfield-doc-auto-refresh/58-04-SUMMARY.md`
</output>
