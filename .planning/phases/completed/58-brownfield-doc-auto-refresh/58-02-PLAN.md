---
phase: 58-brownfield-doc-auto-refresh
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - tests/scripts/detect-stale-intel.test.js
autonomous: true
must_haves:
  truths:
    - Tests cover 5 brownfield staleness detection cases from research
    - Tests use temp git repos with controlled Analysis Date headers
    - Tests verify brownfieldDocStale boolean correctness at 30% threshold
    - Tests verify graceful degradation for missing codebase dir, missing dates, git failures
  artifacts:
    - tests/scripts/detect-stale-intel.test.js
  key_links:
    - Tests import detectBrownfieldDocStaleness from detect-stale-intel.cjs
    - Test fixtures use .planning/codebase/ with Analysis Date headers
---

<objective>
Write unit tests for the brownfield doc staleness detection function added in plan 01.

Purpose: Verify that `detectBrownfieldDocStaleness()` correctly identifies stale brownfield docs across all edge cases. The research identified 5 required test cases.

Output: `tests/scripts/detect-stale-intel.test.js` with comprehensive brownfield staleness detection tests.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create test file with temp git repo setup</name>
  <files>tests/scripts/detect-stale-intel.test.js</files>
  <action>
Create `tests/scripts/detect-stale-intel.test.js` using the same test pattern as `tests/scripts/scan-codebase.test.js`:

```javascript
import { test, describe, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert';
import { createRequire } from 'node:module';
import { execSync } from 'node:child_process';
import fs from 'node:fs';
import path from 'node:path';
import os from 'node:os';

const require = createRequire(import.meta.url);
```

Import `detectBrownfieldDocStaleness` from the script:

```javascript
const ROOT = process.cwd();
const SCRIPT_PATH = path.join(ROOT, 'skills/kata-map-codebase/scripts/detect-stale-intel.cjs');
const { detectBrownfieldDocStaleness } = require(SCRIPT_PATH);
```

Create `beforeEach`/`afterEach` that:
- Creates a temp directory with `fs.mkdtempSync`
- Initializes a git repo with `git init`, `git config user.email/name`
- Creates `.planning/codebase/` directory
- Creates `.planning/intel/` directory
- Creates initial source files in `src/` (at least 10 .js files to have meaningful percentages)
- Commits all files
- `afterEach` removes the temp directory with `fs.rmSync`

Helper function to write a brownfield doc with a specific Analysis Date:

```javascript
function writeBrownfieldDoc(dir, docName, analysisDate) {
  const content = `# ${docName.replace('.md', '')}\n\n**Analysis Date:** ${analysisDate}\n\n## Content\nSample content.`;
  fs.writeFileSync(path.join(dir, '.planning/codebase', docName), content);
}
```

Helper function to modify source files and commit:

```javascript
function modifyAndCommit(dir, files, message) {
  for (const file of files) {
    fs.writeFileSync(path.join(dir, file), `// modified ${Date.now()}\n`);
  }
  execSync('git add -A', { cwd: dir, stdio: 'pipe' });
  execSync(`git commit -m "${message}"`, { cwd: dir, stdio: 'pipe' });
}
```
  </action>
  <verify>Read the file and confirm imports, helpers, and beforeEach/afterEach hooks are present.</verify>
  <done>Test infrastructure ready with temp git repo setup and brownfield doc helpers.</done>
</task>

<task type="auto">
  <name>Task 2: Write 5 brownfield staleness test cases</name>
  <files>tests/scripts/detect-stale-intel.test.js</files>
  <action>
Add a `describe('detectBrownfieldDocStaleness')` block with these 5 test cases:

**Test 1: No .planning/codebase/ directory returns brownfieldDocStale: false**
- Delete `.planning/codebase/` from temp dir (or don't create it)
- Call `detectBrownfieldDocStaleness(tmpDir)`
- Assert `result.brownfieldDocStale === false`

**Test 2: Analysis Date exists, no files changed since returns brownfieldDocStale: false**
- Capture the initial commit date via `git log -1 --format=%ad --date=format:%Y-%m-%d` and use that as the Analysis Date for ARCHITECTURE.md
- No additional commits after the initial setup
- Call `detectBrownfieldDocStaleness(tmpDir)`
- Assert `result.brownfieldDocStale === false`
- Assert `result.brownfieldChangedFiles === 0` or very low
- Assert `result.brownfieldAnalysisDate` is populated

**Test 3: Analysis Date exists, >30% files changed returns brownfieldDocStale: true**
- Write ARCHITECTURE.md with Analysis Date = date of initial commit
- Modify >30% of source files (e.g., 4 out of 10) and commit
- Call `detectBrownfieldDocStaleness(tmpDir)`
- Assert `result.brownfieldDocStale === true`
- Assert `result.brownfieldChangePct > 0.3`
- Assert `result.brownfieldChangedFiles >= 4`

**Test 4: Malformed Analysis Date returns brownfieldDocStale: false**
- Write ARCHITECTURE.md with content `**Analysis Date:** not-a-date`
- Call `detectBrownfieldDocStaleness(tmpDir)`
- Assert `result.brownfieldDocStale === false`
- The regex `\d{4}-\d{2}-\d{2}` won't match, so no date is found

**Test 5: Mixed docs, some with Analysis Date, some without**
- Write ARCHITECTURE.md WITHOUT an Analysis Date header (just content)
- Write STACK.md WITH `**Analysis Date:** YYYY-MM-DD`
- Call `detectBrownfieldDocStaleness(tmpDir)`
- Assert result uses the date from STACK.md
- Assert `result.brownfieldAnalysisDate` is populated

Run: `node --test tests/scripts/detect-stale-intel.test.js`
All 5 tests must pass.
  </action>
  <verify>Run `node --test tests/scripts/detect-stale-intel.test.js` and confirm all tests pass.</verify>
  <done>5 brownfield staleness detection tests passing, covering all edge cases from research.</done>
</task>
</tasks>

<verification>
1. `node --test tests/scripts/detect-stale-intel.test.js` passes all 5 tests
2. Tests cover: missing codebase dir, fresh docs, stale docs (>30%), malformed date, mixed docs
3. Tests use real git repos for accurate commit/diff behavior
4. No flaky tests (dates and commit hashes are deterministic in test setup)
</verification>

<success_criteria>
- 5 test cases covering all brownfield staleness edge cases
- All tests use temp git repos with controlled state
- Tests verify both boolean result and numeric fields (changePct, changedFiles, totalFiles)
- Tests run cleanly with `node --test`
- No dependency on external state (fully isolated)
</success_criteria>

<output>
After completion, create `.planning/phases/pending/58-brownfield-doc-auto-refresh/58-02-SUMMARY.md`
</output>
