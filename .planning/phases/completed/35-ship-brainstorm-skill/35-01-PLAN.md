---
phase: 35-ship-brainstorm-skill
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-brainstorm/SKILL.md
autonomous: true
source_issue: "#99"
must_haves:
  truths:
    - Skill checks CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS env var before spawning agents
    - If not enabled, user is offered Enable or Skip via AskUserQuestion
    - If user chooses Enable, settings.json merge writes env var and instructs restart
    - If user chooses Skip, skill exits gracefully with explanation
    - If enabled in settings but not in env (needs restart), skill detects and instructs restart
    - TeamCreate replaces Teammate(spawnTeam) in Step 3
    - TeamDelete replaces Teammate(cleanup) in Step 6
  artifacts:
    - skills/kata-brainstorm/SKILL.md (modified)
  key_links:
    - Prerequisite check runs before any context gathering or agent spawning
    - Settings merge uses read-merge-write pattern (never overwrites)
    - Global ~/.claude/settings.json (not project-level .claude/settings.json)
---

<objective>
Add Agent Teams prerequisite check and update team API references in kata-brainstorm skill.

Purpose: The skill uses Agent Teams (experimental). Without the prerequisite check, it would fail with cryptic errors if the feature isn't enabled. Updating API names from Teammate to TeamCreate/TeamDelete aligns with the current Claude Code tool names.

Output: Modified SKILL.md with new Step 0 (prerequisite check) and corrected API references in Steps 3 and 6.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/35-ship-brainstorm-skill/35-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Step 0 prerequisite check and update API references</name>
  <files>skills/kata-brainstorm/SKILL.md</files>
  <action>
Modify the existing SKILL.md to add a new Step 0 and update API references. The changes:

**1. Insert Step 0: Check Agent Teams Prerequisite** (before current Step 1)

Add a new "### Step 0: Check Agent Teams Prerequisite" section after "## Process" and before the current Step 1. The step instructs Claude to:

a) Run bash to check the env var:
```bash
echo "$CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"
```

b) If output is "1", proceed to Step 1.

c) If output is NOT "1", run a secondary check against settings.json:
```bash
node -e "
  try {
    const fs = require('fs');
    const path = require('path');
    const s = JSON.parse(fs.readFileSync(path.join(process.env.HOME, '.claude', 'settings.json'), 'utf8'));
    console.log((s.env && s.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS) || '');
  } catch(e) { console.log(''); }
"
```

d) If settings.json shows "1" but env var doesn't, display: "Agent Teams is enabled in settings but requires a restart. Please exit Claude Code (`/exit`) and relaunch, then run `/kata-brainstorm` again." Then STOP.

e) If neither env var nor settings.json shows "1", present AskUserQuestion:
  - Header: "Agent Teams Required"
  - Question: "Brainstorming uses Claude Code Agent Teams (experimental feature). Enable it?"
  - Option A: "Enable Agent Teams" — run the settings.json merge (read-merge-write pattern using Node.js), then display: "Agent Teams enabled in ~/.claude/settings.json. Please restart Claude Code (`/exit` then relaunch) and run `/kata-brainstorm` again." Then STOP.
  - Option B: "Skip brainstorm" — display: "Brainstorming requires Agent Teams. You can enable it later by adding CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 to ~/.claude/settings.json under the env key." Then STOP.

The settings.json merge code (for Option A):
```bash
node -e "
  const fs = require('fs');
  const path = require('path');
  const settingsPath = path.join(process.env.HOME, '.claude', 'settings.json');
  let settings = {};
  try {
    settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));
  } catch (e) {}
  if (!settings.env) settings.env = {};
  settings.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS = '1';
  fs.mkdirSync(path.dirname(settingsPath), { recursive: true });
  fs.writeFileSync(settingsPath, JSON.stringify(settings, null, 2));
  console.log('Agent Teams enabled in ~/.claude/settings.json');
"
```

**2. Update Step 3 API reference** (line 50-52 area)

Replace:
```
1. Create team with `Teammate` tool (`spawnTeam`)
```
With:
```
1. Create team with `TeamCreate` tool
```

**3. Update Step 6 API reference** (line 129 area)

Replace:
```
2. Clean up the team with `Teammate` tool (`cleanup`)
```
With:
```
2. Clean up the team with `TeamDelete` tool
```

**4. Renumber existing steps**

Current Steps 1-6 become Steps 1-6 (same numbers). The new Step 0 is inserted before them. No renumbering needed since Step 0 is a "Step 0" prefix.

Do NOT modify any other content in the file. Preserve the explorer/challenger prompt templates, the default team structure table, the customization section, and the output structure section exactly as they are.
  </action>
  <verify>
Read skills/kata-brainstorm/SKILL.md and verify:
1. "Step 0: Check Agent Teams Prerequisite" section exists before Step 1
2. Step 0 includes env var check, settings.json secondary check, AskUserQuestion with Enable/Skip options, and restart messaging
3. Step 0 includes the Node.js read-merge-write pattern for settings.json (never raw overwrite)
4. Step 3 references `TeamCreate` (not `Teammate`)
5. Step 6 references `TeamDelete` (not `Teammate`)
6. All other content preserved (team structure table, prompt templates, customization, output structure)
  </verify>
  <done>
SKILL.md contains Step 0 with prerequisite check (env var + settings.json fallback), AskUserQuestion gate, settings merge code, and restart instructions. Steps 3 and 6 use TeamCreate/TeamDelete. All existing content preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build includes updated skill</name>
  <files>skills/kata-brainstorm/SKILL.md</files>
  <action>
Run the plugin build and verify kata-brainstorm is included with the new content:

```bash
npm run build:plugin
```

Then verify:
1. `dist/plugin/skills/kata-brainstorm/SKILL.md` exists
2. The built file contains "Step 0: Check Agent Teams Prerequisite"
3. The built file contains "TeamCreate" and "TeamDelete"
4. The built file does NOT contain "Teammate" (the old API name)
5. YAML frontmatter is preserved (name: kata-brainstorm, description with triggers)

Also run existing tests to confirm no regressions:
```bash
npm test
```
  </action>
  <verify>
```bash
# Build succeeds
npm run build:plugin

# Built file exists and contains new content
grep -q "Step 0" dist/plugin/skills/kata-brainstorm/SKILL.md
grep -q "TeamCreate" dist/plugin/skills/kata-brainstorm/SKILL.md
grep -q "TeamDelete" dist/plugin/skills/kata-brainstorm/SKILL.md
! grep -q "Teammate" dist/plugin/skills/kata-brainstorm/SKILL.md

# Tests pass
npm test
```
  </verify>
  <done>
Build produces dist/plugin/skills/kata-brainstorm/SKILL.md with prerequisite check and updated API references. Tests pass.
  </done>
</task>

</tasks>

<verification>
1. `/kata-brainstorm` will invoke a skill that checks for Agent Teams before doing anything
2. If Agent Teams is missing, user gets a clear Enable/Skip choice
3. If user enables, settings.json is merged (not overwritten) and restart is required
4. If user skips, graceful exit with explanation
5. Team API uses current tool names (TeamCreate, TeamDelete)
6. Build output includes the updated skill
</verification>

<success_criteria>
- [ ] Step 0 prerequisite check present in SKILL.md
- [ ] Env var check + settings.json fallback detection
- [ ] AskUserQuestion with Enable/Skip options
- [ ] Settings merge uses read-merge-write (not overwrite)
- [ ] Restart messaging for both "just enabled" and "enabled but needs restart" cases
- [ ] TeamCreate/TeamDelete replace Teammate references
- [ ] Plugin build includes updated skill
- [ ] Existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/pending/35-ship-brainstorm-skill/35-01-SUMMARY.md`
</output>
