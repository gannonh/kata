# Phase 0.1: Claude Code Plugin Distribution - Research

**Researched:** 2026-01-19
**Domain:** Claude Code Plugin System
**Confidence:** HIGH

## Summary

This research investigates how to package Kata as a Claude Code plugin using the official plugin system instead of the current custom install.js approach. The plugin-dev system provides a standardized structure with automatic discovery of commands, agents, skills, hooks, and MCP servers.

The key finding is that Kata's current structure maps well to the plugin format, requiring primarily:
1. Creation of `.claude-plugin/plugin.json` manifest
2. Restructuring `kata/` directory into `skills/` format with `SKILL.md` files
3. Converting `kata/workflows/` and `kata/references/` into skill references
4. Updating path references from `~/.claude/` to `${CLAUDE_PLUGIN_ROOT}/`

**Primary recommendation:** Create a hybrid distribution that supports both plugin system installation AND the existing npx/install.js method for users without plugin system access.

## Standard Stack

The established structure for Claude Code plugins:

### Core (Plugin System)

| Component | Format | Purpose | Why Standard |
|-----------|--------|---------|--------------|
| `.claude-plugin/plugin.json` | JSON | Plugin manifest | Required for plugin discovery |
| `commands/` | `.md` files | Slash commands | Auto-discovered, namespaced |
| `agents/` | `.md` files | Subagents | Auto-discovered |
| `skills/` | Directories with `SKILL.md` | Knowledge bundles | Progressive disclosure |
| `hooks/hooks.json` | JSON | Event automation | Auto-registered |
| `.mcp.json` | JSON | MCP servers | Auto-started |

### Supporting

| Component | Purpose | When to Use |
|-----------|---------|-------------|
| `skills/*/references/` | Detailed documentation | Defer loading until needed |
| `skills/*/examples/` | Working code samples | User can copy/adapt |
| `skills/*/scripts/` | Utility scripts | Deterministic operations |
| `${CLAUDE_PLUGIN_ROOT}` | Portable paths | All intra-plugin references |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Plugin system | npx install.js | Current approach, works without plugin system, but not discoverable via `/plugins` |
| skills/ format | flat kata/ dir | Current approach, works but not progressive disclosure |

## Architecture Patterns

### Recommended Plugin Structure for Kata

```
kata/
├── .claude-plugin/
│   └── plugin.json              # Plugin manifest (NEW)
├── commands/
│   └── kata/                    # Existing - already correct format
│       ├── help.md
│       ├── new-project.md
│       ├── execute-phase.md
│       └── ... (24 commands)
├── agents/                      # Existing - move to plugin root
│   ├── kata-executor.md
│   ├── kata-planner.md
│   ├── kata-verifier.md
│   └── ... (11 agents)
├── skills/                      # NEW - convert from kata/
│   ├── workflows/               # One skill per workflow
│   │   ├── SKILL.md            # Main workflow skill
│   │   ├── execute-plan.md     # Reference: execute-plan workflow
│   │   ├── execute-phase.md    # Reference: execute-phase workflow
│   │   └── ... (12 workflows)
│   ├── templates/               # Template skill
│   │   ├── SKILL.md
│   │   └── ... (template files)
│   └── references/              # Reference skill
│       ├── SKILL.md
│       └── ... (reference files)
├── hooks/
│   ├── hooks.json              # NEW - register hooks
│   ├── statusline.js           # Existing
│   └── kata-check-update.js    # Existing
└── scripts/                     # Helper scripts (optional)
```

### Pattern 1: Skill per Domain (Recommended)

**What:** Group related content into skills with progressive disclosure
**When to use:** Complex domains with multiple files

```
skills/
├── project-setup/              # Skill for project setup
│   ├── SKILL.md                # Triggers: "new project", "setup kata"
│   ├── references/
│   │   └── requirements.md     # Detailed requirements format
│   └── examples/
│       └── PROJECT.md.example
├── phase-execution/            # Skill for execution
│   ├── SKILL.md                # Triggers: "execute phase", "run plan"
│   └── references/
│       ├── checkpoints.md
│       └── verification-patterns.md
└── roadmap-planning/           # Skill for planning
    ├── SKILL.md
    └── references/
        └── tdd.md
```

### Pattern 2: Workflows as References

**What:** Keep workflows as reference files within skills
**When to use:** Workflows are procedural guidance, not standalone triggers

```yaml
# skills/execution/SKILL.md
---
name: Kata Execution
description: This skill should be used when executing phases, running plans,
  verifying work, or debugging execution issues.
---

## Overview
[Core execution concepts]

## Workflows
- `references/execute-phase.md` - Phase execution workflow
- `references/execute-plan.md` - Plan execution workflow

## Quick Reference
[Essential procedures]
```

### Anti-Patterns to Avoid

- **Flat skills:** Putting all content in SKILL.md bloats context
- **Missing SKILL.md:** Directories without SKILL.md won't be discovered
- **Hardcoded paths:** Using `~/.claude/` instead of `${CLAUDE_PLUGIN_ROOT}`
- **Wrong wrapper format:** Plugin hooks.json needs `{"hooks": {...}}` wrapper
- **Component directories inside .claude-plugin:** Commands, agents, skills must be at root level

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Plugin structure | Custom directory layout | `.claude-plugin/plugin.json` + standard dirs | Auto-discovery, namespacing, validation |
| Component discovery | Custom file scanning | Standard `commands/`, `agents/`, `skills/` dirs | Claude Code handles discovery |
| Path portability | Hardcoded paths | `${CLAUDE_PLUGIN_ROOT}` variable | Works across installation methods |
| Hook registration | Manual settings.json editing | `hooks/hooks.json` | Auto-merged with user hooks |
| Progressive disclosure | Loading all files | SKILL.md + references/ | Load only when needed |

**Key insight:** The plugin system handles discovery, namespacing, and loading. Don't replicate this logic - use the standard structure and let Claude Code do the work.

## Common Pitfalls

### Pitfall 1: Wrong hooks.json Format

**What goes wrong:** Hooks don't load, no error shown
**Why it happens:** Plugin hooks.json uses wrapper format, settings.json uses direct format
**How to avoid:** Always use wrapper format for plugin hooks.json:

```json
// CORRECT for plugins (hooks/hooks.json)
{
  "hooks": {
    "SessionStart": [...]
  }
}

// WRONG for plugins (this is settings.json format)
{
  "SessionStart": [...]
}
```
**Warning signs:** Hooks don't trigger despite correct configuration

### Pitfall 2: Components Inside .claude-plugin/

**What goes wrong:** Commands, agents, skills not discovered
**Why it happens:** Assuming manifest directory contains components
**How to avoid:** Place component directories at plugin root:

```
plugin/
├── .claude-plugin/
│   └── plugin.json        # Only manifest here
├── commands/              # NOT inside .claude-plugin/
├── agents/                # NOT inside .claude-plugin/
└── skills/                # NOT inside .claude-plugin/
```
**Warning signs:** `/help` doesn't show commands, agents not triggered

### Pitfall 3: Missing SKILL.md

**What goes wrong:** Skill directory ignored
**Why it happens:** Only directories with SKILL.md are discovered
**How to avoid:** Every skill directory must have SKILL.md with frontmatter:

```
skills/
├── my-skill/
│   ├── SKILL.md           # REQUIRED
│   └── references/
└── incomplete-skill/
    └── references/        # IGNORED - no SKILL.md
```
**Warning signs:** Skill content exists but never loads

### Pitfall 4: Hardcoded Paths in Commands/Hooks

**What goes wrong:** Works on developer machine, fails on user machines
**Why it happens:** Using `~/.claude/` or absolute paths
**How to avoid:** Always use `${CLAUDE_PLUGIN_ROOT}`:

```markdown
# WRONG
@~/.claude/kata/templates/project.md

# CORRECT
@${CLAUDE_PLUGIN_ROOT}/skills/templates/project.md
```
**Warning signs:** "File not found" errors on user machines

### Pitfall 5: Skill Description Without Trigger Phrases

**What goes wrong:** Skill never activates autonomously
**Why it happens:** Vague description without specific user queries
**How to avoid:** Include specific trigger phrases:

```yaml
# WRONG
description: Provides project setup guidance

# CORRECT
description: This skill should be used when the user asks to "create a new project",
  "start a kata project", "setup planning files", or "initialize milestone".
```
**Warning signs:** Have to manually load skill, never auto-triggers

## Code Examples

### Plugin Manifest (plugin.json)

```json
// Source: plugin-dev manifest-reference.md
{
  "name": "kata",
  "version": "0.1.5",
  "description": "Spec-driven development framework for Claude Code with systematic workflows",
  "author": {
    "name": "Gannon Hall",
    "email": "gannon@example.com"
  },
  "homepage": "https://github.com/gannonh/kata",
  "repository": "https://github.com/gannonh/kata",
  "license": "MIT",
  "keywords": [
    "development-workflow",
    "spec-driven",
    "meta-prompting",
    "planning",
    "execution"
  ]
}
```

### SKILL.md Format

```markdown
// Source: plugin-dev skill-development SKILL.md
---
name: Kata Workflows
description: This skill should be used when the user asks to "execute a phase",
  "run a plan", "verify work", "debug execution", "check progress", or needs
  guidance on Kata's execution workflows, verification patterns, or debugging.
version: 0.1.5
---

# Kata Workflows

## Overview

Kata workflows guide systematic software development through phases and plans.

## Core Workflows

### Execute Phase
- Load phase plans
- Execute sequentially or in parallel waves
- Track progress in STATE.md

### Execute Plan
- Read plan file
- Execute tasks
- Commit on completion

## Quick Reference

| Workflow | Command | Purpose |
|----------|---------|---------|
| execute-phase | `/kata:execute-phase N` | Run all plans in phase |
| verify-work | `/kata:verify-work N` | Check phase completion |

## Additional Resources

### Reference Files
- **`references/execute-phase.md`** - Detailed execution workflow
- **`references/checkpoints.md`** - Checkpoint handling
- **`references/verification-patterns.md`** - Verification approaches
```

### Hook Configuration (hooks.json)

```json
// Source: plugin-dev hook-development SKILL.md
{
  "description": "Kata hooks for session management",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/kata-check-update.js",
            "timeout": 10
          }
        ]
      }
    ]
  }
}
```

### Command with Plugin Path Reference

```markdown
---
description: Show Kata progress and current state
allowed-tools: [Read, Bash]
---

# Progress Command

Show current progress from STATE.md.

## Process

1. Load STATE.md: @${CLAUDE_PLUGIN_ROOT}/../../.planning/STATE.md
2. Parse current phase and plan
3. Display progress summary

Note: For project-specific state, read @.planning/STATE.md
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual file copying via install.js | Plugin system with auto-discovery | Claude Code plugins feature | Standardized installation, marketplace distribution |
| Flat file structure | Skills with progressive disclosure | Plugin-dev best practices | Context efficiency, auto-triggering |
| Hardcoded `~/.claude/` paths | `${CLAUDE_PLUGIN_ROOT}` variable | Plugin system | Portable across installations |

**Deprecated/outdated:**
- `bin/install.js` direct file copy approach - Will be retained for backwards compatibility but plugin system preferred

## Migration Considerations

### Kata-Specific Challenges

1. **Path references in 24 commands:** All `@~/.claude/kata/...` references need updating to `@${CLAUDE_PLUGIN_ROOT}/skills/...`

2. **Workflow files as skills:** The 12 workflows need SKILL.md wrappers with trigger descriptions

3. **Template references:** Commands reference templates that need skill-based paths

4. **Agent paths:** Agents reference workflows and templates with `~/.claude/` paths

5. **Dual installation:** Need to support both plugin system and npx install for users without plugin access

### Recommended Migration Strategy

1. **Phase 1:** Create `.claude-plugin/plugin.json` manifest
2. **Phase 2:** Restructure `kata/` into `skills/` with SKILL.md files
3. **Phase 3:** Update all path references to `${CLAUDE_PLUGIN_ROOT}`
4. **Phase 4:** Create `hooks/hooks.json` for hook registration
5. **Phase 5:** Update install.js to optionally create plugin structure
6. **Phase 6:** Test both installation methods

## Open Questions

Things that couldn't be fully resolved:

1. **Dual distribution support**
   - What we know: Plugin system uses `${CLAUDE_PLUGIN_ROOT}`, install.js uses `~/.claude/`
   - What's unclear: Best way to support both with single codebase
   - Recommendation: Use `${CLAUDE_PLUGIN_ROOT}` everywhere, have install.js create symlink or expand paths

2. **Statusline hook registration**
   - What we know: Current install.js modifies settings.json for statusline
   - What's unclear: Whether plugin hooks.json can register statusline
   - Recommendation: Research statusline hook support in plugin system; may need settings.json for statusline

3. **Version checking hook**
   - What we know: kata-check-update.js runs on SessionStart
   - What's unclear: How version checking works when installed as plugin vs npx
   - Recommendation: Check `${CLAUDE_PLUGIN_ROOT}` vs npm registry for version comparison

## Sources

### Primary (HIGH confidence)

- plugin-dev plugin `skills/plugin-structure/SKILL.md` - Plugin directory structure
- plugin-dev plugin `skills/plugin-structure/references/manifest-reference.md` - plugin.json specification
- plugin-dev plugin `skills/skill-development/SKILL.md` - Skill creation patterns
- plugin-dev plugin `skills/command-development/SKILL.md` - Command format
- plugin-dev plugin `skills/hook-development/SKILL.md` - Hook configuration
- plugin-dev plugin `skills/agent-development/SKILL.md` - Agent format
- plugin-dev plugin `commands/create-plugin.md` - Plugin creation workflow
- plugin-dev plugin `skills/plugin-structure/examples/standard-plugin.md` - Full plugin example

### Secondary (MEDIUM confidence)

- Kata current structure (`commands/kata/`, `agents/`, `kata/workflows/`) - Existing implementation
- `~/.claude/plugins/installed_plugins.json` - Plugin registration format

### Tertiary (LOW confidence)

- None - all findings verified with plugin-dev documentation

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Verified with plugin-dev official documentation
- Architecture: HIGH - Based on plugin-dev examples and patterns
- Migration: MEDIUM - Kata-specific, needs validation during implementation
- Pitfalls: HIGH - Documented in plugin-dev skill content

**Research date:** 2026-01-19
**Valid until:** 90 days (plugin system is stable)
