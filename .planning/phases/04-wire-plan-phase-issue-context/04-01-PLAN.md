---
phase: 04-wire-plan-phase-issue-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/plan-phase/SKILL.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "plan-phase extracts linked issues from STATE.md Pending Issues section"
    - "plan-phase extracts linked issues from STATE.md Milestone Scope Issues section"
    - "kata-planner receives issue context in Task prompt when issues are linked"
    - "Generated PLAN.md files include source_issue when created from linked issues"
  artifacts:
    - path: "skills/plan-phase/SKILL.md"
      provides: "Issue context extraction and passing to planner"
      contains: "Linked Issues"
  key_links:
    - from: "skills/plan-phase/SKILL.md"
      to: ".planning/STATE.md"
      via: "awk extraction in Step 7"
      pattern: "Pending Issues|Milestone Scope Issues"
    - from: "skills/plan-phase/SKILL.md"
      to: "kata-planner Task prompt"
      via: "ISSUE_CONTEXT_SECTION in Step 8"
      pattern: "Linked Issues"
---

<objective>
Wire plan-phase to read issue context from STATE.md and pass it to kata-planner so generated plans include source_issue for traceability.

Purpose: Close INTEG-03 gap - plans created from linked issues should have source_issue set, enabling PRs to auto-close their source GitHub issues.

Output: Updated skills/plan-phase/SKILL.md with issue context extraction and passing.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-wire-plan-phase-issue-context/04-RESEARCH.md

@skills/plan-phase/SKILL.md
@agents/kata-planner.md (lines 489-512 for source_issue documentation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue extraction to Step 7</name>
  <files>skills/plan-phase/SKILL.md</files>
  <action>
In Step 7 (Read Context Files), after the existing file reads, add issue extraction logic:

1. Add a new subsection "### Extract Linked Issues from STATE.md" after the file reading list

2. Add bash code block that:
   - Extracts PHASE_DIR_NAME from $PHASE_DIR using basename
   - Extracts PHASE_NUM using grep -oE '^[0-9.]+'
   - Uses awk to extract issues from "### Pending Issues" section that match the current phase
   - Uses awk to extract issues from "### Milestone Scope Issues" section that match the current phase
   - Combines results into LINKED_ISSUES variable
   - Pattern must match both "Phase ${PHASE_NUM}-" and "Phase ${PHASE_DIR_NAME}" formats

3. Add conditional section that builds ISSUE_CONTEXT_SECTION only if LINKED_ISSUES is non-empty:
   ```
   ISSUE_CONTEXT_SECTION=""
   if [ -n "$LINKED_ISSUES" ]; then
     ISSUE_CONTEXT_SECTION="
   **Linked Issues:**
   ${LINKED_ISSUES}

   Note: Set \`source_issue:\` in plan frontmatter for traceability:
   - GitHub issues: \`source_issue: github:#N\` (extract from provenance field)
   - Local issues: \`source_issue: [file path]\`
   "
   fi
   ```

4. Add "Store ISSUE_CONTEXT_SECTION for use in Step 8 prompt" at the end of the step

Reference the exact patterns from 04-RESEARCH.md code examples.
  </action>
  <verify>
grep -A30 "### Extract Linked Issues" skills/plan-phase/SKILL.md shows:
- PHASE_DIR_NAME and PHASE_NUM extraction
- awk commands for both sections
- Conditional ISSUE_CONTEXT_SECTION building
  </verify>
  <done>
Step 7 contains issue extraction logic that reads both STATE.md sections and builds optional context section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Include issue context in Step 8 Task prompt</name>
  <files>skills/plan-phase/SKILL.md</files>
  <action>
In Step 8 (Spawn kata-planner Agent), modify the planning_context prompt template:

1. Find the markdown prompt template inside the code block after "Fill prompt with inlined content and spawn:"

2. Add a new section after "**Research (if exists):**" and before "**Gap Closure (if --gaps mode):**":
   ```
   **Linked Issues (from STATE.md):**
   {issue_context_section}
   ```

3. This section will be empty string when no issues are linked, which is correct behavior (planner proceeds without issue context).

4. The existing Step 7 stores ISSUE_CONTEXT_SECTION - use that variable name consistently.

Do NOT modify the Task() call itself - only the prompt template content.
Do NOT add any new required behavior - issue context is OPTIONAL.
  </action>
  <verify>
grep -B5 -A5 "Linked Issues" skills/plan-phase/SKILL.md shows:
- New section in planning_context template
- Positioned after Research and before Gap Closure
  </verify>
  <done>
Step 8 Task prompt includes {issue_context_section} placeholder that receives linked issue data when available.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Syntax check**: Read skills/plan-phase/SKILL.md and verify no malformed bash or markdown

2. **Pattern check**: Verify the extraction patterns match both phase reference formats:
   - "Phase 04-" (number only)
   - "Phase 04-wire-plan-phase-issue-context" (full directory name)

3. **Flow check**: Trace the data flow:
   - STATE.md "Pending Issues" -> LINKED_ISSUES
   - STATE.md "Milestone Scope Issues" -> LINKED_ISSUES
   - LINKED_ISSUES -> ISSUE_CONTEXT_SECTION (if non-empty)
   - ISSUE_CONTEXT_SECTION -> Task prompt -> kata-planner
   - kata-planner sets source_issue in PLAN.md frontmatter (already documented in agent)

4. **Non-breaking check**: Verify existing behavior unchanged when no issues linked (empty section, not error)
</verification>

<success_criteria>
- [ ] skills/plan-phase/SKILL.md Step 7 extracts linked issues from both STATE.md sections
- [ ] Step 7 uses awk with proper section boundaries (### header matching)
- [ ] Step 7 matches both phase number and full directory name patterns
- [ ] Step 7 builds ISSUE_CONTEXT_SECTION only when issues exist
- [ ] Step 8 planning_context template includes Linked Issues section
- [ ] Issue context is OPTIONAL - absence does not break planning
- [ ] No syntax errors in modified file
</success_criteria>

<output>
After completion, create `.planning/phases/04-wire-plan-phase-issue-context/04-01-SUMMARY.md`
</output>
