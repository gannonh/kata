---
phase: 03-phase-issues
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-adding-milestones/SKILL.md
  - skills/kata-adding-milestones/references/github-mapping.md
autonomous: true

must_haves:
  truths:
    - "Phase issues created with phase label when milestone created"
    - "Issue body includes goal and success criteria from ROADMAP.md"
    - "Phase issues assigned to GitHub Milestone"
    - "Issues created only when github.issueMode allows"
  artifacts:
    - path: "skills/kata-adding-milestones/SKILL.md"
      provides: "Phase issue creation logic in Phase 9.5"
      contains: "gh issue create"
    - path: "skills/kata-adding-milestones/references/github-mapping.md"
      provides: "Updated mapping documentation"
      contains: "Phase | GitHub Issue | `add-milestone`"
  key_links:
    - from: "SKILL.md"
      to: "ROADMAP.md"
      via: "parses phase goals and success criteria"
      pattern: "awk.*Phase.*ROADMAP"
    - from: "SKILL.md"
      to: "GitHub API"
      via: "gh issue create with --milestone"
      pattern: "gh issue create.*--milestone"
---

<objective>
Add phase issue creation to kata-adding-milestones skill.

Purpose: When a milestone is created with phases defined in ROADMAP.md, create corresponding GitHub Issues for each phase, assigned to the milestone with the `phase` label.

Output:
- Updated `kata-adding-milestones/SKILL.md` with new Phase 9.5 (Create Phase Issues)
- Updated `github-mapping.md` to reflect the implementation
</objective>

<execution_context>
@~/.claude/kata/references/execute-plan.md
@~/.claude/kata/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-phase-issues/03-RESEARCH.md

Current skill:
@skills/kata-adding-milestones/SKILL.md
@skills/kata-adding-milestones/references/github-mapping.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 9.5 - Create Phase Issues to SKILL.md</name>
  <files>skills/kata-adding-milestones/SKILL.md</files>
  <action>
Read the current SKILL.md and add a new Phase 9.5 after Phase 9 (Create Roadmap) and before Phase 10 (Done).

Insert between the roadmap commit section and the completion banner. The new phase should:

**Phase 9.5: Create Phase Issues (if enabled)**

1. **Check github.enabled** - Skip silently if false

2. **Check github.issueMode** (auto | ask | never):
   - If "never": Skip phase issue creation silently
   - If "ask": Use AskUserQuestion to prompt:
     ```
     header: "GitHub Phase Issues"
     question: "Create GitHub Issues for each phase in this milestone?"
     options:
       - "Yes" — Create issues for all phases
       - "No" — Skip issue creation for this milestone
     ```
   - If "auto" or user approved: Proceed with creation

3. **Create phase label (idempotent)**:
   ```bash
   gh label create "phase" --color "0E8A16" --description "Kata phase tracking" --force 2>/dev/null || true
   ```

4. **Get milestone number** (from Phase 5.5):
   ```bash
   MILESTONE_NUM=$(gh api /repos/:owner/:repo/milestones --jq ".[] | select(.title==\"v${VERSION}\") | .number" 2>/dev/null)
   if [ -z "$MILESTONE_NUM" ]; then
     echo "Warning: Could not find GitHub Milestone v${VERSION}. Skipping phase issue creation."
     # Continue without phase issues
   fi
   ```

5. **Parse phases from ROADMAP.md** (for this milestone only):

   The ROADMAP.md structure uses:
   - Milestone headers: `### v1.1.0 GitHub Integration (Planned)` or `### v{VERSION} {Name} (Status)`
   - Phase headers: `#### Phase N: Phase Name`
   - Goal line: `**Goal**: description text`
   - Requirements line: `**Requirements**: REQ-01, REQ-02` (optional)
   - Success criteria: `**Success Criteria** (what must be TRUE):` followed by numbered list

   ```bash
   # Find the milestone section and extract phases
   # VERSION is already set (e.g., "1.1.0")

   ROADMAP_FILE=".planning/ROADMAP.md"

   # Get line numbers for milestone section boundaries
   MILESTONE_START=$(grep -n "^### v${VERSION}" "$ROADMAP_FILE" | head -1 | cut -d: -f1)
   NEXT_MILESTONE=$(awk -v start="$MILESTONE_START" 'NR > start && /^### v[0-9]/ {print NR; exit}' "$ROADMAP_FILE")

   # If no next milestone, use end of file
   if [ -z "$NEXT_MILESTONE" ]; then
     NEXT_MILESTONE=$(wc -l < "$ROADMAP_FILE")
   fi

   # Extract phase blocks within this milestone section
   # Each phase starts with "#### Phase N:" and ends at next "#### Phase" or section boundary
   PHASE_HEADERS=$(sed -n "${MILESTONE_START},${NEXT_MILESTONE}p" "$ROADMAP_FILE" | grep -n "^#### Phase [0-9]")

   # Process each phase
   echo "$PHASE_HEADERS" | while IFS= read -r phase_line; do
     # Extract phase number and name from "#### Phase N: Name"
     PHASE_NUM=$(echo "$phase_line" | sed -E 's/.*Phase ([0-9.]+):.*/\1/')
     PHASE_NAME=$(echo "$phase_line" | sed -E 's/.*Phase [0-9.]+: (.*)/\1/')

     # Get relative line number within milestone section
     PHASE_REL_LINE=$(echo "$phase_line" | cut -d: -f1)
     PHASE_ABS_LINE=$((MILESTONE_START + PHASE_REL_LINE - 1))

     # Find next phase or section end
     NEXT_PHASE_LINE=$(sed -n "$((PHASE_ABS_LINE+1)),${NEXT_MILESTONE}p" "$ROADMAP_FILE" | grep -n "^#### Phase\|^### \|^## " | head -1 | cut -d: -f1)
     if [ -z "$NEXT_PHASE_LINE" ]; then
       PHASE_END=$NEXT_MILESTONE
     else
       PHASE_END=$((PHASE_ABS_LINE + NEXT_PHASE_LINE - 1))
     fi

     # Extract phase block
     PHASE_BLOCK=$(sed -n "${PHASE_ABS_LINE},${PHASE_END}p" "$ROADMAP_FILE")

     # Extract goal (line starting with **Goal**:)
     PHASE_GOAL=$(echo "$PHASE_BLOCK" | grep "^\*\*Goal\*\*:" | sed 's/\*\*Goal\*\*: *//')

     # Extract requirements (line starting with **Requirements**:) - may not exist
     REQUIREMENT_IDS=$(echo "$PHASE_BLOCK" | grep "^\*\*Requirements\*\*:" | sed 's/\*\*Requirements\*\*: *//')

     # Extract success criteria (numbered list after **Success Criteria**)
     # Convert to checklist format: "  1. item" -> "- [ ] item"
     SUCCESS_CRITERIA_AS_CHECKLIST=$(echo "$PHASE_BLOCK" | \
       awk '/^\*\*Success Criteria\*\*/{found=1; next} found && /^  [0-9]+\./{print} found && /^\*\*/{exit}' | \
       sed -E 's/^  [0-9]+\. /- [ ] /')

     # [Issue creation code uses these variables - see step 6]
   done
   ```

6. **For each phase, create issue**:
   ```bash
   # Check if issue already exists (idempotent)
   EXISTING=$(gh issue list --label "phase" --milestone "v${VERSION}" --json number,title --jq ".[] | select(.title | startswith(\"Phase ${PHASE_NUM}:\")) | .number" 2>/dev/null)

   if [ -n "$EXISTING" ]; then
     echo "Phase ${PHASE_NUM} issue already exists: #${EXISTING}"
   else
     # Build issue body using temp file (handles special characters safely)
     cat > /tmp/phase-issue-body.md << PHASE_EOF
## Goal

${PHASE_GOAL}

## Success Criteria

${SUCCESS_CRITERIA_AS_CHECKLIST}
$([ -n "$REQUIREMENT_IDS" ] && echo "
## Requirements

${REQUIREMENT_IDS}")

## Plans

<!-- Checklist added by /kata:planning-phases (Phase 4) -->
_Plans will be added after phase planning completes._

---
<sub>Created by Kata | Phase ${PHASE_NUM} of milestone v${VERSION}</sub>
PHASE_EOF

     # Create issue
     gh issue create \
       --title "Phase ${PHASE_NUM}: ${PHASE_NAME}" \
       --body-file /tmp/phase-issue-body.md \
       --label "phase" \
       --milestone "v${VERSION}" \
       2>/dev/null && echo "Created issue: Phase ${PHASE_NUM}: ${PHASE_NAME}" || echo "Warning: Failed to create issue for Phase ${PHASE_NUM}"
   fi
   ```

7. **Display summary** (after loop):
   ```
   ◆ GitHub Phase Issues: [N] created for milestone v${VERSION}
   ```

**Error handling principle:** All operations are non-blocking. Missing milestone, auth issues, or creation failures warn but do not stop the milestone flow.

**IMPORTANT:** Use temp file approach (--body-file) to handle special characters in phase goals. Direct --body strings break with quotes/backticks.
  </action>
  <verify>grep -c "Phase 9.5" SKILL.md returns 1; grep "gh issue create" SKILL.md returns match; grep "PHASE_GOAL=" SKILL.md returns match</verify>
  <done>SKILL.md updated with Phase 9.5 for phase issue creation including ROADMAP parsing logic</done>
</task>

<task type="auto">
  <name>Task 2: Update github-mapping.md documentation</name>
  <files>skills/kata-adding-milestones/references/github-mapping.md</files>
  <action>
Read the current github-mapping.md and update it to reflect the implementation.

1. **Update Mapping Table** - Change the "Phase" row:
   ```
   | **Phase** | GitHub Issue | `add-milestone` (Phase 9.5) | Assigned to corresponding milestone. `phase` label applied. |
   ```
   (Changed from `planning-phases (future)` to `add-milestone (Phase 9.5)`)

2. **Add new section "Phase Issue Creation Flow (Phase 9.5)"** after "Milestone Creation Flow":

   Document the complete flow:
   - When it runs (after roadmap commit, when github.enabled=true)
   - issueMode check (auto/ask/never behavior)
   - Label creation (idempotent with --force)
   - ROADMAP parsing pattern (awk/sed for phase blocks)
   - Issue existence check (idempotent - skip if exists)
   - Issue body template structure
   - Error handling (non-blocking)

3. **Update "Phase Issue Creation (Future)" section** - Remove or mark as "Implemented in Phase 9.5"

4. **Ensure examples show actual command patterns** used in SKILL.md
  </action>
  <verify>grep "add-milestone" github-mapping.md returns match for Phase row; grep "Phase 9.5" github-mapping.md returns match</verify>
  <done>github-mapping.md updated with implementation details</done>
</task>

</tasks>

<verification>
- [ ] SKILL.md contains "Phase 9.5: Create Phase Issues"
- [ ] SKILL.md includes issueMode check (auto/ask/never)
- [ ] SKILL.md includes label creation with --force
- [ ] SKILL.md includes milestone number lookup
- [ ] SKILL.md includes ROADMAP parsing with awk/sed commands
- [ ] SKILL.md assigns PHASE_GOAL, SUCCESS_CRITERIA_AS_CHECKLIST, REQUIREMENT_IDS variables
- [ ] SKILL.md includes idempotent issue existence check
- [ ] SKILL.md uses --body-file pattern (not inline --body)
- [ ] github-mapping.md mapping table shows add-milestone for Phase
- [ ] github-mapping.md has Phase 9.5 flow documentation
</verification>

<success_criteria>
1. Phase issues created with `phase` label when milestone created
2. Issue body includes phase goal and success criteria from ROADMAP.md
3. Phase issues assigned to corresponding GitHub Milestone
4. Issues created respecting `github.issueMode` config setting
</success_criteria>

<output>
After completion, create `.planning/phases/03-phase-issues/03-01-SUMMARY.md`
</output>
