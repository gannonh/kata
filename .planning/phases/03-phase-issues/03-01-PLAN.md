---
phase: 03-phase-issues
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-adding-milestones/SKILL.md
  - skills/kata-adding-milestones/references/github-mapping.md
autonomous: true

must_haves:
  truths:
    - "Phase issues created with phase label when milestone created"
    - "Issue body includes goal and success criteria from ROADMAP.md"
    - "Phase issues assigned to GitHub Milestone"
    - "Issues created only when github.issueMode allows"
  artifacts:
    - path: "skills/kata-adding-milestones/SKILL.md"
      provides: "Phase issue creation logic in Phase 9.5"
      contains: "gh issue create"
    - path: "skills/kata-adding-milestones/references/github-mapping.md"
      provides: "Updated mapping documentation"
      contains: "Phase | GitHub Issue | `add-milestone`"
  key_links:
    - from: "SKILL.md"
      to: "ROADMAP.md"
      via: "parses phase goals and success criteria"
      pattern: "awk.*Phase.*ROADMAP"
    - from: "SKILL.md"
      to: "GitHub API"
      via: "gh issue create with --milestone"
      pattern: "gh issue create.*--milestone"
---

<objective>
Add phase issue creation to kata-adding-milestones skill.

Purpose: When a milestone is created with phases defined in ROADMAP.md, create corresponding GitHub Issues for each phase, assigned to the milestone with the `phase` label.

Output:
- Updated `kata-adding-milestones/SKILL.md` with new Phase 9.5 (Create Phase Issues)
- Updated `github-mapping.md` to reflect the implementation
</objective>

<execution_context>
@~/.claude/kata/references/execute-plan.md
@~/.claude/kata/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-phase-issues/03-RESEARCH.md

Current skill:
@skills/kata-adding-milestones/SKILL.md
@skills/kata-adding-milestones/references/github-mapping.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 9.5 - Create Phase Issues to SKILL.md</name>
  <files>skills/kata-adding-milestones/SKILL.md</files>
  <action>
Read the current SKILL.md and add a new Phase 9.5 after Phase 9 (Create Roadmap) and before Phase 10 (Done).

Insert between the roadmap commit section and the completion banner. The new phase should:

**Phase 9.5: Create Phase Issues (if enabled)**

1. **Check github.enabled** - Skip silently if false

2. **Check github.issueMode** (auto | ask | never):
   - If "never": Skip phase issue creation silently
   - If "ask": Use AskUserQuestion to prompt:
     ```
     header: "GitHub Phase Issues"
     question: "Create GitHub Issues for each phase in this milestone?"
     options:
       - "Yes" — Create issues for all phases
       - "No" — Skip issue creation for this milestone
     ```
   - If "auto" or user approved: Proceed with creation

3. **Create phase label (idempotent)**:
   ```bash
   gh label create "phase" --color "0E8A16" --description "Kata phase tracking" --force 2>/dev/null || true
   ```

4. **Get milestone number** (from Phase 5.5):
   ```bash
   MILESTONE_NUM=$(gh api /repos/:owner/:repo/milestones --jq ".[] | select(.title==\"v${VERSION}\") | .number" 2>/dev/null)
   if [ -z "$MILESTONE_NUM" ]; then
     echo "Warning: Could not find GitHub Milestone v${VERSION}. Skipping phase issue creation."
     # Continue without phase issues
   fi
   ```

5. **Parse phases from ROADMAP.md** (for this milestone only):
   ```bash
   # Extract phase numbers for this milestone (look for milestone header, get phases until next milestone)
   # Phases in ROADMAP.md follow pattern: "#### Phase N: Name"
   # Phase details include Goal and Success Criteria
   ```

6. **For each phase, create issue**:
   ```bash
   # Check if issue already exists (idempotent)
   EXISTING=$(gh issue list --label "phase" --milestone "$MILESTONE_NUM" --json number,title --jq ".[] | select(.title | startswith(\"Phase ${PHASE_NUM}:\")) | .number" 2>/dev/null)

   if [ -n "$EXISTING" ]; then
     echo "Phase ${PHASE_NUM} issue already exists: #${EXISTING}"
   else
     # Build issue body using HEREDOC (handles special characters)
     cat > /tmp/phase-issue-body.md << 'PHASE_EOF'
   ## Goal

   ${PHASE_GOAL}

   ## Success Criteria

   ${SUCCESS_CRITERIA_AS_CHECKLIST}

   ## Requirements

   ${REQUIREMENT_IDS}

   ## Plans

   <!-- Checklist added by /kata:planning-phases (Phase 4) -->
   _Plans will be added after phase planning completes._

   ---
   <sub>Created by Kata | Phase ${PHASE_NUM} of milestone v${VERSION}</sub>
   PHASE_EOF

     # Create issue
     gh issue create \
       --title "Phase ${PHASE_NUM}: ${PHASE_NAME}" \
       --body-file /tmp/phase-issue-body.md \
       --label "phase" \
       --milestone "$MILESTONE_NUM" \
       2>/dev/null && echo "Created issue: Phase ${PHASE_NUM}: ${PHASE_NAME}" || echo "Warning: Failed to create issue for Phase ${PHASE_NUM}"
   fi
   ```

7. **Display summary** (after loop):
   ```
   ◆ GitHub Phase Issues: [N] created for milestone v${VERSION}
   ```

**Error handling principle:** All operations are non-blocking. Missing milestone, auth issues, or creation failures warn but do not stop the milestone flow.

**IMPORTANT:** Use temp file approach (--body-file) to handle special characters in phase goals. Direct --body strings break with quotes/backticks.
  </action>
  <verify>grep -c "Phase 9.5" SKILL.md returns 1; grep "gh issue create" SKILL.md returns match</verify>
  <done>SKILL.md updated with Phase 9.5 for phase issue creation</done>
</task>

<task type="auto">
  <name>Task 2: Update github-mapping.md documentation</name>
  <files>skills/kata-adding-milestones/references/github-mapping.md</files>
  <action>
Read the current github-mapping.md and update it to reflect the implementation.

1. **Update Mapping Table** - Change the "Phase" row:
   ```
   | **Phase** | GitHub Issue | `add-milestone` (Phase 9.5) | Assigned to corresponding milestone. `phase` label applied. |
   ```
   (Changed from `planning-phases (future)` to `add-milestone (Phase 9.5)`)

2. **Add new section "Phase Issue Creation Flow (Phase 9.5)"** after "Milestone Creation Flow":

   Document the complete flow:
   - When it runs (after roadmap commit, when github.enabled=true)
   - issueMode check (auto/ask/never behavior)
   - Label creation (idempotent with --force)
   - ROADMAP parsing pattern (awk for phase blocks)
   - Issue existence check (idempotent - skip if exists)
   - Issue body template structure
   - Error handling (non-blocking)

3. **Update "Phase Issue Creation (Future)" section** - Remove or mark as "Implemented in Phase 9.5"

4. **Ensure examples show actual command patterns** used in SKILL.md
  </action>
  <verify>grep "add-milestone" github-mapping.md returns match for Phase row; grep "Phase 9.5" github-mapping.md returns match</verify>
  <done>github-mapping.md updated with implementation details</done>
</task>

</tasks>

<verification>
- [ ] SKILL.md contains "Phase 9.5: Create Phase Issues"
- [ ] SKILL.md includes issueMode check (auto/ask/never)
- [ ] SKILL.md includes label creation with --force
- [ ] SKILL.md includes milestone number lookup
- [ ] SKILL.md includes ROADMAP parsing for phases
- [ ] SKILL.md includes idempotent issue existence check
- [ ] SKILL.md uses --body-file pattern (not inline --body)
- [ ] github-mapping.md mapping table shows add-milestone for Phase
- [ ] github-mapping.md has Phase 9.5 flow documentation
</verification>

<success_criteria>
1. Phase issues created with `phase` label when milestone created
2. Issue body includes phase goal and success criteria from ROADMAP.md
3. Phase issues assigned to corresponding GitHub Milestone
4. Issues created respecting `github.issueMode` config setting
</success_criteria>

<output>
After completion, create `.planning/phases/03-phase-issues/03-01-SUMMARY.md`
</output>
