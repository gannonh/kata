---
phase: 07-deprecate-npx-support
plan: 03
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified:
  - scripts/build.js
  - tests/build.test.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Build system only produces plugin distribution"
    - "NPM build target removed from build.js"
    - "NPM build tests removed from test file"
    - "package.json files array minimized for deprecation package"
  artifacts:
    - path: "scripts/build.js"
      provides: "Plugin-only build script"
      contains: "buildPlugin"
    - path: "tests/build.test.js"
      provides: "Plugin-only build tests"
      min_lines: 50
    - path: "package.json"
      provides: "Minimal files array"
      contains: '"bin"'
  key_links:
    - from: "scripts/build.js"
      to: "dist/plugin/"
      via: "buildPlugin function"
      pattern: "dist.*plugin"
---

<objective>
Simplify build system to plugin-only distribution.

Purpose: With NPX deprecated, the dual-target build system (plugin + npm) can be reduced to plugin-only. The npm distribution will be a minimal deprecation stub.

Output: Simplified build.js, updated tests, minimal package.json files array.
</objective>

<execution_context>
Current state:
- `npm run build` runs both plugin and npm targets
- `npm run build:plugin` runs plugin only
- `npm run build:npm` runs npm only

Target state:
- `npm run build` runs plugin only (same as build:plugin)
- `npm run build:npm` removed
- Tests only validate plugin build
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@scripts/build.js
@tests/build.test.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove NPM build target from build.js</name>
  <files>scripts/build.js</files>
  <action>
Modify scripts/build.js to remove NPM build functionality:

1. Remove `NPM_INCLUDES` constant
2. Remove `buildNpm()` function
3. Update `main()` to only support 'plugin' target (or default to plugin)
4. Remove npm-specific validation from `validateBuild()`
5. Remove renameSkillDir() and transformSkillName() since source now matches distribution (skills already renamed in 07-01)
6. Clean up COMMON_INCLUDES to remove npm-specific items

The result should be a lean plugin-only build script. Key functions to keep:
- `cleanDir()`
- `shouldExclude()`
- `copyFile()`, `copyDir()`, `copyPath()`
- `transformPluginPaths()` (for agent/skill Skill() invocations)
- `copySkillsForPlugin()` (simplified - no rename needed)
- `copySkillContents()` (simplified - no name transform needed)
- `writeVersion()`
- `validateBuild()` (plugin-only validation)
- `buildPlugin()`

Update main() to:
```javascript
function main() {
  const args = process.argv.slice(2);
  const target = args[0] || 'plugin';

  if (target !== 'plugin' && target !== 'all') {
    console.error(`Unknown target: ${target}`);
    console.log(`\nUsage: node scripts/build.js [plugin]`);
    process.exit(1);
  }

  const success = buildPlugin();
  if (!success) process.exit(1);
  console.log(`\n${green}Build complete!${reset}\n`);
}
```
  </action>
  <verify>
```bash
# Build plugin
npm run build:plugin

# Verify dist/plugin exists
ls dist/plugin/

# Verify no dist/npm (or empty)
ls dist/npm 2>/dev/null && echo "WARN: dist/npm still exists" || echo "OK: no dist/npm"
```
  </verify>
  <done>build.js simplified to plugin-only, NPM build code removed</done>
</task>

<task type="auto">
  <name>Task 2: Update tests and package.json</name>
  <files>tests/build.test.js, package.json</files>
  <action>
1. **tests/build.test.js**: Remove NPM build test suite
   - Delete entire `describe('NPM build', ...)` block
   - Delete `describe('Version consistency', ...)` test for npm VERSION
   - Keep plugin build tests
   - Update any tests that reference npm paths

2. **package.json**: Update for deprecation package
   - Keep `bin` field (needed for npx to work)
   - Reduce `files` array to just `["bin"]` - deprecation stub only needs bin/install.js
   - Remove npm build scripts:
     - Remove `"build:npm": "node scripts/build.js npm"`
     - Update `"build": "node scripts/build.js plugin"` (just plugin)
   - Keep `"build:plugin"` for clarity
   - Keep `"build:hooks"` if hooks are still used

Final package.json files array:
```json
"files": [
  "bin"
]
```

Final scripts (relevant ones):
```json
"scripts": {
  "test": "node --test --test-reporter spec ./tests/build.test.js",
  "build": "node scripts/build.js plugin",
  "build:plugin": "node scripts/build.js plugin",
  "build:hooks": "node scripts/build-hooks.cjs",
  "prepublishOnly": "npm run build:hooks"
}
```
  </action>
  <verify>
```bash
# Run tests (should pass with reduced test suite)
npm test

# Verify package.json files array
node -p "require('./package.json').files"
# Should show ["bin"] or similar minimal array

# Verify build scripts
node -p "require('./package.json').scripts.build"
# Should reference plugin only
```
  </verify>
  <done>Tests reduced to plugin-only, package.json minimized for deprecation</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds (plugin only)
- [ ] `npm test` passes with reduced test suite
- [ ] `ls dist/plugin/skills/` shows renamed skills (no kata- prefix)
- [ ] `node -p "require('./package.json').files"` shows minimal array
</verification>

<success_criteria>
1. build.js only builds plugin distribution
2. NPM build tests removed
3. package.json files array reduced to ["bin"]
4. npm scripts updated (no build:npm)
5. `npm run build` and `npm test` pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-deprecate-npx-support/07-03-SUMMARY.md`
</output>
