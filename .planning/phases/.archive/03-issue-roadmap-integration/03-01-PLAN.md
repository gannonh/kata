---
phase: 03-issue-roadmap-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/add-milestone/SKILL.md
  - skills/check-issues/SKILL.md
autonomous: true

must_haves:
  truths:
    - "User can select backlog issues during milestone scope definition"
    - "User can link an issue to an existing phase for planned work"
    - "Issue-phase linkage is tracked in STATE.md"
  artifacts:
    - path: "skills/add-milestone/SKILL.md"
      provides: "Issue selection step in milestone flow"
      contains: "Backlog Issues"
    - path: "skills/check-issues/SKILL.md"
      provides: "Complete phase linkage flow"
      contains: "linked_phase"
  key_links:
    - from: "skills/add-milestone/SKILL.md"
      to: ".planning/issues/open/*.md"
      via: "AskUserQuestion multiSelect"
      pattern: "multiSelect.*true"
    - from: "skills/check-issues/SKILL.md"
      to: ".planning/STATE.md"
      via: "linkage tracking"
      pattern: "linked_phase"
---

<objective>
Add issue selection to milestone scope definition and complete the "Link to existing phase" flow in check-issues.

Purpose: Enable users to pull backlog issues into milestones and phases, completing the bidirectional link between issues and the roadmap.
Output: Updated add-milestone and check-issues skills with issue-roadmap integration.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-issue-roadmap-integration/03-RESEARCH.md

@skills/add-milestone/SKILL.md
@skills/check-issues/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue selection to add-milestone</name>
  <files>skills/add-milestone/SKILL.md</files>
  <action>
Add a new step "Phase 7.5: Issue Selection" between Phase 7 (Research Decision) and Phase 8 (Define Requirements).

The step should:

1. Check for backlog issues:
```bash
BACKLOG_COUNT=$(ls .planning/issues/open/*.md 2>/dev/null | wc -l | tr -d ' ')
```

2. If BACKLOG_COUNT > 0, present issue selection using AskUserQuestion:
   - header: "Backlog Issues"
   - question: "Include any backlog issues in this milestone's scope?"
   - multiSelect: true
   - options: Build dynamically from open issues (title, area, age)
   - Include "None — Start fresh" option

3. For each selected issue:
   - Note in planning context for requirements phase
   - Store as SELECTED_ISSUES variable for use in Phase 8

4. If BACKLOG_COUNT = 0, skip silently

The pattern for listing issues should follow check-issues list_issues step:
```bash
for file in .planning/issues/open/*.md; do
  [ -f "$file" ] || continue
  created=$(grep "^created:" "$file" | cut -d' ' -f2)
  title=$(grep "^title:" "$file" | cut -d':' -f2- | xargs)
  area=$(grep "^area:" "$file" | cut -d' ' -f2)
  echo "$file|$title|$area|$created"
done
```

Format options as: `"[title]" — [area], [age]`

This is informational only for this milestone — selected issues provide context during requirements definition but don't automatically become requirements. User still defines requirements through the existing Phase 8 flow.
  </action>
  <verify>
Read skills/add-milestone/SKILL.md and confirm:
- "Phase 7.5" or equivalent step exists
- Step checks for open issues
- AskUserQuestion with multiSelect: true
- SELECTED_ISSUES variable captured
  </verify>
  <done>add-milestone presents backlog issues for milestone scope selection when issues exist</done>
</task>

<task type="auto">
  <name>Task 2: Complete check-issues phase linkage</name>
  <files>skills/check-issues/SKILL.md</files>
  <action>
Enhance the "Link to existing phase" flow in the execute_action step to properly track issue-phase linkage.

Currently the flow:
1. Finds upcoming phases
2. Presents selection
3. Notes linkage in STATE.md "### Pending Issues" (stub)
4. Displays confirmation

Update to properly implement step 3:

When phase is selected:

1. Read STATE.md
2. Find or create "### Pending Issues" section
3. Add linkage entry with format:
```
- [issue-title] → Phase [N]: [phase-name]
  - File: [issue-file-path]
  - GitHub: #[number] (if linked)
  - Linked: [timestamp]
```

4. Write updated STATE.md

The linked_phase annotation enables:
- Phase planning can check STATE.md for linked issues
- Issue shows association in check-issues list
- Traceability for auditing

Also add a note to the issue file itself:
```bash
# Add linked_phase to issue frontmatter
sed -i '' '/^---$/,/^---$/{s/^---$/---\nlinked_phase: [phase-name]/;:a;n;ba}' "$ISSUE_FILE"
```

This creates bidirectional tracking: STATE.md knows which issues are linked to phases, and issues know which phase they're linked to.

Handle edge cases:
- STATE.md doesn't have "### Pending Issues" section: Create it
- Issue already linked to a phase: Warn and ask to override or cancel
- Phase doesn't exist in ROADMAP.md: Show error message
  </action>
  <verify>
Read skills/check-issues/SKILL.md execute_action step and confirm:
- STATE.md update logic exists
- "### Pending Issues" section handling
- linked_phase format in STATE.md
- Issue file frontmatter update
  </verify>
  <done>"Link to existing phase" properly tracks issue-phase linkage in STATE.md and issue file</done>
</task>

</tasks>

<verification>
1. Read skills/add-milestone/SKILL.md — confirm issue selection step exists
2. Read skills/check-issues/SKILL.md — confirm phase linkage tracking complete
3. Pattern check: grep for "multiSelect.*true" in add-milestone
4. Pattern check: grep for "linked_phase" in check-issues
</verification>

<success_criteria>
- [ ] add-milestone presents backlog issues during milestone scope definition
- [ ] User can select multiple issues to inform milestone scope
- [ ] check-issues "Link to existing phase" updates STATE.md properly
- [ ] Issue files track their linked phase in frontmatter
- [ ] Both skills remain functional with existing features
</success_criteria>

<output>
After completion, create `.planning/phases/03-issue-roadmap-integration/03-01-SUMMARY.md`
</output>
