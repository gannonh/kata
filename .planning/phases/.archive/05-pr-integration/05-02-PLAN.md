---
phase: 05-pr-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - skills/kata-tracking-progress/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Progress skill shows PR status when pr_workflow: true"
    - "PR status includes state (draft/ready/merged)"
    - "PR status shows PR number and title"
  artifacts:
    - path: "skills/kata-tracking-progress/SKILL.md"
      provides: "PR status display in progress report"
      contains: "gh pr"
  key_links:
    - from: "skills/kata-tracking-progress/SKILL.md"
      to: ".planning/config.json"
      via: "pr_workflow config read"
      pattern: "PR_WORKFLOW.*pr_workflow"
---

<objective>
Add PR status display to kata-tracking-progress when pr_workflow: true.

Purpose: Show PR state (draft/ready/merged) in progress reports so users can see execution status from both planning and GitHub perspectives.

Output: Updated SKILL.md with PR status section in the report step.
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pr-integration/05-RESEARCH.md

Key file to modify:
@skills/kata-tracking-progress/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PR status to progress report</name>
  <files>skills/kata-tracking-progress/SKILL.md</files>
  <action>
    In the "report" step, after loading config in the "load" step, add PR workflow config reading:

    ```bash
    PR_WORKFLOW=$(cat .planning/config.json 2>/dev/null | grep -o '"pr_workflow"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
    ```

    In the "report" step, add a new section after "## Active Debug Sessions" (or before "## What's Next"):

    ```markdown
    ## PR Status
    ```

    Only display this section when pr_workflow: true.

    Check for PR on current branch or phase branch:
    ```bash
    if [ "$PR_WORKFLOW" = "true" ]; then
      # Get current branch
      CURRENT_BRANCH=$(git branch --show-current)

      # Check if there's a PR for this branch
      PR_INFO=$(gh pr list --head "$CURRENT_BRANCH" --json number,state,title,url --jq '.[0]' 2>/dev/null)

      if [ -n "$PR_INFO" ] && [ "$PR_INFO" != "null" ]; then
        PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
        PR_STATE=$(echo "$PR_INFO" | jq -r '.state')
        PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
        PR_URL=$(echo "$PR_INFO" | jq -r '.url')

        # Map state to display
        case "$PR_STATE" in
          "OPEN")
            # Check if draft
            IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft --jq '.isDraft' 2>/dev/null)
            if [ "$IS_DRAFT" = "true" ]; then
              STATE_DISPLAY="Draft"
            else
              STATE_DISPLAY="Ready for review"
            fi
            ;;
          "MERGED") STATE_DISPLAY="Merged" ;;
          "CLOSED") STATE_DISPLAY="Closed" ;;
          *) STATE_DISPLAY="$PR_STATE" ;;
        esac
      fi
    fi
    ```

    Output format in report:
    ```
    ## PR Status

    PR #[number]: [title]
    Status: [Draft | Ready for review | Merged]
    URL: [url]
    ```

    If no PR exists:
    ```
    ## PR Status

    No open PR for current branch.
    Branch: [current_branch]
    ```

    If pr_workflow: false, skip this section entirely (don't show empty section).
  </action>
  <verify>grep -A 15 "PR Status" skills/kata-tracking-progress/SKILL.md | grep -q "gh pr"</verify>
  <done>Progress report shows PR status when pr_workflow: true, including state and URL</done>
</task>

<task type="auto">
  <name>Task 2: Update route displays with PR context</name>
  <files>skills/kata-tracking-progress/SKILL.md</files>
  <action>
    Update Route A (unexecuted plan exists) and Route C (phase complete, more phases) to include PR context when pr_workflow: true.

    In Route A, add after the plan objective line:
    ```
    {If pr_workflow AND PR exists: PR #[number] ([state]) — [url]}
    ```

    In Route C (Phase complete, more phases remain), add:
    ```
    ## Phase [Z] Complete

    {If pr_workflow: PR #[number] ready for review — merge before continuing}
    ```

    In Route D (Milestone complete), add:
    ```
    {If pr_workflow: All phase PRs should be merged before completing milestone}
    ```

    The PR context helps users know when to merge PRs during the workflow.
  </action>
  <verify>grep -A 20 "Route A" skills/kata-tracking-progress/SKILL.md | grep -q "pr_workflow\|PR"</verify>
  <done>Route displays include PR context when pr_workflow: true</done>
</task>

</tasks>

<verification>
```bash
# Verify PR status integration
grep "PR Status" skills/kata-tracking-progress/SKILL.md && echo "PR Status section exists"
grep "pr_workflow" skills/kata-tracking-progress/SKILL.md && echo "pr_workflow config check exists"
grep "gh pr" skills/kata-tracking-progress/SKILL.md && echo "gh pr commands exist"
```
</verification>

<success_criteria>
- [ ] Progress report includes PR Status section when pr_workflow: true
- [ ] PR status shows number, title, state (draft/ready/merged), and URL
- [ ] No PR Status section when pr_workflow: false
- [ ] Route displays include PR context where relevant
</success_criteria>

<output>
After completion, create `.planning/phases/05-pr-integration/05-02-SUMMARY.md`
</output>
