# Phase 7: Deprecate NPX Support - Research

**Researched:** 2026-01-27
**Domain:** NPX/NPM distribution removal, plugin-only distribution
**Confidence:** HIGH

## Summary

This phase removes the NPX distribution path from Kata, making it plugin-only. The NPX distribution was the original installation method (`npx @gannonh/kata`) that copies Kata files to `~/.claude/` or `./.claude/`. With the Claude Code plugin marketplace now mature and established as the primary distribution channel, maintaining dual distribution adds complexity without significant benefit.

The deprecation is straightforward: remove NPX-specific code, update build system to plugin-only, remove CI workflows for NPM publishing, and update all documentation. Existing NPX users should migrate to the plugin installation method.

**Primary recommendation:** Clean break with clear migration path. Remove all NPX code rather than maintaining deprecated stubs.

## Standard Stack

No new libraries needed. This phase removes code rather than adding it.

### Files to Remove

| File/Directory | Purpose | Notes |
| -------------- | ------- | ----- |
| `bin/install.js` | NPX entry point installer | 563 lines, handles global/local install |
| `dist/npm/` | NPM build output | Generated by build system |
| `hooks/kata-check-update.js` | NPX update checker hook | Checks npm registry for updates |
| `hooks/kata-npm-statusline.js` | NPX statusline with update indicator | Shows `/kata:update` prompt |
| `skills/kata-updating/` | NPX update skill | Runs `npx @gannonh/kata` |
| `commands/kata/update.md` | Update command wrapper | Invokes kata-updating skill |
| `.github/workflows/publish.yml` | NPM publish workflow | Publishes to npm registry |

### Files to Modify

| File | Change Required |
| ---- | --------------- |
| `package.json` | Remove `bin` entry, `files` list, NPM-specific scripts |
| `scripts/build.js` | Remove NPM build target, simplify to plugin-only |
| `tests/build.test.js` | Remove NPM build tests |
| `README.md` | Remove NPX installation instructions |
| `CLAUDE.md` | Remove NPX invocation syntax references |
| `KATA-STYLE.md` | Remove NPX path references |
| `docs/release-mgmt.md` | Remove NPM release process documentation |
| `.github/workflows/plugin-release.yml` | Remove dependency on publish.yml |
| Various skills/agents | Remove `~/.claude/` path handling |

## Architecture Patterns

### Current Dual Distribution Architecture

```
Source repo (kata/)
       |
   build.js
       |
   +---+---+
   |       |
dist/npm  dist/plugin
   |           |
   v           v
NPM registry  kata-marketplace
(@gannonh/kata)    (plugin)
```

### Target Plugin-Only Architecture

```
Source repo (kata/)
       |
   build.js
       |
   dist/plugin
       |
       v
  kata-marketplace
     (plugin)
```

### Path Resolution Changes

**Before (dual distribution):**
- NPX: `~/.claude/skills/kata-*` or `./.claude/skills/kata-*`
- Plugin: `.claude/skills/*` (kata- prefix stripped)

**After (plugin-only):**
- Plugin only: `.claude/skills/*` (kata- prefix stripped)
- All `@~/.claude/` patterns removed from source

### Build System Simplification

Current `scripts/build.js` handles two targets:
1. `plugin` - Transforms paths, strips prefixes, outputs to `dist/plugin/`
2. `npm` - No transforms, outputs to `dist/npm/`

After deprecation:
- Remove `buildNpm()` function
- Remove `NPM_INCLUDES` constant
- Remove `npm` target from CLI
- Rename `build all` to just `build`
- Simplify validation to plugin-only checks

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
| ------- | ----------- | ----------- | --- |
| Migration messaging | Custom deprecation system | README banner + CHANGELOG entry | Simple, visible |
| Version tracking | Custom tracking | Plugin marketplace version | Single source of truth |
| Update notifications | Custom hook | Plugin marketplace update system | Built into Claude Code |

**Key insight:** The plugin marketplace already handles versioning, updates, and distribution. Removing NPX eliminates duplicate systems.

## Common Pitfalls

### Pitfall 1: Breaking Existing NPX Users Without Notice

**What goes wrong:** Users running `npx @gannonh/kata` get errors after NPM package removal
**Why it happens:** NPM package is unpublished or points to deprecated code
**How to avoid:**
1. Publish final NPM version with deprecation notice
2. Keep package on NPM but make it print migration instructions
3. Update README before code removal
**Warning signs:** Support requests from NPX users

### Pitfall 2: Orphaned Path References

**What goes wrong:** Code still references `~/.claude/` paths that no longer exist
**Why it happens:** Incomplete search/replace across codebase
**How to avoid:**
1. Use grep to find ALL `~/.claude/` references
2. Test plugin installation from scratch
3. Run build validation tests
**Warning signs:** "File not found" errors in plugin mode

### Pitfall 3: Breaking CI/CD Dependencies

**What goes wrong:** Plugin release workflow fails because it depends on NPM workflow
**Why it happens:** `workflow_run` trigger references deleted workflow
**How to avoid:**
1. Update plugin-release.yml to trigger directly on push to main
2. Remove workflow_run dependency
3. Test CI pipeline before merging
**Warning signs:** Plugin releases stop working

### Pitfall 4: Incomplete Documentation Update

**What goes wrong:** Users find outdated NPX instructions in docs
**Why it happens:** Documentation spread across multiple files
**How to avoid:**
1. Grep for `npx`, `npm`, `~/.claude/` across ALL markdown files
2. Update CLAUDE.md, README.md, KATA-STYLE.md, docs/
3. Update skill descriptions that mention NPX
**Warning signs:** Confused users, stale documentation

### Pitfall 5: Leaving NPM Package in Broken State

**What goes wrong:** Old NPM package installs but doesn't work
**Why it happens:** Package exists but code is gone
**How to avoid:**
1. Either: Keep final version with deprecation message
2. Or: Unpublish package (72-hour window)
3. Document migration clearly
**Warning signs:** NPM install errors, broken installs

## Code Examples

### Deprecation Notice for Final NPM Version

If keeping package on NPM with deprecation:

```javascript
#!/usr/bin/env node
// bin/install.js - Final deprecation version

const amber = '\x1b[33m';
const reset = '\x1b[0m';

console.log(`
${amber}╔═══════════════════════════════════════════════════════════╗
║  Kata NPX installation has been deprecated                 ║
╚═══════════════════════════════════════════════════════════╝${reset}

Kata is now distributed exclusively as a Claude Code plugin.

${amber}To install:${reset}
  1. Start Claude Code: ${amber}claude${reset}
  2. Run: ${amber}/plugin install kata@gannonh-kata-marketplace${reset}

For more information: https://github.com/gannonh/kata

`);
process.exit(0);
```

### Updated Plugin Release Workflow

Remove workflow_run dependency:

```yaml
# .github/workflows/plugin-release.yml
name: Plugin Release

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - '.claude-plugin/plugin.json'

jobs:
  release:
    runs-on: ubuntu-latest
    # ... rest of workflow
```

### Build Script Simplification

```javascript
// scripts/build.js - Plugin-only version
function main() {
  const args = process.argv.slice(2);
  const target = args[0] || 'plugin';

  if (target !== 'plugin' && target !== 'all') {
    console.error('Usage: node scripts/build.js [plugin]');
    process.exit(1);
  }

  return buildPlugin();
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
| ------------ | ---------------- | ------------ | ------ |
| NPX + Plugin dual distribution | Plugin-only | Phase 7 | Simplified maintenance |
| `~/.claude/` path resolution | Plugin-relative paths | v1.0.8 (Phase 2.1) | Enabled plugin-only |
| Manual update via npx | Claude Code plugin update | Plugin release | Native updates |

**Deprecated/outdated after this phase:**
- `npx @gannonh/kata` installation method
- `~/.claude/kata/` directory structure for NPX installs
- `/kata:update` command (replaced by `/plugin update`)
- NPM registry as distribution channel

## Open Questions

1. **NPM Package Fate**
   - What we know: Package can be deprecated, unpublished, or kept with message
   - What's unclear: Best practice for npm deprecation
   - Recommendation: Keep package with deprecation message pointing to plugin

2. **Existing NPX Installations**
   - What we know: Files will remain in `~/.claude/` until manually removed
   - What's unclear: Should we provide cleanup instructions?
   - Recommendation: Add migration section to README with cleanup commands

3. **Local Development Workflow**
   - What we know: `node bin/install.js --local` used for testing
   - What's unclear: How to test plugin builds locally without marketplace
   - Recommendation: Use `--plugin-dir` flag for local testing

## Sources

### Primary (HIGH confidence)
- `bin/install.js` - NPX installer implementation (563 lines)
- `scripts/build.js` - Build system with dual targets
- `.github/workflows/publish.yml` - NPM publish workflow
- `docs/release-mgmt.md` - Current release process documentation

### Secondary (MEDIUM confidence)
- `CLAUDE.md` - Documents NPX vs plugin invocation syntax
- `README.md` - User-facing installation instructions
- `hooks/kata-check-update.js` - Update checking mechanism

### Tertiary (LOW confidence)
- Historical planning docs in `.planning/phases/.archive/`

## Metadata

**Confidence breakdown:**
- Files to remove: HIGH - Direct code inspection
- Files to modify: HIGH - Grep analysis of codebase
- Migration strategy: MEDIUM - Best practices, no official guidance
- NPM package handling: MEDIUM - Multiple valid approaches

**Research date:** 2026-01-27
**Valid until:** 30 days (stable domain, no external dependencies)

---

## Inventory: Files Affected by NPX Deprecation

### Files to Delete (Complete Removal)

1. **`bin/install.js`** - NPX entry point (563 lines)
   - Global/local installation logic
   - Path replacement for `~/.claude/`
   - Settings.json hook configuration

2. **`skills/kata-updating/SKILL.md`** - Update skill
   - Runs `npx @gannonh/kata --global`
   - Version comparison with npm registry

3. **`commands/kata/update.md`** - Update command (if exists)
   - Wrapper for kata-updating skill

4. **`hooks/kata-check-update.js`** - Update checker hook
   - SessionStart hook checking npm for updates
   - Writes to cache for statusline

5. **`hooks/kata-npm-statusline.js`** - NPM statusline
   - Shows update indicator when new version available

6. **`.github/workflows/publish.yml`** - NPM publish workflow
   - Triggers on main push with version change
   - Builds npm distribution, publishes to registry

### Files to Modify

1. **`package.json`**
   - Remove: `"bin": {"kata": "bin/install.js"}`
   - Remove: `"files": ["bin", ...]`
   - Update: scripts (remove build:npm, test references)

2. **`scripts/build.js`**
   - Remove: `buildNpm()` function
   - Remove: `NPM_INCLUDES` constant
   - Remove: npm target from CLI
   - Simplify: `main()` to plugin-only

3. **`tests/build.test.js`**
   - Remove: 'NPM build' describe block
   - Remove: NPM-related test cases
   - Keep: Plugin build tests

4. **`.github/workflows/plugin-release.yml`**
   - Change: trigger from `workflow_run` to `push`
   - Remove: dependency on publish.yml

5. **`README.md`**
   - Remove: NPX installation instructions
   - Remove: NPX update instructions
   - Add: Deprecation notice for existing NPX users
   - Update: Installation to plugin-only

6. **`CLAUDE.md`**
   - Remove: NPX invocation syntax
   - Remove: NPX path references
   - Update: Skills Architecture table

7. **`KATA-STYLE.md`**
   - Remove: NPX path references in "@-Reference Patterns"
   - Remove: NPX build target mentions

8. **`docs/release-mgmt.md`**
   - Remove: NPM distribution channel
   - Remove: publish.yml documentation
   - Simplify: Release flow to plugin-only

9. **`skills/kata-providing-help/SKILL.md`**
   - Remove: NPX update reference

10. **`skills/kata-showing-whats-new/SKILL.md`**
    - Remove: NPX update instructions

11. **`hooks/kata-plugin-statusline.js`**
    - May need updates if it references npm

12. **Various agent files** - Search for `~/.claude/` references

### Files to Verify (May Need Updates)

```bash
# Find all NPX/npm references
grep -r "npx" --include="*.md" --include="*.js" --include="*.json" .
grep -r "npm" --include="*.md" --include="*.js" .
grep -r "~/.claude/" --include="*.md" .
grep -r "install.js" --include="*.md" --include="*.js" .
```

This inventory provides the complete scope of changes needed for the deprecation.
