---
phase: 02-phase-movement
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - skills/kata-move-phase/SKILL.md
  - skills/kata-help/SKILL.md
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "User can reorder phases within a milestone via /kata:kata-move-phase N before M"
    - "Reordering renumbers all affected phases automatically"
    - "Move-phase skill appears in /kata:kata-help listing"
    - "REQUIREMENTS.md traceability updated for PHASE-02, PHASE-03, PHASE-04"
  artifacts:
    - path: "skills/kata-move-phase/SKILL.md"
      provides: "Reorder capability added to move-phase skill"
      contains: "before"
    - path: "skills/kata-help/SKILL.md"
      provides: "Move-phase listed in help"
      contains: "kata-move-phase"
  key_links:
    - from: "skills/kata-move-phase/SKILL.md"
      to: ".planning/ROADMAP.md"
      via: "Phase section reordering and renumbering"
      pattern: "reorder|before|after"
    - from: "skills/kata-help/SKILL.md"
      to: "skills/kata-move-phase/SKILL.md"
      via: "Help listing reference"
      pattern: "kata-move-phase"
---

<objective>
Add within-milestone reorder capability to kata-move-phase (PHASE-03) and wire up help listing and requirements traceability.

Purpose: Complete the move-phase skill with reorder support and ensure it's discoverable and tracked.
Output: Extended skill with reorder, updated help, updated requirements traceability.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-phase-movement/02-RESEARCH.md
@.planning/phases/02-phase-movement/02-01-SUMMARY.md

# Files to modify
@skills/kata-move-phase/SKILL.md
@skills/kata-help/SKILL.md
@skills/kata-remove-phase/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add within-milestone reorder capability to kata-move-phase (PHASE-03)</name>
  <files>skills/kata-move-phase/SKILL.md</files>
  <action>
Extend the existing kata-move-phase skill (created in Plan 01) to handle within-milestone reordering. The skill's parse_arguments step already detects "before"/"after" keywords. Add the reorder implementation.

**Invocation patterns to support:**
- `/kata:kata-move-phase 3 before 1` - Move Phase 3 to position 1 (before current Phase 1)
- `/kata:kata-move-phase 3 after 1` - Move Phase 3 to position 2 (after current Phase 1)

**Add/modify these steps for the reorder operation:**

1. **step: validate_reorder_target** (new step, after validate_phase_movable)
   - Target position phase must exist in same milestone
   - Target position phase can be any state (active, pending, completed) since we're reordering the roadmap, but the phase being moved must be pending
   - "before 1" means the phase takes position 1 and everything else shifts up
   - "after 1" means the phase takes position 2 and phases 2+ shift up

2. **step: confirm_reorder** (new step)
   - Show: "Reordering Phase {N}: {Name}"
   - Show the new order of all phases in the milestone
   - Wait for confirmation

3. **step: reorder_roadmap** (new step)
   - Remove the phase section from its current position in ROADMAP.md
   - Insert at the target position
   - Renumber ALL phases in the milestone sequentially (1, 2, 3, ...)
   - Update dependency references within the milestone

4. **step: renumber_all_directories** (new step)
   - Rename ALL phase directories in the milestone to match new numbering
   - Process rename order carefully to avoid conflicts:
     - Use temporary names if needed, OR
     - Process in correct order (for shifts down: lowest first; for shifts up: highest first)
   - Rename files inside each renumbered directory
   - Handle decimal phases (N.1, N.2 follow their parent integer)

5. Update the existing **step: update_state** to also handle the reorder case

6. Update the existing **step: commit** for reorder: `"chore: reorder phase {N} {before|after} {M}"`

7. Update **step: completion** to show reorder-specific summary

**Rename order approach (from research):**
For reordering, use a two-pass approach:
1. First rename the moving phase to a temp name (e.g., `tmp-{slug}`)
2. Then renumber all remaining phases sequentially
3. Finally rename the temp directory to its final number

This avoids the collision problem entirely.

Keep the skill well-organized with clear separation between move and reorder code paths. Use `<if>` style conditions or clear comments marking which steps apply to which operation.
  </action>
  <verify>
- `grep -c "before\|after\|reorder" skills/kata-move-phase/SKILL.md` returns multiple matches
- Skill contains steps for: validate_reorder_target, confirm_reorder, reorder_roadmap, renumber_all_directories
- Skill handles both operation types: "to" (cross-milestone) and "before"/"after" (reorder)
- Skill is under 500 lines total (check with `wc -l`)
  </verify>
  <done>kata-move-phase skill handles both cross-milestone moves (/kata:kata-move-phase 3 to v1.6.0) and within-milestone reorders (/kata:kata-move-phase 3 before 1). Both operations validate the phase is in pending/, renumber affected directories, update ROADMAP.md, and commit.</done>
</task>

<task type="auto">
  <name>Task 2: Update help listing and requirements traceability</name>
  <files>skills/kata-help/SKILL.md, .planning/REQUIREMENTS.md</files>
  <action>
1. **skills/kata-help/SKILL.md** - Add kata-move-phase to the "Roadmap Management" section (near kata-add-phase, kata-insert-phase, kata-remove-phase). Insert it after kata-remove-phase following the same format:

```markdown
**`/kata:kata-move-phase <phase> <operation>`**
Move a phase between milestones or reorder within a milestone.

- Cross-milestone: moves phase to target milestone, renumbers both
- Reorder: changes phase position within milestone, renumbers all
- Only pending phases can be moved

Usage: `/kata:kata-move-phase 3 to v1.6.0` (cross-milestone)
Usage: `/kata:kata-move-phase 3 before 1` (reorder within milestone)
```

2. **REQUIREMENTS.md** - Update the traceability table to map PHASE-02, PHASE-03, PHASE-04 to Phase 2 plans:

| PHASE-02 | 2 | 01, 02 | Complete |
| PHASE-03 | 2 | 02     | Complete |
| PHASE-04 | 2 | 01     | Complete |

Also check the requirement checkboxes: mark PHASE-02, PHASE-03, and PHASE-04 as complete with `[x]`.
  </action>
  <verify>
- `grep "kata-move-phase" skills/kata-help/SKILL.md` returns matches
- `grep "PHASE-02.*Complete" .planning/REQUIREMENTS.md` returns a match
- `grep "PHASE-03.*Complete" .planning/REQUIREMENTS.md` returns a match
- `grep "PHASE-04.*Complete" .planning/REQUIREMENTS.md` returns a match
- `grep "\[x\].*PHASE-02" .planning/REQUIREMENTS.md` returns a match
  </verify>
  <done>kata-move-phase appears in help listing under Roadmap Management. REQUIREMENTS.md traceability shows PHASE-02, PHASE-03, PHASE-04 complete with correct plan mappings.</done>
</task>

</tasks>

<verification>
- kata-move-phase handles both "to" (cross-milestone) and "before"/"after" (reorder) operations
- Skill is listed in kata-help under Roadmap Management
- REQUIREMENTS.md traceability updated for all 3 requirements
- All requirement checkboxes marked complete
</verification>

<success_criteria>
- PHASE-03 fully implemented: reorder within milestone with automatic renumbering
- Help listing includes kata-move-phase with both usage patterns
- Requirements traceability complete for PHASE-02, PHASE-03, PHASE-04
- Skill total size under 500 lines
</success_criteria>

<output>
After completion, create `.planning/phases/02-phase-movement/02-02-SUMMARY.md`
</output>
