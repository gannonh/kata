---
phase: 02-phase-movement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-move-phase/SKILL.md
  - skills/kata-add-milestone/SKILL.md
  - skills/kata-complete-milestone/references/milestone-archive-template.md
  - skills/kata-complete-milestone/references/milestone-complete.md
  - agents/kata-roadmapper.md
autonomous: true

must_haves:
  truths:
    - "User can move a pending phase to a different milestone via /kata:kata-move-phase N to vX.Y"
    - "Phase directory is renamed and relocated correctly after move"
    - "ROADMAP.md reflects the move with correct numbering at both source and destination"
    - "Each milestone starts phase numbering at 1 (not cumulative)"
  artifacts:
    - path: "skills/kata-move-phase/SKILL.md"
      provides: "Move-phase skill with cross-milestone move capability"
      contains: "kata-move-phase"
    - path: "skills/kata-add-milestone/SKILL.md"
      provides: "Updated numbering guidance"
      contains: "Start phase numbering at 1"
    - path: "agents/kata-roadmapper.md"
      provides: "Updated starting number rule"
      contains: "start at 1"
  key_links:
    - from: "skills/kata-move-phase/SKILL.md"
      to: ".planning/ROADMAP.md"
      via: "ROADMAP section extraction and insertion"
      pattern: "ROADMAP\\.md"
    - from: "skills/kata-move-phase/SKILL.md"
      to: ".planning/phases/pending/"
      via: "Universal phase discovery"
      pattern: "find .planning/phases"
---

<objective>
Create the kata-move-phase skill for cross-milestone phase movement (PHASE-02) and update 4 files to enforce per-milestone phase numbering starting at 1 (PHASE-04).

Purpose: Enable flexible phase reorganization between milestones and establish independent phase numbering per milestone.
Output: New skill file + 4 updated files enforcing per-milestone numbering.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-phase-movement/02-RESEARCH.md

# Pattern references (read these for consistent skill structure)
@skills/kata-remove-phase/SKILL.md
@skills/kata-add-phase/SKILL.md
@skills/kata-add-milestone/SKILL.md
@skills/kata-complete-milestone/references/milestone-archive-template.md
@skills/kata-complete-milestone/references/milestone-complete.md
@agents/kata-roadmapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update 4 files for per-milestone phase numbering (PHASE-04)</name>
  <files>
    skills/kata-add-milestone/SKILL.md,
    skills/kata-complete-milestone/references/milestone-archive-template.md,
    skills/kata-complete-milestone/references/milestone-complete.md,
    agents/kata-roadmapper.md
  </files>
  <action>
Update 4 files to enforce per-milestone phase numbering starting at 1. Each milestone gets independent numbering.

1. **skills/kata-add-milestone/SKILL.md** (around lines 706-709 and 736):
   - Replace the text about determining starting phase number and continuing from previous milestone. Change "New phases continue from there (e.g., if v1.0 ended at phase 5, v1.1 starts at phase 6)" to guidance that each milestone starts at 1.
   - Replace "Start phase numbering from [N] (continues from previous milestone)" with "Start phase numbering at 1 (each milestone has independent numbering)"
   - Remove the step about reading MILESTONES.md to find the last phase number from previous milestone. Replace with instruction to always start at phase 1.

2. **skills/kata-complete-milestone/references/milestone-archive-template.md** (line 122):
   - Replace "Continue phase numbering in next milestone (never restart at 01)" with "Each milestone starts phase numbering at 1"

3. **skills/kata-complete-milestone/references/milestone-complete.md** (line 707):
   - Replace "Phase directories (.planning/phases/) are NOT deleted. They accumulate across milestones as the raw execution history. Phase numbering continues (v1.0 phases 1-4, v1.1 phases 5-8, etc.)." with "Phase directories (.planning/phases/) are NOT deleted. They accumulate across milestones as the raw execution history. Each milestone starts phase numbering at 1 (independent numbering per milestone)."

4. **agents/kata-roadmapper.md** (around lines 188-190):
   - The "Starting number" section currently says "New milestone: Start at 1, Continuing milestone: Check existing phases, start at last + 1". Simplify to: "Starting number: Always start at 1 (each milestone has independent phase numbering)"

Do NOT change any other content in these files. Preserve all formatting and surrounding context.
  </action>
  <verify>
Grep all 4 files for the old patterns to confirm they're gone:
- `grep -r "continue phase numbering" skills/kata-complete-milestone/ agents/` should return nothing
- `grep -r "continues from previous" skills/kata-add-milestone/` should return nothing
- `grep -r "never restart at 01" skills/kata-complete-milestone/` should return nothing
- `grep -r "phases 5-8" skills/kata-complete-milestone/` should return nothing
- `grep -r "start at 1" skills/kata-add-milestone/ skills/kata-complete-milestone/ agents/kata-roadmapper.md` should show the new text in all 4 files
  </verify>
  <done>All 4 files enforce per-milestone phase numbering starting at 1. No references to cumulative numbering remain in these files.</done>
</task>

<task type="auto">
  <name>Task 2: Create kata-move-phase skill for cross-milestone moves (PHASE-02)</name>
  <files>skills/kata-move-phase/SKILL.md</files>
  <action>
Create a new skill `skills/kata-move-phase/SKILL.md` following the patterns established in kata-remove-phase and kata-add-phase. This task covers the cross-milestone move operation (PHASE-02). Reorder capability (PHASE-03) will be added in Plan 02.

The skill should handle the invocation pattern: `/kata:kata-move-phase 3 to v1.6.0`

**Frontmatter:**
```yaml
---
name: kata-move-phase
description: Move a phase between milestones or reorder phases within a milestone. Triggers include "move phase", "move phase to milestone", "reorder phase", "reorder phases".
metadata:
  version: "0.1.0"
user-invocable: true
disable-model-invocation: false
allowed-tools:
  - Read
  - Write
  - Bash
---
```

**Structure (follow kata-remove-phase pattern):**

1. `<objective>` - Move a pending phase to a different milestone, renumbering at both source and destination.

2. `<execution_context>` - @.planning/ROADMAP.md, @.planning/STATE.md

3. `<process>` with these steps:

   **step: parse_arguments**
   - First arg: phase number (integer)
   - Detect operation: if second arg is "to" -> cross-milestone move (this plan). If "before" or "after" -> reorder (Plan 02 will add this).
   - For "to" operation: third arg is target milestone version (e.g., v1.6.0)
   - Error if no args, invalid format, or unrecognized operation keyword

   **step: load_state**
   - Load ROADMAP.md and STATE.md
   - Parse current milestone from roadmap

   **step: validate_phase_exists**
   - Use universal phase discovery (for state in active pending completed) to find the phase directory
   - Verify phase exists in ROADMAP.md with heading pattern `#### Phase {N}:`

   **step: validate_phase_movable**
   - Phase must be in pending/ (not active or completed)
   - Phase must not have SUMMARY.md files (no executed plans)
   - If validation fails, show clear error with reason

   **step: validate_target_milestone**
   - Target milestone must exist in ROADMAP.md (search for heading pattern)
   - Target milestone must not be the same as source milestone
   - If not found, list available milestones

   **step: calculate_destination_number**
   - Find the highest phase number in the target milestone
   - New phase number = highest + 1
   - Format as two-digit: `printf "%02d"`

   **step: confirm_move**
   - Show summary: "Moving Phase {N}: {Name} from {source_milestone} to {target_milestone}"
   - Show what will happen: directory rename, ROADMAP.md updates, new phase number
   - Wait for confirmation

   **step: remove_from_source_milestone**
   - Remove the phase section from source milestone in ROADMAP.md (heading to next heading)
   - Renumber remaining phases in source milestone to close the gap
   - Use the same renumbering approach as kata-remove-phase (descending order for downward shifts)

   **step: add_to_target_milestone**
   - Insert phase section into target milestone in ROADMAP.md
   - Use the calculated destination number
   - Preserve phase goal, requirements, dependencies (update dependency references)

   **step: rename_phase_directory**
   - Move directory from pending/ with old number to pending/ with new number
   - Rename files inside directory (NN-01-PLAN.md -> MM-01-PLAN.md, etc.)
   - Handle decimal phases that belong to the moved phase (N.1, N.2 move with parent)

   **step: renumber_source_directories**
   - Renumber directories of phases that shifted due to the gap in source milestone
   - Process in correct order to avoid conflicts
   - Rename files inside renumbered directories

   **step: update_state**
   - Update STATE.md with roadmap evolution note
   - Update REQUIREMENTS.md traceability if requirements reference the moved phase

   **step: commit**
   - Check planning config for commit_docs setting
   - If true: `git add .planning/ skills/kata-move-phase/ && git commit -m "chore: move phase {N} to {target_milestone}"`

   **step: completion**
   - Show completion summary with all changes made
   - Show "What's Next" options

4. `<anti_patterns>` section:
   - Don't move active or completed phases
   - Don't move phases with executed plans (SUMMARY.md exists)
   - Don't move to same milestone (use reorder instead)
   - Don't forget decimal phases (they move with parent)
   - Don't commit if commit_docs is false

5. `<edge_cases>` section:
   - Phase has PLAN.md files but no SUMMARY.md (allowed, rename plan files)
   - Target milestone is empty (first phase becomes Phase 1)
   - Last phase in source milestone removed (no renumbering needed)
   - Decimal phases under moved integer phase (move them all)

6. `<success_criteria>` checklist

Keep the skill under 400 lines. Use the same error message formatting as kata-remove-phase. Use universal phase discovery (for state in active pending completed with flat fallback) from Phase 1.
  </action>
  <verify>
- `ls skills/kata-move-phase/SKILL.md` confirms file exists
- File has valid YAML frontmatter with name: kata-move-phase
- File contains steps for: parse_arguments, load_state, validate_phase_exists, validate_phase_movable, validate_target_milestone, calculate_destination_number, confirm_move, remove_from_source_milestone, add_to_target_milestone, rename_phase_directory, renumber_source_directories, update_state, commit, completion
- File references universal phase discovery pattern
- File includes anti_patterns, edge_cases, and success_criteria sections
  </verify>
  <done>New kata-move-phase skill exists with cross-milestone move capability. Skill follows established patterns from kata-remove-phase and kata-add-phase. Handles argument parsing, validation, ROADMAP.md updates, directory renaming, file renaming, and state updates.</done>
</task>

</tasks>

<verification>
- All 4 PHASE-04 files updated with per-milestone numbering
- No references to cumulative numbering remain in modified files
- kata-move-phase skill created with proper frontmatter and process steps
- Skill uses universal phase discovery from Phase 1
- Skill validates only pending phases can be moved
</verification>

<success_criteria>
- PHASE-04 fully implemented: 4 files updated to enforce per-milestone numbering at 1
- PHASE-02 skill created: kata-move-phase handles cross-milestone moves
- All changes follow established codebase patterns
- No new external dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-phase-movement/02-01-SUMMARY.md`
</output>
