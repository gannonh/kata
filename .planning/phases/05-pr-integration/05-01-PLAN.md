---
phase: 05-pr-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-executing-phases/SKILL.md
  - skills/kata-executing-phases/references/phase-execute.md
autonomous: true

must_haves:
  truths:
    - "Phase branch created before execution when pr_workflow: true"
    - "Draft PR opened after first wave commits to branch"
    - "PR marked ready when phase execution completes"
    - "PR title follows v{milestone} Phase {N}: {Name} convention"
    - "PR body includes phase goal, plans checklist, and Closes #X"
  artifacts:
    - path: "skills/kata-executing-phases/SKILL.md"
      provides: "PR workflow integration steps"
      contains: "git checkout -b"
    - path: "skills/kata-executing-phases/references/phase-execute.md"
      provides: "Detailed PR workflow in phase-execute"
      contains: "gh pr create --draft"
  key_links:
    - from: "skills/kata-executing-phases/SKILL.md"
      to: ".planning/config.json"
      via: "pr_workflow config read"
      pattern: "PR_WORKFLOW.*pr_workflow"
    - from: "skills/kata-executing-phases/SKILL.md"
      to: "gh pr"
      via: "GitHub CLI commands"
      pattern: "gh pr create|gh pr ready"
---

<objective>
Add PR workflow to kata-executing-phases: create branch at phase start, open draft PR after first wave, mark ready at phase completion.

Purpose: Enable Phase PRs that track execution progress and link to phase issues when `pr_workflow: true`.

Output: Updated SKILL.md and phase-execute.md with PR workflow steps integrated at the correct positions.
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pr-integration/05-RESEARCH.md

Key files to modify:
@skills/kata-executing-phases/SKILL.md
@skills/kata-executing-phases/references/phase-execute.md
@skills/kata-executing-phases/references/planning-config.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add branch creation step to kata-executing-phases SKILL.md</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
    Add Step 1.5 after "Validate phase exists" (step 1) and before "Discover plans" (step 2).

    Step 1.5: Create Phase Branch (pr_workflow only)

    Read pr_workflow config:
    ```bash
    PR_WORKFLOW=$(cat .planning/config.json 2>/dev/null | grep -o '"pr_workflow"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
    ```

    If PR_WORKFLOW=false: Skip to step 2.

    If PR_WORKFLOW=true:
    1. Get milestone version from ROADMAP.md
    2. Get phase number and slug from PHASE_DIR
    3. Infer branch type from phase goal (feat/fix/docs/refactor/chore, default feat)
    4. Create branch with pattern: {type}/v{milestone}-{phase}-{slug}

    Branch creation with re-run protection:
    ```bash
    BRANCH="{type}/v${MILESTONE}-${PHASE}-${SLUG}"
    if git show-ref --verify --quiet refs/heads/"$BRANCH"; then
      git checkout "$BRANCH"
      echo "Branch $BRANCH exists, resuming on it"
    else
      git checkout -b "$BRANCH"
      echo "Created branch $BRANCH"
    fi
    ```

    Store BRANCH variable for use in step 4.5 and step 10.5.

    Also update the step numbering in the process section to reflect new steps (1.5, 4.5, 10.5).
  </action>
  <verify>grep -A 20 "Create Phase Branch" skills/kata-executing-phases/SKILL.md | grep -q "git checkout -b"</verify>
  <done>Step 1.5 creates phase branch when pr_workflow: true, with re-run protection</done>
</task>

<task type="auto">
  <name>Task 2: Add draft PR creation step after first wave</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
    Add Step 4.5 inside the "Execute waves" section, after the first wave completes (after wave 1 GitHub issue checkbox update).

    Step 4.5: Open Draft PR (pr_workflow only, first wave only)

    After first wave completion:
    ```bash
    if [ "$PR_WORKFLOW" = "true" ] && [ "$WAVE_NUM" = "1" ]; then
      # Check if PR already exists (re-run protection)
      EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null)
      if [ -n "$EXISTING_PR" ]; then
        echo "PR #${EXISTING_PR} already exists, skipping creation"
        PR_NUMBER="$EXISTING_PR"
      else
        # Push branch and create draft PR
        git push -u origin "$BRANCH"

        # Build PR body
        PHASE_GOAL=$(grep -A 1 "^## Goal" ${PHASE_DIR}/*-PLAN.md | tail -1 || grep "Goal:" .planning/ROADMAP.md | head -1)

        # Get phase issue number for linking (if github.enabled)
        CLOSES_LINE=""
        if [ "$GITHUB_ENABLED" = "true" ] && [ "$ISSUE_MODE" != "never" ]; then
          PHASE_ISSUE=$(gh issue list --label phase --milestone "v${MILESTONE}" \
            --json number,title --jq ".[] | select(.title | startswith(\"Phase ${PHASE_NUM}:\")) | .number" 2>/dev/null)
          [ -n "$PHASE_ISSUE" ] && CLOSES_LINE="Closes #${PHASE_ISSUE}"
        fi

        # Build plans checklist (all unchecked initially)
        PLANS_CHECKLIST=""
        for plan in ${PHASE_DIR}/*-PLAN.md; do
          plan_name=$(grep -m1 "<name>" "$plan" | sed 's/.*<name>//;s/<\/name>.*//')
          plan_num=$(basename "$plan" | sed -E 's/^[0-9]+-([0-9]+)-PLAN\.md$/\1/')
          PLANS_CHECKLIST="${PLANS_CHECKLIST}- [ ] Plan ${plan_num}: ${plan_name}\n"
        done

        cat > /tmp/pr-body.md << PR_EOF
## Phase Goal

${PHASE_GOAL}

## Plans

${PLANS_CHECKLIST}

## Success Criteria

$(grep -A 20 "Success Criteria" .planning/ROADMAP.md | grep "^  [0-9]\." | head -10)

${CLOSES_LINE}
PR_EOF

        # Create draft PR
        gh pr create --draft \
          --base main \
          --title "v${MILESTONE} Phase ${PHASE_NUM}: ${PHASE_NAME}" \
          --body-file /tmp/pr-body.md

        PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
        echo "Created draft PR #${PR_NUMBER}"
      fi
    fi
    ```

    Store PR_NUMBER for step 10.5.
  </action>
  <verify>grep -A 30 "Open Draft PR" skills/kata-executing-phases/SKILL.md | grep -q "gh pr create --draft"</verify>
  <done>Step 4.5 opens draft PR after first wave with phase goal, plans checklist, and issue link</done>
</task>

<task type="auto">
  <name>Task 3: Add PR ready step and update offer_next with PR URL</name>
  <files>skills/kata-executing-phases/SKILL.md</files>
  <action>
    Add Step 10.5 after "Commit phase completion" (step 10) and before "Offer next steps" (step 11).

    Step 10.5: Mark PR Ready (pr_workflow only)

    After phase completion commit:
    ```bash
    if [ "$PR_WORKFLOW" = "true" ]; then
      # Push final commits
      git push origin "$BRANCH"

      # Mark PR ready for review
      gh pr ready

      PR_URL=$(gh pr view --json url --jq '.url')
      echo "PR marked ready: $PR_URL"
    fi
    ```

    Store PR_URL for offer_next output.

    Update the offer_next section Route A and Route B to include PR URL when pr_workflow: true:

    Route A addition (after GitHub Issue line):
    ```
    {If pr_workflow: PR: #{pr_number} ({pr_url}) — ready for review}
    ```

    Route B addition (in milestone complete section):
    ```
    {If pr_workflow: Phase PRs ready — merge to prepare for release}
    ```
  </action>
  <verify>grep -A 10 "Mark PR Ready" skills/kata-executing-phases/SKILL.md | grep -q "gh pr ready"</verify>
  <done>Step 10.5 marks PR ready, offer_next includes PR URL when pr_workflow: true</done>
</task>

</tasks>

<verification>
```bash
# Verify all PR workflow steps exist
grep -c "pr_workflow" skills/kata-executing-phases/SKILL.md
# Should be >= 6 (multiple checks)

grep "Create Phase Branch" skills/kata-executing-phases/SKILL.md && echo "Step 1.5 exists"
grep "Open Draft PR" skills/kata-executing-phases/SKILL.md && echo "Step 4.5 exists"
grep "Mark PR Ready" skills/kata-executing-phases/SKILL.md && echo "Step 10.5 exists"
grep "gh pr create --draft" skills/kata-executing-phases/SKILL.md && echo "Draft PR creation exists"
grep "gh pr ready" skills/kata-executing-phases/SKILL.md && echo "PR ready marking exists"
```
</verification>

<success_criteria>
- [ ] Step 1.5 creates phase branch when pr_workflow: true with re-run protection
- [ ] Step 4.5 opens draft PR after first wave with phase goal and plans checklist
- [ ] Step 4.5 includes "Closes #X" when github.enabled and phase issue exists
- [ ] Step 10.5 marks PR ready after phase completion
- [ ] offer_next includes PR URL when pr_workflow: true
- [ ] All steps have re-run protection (idempotent)
</success_criteria>

<output>
After completion, create `.planning/phases/05-pr-integration/05-01-SUMMARY.md`
</output>
