---
phase: 05-pr-integration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/skills/executing-phases.test.js
  - tests/skills/tracking-progress.test.js
  - skills/kata-executing-phases/references/github-integration.md
autonomous: true

must_haves:
  truths:
    - "Tests verify PR workflow steps exist in executing-phases skill"
    - "Tests verify PR status display in tracking-progress skill"
    - "GitHub integration docs updated with Phase 5 status"
  artifacts:
    - path: "tests/skills/executing-phases.test.js"
      provides: "PR workflow tests"
      contains: "PR Integration"
    - path: "tests/skills/tracking-progress.test.js"
      provides: "PR status display tests"
      contains: "PR Status"
    - path: "skills/kata-executing-phases/references/github-integration.md"
      provides: "Updated integration docs"
      contains: "Implemented"
  key_links:
    - from: "tests/skills/executing-phases.test.js"
      to: "skills/kata-executing-phases/SKILL.md"
      via: "skill content assertions"
      pattern: "skillContent.*pr_workflow"
---

<objective>
Add tests for PR workflow integration and update documentation.

Purpose: Validate PR workflow implementation with static tests and update github-integration.md to reflect Phase 5 completion.

Output: Tests that verify PR workflow steps exist, and updated documentation.
</objective>

<execution_context>
@./references/execute-plan.md
@./references/summary-template.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pr-integration/05-RESEARCH.md

Key files to modify:
@tests/skills/executing-phases.test.js
@tests/skills/tracking-progress.test.js
@skills/kata-executing-phases/references/github-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PR workflow tests to executing-phases.test.js</name>
  <files>tests/skills/executing-phases.test.js</files>
  <action>
    Add a new describe block for Phase 5 PR Integration tests:

    ```javascript
    describe('PR Integration - Phase 5', () => {
      it('contains branch creation step', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasBranchCreation = skillContent.includes('Create Phase Branch') ||
                                   skillContent.includes('git checkout -b');

        if (!hasBranchCreation) {
          throw new Error('Expected skill to include branch creation step for pr_workflow');
        }
      });

      it('contains draft PR creation step', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasDraftPR = skillContent.includes('gh pr create --draft');

        if (!hasDraftPR) {
          throw new Error('Expected skill to include draft PR creation with gh pr create --draft');
        }
      });

      it('contains PR ready step', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasPRReady = skillContent.includes('gh pr ready');

        if (!hasPRReady) {
          throw new Error('Expected skill to include gh pr ready step');
        }
      });

      it('includes PR title convention', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        // Should have title pattern: v{milestone} Phase {N}: {Name}
        const hasTitlePattern = skillContent.includes('v${MILESTONE} Phase') ||
                                skillContent.includes('v{milestone} Phase');

        if (!hasTitlePattern) {
          throw new Error('Expected skill to include PR title convention');
        }
      });

      it('includes issue linking in PR body', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasClosesLink = skillContent.includes('Closes #');

        if (!hasClosesLink) {
          throw new Error('Expected skill to include "Closes #" issue linking in PR body');
        }
      });

      it('has re-run protection for branch creation', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasReRunProtection = skillContent.includes('show-ref --verify') ||
                                    skillContent.includes('branch exists');

        if (!hasReRunProtection) {
          throw new Error('Expected skill to have re-run protection for branch creation');
        }
      });

      it('has re-run protection for PR creation', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-executing-phases', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasExistingPRCheck = skillContent.includes('EXISTING_PR') ||
                                    skillContent.includes('PR already exists');

        if (!hasExistingPRCheck) {
          throw new Error('Expected skill to check for existing PR before creation');
        }
      });
    });
    ```

    Place after the existing "Plan Sync - Wave Completion (Phase 4)" describe block.
  </action>
  <verify>grep "PR Integration - Phase 5" tests/skills/executing-phases.test.js</verify>
  <done>executing-phases.test.js has Phase 5 PR Integration test suite</done>
</task>

<task type="auto">
  <name>Task 2: Add PR status tests to tracking-progress.test.js</name>
  <files>tests/skills/tracking-progress.test.js</files>
  <action>
    Add a new describe block for PR status display tests:

    ```javascript
    describe('PR Status Display - Phase 5', () => {
      it('contains pr_workflow config check', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-tracking-progress', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasPRWorkflowCheck = skillContent.includes('pr_workflow') ||
                                    skillContent.includes('PR_WORKFLOW');

        if (!hasPRWorkflowCheck) {
          throw new Error('Expected skill to check pr_workflow config');
        }
      });

      it('contains PR status section', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-tracking-progress', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasPRStatus = skillContent.includes('PR Status') ||
                            skillContent.includes('PR #');

        if (!hasPRStatus) {
          throw new Error('Expected skill to display PR status');
        }
      });

      it('uses gh pr commands for status', () => {
        const skillPath = join(testDir, '.claude', 'skills', 'kata-tracking-progress', 'SKILL.md');
        const skillContent = readFileSync(skillPath, 'utf8');

        const hasGHPR = skillContent.includes('gh pr');

        if (!hasGHPR) {
          throw new Error('Expected skill to use gh pr commands for status');
        }
      });
    });
    ```

    Add readFileSync to the imports at top of file if not present.
  </action>
  <verify>grep "PR Status Display - Phase 5" tests/skills/tracking-progress.test.js</verify>
  <done>tracking-progress.test.js has Phase 5 PR status test suite</done>
</task>

<task type="auto">
  <name>Task 3: Update github-integration.md with Phase 5 status</name>
  <files>skills/kata-executing-phases/references/github-integration.md</files>
  <action>
    Update the summary table at the bottom of github-integration.md.

    Change the `kata-tracking-progress` row from "Planned" to "Implemented":

    Before:
    ```
    | `kata-tracking-progress`   | 6     | Show GH issue/milestone/PR status   | `github.enabled`, `pr_workflow`        | Planned     |
    ```

    After:
    ```
    | `kata-tracking-progress`   | 5     | Show GH issue/milestone/PR status   | `github.enabled`, `pr_workflow`        | Implemented |
    ```

    Add a new section under "### Phase 4-5: Execution & Tracking" documenting the PR workflow:

    ```markdown
    ### Phase 5: PR Integration (Implemented)

    #### `kata-executing-phases` PR Workflow

    **Hook:** At phase start, after first wave, and at phase completion
    **Action:** Create branch, open draft PR, mark PR ready
    **Config checked:** `pr_workflow`

    **Flow:**
    1. Step 1.5: Create phase branch (`{type}/v{milestone}-{phase}-{slug}`)
    2. Step 4.5: Open draft PR after first wave (includes phase goal, plans checklist, "Closes #X")
    3. Step 10.5: Mark PR ready after phase completion

    **PR Title:** `v{milestone} Phase {N}: {Phase Name}`

    **PR Body:**
    ```markdown
    ## Phase Goal
    [Goal from ROADMAP.md]

    ## Plans
    - [ ] Plan 01: [name]
    - [ ] Plan 02: [name]

    ## Success Criteria
    - [ ] [criterion 1]
    - [ ] [criterion 2]

    Closes #[phase-issue-number]
    ```

    **Re-run Protection:**
    - Branch creation: checks if branch exists before creating
    - PR creation: checks if PR exists before creating
    ```
  </action>
  <verify>grep "Phase 5: PR Integration" skills/kata-executing-phases/references/github-integration.md</verify>
  <done>github-integration.md updated with Phase 5 documentation and status</done>
</task>

</tasks>

<verification>
```bash
# Run tests
npm test -- --grep "PR Integration"
npm test -- --grep "PR Status Display"

# Verify docs updated
grep "Implemented" skills/kata-executing-phases/references/github-integration.md | grep -c "tracking-progress"
```
</verification>

<success_criteria>
- [ ] executing-phases.test.js has PR workflow test suite
- [ ] tracking-progress.test.js has PR status test suite
- [ ] github-integration.md documents Phase 5 implementation
- [ ] Summary table shows tracking-progress as Implemented
- [ ] All new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-pr-integration/05-03-SUMMARY.md`
</output>
