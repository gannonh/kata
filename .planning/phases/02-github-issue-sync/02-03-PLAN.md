---
phase: 02-github-issue-sync
plan: 03
type: execute
wave: 2
depends_on: [02-02]
files_modified:
  - skills/check-issues/SKILL.md
autonomous: true

must_haves:
  truths:
    - "When working on a GitHub-linked issue, completion auto-updates/closes the GitHub Issue"
    - "Issue provenance is preserved through the work-on-it flow"
    - "GitHub Issue closed with completion comment referencing Kata execution"
  artifacts:
    - path: "skills/check-issues/SKILL.md"
      provides: "Auto-close GitHub Issue on completion"
      contains: "gh issue close"
  key_links:
    - from: "skills/check-issues/SKILL.md"
      to: "gh CLI"
      via: "gh issue close with comment"
      pattern: "gh issue close.*--comment"
---

<objective>
Add auto-update/close capability for GitHub-linked issues when work completes.

Purpose: When a user selects "Work on it now" for an issue with GitHub provenance, the GitHub Issue should be closed automatically when the local issue is moved to closed/. This completes the bidirectional sync loop (PULL-02).

Output: Modified check-issues skill that closes GitHub Issues on completion.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-github-issue-sync/02-RESEARCH.md
@.planning/phases/02-github-issue-sync/02-02-SUMMARY.md
@skills/check-issues/SKILL.md
@skills/execute-phase/references/github-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GitHub close logic to "Work on it now" action</name>
  <files>skills/check-issues/SKILL.md</files>
  <action>
Modify the `execute_action` step's "Work on it now" branch.

AFTER moving the file to closed/, add GitHub close logic:

```bash
# Work on it now action
mv ".planning/issues/open/[filename]" ".planning/issues/closed/"

# Check if issue has GitHub provenance
PROVENANCE=$(grep "^provenance:" ".planning/issues/closed/[filename]" | cut -d' ' -f2)
if echo "$PROVENANCE" | grep -q "^github:"; then
  # Extract issue number from provenance (format: github:owner/repo#N)
  ISSUE_NUMBER=$(echo "$PROVENANCE" | grep -oE '#[0-9]+' | tr -d '#')

  if [ -n "$ISSUE_NUMBER" ]; then
    # Check github.enabled (may have changed since issue was created)
    GITHUB_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"enabled"[[:space:]]*:[[:space:]]*[^,}]*' | head -1 | grep -o 'true\|false' || echo "false")

    if [ "$GITHUB_ENABLED" = "true" ]; then
      # Close GitHub Issue with comment
      gh issue close "$ISSUE_NUMBER" --comment "Completed via Kata workflow" 2>/dev/null \
        && echo "Closed GitHub Issue #${ISSUE_NUMBER}" \
        || echo "Warning: Failed to close GitHub Issue #${ISSUE_NUMBER}"
    fi
  fi
fi
```

Key points:
- Non-blocking: GitHub failures don't block local workflow
- Only close if github.enabled is still true (config may have changed)
- Completion comment references Kata for traceability
- Extract issue number from provenance field (format: `github:owner/repo#N`)
  </action>
  <verify>
Read the updated SKILL.md and verify:
- Provenance check added to "Work on it now" action
- Issue number extraction from provenance field
- `gh issue close` with `--comment` flag
- Non-blocking error handling
  </verify>
  <done>
- GitHub Issue auto-closed when local issue moved to closed/
- Completion comment added for traceability
- Non-blocking error handling implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Update confirmation output for GitHub close</name>
  <files>skills/check-issues/SKILL.md</files>
  <action>
Update the confirmation message shown after "Work on it now" to indicate GitHub status.

After the action completes, the output should show:
```
Issue moved to closed/: [filename]

  [title]
  Area: [area]
  GitHub: Closed #[number] (if applicable)

Ready to begin work.
```

Also update the git commit step to mention GitHub close in the commit message when applicable:
```bash
git commit -m "$(cat <<'EOF'
docs: start work on issue - [title]

Moved to closed/, beginning implementation.
GitHub Issue #N closed (if applicable)
EOF
)"
```
  </action>
  <verify>
Read the updated SKILL.md and verify:
- Confirmation output mentions GitHub Issue close
- Git commit message includes GitHub reference when applicable
  </verify>
  <done>
- User sees GitHub Issue close status in confirmation
- Git commit message documents GitHub Issue closure
  </done>
</task>

<task type="auto">
  <name>Task 3: Add execution linking reference documentation</name>
  <files>skills/check-issues/SKILL.md</files>
  <action>
Add a documentation block within the skill explaining the execution linking flow for future maintainers.

Add an `<execution_linking>` block near the end of the file (before `</success_criteria>`):

```xml
<execution_linking>
## Execution Linking (PULL-02)

When an issue has GitHub provenance (`provenance: github:owner/repo#N`), the following behaviors activate:

1. **Display:** Issue shows GitHub reference in details view
2. **Work on it now:** Closing the local issue also closes the GitHub Issue with a completion comment
3. **Traceability:** Git commits reference the GitHub Issue number

This creates a bidirectional sync loop:
- **Outbound (ISS-02):** `/kata:add-issue` creates GitHub Issue, stores provenance in local file
- **Inbound (PULL-01):** `/kata:check-issues` pulls GitHub Issues, creates local files with provenance
- **Completion (PULL-02):** "Work on it now" closes both local and GitHub Issue

The provenance field is the linchpin - it enables deduplication and bidirectional updates.
</execution_linking>
```

This documents the design for future Claude instances.
  </action>
  <verify>
Grep for "execution_linking" in the skill file.
Verify the documentation block explains the full sync loop.
  </verify>
  <done>
- Documentation block added explaining execution linking
- Design rationale captured for future maintainers
  </done>
</task>

</tasks>

<verification>
1. Read `skills/check-issues/SKILL.md` and verify:
   - Provenance check in "Work on it now" action
   - `gh issue close --comment` command present
   - Non-blocking error handling
   - Confirmation output shows GitHub status
   - Documentation block explains execution linking

2. Full flow test scenario (manual verification):
   - Issue with provenance exists in open/
   - Select "Work on it now"
   - Local file moves to closed/
   - GitHub Issue closed with comment
</verification>

<success_criteria>
- [ ] "Work on it now" checks issue provenance for GitHub reference
- [ ] GitHub Issue closed automatically when local issue moved to closed/
- [ ] Completion comment added to GitHub Issue for traceability
- [ ] Non-blocking error handling (GitHub failures don't block local workflow)
- [ ] Confirmation output shows GitHub close status
- [ ] Git commit message references GitHub Issue closure
- [ ] Documentation block explains execution linking design
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-issue-sync/02-03-SUMMARY.md`
</output>
