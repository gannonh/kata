---
phase: 44-config-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/references/planning-config.md
  - skills/kata-configure-settings/scripts/read-pref.sh
  - skills/kata-configure-settings/scripts/read-config.sh
autonomous: true

must_haves:
  truths:
    - "worktree.enabled appears in planning-config.md schema with type boolean, default false"
    - "read-pref.sh DEFAULTS table includes worktree.enabled with default 'false'"
    - "read-config.sh reads nested keys from config.json only (no preferences cascade)"
    - "bash read-config.sh worktree.enabled returns 'false' when key is absent"
  artifacts:
    - skills/kata-execute-phase/references/planning-config.md
    - skills/kata-configure-settings/scripts/read-pref.sh
    - skills/kata-configure-settings/scripts/read-config.sh
  key_links:
    - "read-config.sh uses same resolveNested pattern as read-pref.sh"
    - "set-config.sh already handles nested key writes; read-config.sh completes the read side"
---

<objective>
Add worktree configuration to the Kata config schema and create a lightweight config reader script.

Purpose: CFG-01 and CFG-02 establish the foundation that all other worktree features build on. Without the schema entry and reader, no other script can detect or toggle worktree mode.
Output: Updated planning-config.md schema, updated read-pref.sh defaults, new read-config.sh script.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@skills/kata-execute-phase/references/planning-config.md
@skills/kata-configure-settings/scripts/read-pref.sh
@skills/kata-configure-settings/scripts/set-config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worktree.enabled to config schema and defaults</name>
  <files>skills/kata-execute-phase/references/planning-config.md, skills/kata-configure-settings/scripts/read-pref.sh</files>
  <action>
1. In `planning-config.md` `<config_schema>`:
   - In the full schema JSON block, add `"worktree": { "enabled": false }` as a top-level sibling of `"pr_workflow"` (after the `"pr_workflow"` key)
   - Add row to the options table AFTER the `pr_workflow` row: `worktree.enabled | false | Enable git worktree isolation per plan (requires pr_workflow: true)`

2. In `read-pref.sh` DEFAULTS table:
   - Add entry: `'worktree.enabled': 'false'`
   - Place it after the `pr_workflow` entry since worktrees extend the PR workflow

Do NOT modify any other values or restructure existing content. Surgical additions only.
  </action>
  <verify>
grep "worktree.enabled" skills/kata-execute-phase/references/planning-config.md
grep "worktree.enabled" skills/kata-configure-settings/scripts/read-pref.sh
  </verify>
  <done>planning-config.md schema includes worktree.enabled with default false. read-pref.sh DEFAULTS includes worktree.enabled: 'false'.</done>
</task>

<task type="auto">
  <name>Task 2: Create read-config.sh for direct config.json reads</name>
  <files>skills/kata-configure-settings/scripts/read-config.sh</files>
  <action>
Create `read-config.sh` that reads ONLY from `.planning/config.json` (no preferences.json cascade, no built-in defaults). This is intentionally simpler than `read-pref.sh` because worktree scripts need raw config state, not preference-resolved values.

Script signature: `read-config.sh <dot.key.path> [fallback]`

Implementation:
- Use the same Node.js heredoc pattern as set-config.sh and read-pref.sh
- Reuse the exact `resolveNested()` function from read-pref.sh
- Resolution order: config.json value found → return it. Not found AND fallback arg provided → return fallback. Not found AND no fallback arg → return empty string (exit 0 in all cases).
- Output via `process.stdout.write()` (no trailing newline, matching read-pref.sh)
- `set -euo pipefail` at top
- Make executable: `chmod +x`

Example usage:
```bash
WORKTREE_ENABLED=$(bash read-config.sh "worktree.enabled" "false")
```

Do NOT add a preferences.json lookup or a DEFAULTS table. The simplicity is the point: this script answers "what does config.json say?" without interpretation.
  </action>
  <verify>
# Verify script exists and is executable
ls -la skills/kata-configure-settings/scripts/read-config.sh

# Verify it reads a known key (run from repo root)
bash skills/kata-configure-settings/scripts/read-config.sh "mode" "fallback"

# Verify it returns fallback for missing key (run from repo root)
bash skills/kata-configure-settings/scripts/read-config.sh "worktree.enabled" "false"
  </verify>
  <done>read-config.sh exists, is executable, reads nested keys from config.json, returns fallback for missing keys, uses no preferences cascade.</done>
</task>

</tasks>

<verification>
```bash
# Schema updated
grep -c "worktree" skills/kata-execute-phase/references/planning-config.md

# Defaults updated
grep "worktree.enabled" skills/kata-configure-settings/scripts/read-pref.sh

# Reader works
bash skills/kata-configure-settings/scripts/read-config.sh "mode" "test"
bash skills/kata-configure-settings/scripts/read-config.sh "worktree.enabled" "false"
bash skills/kata-configure-settings/scripts/read-config.sh "nonexistent.key" "fallback-value"
```
</verification>

<success_criteria>
- [ ] planning-config.md schema includes worktree.enabled (boolean, default false)
- [ ] read-pref.sh DEFAULTS includes worktree.enabled
- [ ] read-config.sh created, executable, reads nested config.json keys
- [ ] read-config.sh returns fallback for absent keys
- [ ] No existing behavior changed in read-pref.sh or planning-config.md
</success_criteria>

<output>
After completion, create `.planning/phases/pending/44-config-foundation/44-01-SUMMARY.md`
</output>
