---
phase: 59-brownfield-intel-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-map-codebase/scripts/detect-stale-intel.cjs
  - tests/scripts/detect-stale-intel.test.js
autonomous: true
must_haves:
  truths:
    - detectBrownfieldDocStaleness falls back to oldest commit (git rev-list --max-parents=0 HEAD) when Analysis Date predates all git history
    - Fallback triggers staleness check against oldest commit instead of returning silent no_commit_at_date
    - Two new tests cover the fallback path (stale case and fresh case)
    - Existing 5 tests continue to pass unchanged
  artifacts:
    - skills/kata-map-codebase/scripts/detect-stale-intel.cjs (patched lines 225-227)
    - tests/scripts/detect-stale-intel.test.js (2 new tests appended)
  key_links:
    - detectBrownfieldDocStaleness no_commit_at_date early return replaced with rev-list fallback
    - Tests use backdated GIT_AUTHOR_DATE/GIT_COMMITTER_DATE env vars and writeBrownfieldDoc helper
---

<objective>
Fix GAP-1: `detectBrownfieldDocStaleness()` silent no-op when Analysis Date predates git history.

Purpose: When a brownfield doc has an Analysis Date older than the repo's first commit, `git log --until` returns empty and the function returns `{ brownfieldDocStale: false, reason: 'no_commit_at_date' }`. This silently skips staleness detection. The fix falls back to the repo's oldest commit as the baseline for diffing.

Output: Patched `detect-stale-intel.cjs` with fallback logic, 2 new tests in `detect-stale-intel.test.js`.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add oldest-commit fallback in detectBrownfieldDocStaleness</name>
  <files>skills/kata-map-codebase/scripts/detect-stale-intel.cjs</files>
  <action>
In `detectBrownfieldDocStaleness()`, replace lines 225-227 (the `if (!baseCommit)` early return) with a fallback that uses the repo's oldest commit:

Replace this block:
```javascript
  if (!baseCommit) {
    return { brownfieldDocStale: false, reason: 'no_commit_at_date' };
  }
```

With:
```javascript
  if (!baseCommit) {
    // Analysis Date predates git history — fall back to oldest commit
    try {
      baseCommit = git('git rev-list --max-parents=0 HEAD', projectRoot);
      if (baseCommit.includes('\n')) {
        baseCommit = baseCommit.split('\n')[0];
      }
    } catch {
      return { brownfieldDocStale: false, reason: 'no_commit_at_date' };
    }
    if (!baseCommit) {
      return { brownfieldDocStale: false, reason: 'no_commit_at_date' };
    }
  }
```

This handles:
- Multiple root commits (orphan branches): takes the first one
- `git rev-list` failure: graceful degradation to original behavior
- Empty result after rev-list: graceful degradation to original behavior
  </action>
  <verify>Read `detect-stale-intel.cjs` lines 225-237 and confirm the `git rev-list --max-parents=0 HEAD` fallback is present.</verify>
  <done>The `no_commit_at_date` early return is replaced with a fallback to the repo's oldest commit. Only returns `no_commit_at_date` when the fallback itself fails.</done>
</task>

<task type="auto">
  <name>Task 2: Add two tests for the oldest-commit fallback path</name>
  <files>tests/scripts/detect-stale-intel.test.js</files>
  <action>
Append two new tests inside the existing `describe('detectBrownfieldDocStaleness', ...)` block, after the "mixed docs" test (line 167). The tests follow the existing pattern: temp git repo, backdated commits via `GIT_AUTHOR_DATE`/`GIT_COMMITTER_DATE`, `writeBrownfieldDoc()` helper.

Test 1 — Analysis Date predates git history, >30% files changed returns stale:
```javascript
  test('Analysis Date predates git history, >30% changed returns brownfieldDocStale: true (fallback)', () => {
    // Analysis Date is far before the repo's initial commit
    const ancientDate = '2020-01-01';

    writeBrownfieldDoc(tmpDir, 'ARCHITECTURE.md', ancientDate);
    execSync('git add -A', { cwd: tmpDir, stdio: 'pipe' });
    execSync('git commit -m "add brownfield doc"', { cwd: tmpDir, stdio: 'pipe' });

    // Modify >30% of source files (4 out of 10)
    modifyAndCommit(
      tmpDir,
      ['src/file-0.js', 'src/file-1.js', 'src/file-2.js', 'src/file-3.js'],
      'modify 4 source files'
    );

    const result = detectBrownfieldDocStaleness(tmpDir);
    assert.strictEqual(result.brownfieldDocStale, true,
      `Expected stale=true via fallback, got: ${JSON.stringify(result)}`);
    assert.ok(result.brownfieldChangePct > 0.3,
      `Expected changePct > 0.3, got ${result.brownfieldChangePct}`);
    assert.ok(result.brownfieldChangedFiles >= 4,
      `Expected changedFiles >= 4, got ${result.brownfieldChangedFiles}`);
  });
```

Test 2 — Analysis Date predates git history, no changes after initial commit returns fresh:
```javascript
  test('Analysis Date predates git history, no changes returns brownfieldDocStale: false (fallback)', () => {
    // Analysis Date is far before the repo's initial commit
    const ancientDate = '2020-01-01';

    writeBrownfieldDoc(tmpDir, 'ARCHITECTURE.md', ancientDate);
    execSync('git add -A', { cwd: tmpDir, stdio: 'pipe' });
    execSync('git commit -m "add brownfield doc"', { cwd: tmpDir, stdio: 'pipe' });

    // No source file modifications after initial commit
    const result = detectBrownfieldDocStaleness(tmpDir);
    assert.strictEqual(result.brownfieldDocStale, false,
      `Expected stale=false via fallback (no source changes), got: ${JSON.stringify(result)}`);
    assert.strictEqual(result.brownfieldAnalysisDate, ancientDate);
  });
```

Both tests verify the fallback path works correctly by using an Analysis Date (2020-01-01) that is guaranteed to predate the repo's initial commit (created in beforeEach during the current test run). The existing `git log --until` returns empty for this date, triggering the new `git rev-list --max-parents=0 HEAD` fallback.
  </action>
  <verify>Run `node --test tests/scripts/detect-stale-intel.test.js` and confirm all 7 tests pass (5 existing + 2 new).</verify>
  <done>7/7 tests pass. The two new tests confirm the fallback detects staleness correctly when Analysis Date predates git history.</done>
</task>
</tasks>

<verification>
1. `node --test tests/scripts/detect-stale-intel.test.js` passes 7/7 tests
2. The two new tests specifically cover the `git rev-list --max-parents=0 HEAD` fallback path
3. Existing 5 tests unchanged and passing
4. No behavioral changes to other code paths in `detectBrownfieldDocStaleness`
</verification>

<success_criteria>
- detectBrownfieldDocStaleness falls back to oldest commit when Analysis Date predates git history
- Fallback correctly detects staleness when >30% source files changed since oldest commit
- Fallback correctly returns fresh when no source files changed since oldest commit
- All 7 tests pass (5 existing + 2 new)
- Graceful degradation when git rev-list fails
</success_criteria>

<output>
After completion, create `.planning/phases/pending/59-brownfield-intel-gap-closure/59-01-SUMMARY.md`
</output>
