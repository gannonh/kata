---
phase: 58-brownfield-doc-auto-refresh
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-map-codebase/scripts/detect-stale-intel.cjs
autonomous: true
must_haves:
  truths:
    - detect-stale-intel.cjs parses Analysis Date from .planning/codebase/ docs
    - detect-stale-intel.cjs compares Analysis Date against git history of source files
    - Output JSON includes brownfieldDocStale, brownfieldAnalysisDate, brownfieldChangedFiles, brownfieldTotalFiles, brownfieldChangePct fields
    - 30% threshold determines staleness (matching existing doc gardening threshold)
  artifacts:
    - skills/kata-map-codebase/scripts/detect-stale-intel.cjs (extended with brownfield detection)
  key_links:
    - detectBrownfieldDocStaleness function exported from detect-stale-intel.cjs
    - CLI output merges brownfield fields into existing JSON result
---

<objective>
Extend `detect-stale-intel.cjs` with brownfield doc staleness detection.

Purpose: The script currently detects staleness of code-scanned index entries only. It never checks whether `.planning/codebase/*.md` docs have drifted from the actual codebase. This plan adds a `detectBrownfieldDocStaleness()` function that parses the `**Analysis Date:** YYYY-MM-DD` header from brownfield docs, finds the git commit at that date, diffs against HEAD, and determines whether >30% of source files have changed.

Output: Updated `detect-stale-intel.cjs` with brownfield detection function, integrated into CLI output JSON.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add SUPPORTED_EXTENSIONS constant and detectBrownfieldDocStaleness function</name>
  <files>skills/kata-map-codebase/scripts/detect-stale-intel.cjs</files>
  <action>
Add a `SUPPORTED_EXTENSIONS` array matching scan-codebase.cjs:
```javascript
const SUPPORTED_EXTENSIONS = [
  'js', 'mjs', 'cjs', 'ts', 'mts', 'cts', 'jsx', 'tsx',
  'py', 'go', 'rs', 'java',
];
```

Add a new function `detectBrownfieldDocStaleness(projectRoot)` after the existing `detectStaleFiles` function. The function:

1. Checks if `.planning/codebase/` directory exists. If not, returns `{ brownfieldDocStale: false }`.
2. Reads brownfield doc files in order: ARCHITECTURE.md, STACK.md, CONVENTIONS.md, STRUCTURE.md, TESTING.md, INTEGRATIONS.md, CONCERNS.md. For each, tries to parse `**Analysis Date:** YYYY-MM-DD` via regex `/\*\*Analysis Date:\*\*\s*(\d{4}-\d{2}-\d{2})/`. Uses the first date found. If no date found in any doc, returns `{ brownfieldDocStale: false, reason: 'no_analysis_date' }`.
3. Finds the commit at or before the analysis date: `git log --until="${analysisDate}T23:59:59" --format=%H -1`. If no commit found or git fails, returns `{ brownfieldDocStale: false, reason: 'no_commit_at_date' }`.
4. Runs `git diff --name-only ${baseCommit}..HEAD` to get changed files. If no changes, returns `{ brownfieldDocStale: false, brownfieldAnalysisDate, brownfieldChangedFiles: 0, brownfieldTotalFiles: 0, brownfieldChangePct: 0 }`.
5. Filters changed files to source files only (extension in SUPPORTED_EXTENSIONS).
6. Gets total source file count via `git ls-files`, filtered to SUPPORTED_EXTENSIONS.
7. Computes changePct = sourceChanged.length / totalFiles.
8. Returns:
```javascript
{
  brownfieldDocStale: changePct > 0.3,
  brownfieldAnalysisDate: analysisDate,
  brownfieldChangedFiles: sourceChanged.length,
  brownfieldTotalFiles: totalFiles,
  brownfieldChangePct: Math.round(changePct * 100) / 100,
}
```

All git operations use the existing `git()` helper. Wrap each git call in try/catch for graceful degradation. The function uses the existing `dirExists()` helper.
  </action>
  <verify>Read the file and confirm `detectBrownfieldDocStaleness` function exists with all 8 steps implemented.</verify>
  <done>Function parses Analysis Date, compares git history, returns brownfield staleness fields with 30% threshold.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate brownfield detection into CLI output and exports</name>
  <files>skills/kata-map-codebase/scripts/detect-stale-intel.cjs</files>
  <action>
Modify the `main()` function to call `detectBrownfieldDocStaleness(projectRoot)` after `detectStaleFiles(projectRoot)`. Merge the brownfield result into the existing result object using spread:

```javascript
function main() {
  const projectRoot = resolveProjectRoot();
  const result = detectStaleFiles(projectRoot);
  const brownfield = detectBrownfieldDocStaleness(projectRoot);
  console.log(JSON.stringify({ ...result, ...brownfield }, null, 2));
}
```

Update the `module.exports` line to include the new function:

```javascript
module.exports = { detectStaleFiles, detectBrownfieldDocStaleness };
```

This ensures:
- CLI output includes all existing fields plus brownfield fields
- The function is importable for unit testing
- The existing detectStaleFiles behavior is unchanged
  </action>
  <verify>Run `node skills/kata-map-codebase/scripts/detect-stale-intel.cjs` from the project root. Confirm the JSON output includes `brownfieldDocStale`, `brownfieldAnalysisDate`, and related fields alongside the existing fields.</verify>
  <done>CLI output includes brownfield staleness fields. Function is exported for testing.</done>
</task>
</tasks>

<verification>
1. `node skills/kata-map-codebase/scripts/detect-stale-intel.cjs` outputs valid JSON with both existing fields and new brownfield fields
2. `detectBrownfieldDocStaleness` is exported from the module
3. When `.planning/codebase/` exists with dated docs, `brownfieldAnalysisDate` is populated
4. No changes to existing `detectStaleFiles` behavior (existing tests still pass if any)
</verification>

<success_criteria>
- detect-stale-intel.cjs exports `detectBrownfieldDocStaleness` function
- CLI output JSON includes `brownfieldDocStale`, `brownfieldAnalysisDate`, `brownfieldChangedFiles`, `brownfieldTotalFiles`, `brownfieldChangePct`
- Function handles missing codebase dir, missing Analysis Date, git failures gracefully
- 30% threshold matches existing doc gardening threshold
- No changes to existing staleness detection behavior
</success_criteria>

<output>
After completion, create `.planning/phases/pending/58-brownfield-doc-auto-refresh/58-01-SUMMARY.md`
</output>
