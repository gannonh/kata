---
phase: 45-worktree-scripting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/scripts/create-phase-branch.sh
  - skills/kata-execute-phase/scripts/update-issue-checkboxes.sh
  - skills/kata-execute-phase/scripts/create-draft-pr.sh
  - skills/kata-execute-phase/SKILL.md
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "Inline bash blocks in SKILL.md steps 1.5 and 4 are replaced with calls to standalone scripts"
    - "Extracted scripts produce identical behavior to the inline blocks they replace"
    - "SKILL.md is shorter and easier to read after extraction"
  artifacts:
    - path: "skills/kata-execute-phase/scripts/create-phase-branch.sh"
      provides: "Phase branch creation with type inference and re-run protection"
    - path: "skills/kata-execute-phase/scripts/update-issue-checkboxes.sh"
      provides: "GitHub issue checkbox updates after wave completion"
    - path: "skills/kata-execute-phase/scripts/create-draft-pr.sh"
      provides: "Draft PR creation with phase metadata"
  key_links:
    - from: "SKILL.md step 1.5"
      to: "create-phase-branch.sh"
      via: "bash ./scripts/create-phase-branch.sh call replacing inline block"
    - from: "SKILL.md step 4"
      to: "update-issue-checkboxes.sh"
      via: "bash ./scripts/update-issue-checkboxes.sh call replacing inline block"
    - from: "SKILL.md step 4"
      to: "create-draft-pr.sh"
      via: "bash ./scripts/create-draft-pr.sh call replacing inline block"
---

<objective>
Extract three inline bash blocks from `kata-execute-phase/SKILL.md` into standalone scripts in the `scripts/` directory.

Purpose: SKILL.md currently contains ~100 lines of inline bash across steps 1.5 and 4. Extracting to scripts makes them testable, reusable by Phase 46's worktree integration, and reduces SKILL.md cognitive load. This satisfies HOUSE-01.

Output: Three new scripts in `skills/kata-execute-phase/scripts/` and a slimmer SKILL.md that calls them.
</objective>

<execution_context>
<!-- Executor reads current SKILL.md to extract the exact inline blocks -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@skills/kata-execute-phase/SKILL.md
@skills/kata-execute-phase/scripts/find-phase.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract create-phase-branch.sh from SKILL.md step 1.5</name>
  <files>skills/kata-execute-phase/scripts/create-phase-branch.sh</files>
  <action>
Create `skills/kata-execute-phase/scripts/create-phase-branch.sh` by extracting the inline bash from SKILL.md step 1.5 ("Create Phase Branch").

**Script interface:**
```
Usage: create-phase-branch.sh <phase-dir>
Output: key=value pairs (BRANCH, BRANCH_TYPE, MILESTONE, PHASE_NUM, SLUG)
Exit: 0=success (on branch), 1=error
```

The script receives PHASE_DIR as its single argument and:
1. Reads MILESTONE from ROADMAP.md (grep for current milestone version)
2. Extracts PHASE_NUM and SLUG from the phase directory basename
3. Infers BRANCH_TYPE from phase goal in ROADMAP.md (feat/fix/docs/refactor/chore, default feat)
4. Constructs branch name: `{BRANCH_TYPE}/v{MILESTONE}-{PHASE_NUM}-{SLUG}`
5. Re-run protection: if branch exists, checkout and print "resumed"; if not, create and print "created"
6. Outputs key=value pairs: BRANCH, BRANCH_TYPE, MILESTONE, PHASE_NUM, SLUG

Use `set -euo pipefail`. Follow the exact logic currently inline in SKILL.md step 1.5. Make executable.

The existing inline code is approximately:
```bash
MILESTONE=$(grep -E "Current Milestone:|ðŸ”„" .planning/ROADMAP.md | grep -oE 'v[0-9]+\.[0-9]+(\.[0-9]+)?' | head -1 | tr -d 'v')
PHASE_NUM=$(basename "$PHASE_DIR" | sed -E 's/^([0-9]+)-.*/\1/')
SLUG=$(basename "$PHASE_DIR" | sed -E 's/^[0-9]+-//')
# ... branch type inference from phase goal ...
BRANCH="${BRANCH_TYPE}/v${MILESTONE}-${PHASE_NUM}-${SLUG}"
# ... create or checkout ...
```

Preserve this logic exactly. Do NOT change behavior.
  </action>
  <verify>
```bash
test -x skills/kata-execute-phase/scripts/create-phase-branch.sh
bash skills/kata-execute-phase/scripts/create-phase-branch.sh 2>&1 | grep -q "Usage"
```
  </verify>
  <done>create-phase-branch.sh exists, is executable, accepts phase-dir argument, outputs key=value pairs, has re-run protection.</done>
</task>

<task type="auto">
  <name>Task 2: Extract update-issue-checkboxes.sh and create-draft-pr.sh from SKILL.md step 4</name>
  <files>skills/kata-execute-phase/scripts/update-issue-checkboxes.sh, skills/kata-execute-phase/scripts/create-draft-pr.sh</files>
  <action>
Create two scripts extracted from SKILL.md step 4.

**update-issue-checkboxes.sh:**
```
Usage: update-issue-checkboxes.sh <phase-num> <phase-dir> <completed-plan-nums>
  completed-plan-nums: space-separated plan numbers (e.g., "01 02")
Output: Status message (updated/skipped/warning)
Exit: 0=success or skipped, 1=error
```

Steps (from the existing inline code):
1. Read github.enabled and issueMode from config.json. If not enabled or issueMode=never, print "Skipped: GitHub issues not enabled" and exit 0.
2. Get milestone version from ROADMAP.md
3. Find phase issue via gh API (two-step: resolve milestone number, then query issues). Use the API pattern from SKILL.md that handles closed milestones.
4. If issue not found, warn and exit 0 (non-blocking).
5. Read current issue body via `gh issue view`
6. For each completed plan number, update checkbox: `- [ ] Plan NN:` to `- [x] Plan NN:`
7. Write to temp file and update via `gh issue edit --body-file`

**create-draft-pr.sh:**
```
Usage: create-draft-pr.sh <phase-dir> <branch>
Output: key=value pairs (PR_NUMBER, PR_URL) or EXISTING_PR=<number>
Exit: 0=success, 1=error
```

Steps (from the existing inline code):
1. Check if PR already exists for this branch via `gh pr list --head`. If yes, print `EXISTING_PR={number}` and exit 0.
2. Push branch: `git push -u origin "$BRANCH"`
3. Get phase name and goal from ROADMAP.md
4. Read github.enabled and issueMode. If enabled, find phase issue for `Closes #N` line (same API pattern as update-issue-checkboxes.sh).
5. Build plans checklist from PLAN.md files in phase dir
6. Collect source_issue references from all plans
7. Write PR body to temp file
8. Create draft PR via `gh pr create --draft`
9. Output `PR_NUMBER={n}` and `PR_URL={url}`

Both scripts use `set -euo pipefail`. Both follow the exact logic currently inline in SKILL.md step 4. Make both executable.
  </action>
  <verify>
```bash
test -x skills/kata-execute-phase/scripts/update-issue-checkboxes.sh
test -x skills/kata-execute-phase/scripts/create-draft-pr.sh
bash skills/kata-execute-phase/scripts/update-issue-checkboxes.sh 2>&1 | grep -q "Usage"
bash skills/kata-execute-phase/scripts/create-draft-pr.sh 2>&1 | grep -q "Usage"
```
  </verify>
  <done>Both scripts exist, are executable, accept appropriate arguments, and produce parseable output. Logic matches the inline code they replace.</done>
</task>

<task type="auto">
  <name>Task 3: Update SKILL.md to call extracted scripts</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Replace the inline bash blocks in SKILL.md with calls to the new scripts.

**Step 1.5 replacement:**

Replace the entire inline bash block (from `MILESTONE=$(grep...` through the `git checkout` block and `Store BRANCH variable` comment) with:

```bash
BRANCH_OUTPUT=$(bash "./scripts/create-phase-branch.sh" "$PHASE_DIR")
eval "$BRANCH_OUTPUT"
# Outputs: BRANCH, BRANCH_TYPE, MILESTONE, PHASE_NUM, SLUG
```

Keep the surrounding context (PR_WORKFLOW check, "If PR_WORKFLOW=false: Skip to step 2" note) unchanged.

**Step 4 GitHub issue checkbox replacement:**

Replace the inline checkbox update block (from `COMPLETED_PLANS_IN_WAVE=""` through `echo "Updated issue #${ISSUE_NUMBER}"`) with:

```bash
# Build space-separated list of completed plan numbers from this wave
COMPLETED_PLANS_IN_WAVE=""
for summary in $(find "${PHASE_DIR}" -maxdepth 1 -name "*-SUMMARY.md" 2>/dev/null); do
  plan_num=$(basename "$summary" | sed -E 's/^[0-9]+-([0-9]+)-SUMMARY\.md$/\1/')
  if echo "${WAVE_PLANS}" | grep -q "plan-${plan_num}"; then
    COMPLETED_PLANS_IN_WAVE="${COMPLETED_PLANS_IN_WAVE} ${plan_num}"
  fi
done

bash "./scripts/update-issue-checkboxes.sh" "$PHASE" "$PHASE_DIR" $COMPLETED_PLANS_IN_WAVE
```

Keep the wave-plan detection loop (it depends on WAVE_PLANS from the wave execution context). Only extract the GitHub API interaction into the script.

**Step 4 Draft PR replacement:**

Replace the inline draft PR block (from `if [ "$PR_WORKFLOW" = "true" ]; then` through the end of the PR creation) with:

```bash
if [ "$PR_WORKFLOW" = "true" ]; then
  PR_OUTPUT=$(bash "./scripts/create-draft-pr.sh" "$PHASE_DIR" "$BRANCH")
  eval "$PR_OUTPUT"
  # Outputs: PR_NUMBER (and possibly EXISTING_PR)
fi
```

**Validation after edits:**
- SKILL.md should be noticeably shorter (removed ~100 lines of inline bash)
- All step numbers and surrounding prose remain intact
- No behavioral changes to the workflow
- `npm run build:plugin && npm test` passes
  </action>
  <verify>
```bash
npm run build:plugin && npm test
```
Verify SKILL.md no longer contains the large inline bash blocks (the gh API calls for issue/PR management).
  </verify>
  <done>SKILL.md steps 1.5 and 4 call extracted scripts instead of inline bash. Build and tests pass. SKILL.md is ~100 lines shorter.</done>
</task>

</tasks>

<verification>
- Three new scripts exist in `skills/kata-execute-phase/scripts/`
- All scripts are executable
- SKILL.md references scripts via `bash "./scripts/{name}.sh"` calls
- `npm run build:plugin && npm test` passes
- No behavioral changes (scripts replicate inline logic exactly)
</verification>

<success_criteria>
- create-phase-branch.sh extracts step 1.5 branch creation logic
- update-issue-checkboxes.sh extracts step 4 issue checkbox logic
- create-draft-pr.sh extracts step 4 PR creation logic
- SKILL.md calls scripts instead of inline bash blocks
- Build and tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/pending/45-worktree-scripting/45-02-SUMMARY.md`
</output>
