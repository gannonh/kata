---
phase: 01-proof-of-concept
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-plan-phase/references/planner-instructions.md
  - skills/kata-plan-phase/SKILL.md
autonomous: true

must_haves:
  truths:
    - "kata-plan-phase spawns a general-purpose subagent with planner instructions inlined for both kata-planner Task() calls"
    - "Both standard and revision mode Task() calls include agent-instructions wrapper"
    - "Planner instructions file contains the full body content from agents/kata-planner.md (no frontmatter)"
  artifacts:
    - path: "skills/kata-plan-phase/references/planner-instructions.md"
      provides: "Planner agent instructions as skill resource"
      min_lines: 1400
    - path: "skills/kata-plan-phase/SKILL.md"
      provides: "Updated orchestrator using general-purpose subagent for planner calls"
      contains: "subagent_type=\"general-purpose\""
  key_links:
    - from: "skills/kata-plan-phase/SKILL.md"
      to: "skills/kata-plan-phase/references/planner-instructions.md"
      via: "Read tool call in step 7 storing content as planner_instructions_content"
      pattern: "references/planner-instructions\\.md"
    - from: "skills/kata-plan-phase/SKILL.md"
      to: "Task() call"
      via: "agent-instructions wrapper prepended to prompt"
      pattern: "agent-instructions"
---

<objective>
Migrate kata-planner from custom subagent to skill resource with inlined instructions.

Purpose: Converts the 2 planner-specific Task() calls in kata-plan-phase from custom agent lookup to explicit prompt content (inlined from skill resource). Covers POC-01 and the planner portion of POC-03 (the 2 `kata-planner` Task() calls in steps 8 and 12). The other custom subagent types in kata-plan-phase (`kata-phase-researcher` at line 234, `kata-plan-checker` at line 474) are Phase 2 scope and remain unchanged.
Output: `planner-instructions.md` skill resource + updated `kata-plan-phase` SKILL.md
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/01-proof-of-concept/01-RESEARCH.md

Source files:
@agents/kata-planner.md
@skills/kata-plan-phase/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract planner instructions to skill resource and update SKILL.md</name>
  <files>skills/kata-plan-phase/references/planner-instructions.md, skills/kata-plan-phase/SKILL.md</files>
  <action>
**Step A: Create planner-instructions.md**

Read `agents/kata-planner.md`. Extract everything AFTER the closing `---` of the YAML frontmatter (line 7 onward). The frontmatter block is lines 1-6 (the `---`, name, description, tools, color, `---`). Copy lines 7+ verbatim into `skills/kata-plan-phase/references/planner-instructions.md`.

Do NOT include the frontmatter. Do NOT restructure, rewrite, or improve the content. Verbatim copy of the body.

Verify the new file does NOT start with `---` and does NOT contain `tools:`, `color:`, or `model:` YAML fields.

**Step B: Add Read call for planner instructions in step 7**

In step 7 ("Read Context Files"), after the existing list of Read tool calls (lines 263-271 which list STATE.md, ROADMAP.md, REQUIREMENTS.md, CONTEXT.md, RESEARCH.md, VERIFICATION.md, UAT.md), add a new bullet:

```
- `${SKILL_BASE_DIR}/references/planner-instructions.md` (required) â€” where `${SKILL_BASE_DIR}` is the skill's base directory shown in the invocation header (e.g., `skills/kata-plan-phase` or the resolved plugin path)
```

After line 272 ("Store all content for use in the Task prompt below."), add:

```
Store the planner instructions content as `planner_instructions_content` for use in the Task prompt.
```

**Step C: Update Task() calls in SKILL.md**

The SKILL.md has two Task() calls that spawn `kata-planner`:

1. **Step 8 (standard planning)** at line ~400-406:
   ```
   Task(
     prompt=filled_prompt,
     subagent_type="kata-planner",
     model="{planner_model}",
     description="Plan Phase {phase}"
   )
   ```

2. **Step 12 (revision mode)** at line ~530-536:
   ```
   Task(
     prompt=revision_prompt,
     subagent_type="kata-planner",
     model="{planner_model}",
     description="Revise Phase {phase} plans"
   )
   ```

For BOTH calls:
- Change `subagent_type="kata-planner"` to `subagent_type="general-purpose"`
- Update the prompt parameter to prepend `<agent-instructions>` wrapper

The updated prompt structure for step 8:
```
"<agent-instructions>\n{planner_instructions_content}\n</agent-instructions>\n\n" + filled_prompt
```

The updated prompt structure for step 12:
```
"<agent-instructions>\n{planner_instructions_content}\n</agent-instructions>\n\n" + revision_prompt
```

The existing prompt sections (`<planning_context>`, `<downstream_consumer>`, `<quality_gate>`, `<revision_context>`, `<instructions>`) stay exactly as-is. The `<agent-instructions>` block gets PREPENDED.

Do NOT change model selection logic. Do NOT change the `kata-phase-researcher` Task() call (line ~234) or the `kata-plan-checker` Task() call (line ~474). Those remain custom subagent types for Phase 2.
  </action>
  <verify>
1. `grep -c 'subagent_type="kata-planner"' skills/kata-plan-phase/SKILL.md` returns 0
2. `grep -c 'subagent_type="general-purpose"' skills/kata-plan-phase/SKILL.md` returns 2
3. `grep -c 'agent-instructions' skills/kata-plan-phase/SKILL.md` returns at least 2
4. `grep -c 'kata-phase-researcher' skills/kata-plan-phase/SKILL.md` returns 1 (unchanged)
5. `grep -c 'kata-plan-checker' skills/kata-plan-phase/SKILL.md` returns 1 (unchanged)
6. `grep 'planner-instructions.md' skills/kata-plan-phase/SKILL.md` returns at least 1 match (the Read call in step 7)
7. `grep 'planner_instructions_content' skills/kata-plan-phase/SKILL.md` returns at least 1 match
8. `head -1 skills/kata-plan-phase/references/planner-instructions.md` does NOT start with `---`
9. `wc -l skills/kata-plan-phase/references/planner-instructions.md` shows ~1430+ lines
10. `npm run build:plugin` succeeds
  </verify>
  <done>
- planner-instructions.md exists with full agent body content (no frontmatter)
- Step 7 includes explicit Read call for `references/planner-instructions.md` storing as `planner_instructions_content`
- Both kata-planner Task() calls in SKILL.md use subagent_type="general-purpose"
- Both kata-planner Task() calls wrap instructions in agent-instructions tags
- kata-phase-researcher and kata-plan-checker Task() calls remain unchanged (Phase 2 scope)
- Build passes
  </done>
</task>

</tasks>

<verification>
- `grep -r 'subagent_type="kata-planner"' skills/kata-plan-phase/` returns empty
- `grep -r 'subagent_type="general-purpose"' skills/kata-plan-phase/SKILL.md` returns 2 matches
- `grep 'agent-instructions' skills/kata-plan-phase/SKILL.md` returns matches for both standard and revision Task() calls
- `grep 'kata-phase-researcher' skills/kata-plan-phase/SKILL.md` returns 1 match (preserved)
- `grep 'kata-plan-checker' skills/kata-plan-phase/SKILL.md` returns 1 match (preserved)
- `grep 'planner-instructions.md' skills/kata-plan-phase/SKILL.md` confirms Read call exists in step 7
- planner-instructions.md starts with `<role>` (first tag in agent body)
- `npm run build:plugin` succeeds without errors
</verification>

<success_criteria>
1. `skills/kata-plan-phase/references/planner-instructions.md` exists with ~1430 lines of agent instructions
2. `skills/kata-plan-phase/SKILL.md` step 7 reads planner-instructions.md and stores as `planner_instructions_content`
3. Both standard (step 8) and revision (step 12) kata-planner Task() calls use general-purpose with inlined instructions
4. kata-phase-researcher and kata-plan-checker remain as custom subagent types (Phase 2 scope)
5. Plugin build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/pending/01-proof-of-concept/01-01-SUMMARY.md`
</output>
