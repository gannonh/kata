---
phase: 03-phase-lookup-ignores-milestone-scope-causing-collisions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-add-milestone/SKILL.md
  - skills/kata-complete-milestone/references/milestone-complete.md
  - skills/kata-complete-milestone/references/milestone-archive-template.md
  - skills/kata-plan-milestone-gaps/SKILL.md
  - skills/kata-plan-phase/SKILL.md
  - skills/kata-plan-phase/references/planner-instructions.md
  - skills/kata-plan-phase/references/phase-researcher-instructions.md
  - skills/kata-plan-phase/references/plan-checker-instructions.md
  - skills/kata-execute-phase/scripts/find-phase.sh
  - skills/kata-execute-phase/references/phase-execute.md
  - skills/kata-verify-work/references/verify-work.md
  - skills/kata-verify-work/references/planner-instructions.md
  - skills/kata-verify-work/references/plan-checker-instructions.md
  - skills/kata-research-phase/SKILL.md
  - skills/kata-research-phase/references/phase-researcher-instructions.md
  - skills/kata-track-progress/SKILL.md
  - skills/kata-pause-work/SKILL.md
  - skills/kata-remove-phase/SKILL.md
  - skills/kata-discuss-phase/references/phase-discuss.md
  - skills/kata-audit-milestone/SKILL.md
  - skills/kata-audit-milestone/references/integration-checker-instructions.md
  - skills/kata-check-issues/SKILL.md
autonomous: true
source_issue: "github:gannonh/kata-orchestrator#102"
must_haves:
  truths:
    - Phase lookup returns unique results because global numbering eliminates prefix collisions
    - New milestones continue from highest existing phase number instead of resetting to 1
    - The phase lookup pattern remains backward-compatible with flat directory layouts
  artifacts:
    - Updated numbering policy in kata-add-milestone (2 locations)
    - Updated numbering policy in kata-complete-milestone (2 locations)
    - Updated phase lookup pattern across ~17 source files (no functional change needed, but policy comments updated)
  key_links:
    - skills/kata-add-milestone/SKILL.md (lines 736, 767)
    - skills/kata-complete-milestone/references/milestone-complete.md
    - skills/kata-complete-milestone/references/milestone-archive-template.md
    - skills/kata-plan-milestone-gaps/SKILL.md (already scans for highest)
---

<objective>
Update numbering policy and phase lookup references across all skill files.

Purpose: Six locations explicitly say "start phase numbering at 1" for each new milestone. These must change to "continue from highest existing phase number + 1." The phase lookup pattern itself doesn't need functional changes (it already works correctly when prefixes are unique), but policy comments embedded in lookup code should reflect global numbering.

Output: All numbering policy references updated. All skill files reflect globally sequential numbering model.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/03-phase-lookup-ignores-milestone-scope-causing-collisions/03-CONTEXT.md
@.planning/phases/pending/03-phase-lookup-ignores-milestone-scope-causing-collisions/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update numbering policy from reset-to-1 to continuation</name>
  <files>skills/kata-add-milestone/SKILL.md, skills/kata-complete-milestone/references/milestone-complete.md, skills/kata-complete-milestone/references/milestone-archive-template.md, skills/kata-plan-milestone-gaps/SKILL.md</files>
  <action>
Update the 6 locations that define or reference the per-milestone numbering policy:

1. **`skills/kata-add-milestone/SKILL.md` (around line 736):** Change "Start phase numbering at 1 (each milestone has independent numbering)" to instruct: scan all existing phase directories across `.planning/phases/{active,pending,completed}/` to find the highest phase number, then start this milestone's phases at highest + 1. Include the continuation numbering bash snippet from the research:
```bash
ALL_PHASE_DIRS=""
for state in active pending completed; do
  [ -d ".planning/phases/${state}" ] && ALL_PHASE_DIRS="${ALL_PHASE_DIRS} $(find .planning/phases/${state} -maxdepth 1 -type d -not -name "${state}" 2>/dev/null)"
done
HIGHEST=$(echo "$ALL_PHASE_DIRS" | tr ' ' '\n' | grep -oE '/[0-9]+' | grep -oE '[0-9]+' | sort -n | tail -1)
NEXT_PHASE=$((HIGHEST + 1))
```

2. **`skills/kata-add-milestone/SKILL.md` (around line 767):** Same change in the roadmapper instructions section. Replace "Start phase numbering at 1 (each milestone has independent numbering)" with "Continue phase numbering from the highest existing phase number + 1 (globally sequential across milestones)."

3. **`skills/kata-complete-milestone/references/milestone-complete.md`:** Find the numbering policy reference and update to reflect global sequential numbering.

4. **`skills/kata-complete-milestone/references/milestone-archive-template.md`:** Same update.

5. **`skills/kata-plan-milestone-gaps/SKILL.md`:** Already scans for highest existing phase. Verify the comment/documentation reflects global numbering. Update any text that says "per-milestone" or "start at 1."

6. **`README.md`:** If it references per-milestone numbering, update to globally sequential.

Do NOT change the phase lookup pattern itself (the find/head snippet). That code works correctly once prefixes are unique. Only update policy text and comments.
  </action>
  <verify>
```bash
# No remaining "start phase numbering at 1" or "start at 1" references
grep -ri "start phase numbering at 1\|start at 1\|each milestone has independent numbering\|per-milestone phase numbering\|starts phase numbering at 1" skills/ --include="*.md" -l
# Should return empty or only historical/archive references

# Verify continuation numbering snippet was added to kata-add-milestone
grep -A 5 "HIGHEST.*NEXT_PHASE" skills/kata-add-milestone/SKILL.md
# Should show the continuation numbering bash snippet
```
  </verify>
  <done>All numbering policy references say "continue from highest + 1" instead of "start at 1."</done>
</task>

<task type="auto">
  <name>Task 2: Update any phase-lookup-adjacent comments and documentation</name>
  <files>skills/kata-plan-phase/SKILL.md, skills/kata-plan-phase/references/planner-instructions.md, skills/kata-execute-phase/references/phase-execute.md, skills/kata-verify-work/references/verify-work.md, CLAUDE.md, KATA-STYLE.md</files>
  <action>
Scan the 17 files containing the phase lookup snippet (listed in 03-RESEARCH.md "Affected Files Inventory"). For each file:

1. Check if there are any inline comments near the lookup that reference per-milestone numbering. If so, update or remove them.
2. Check if there's surrounding documentation text that assumes milestone-scoped phase numbers. If so, update to reflect global sequential numbering.

Also check `CLAUDE.md` and `KATA-STYLE.md` for any references to "per-milestone phase numbering" or similar. Update if found.

The lookup code itself (the `find -name "${PADDED}-*"` pattern) does NOT need changes. It works correctly with globally unique prefixes. This task is about surrounding documentation and comments only.
  </action>
  <verify>
```bash
# Search for remaining per-milestone numbering references in skill files
grep -ri "per-milestone\|milestone-scoped\|each milestone starts\|reset.* phase.*1\|independent numbering" skills/ CLAUDE.md KATA-STYLE.md --include="*.md" -l
# Should return empty or only this phase's own context/research files
```
  </verify>
  <done>No skill file or project documentation references per-milestone phase numbering as current policy.</done>
</task>

</tasks>

<verification>
- `grep -ri "start phase numbering at 1" skills/ --include="*.md"` returns no results
- `grep -ri "per-milestone" skills/ CLAUDE.md KATA-STYLE.md --include="*.md"` returns no results outside phase 3's own research/context files
- `kata-add-milestone` SKILL.md contains continuation numbering logic
</verification>

<success_criteria>
- All 6 numbering policy locations updated to globally sequential model
- No skill file references per-milestone numbering as current policy
- The phase lookup pattern (find/head) remains unchanged and functional
</success_criteria>

<output>
After completion, create `.planning/phases/pending/{N}-phase-lookup-ignores-milestone-scope-causing-collisions/03-02-SUMMARY.md`
(Use OLD plan number 03-02 in summary filename for traceability, since directory may have been renamed by Plan 01)
</output>
