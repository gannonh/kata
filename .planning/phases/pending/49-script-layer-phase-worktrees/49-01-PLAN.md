---
phase: 49-script-layer-phase-worktrees
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/scripts/create-phase-branch.sh
  - tests/scripts/create-phase-branch.test.js
autonomous: true
must_haves:
  truths:
    - create-phase-branch.sh creates a worktree directory at project root via GIT_DIR=.bare git worktree add
    - Worktree directory named {branch-type}-v{milestone}-{phase-num}-{slug} as sibling to main/
    - Rerunning the script with an existing worktree outputs WORKTREE_PATH and BRANCH without error
    - Script outputs WORKTREE_PATH and BRANCH key=value pairs for orchestrator consumption
    - main/ worktree stays on the main branch (no git checkout -b inside main/)
  artifacts:
    - skills/kata-execute-phase/scripts/create-phase-branch.sh
    - tests/scripts/create-phase-branch.test.js
  key_links:
    - create-phase-branch.sh -> orchestrator reads WORKTREE_PATH to know phase working directory
    - project-root.sh sourced for CWD resolution (unchanged)
---

<objective>
Rewrite `create-phase-branch.sh` to create a phase worktree as a sibling to `main/` instead of running `git checkout -b` inside `main/`. The script must output `WORKTREE_PATH` and `BRANCH` so the orchestrator knows where the phase worktree lives.

Purpose: `main/` must stay on the `main` branch permanently. Phase work happens in a dedicated worktree.
Output: Modified `create-phase-branch.sh`, updated tests.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/refactor-worktree-phases.md
@skills/kata-execute-phase/scripts/create-phase-branch.sh
@skills/kata-configure-settings/scripts/project-root.sh
@tests/scripts/create-phase-branch.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite create-phase-branch.sh to create a phase worktree</name>
  <files>skills/kata-execute-phase/scripts/create-phase-branch.sh</files>
  <action>
Replace the `git checkout -b` / `git checkout` block (lines 41-49) with worktree creation logic.

**Keep unchanged:** Lines 1-39 (shebang, set, project-root source, PHASE_DIR arg, milestone extraction, phase num/slug parsing, branch type inference, BRANCH name construction). These are correct.

**Replace lines 41-49 with:**

1. Compute WORKTREE_DIR. The script runs from inside `main/` (project-root.sh cd's there). The project root (parent of main/) is `$(cd .. && pwd)`. The worktree directory name uses dashes not slashes: `${BRANCH_TYPE}-v${MILESTONE}-${PHASE_NUM}-${SLUG}`.

```bash
WORKTREE_DIR="$(cd .. && pwd)/${BRANCH_TYPE}-v${MILESTONE}-${PHASE_NUM}-${SLUG}"
```

2. Handle resumption: if the worktree directory already exists AND the branch exists, output the path and exit 0. Do NOT error.

```bash
if [ -d "$WORKTREE_DIR" ] && GIT_DIR=../.bare git show-ref --verify --quiet refs/heads/"$BRANCH"; then
  echo "Phase worktree $WORKTREE_DIR exists, resuming" >&2
else
  GIT_DIR=../.bare git worktree add "$WORKTREE_DIR" -b "$BRANCH" main >&2
  echo "Created phase worktree $WORKTREE_DIR on branch $BRANCH" >&2
fi
```

3. Update output to include WORKTREE_PATH:

```bash
echo "WORKTREE_PATH=$WORKTREE_DIR"
echo "BRANCH=$BRANCH"
echo "BRANCH_TYPE=$BRANCH_TYPE"
echo "MILESTONE=$MILESTONE"
echo "PHASE_NUM=$PHASE_NUM"
echo "SLUG=$SLUG"
```

**Critical:** The script sources `project-root.sh` which cd's to the project root (directory containing `.planning/`). In a bare repo layout, that's `main/`. So `../.bare` reaches the bare repo. Use `GIT_DIR=../.bare` for all git commands. Use `$(cd .. && pwd)` to get the project root's parent (the bare repo project root where `main/` and `.bare/` live).

**Do NOT** use `git checkout` anywhere. The whole point is to stop switching `main/` off the main branch.
  </action>
  <verify>
Build the plugin (`npm run build:plugin`), then run the existing test suite: `npm run test:scripts`. Existing tests will fail because the test setup uses a normal git repo (not bare layout). That's expected and will be fixed in Task 2.

Manual verification: read the modified script and confirm:
- No `git checkout` or `git checkout -b` commands exist
- `GIT_DIR=../.bare git worktree add` is used for creation
- WORKTREE_PATH is in the output
- Resumption case outputs path without error
  </verify>
  <done>
`create-phase-branch.sh` creates a worktree directory at project root level using `git worktree add`, outputs WORKTREE_PATH, handles resumption idempotently, and never runs `git checkout` inside `main/`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update create-phase-branch.sh tests for bare repo + worktree layout</name>
  <files>tests/scripts/create-phase-branch.test.js</files>
  <action>
The existing tests use a normal git repo (`git init`). The modified script requires a bare repo layout with `main/` worktree and `.bare/` directory.

**Replace `createGitRepoWithRoadmap` with a bare-repo-aware version.** Follow the same pattern used in `manage-worktree.test.js`'s `createBareRepo`:

1. `git init -b main` in tmpDir
2. Create `.planning/phases/pending/{phaseNum}-test-phase/` and `.planning/ROADMAP.md`
3. `git add -A && git commit -m "init"`
4. `git clone --bare . .bare`
5. Remove `.git`, replace with `gitdir: .bare`
6. `GIT_DIR=.bare git worktree add main main`

**Update `runScript`:** The script now runs from inside `main/` (project-root.sh detects `main/.planning/`), so pass `path.join(dir, 'main')` as cwd instead of `dir`.

Wait: `project-root.sh` checks: (1) KATA_PROJECT_ROOT, (2) CWD has `.planning/`, (3) CWD/main has `.planning/`. In the bare layout, `.planning/` is inside `main/`, not at the project root. So if cwd is `dir` (project root), `project-root.sh` will find `main/.planning/` and cd to `main/`. If cwd is `dir/main`, it will find `.planning/` directly. Either way, the script ends up in `main/`.

Set cwd to `dir` (project root). The script will resolve to `main/` via project-root.sh.

**Update assertions:**

- `kv.BRANCH` format unchanged (e.g., `feat/v1.10.0-05-test-phase`)
- Add assertion for `kv.WORKTREE_PATH`: should end with `/{branchType}-v1.10.0-05-test-phase`
- Add assertion that `main/` still on main branch: `git -C main branch --show-current` returns `main`
- Add assertion that the worktree directory exists at the project root

**Update idempotent test:** Run script twice, verify both runs output the same WORKTREE_PATH and BRANCH.

**Add new test:** "main/ stays on main branch after phase branch creation" - verify `git -C main branch --show-current` returns `main`.

**Expected test count:** 6-7 tests (existing 6 + invariant check, some merged).

Key: the `expected` array in "outputs all key=value pairs" must include `WORKTREE_PATH` (6 keys now, not 5).
  </action>
  <verify>
```bash
npm run build:plugin && node --test tests/scripts/create-phase-branch.test.js
```
All tests pass. No test uses `git checkout`.
  </verify>
  <done>
All `create-phase-branch.test.js` tests pass against the modified script. Tests use bare repo layout. Tests verify WORKTREE_PATH output, worktree directory creation, resumption, and the invariant that `main/` stays on the main branch.
  </done>
</task>

</tasks>

<verification>
```bash
npm run build:plugin && node --test tests/scripts/create-phase-branch.test.js
```

Manual check: grep the modified script for `git checkout` â€” should return zero matches.
</verification>

<success_criteria>
- `create-phase-branch.sh` creates a worktree via `git worktree add`, not `git checkout -b`
- Output includes `WORKTREE_PATH` pointing to the phase worktree directory
- Worktree directory named `{branch-type}-v{milestone}-{phase-num}-{slug}`
- Resumption: rerunning with existing worktree outputs path without error
- `main/` stays on `main` branch (no checkout commands in script)
- All tests in `create-phase-branch.test.js` pass
</success_criteria>

<output>
After completion, create `.planning/phases/49-script-layer-phase-worktrees/49-01-SUMMARY.md`
</output>
