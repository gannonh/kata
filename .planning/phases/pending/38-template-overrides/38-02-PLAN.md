---
phase: 38-template-overrides
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - skills/kata-execute-phase/references/phase-execute.md
  - skills/kata-complete-milestone/references/milestone-complete.md
  - skills/kata-verify-work/references/verify-work.md
  - skills/kata-plan-phase/SKILL.md
  - hooks/kata-template-drift.js
  - hooks/hooks.json
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "Placing a file at .planning/templates/summary-template.md causes kata-execute-phase to use the override instead of the plugin default"
    - "Placing a file at .planning/templates/changelog-entry.md causes kata-complete-milestone to use the override"
    - "Placing a file at .planning/templates/UAT-template.md causes kata-verify-work to use the override"
    - "Placing a file at .planning/templates/verification-report.md causes kata-verify-work to use the override"
    - "Session-start hook detects missing required fields in a project template override and emits a warning line"
    - "Session-start hook emits nothing when no .planning/templates/ directory exists"
    - "Session-start hook emits nothing when all required fields are present in project overrides"
  artifacts:
    - hooks/kata-template-drift.js
  key_links:
    - "phase-execute.md resolves summary-template.md via resolve-template.sh before spawning subagent"
    - "milestone-complete.md resolves changelog-entry.md via resolve-template.sh"
    - "verify-work.md resolves UAT-template.md and verification-report.md via resolve-template.sh"
    - "hooks.json registers kata-template-drift.js alongside existing statusline hook"
---

<objective>
Wire template resolution into the four orchestrator skills and create the session-start drift detection hook.

Purpose: Complete TMPL-02 (resolution wiring) and TMPL-04 (drift detection). After this plan, skills resolve templates through the override chain and users get warnings when their project template overrides are missing required fields.
Output: 4 skill reference files updated with resolution logic, 1 drift detection hook, hooks.json updated.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/38-template-overrides/38-RESEARCH.md

@skills/kata-execute-phase/references/phase-execute.md
@skills/kata-execute-phase/SKILL.md
@skills/kata-complete-milestone/references/milestone-complete.md
@skills/kata-complete-milestone/SKILL.md
@skills/kata-verify-work/references/verify-work.md
@skills/kata-verify-work/SKILL.md
@skills/kata-plan-phase/SKILL.md
@hooks/hooks.json
@hooks/kata-setup-statusline.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire template resolution into orchestrator skills</name>
  <files>
    skills/kata-execute-phase/references/phase-execute.md,
    skills/kata-complete-milestone/references/milestone-complete.md,
    skills/kata-verify-work/references/verify-work.md,
    skills/kata-plan-phase/SKILL.md
  </files>
  <action>
Update each orchestrator skill to resolve templates via `resolve-template.sh` BEFORE spawning subagents, then inline the resolved template content into the subagent prompt.

**kata-execute-phase (phase-execute.md):**
In the subagent spawning section where the executor prompt is constructed (around lines 240-260), add template resolution before the subagent spawn. The orchestrator should:
1. Resolve the summary template path: `SUMMARY_TEMPLATE_PATH=$(bash "${PLUGIN_ROOT}/skills/kata-execute-phase/scripts/resolve-template.sh" "summary-template.md")`
2. Read the content: `SUMMARY_TEMPLATE=$(cat "$SUMMARY_TEMPLATE_PATH")`
3. Include the resolved template content in the subagent prompt context instead of the static `@./summary-template.md` reference.

Change the subagent prompt's `<execution_context>` to inline the resolved content. Replace the `@./summary-template.md` reference with a `{summary_template_content}` variable that gets the resolved content. Add a step or note explaining that the orchestrator resolves this before spawning.

**kata-complete-milestone (milestone-complete.md):**
Find where changelog generation uses the template format. Add resolution of `changelog-entry.md` before the changelog generation step. The milestone-complete workflow should resolve `changelog-entry.md` via the script and use the resolved content instead of the static `@./changelog-entry.md` reference in `changelog-generator.md`.

Add instructions in milestone-complete.md to resolve the template path before referencing changelog-generator.md:
```bash
CHANGELOG_TEMPLATE_PATH=$(bash "${PLUGIN_ROOT}/skills/kata-execute-phase/scripts/resolve-template.sh" "changelog-entry.md")
CHANGELOG_TEMPLATE=$(cat "$CHANGELOG_TEMPLATE_PATH")
```

**kata-verify-work (verify-work.md):**
This skill uses UAT-template.md (line 18: `@./UAT-template.md`) and spawns a verifier subagent that uses verification-report.md. Add resolution for both templates.

1. Resolve UAT template: Replace the static `@./UAT-template.md` reference with resolution via the script. The orchestrator reads the resolved UAT template and passes it as context.
2. For verification-report.md: The verifier subagent (spawned by verify-work.md) needs this template. The orchestrator resolves it and inlines the content into the verifier subagent prompt.

**kata-plan-phase (SKILL.md):**
The planner subagent uses plan-template.md (via planner-instructions.md). The plan-phase orchestrator should resolve `plan-template.md` before spawning the planner and inline the resolved template. Add a resolution step in SKILL.md before the planner spawn step.

**Pattern for all skills:**
```bash
# Resolve template (project override or plugin default)
TEMPLATE_PATH=$(bash "${PLUGIN_ROOT}/skills/kata-execute-phase/scripts/resolve-template.sh" "template-name.md")
TEMPLATE_CONTENT=$(cat "$TEMPLATE_PATH")
# Inline TEMPLATE_CONTENT into subagent prompt
```

The `PLUGIN_ROOT` variable should come from `CLAUDE_PLUGIN_ROOT` env var. Each skill already has access to this via the plugin runtime. Use the `PLUGIN_ROOT` pattern already present in these files, or add it if missing.

Do NOT change the template file locations. Do NOT remove the template files from references/. The resolution script handles finding them.
  </action>
  <verify>
Grep each modified file for the resolve-template.sh call:
```bash
grep -l "resolve-template.sh" skills/kata-execute-phase/references/phase-execute.md skills/kata-complete-milestone/references/milestone-complete.md skills/kata-verify-work/references/verify-work.md skills/kata-plan-phase/SKILL.md
```

Confirm the static @-references to templates are replaced with resolution patterns:
```bash
# These should NOT have bare @./summary-template.md in the subagent prompt section
grep -c "@./summary-template.md" skills/kata-execute-phase/references/phase-execute.md
# This should NOT have @./UAT-template.md as a bare reference in the template section
grep -c "@./UAT-template.md" skills/kata-verify-work/references/verify-work.md
```
  </verify>
  <done>Four orchestrator skills resolve templates via resolve-template.sh before spawning subagents. Project template overrides at .planning/templates/{name}.md take precedence over plugin defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Create kata-template-drift.js session-start hook and register in hooks.json</name>
  <files>hooks/kata-template-drift.js, hooks/hooks.json</files>
  <action>
**Create hooks/kata-template-drift.js:**

Node.js session-start hook following the same pattern as `kata-setup-statusline.js`:
- Read JSON from stdin (SessionStart hook input with `cwd` field)
- Wrap all logic in try/catch with empty catch (silent failure)
- Use `import` syntax (ESM, matching existing hooks)

**Hook logic:**
1. Get `cwd` from stdin JSON. Get `CLAUDE_PLUGIN_ROOT` from env.
2. Check if `.planning/templates/` directory exists in cwd. If not, exit 0 silently (no overrides, no drift to check).
3. For each `.md` file in `.planning/templates/`:
   a. Find the corresponding plugin default by globbing `${PLUGIN_ROOT}/skills/kata-*/references/${filename}`
   b. Read the plugin default and parse its `<!-- kata-template-schema ... -->` comment
   c. Extract `required-fields.frontmatter` and `required-fields.body` arrays
   d. Read the project override file content
   e. For frontmatter required fields: check if each field name appears in the override's YAML frontmatter section (between `---` delimiters)
   f. For body required fields: check if each section name appears as a markdown heading or XML tag in the override content
   g. Collect missing fields
4. For each template with missing fields, emit one warning line to stdout:
   `[kata] Template drift: {filename} missing required field(s): {comma-separated fields}. Run resolve-template.sh for defaults.`
5. Emit nothing if no drift detected. At most one line per drifted template.

**Schema comment parsing (regex, not YAML parser):**
```javascript
function parseSchemaComment(content) {
  const match = content.match(/<!--\s*kata-template-schema\n([\s\S]*?)-->/);
  if (!match) return null;
  const schema = match[1];
  const required = { frontmatter: [], body: [] };

  // Match frontmatter required fields
  const fmSection = schema.match(/required-fields:\s*\n\s*frontmatter:\s*\[([^\]]*)\]/);
  if (fmSection) {
    required.frontmatter = fmSection[1].split(',').map(f => f.trim()).filter(Boolean);
  }

  // Match body required fields
  const bodySection = schema.match(/body:\s*\[([^\]]*)\]/);
  if (bodySection) {
    required.body = bodySection[1].split(',').map(f => f.trim()).filter(Boolean);
  }

  return required;
}
```

**Field presence checking:**
- Frontmatter: Parse content between first `---` pair, check if field name appears as a key
- Body: Check if section name appears anywhere in the content after the frontmatter (as heading, XML tag, or text)

**Update hooks/hooks.json:**
Add the drift detection hook as a second entry in the SessionStart hooks array:

```json
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          { "type": "command", "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/kata-setup-statusline.js" },
          { "type": "command", "command": "node ${CLAUDE_PLUGIN_ROOT}/hooks/kata-template-drift.js" }
        ]
      }
    ]
  }
}
```

Keep the existing description field in hooks.json.
  </action>
  <verify>
```bash
# Verify hook file exists and has correct structure
test -f hooks/kata-template-drift.js && echo "hook: EXISTS" || echo "hook: MISSING"
grep -c "kata-template-schema" hooks/kata-template-drift.js

# Verify hooks.json has both hooks
grep -c "kata-template-drift" hooks/hooks.json
grep -c "kata-setup-statusline" hooks/hooks.json

# Test hook with no .planning/templates/ (should emit nothing)
echo '{"cwd":"'"$(pwd)"'"}' | CLAUDE_PLUGIN_ROOT="$(pwd)" node hooks/kata-template-drift.js

# Test hook with a project override missing fields
mkdir -p .planning/templates
echo "# My Override" > .planning/templates/summary-template.md
echo '{"cwd":"'"$(pwd)"'"}' | CLAUDE_PLUGIN_ROOT="$(pwd)" node hooks/kata-template-drift.js
rm .planning/templates/summary-template.md
rmdir .planning/templates 2>/dev/null || true
```
  </verify>
  <done>kata-template-drift.js detects missing required fields in project template overrides and emits per-template warning lines. hooks.json registers the hook alongside the existing statusline hook. Hook is silent when no overrides exist or when all required fields are present.</done>
</task>

</tasks>

<verification>
- Project override at `.planning/templates/summary-template.md` causes kata-execute-phase to resolve it instead of plugin default
- Session-start hook warns when a project override is missing required fields from the schema comment
- Hook emits nothing when no `.planning/templates/` exists
- Hook emits nothing when all fields are present
- All four orchestrator skills contain resolve-template.sh calls
- hooks.json has both SessionStart hooks registered
</verification>

<success_criteria>
- TMPL-02: Template resolution checks .planning/templates/{name}.md first, falls back to plugin default
- TMPL-04: Session-start hook detects drift and emits warnings for missing required fields
- Skills that use templates resolve project-override-first, plugin-default-second
</success_criteria>

<output>
After completion, create `.planning/phases/38-template-overrides/38-02-SUMMARY.md`
</output>
