---
phase: 48-test-coverage-of-new-functionality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/scripts/setup-worktrees.test.js
  - tests/scripts/create-phase-branch.test.js
autonomous: true
must_haves:
  truths:
    - "setup-worktrees.sh tests cover: precondition checks (pr_workflow, git repo, clean tree, idempotency) with correct exit codes"
    - "create-phase-branch.sh tests cover: branch creation, branch type inference, idempotent resume, key=value output format, milestone extraction"
    - "All tests use real git repos created in tmpDir — no mocking"
  artifacts:
    - path: "tests/scripts/setup-worktrees.test.js"
      provides: "Script tests for setup-worktrees.sh preconditions and conversion"
    - path: "tests/scripts/create-phase-branch.test.js"
      provides: "Script tests for create-phase-branch.sh"
  key_links:
    - from: "tests/scripts/setup-worktrees.test.js"
      to: "dist/plugin/skills/kata-configure-settings/scripts/setup-worktrees.sh"
      via: "execSync invocation of built artifact"
    - from: "tests/scripts/create-phase-branch.test.js"
      to: "dist/plugin/skills/kata-execute-phase/scripts/create-phase-branch.sh"
      via: "execSync invocation of built artifact"
---

<objective>
Write fast script tests for `setup-worktrees.sh` and `create-phase-branch.sh`. Both require real git repos as fixtures. Tests validate precondition checks, exit codes, and key=value output.

Purpose: Cover the 2 git-dependent scripts that don't require GitHub API access.
Output: Two test files using temporary git repos.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing test pattern
@tests/scripts/template-system.test.js

# Scripts under test
@skills/kata-configure-settings/scripts/setup-worktrees.sh
@skills/kata-execute-phase/scripts/create-phase-branch.sh

# Dependency: setup-worktrees.sh calls read-config.sh
@skills/kata-configure-settings/scripts/read-config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tests for setup-worktrees.sh</name>
  <files>tests/scripts/setup-worktrees.test.js</files>
  <action>
Create `tests/scripts/setup-worktrees.test.js`.

Setup helper: `createGitRepo(dir)` — runs `git init`, `git commit --allow-empty -m "init"` in tmpDir. Also creates `.planning/config.json` with `{"pr_workflow": "true"}` and copies built skills.

Test cases (precondition checks — fast, no destructive conversion):
1. Exits 1 when pr_workflow is false — config has `"pr_workflow": "false"`, assert exit 1, stderr contains "pr_workflow"
2. Exits 1 when not a git repo — no `git init`, assert exit 1, stderr contains "Not a git repository"
3. Exits 1 when working tree is dirty — create untracked file, assert exit 1, stderr contains "uncommitted changes"
4. Exits 0 (idempotent) when .bare already exists — `mkdir .bare`, assert exit 0, stdout contains "Already converted"
5. Full conversion works — valid preconditions, run script, assert: `.bare/` exists, `.git` is a file (not directory) containing "gitdir: .bare", `main/` directory exists

For test 5 (full conversion), the script runs `git clone --bare . .bare`, then removes `.git` dir, creates `.git` pointer file, and runs `git worktree add main main`. This is a real git operation. Verify post-conditions:
- `.bare` is a directory
- `.git` is a file (not dir) with content "gitdir: .bare"
- `main/` exists and contains the repo files

Important: Set `GIT_CONFIG_GLOBAL` and `GIT_AUTHOR_NAME` / `GIT_AUTHOR_EMAIL` / `GIT_COMMITTER_NAME` / `GIT_COMMITTER_EMAIL` env vars for git operations in test to avoid needing global git config.
  </action>
  <verify>node --test tests/scripts/setup-worktrees.test.js</verify>
  <done>All 5 test cases pass. Tests run in under 10 seconds.</done>
</task>

<task type="auto">
  <name>Task 2: Tests for create-phase-branch.sh</name>
  <files>tests/scripts/create-phase-branch.test.js</files>
  <action>
Create `tests/scripts/create-phase-branch.test.js`.

Setup helper: `createGitRepoWithRoadmap(dir, phaseGoal)` — runs `git init`, creates `.planning/ROADMAP.md` with milestone and phase entries, commits, copies built skills.

ROADMAP.md fixture (minimal):
```markdown
## Current Milestone: v1.10.0

#### Phase 5: Auth System
- Goal: Build authentication endpoints
```

Test cases:
1. Creates branch with correct name format — run with `phase-dir=.planning/phases/pending/05-auth`, assert output contains `BRANCH=feat/v1.10.0-05-auth`
2. Infers `fix` branch type — ROADMAP goal contains "fix login bug", assert `BRANCH_TYPE=fix`
3. Infers `docs` branch type — ROADMAP goal contains "document API", assert `BRANCH_TYPE=docs`
4. Infers `refactor` branch type — ROADMAP goal contains "refactor auth module", assert `BRANCH_TYPE=refactor`
5. Defaults to `feat` branch type — ROADMAP goal is "Build authentication", assert `BRANCH_TYPE=feat`
6. Idempotent: resumes on existing branch — run twice, second run succeeds with same output, stderr contains "exists, resuming"
7. Outputs all 5 key=value pairs — parse output, verify BRANCH, BRANCH_TYPE, MILESTONE, PHASE_NUM, SLUG are all present

For branch type tests, create separate ROADMAP fixtures with different Goal: lines. Each test can write its own ROADMAP, commit it (or just write it — script reads from filesystem, git status doesn't matter for grep).

Actually: the script reads ROADMAP.md via grep, not via git. So the file just needs to exist in the working directory. BUT `git checkout -b` requires a git repo. So: init repo, make initial commit, write ROADMAP.md (doesn't need to be committed), create the phase-dir, run script.

Set git env vars for test isolation (same as Task 1).
  </action>
  <verify>node --test tests/scripts/create-phase-branch.test.js</verify>
  <done>All 7 test cases pass. Tests run in under 10 seconds.</done>
</task>

</tasks>

<verification>
```bash
node --test tests/scripts/setup-worktrees.test.js tests/scripts/create-phase-branch.test.js
```
Both files run, all tests pass. Git repos created and cleaned up in tmpDir.
</verification>

<success_criteria>
- setup-worktrees.test.js covers all 4 precondition failures + full conversion
- create-phase-branch.test.js covers branch naming, all branch type inference paths, idempotency, output format
- Tests use real git repos (no mocking) but complete in under 10 seconds
- No GitHub API calls, no network access
</success_criteria>

<output>
After completion, create `.planning/phases/48-test-coverage-of-new-functionality/48-02-SUMMARY.md`
</output>
