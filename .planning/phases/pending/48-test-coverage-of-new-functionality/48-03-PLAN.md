---
phase: 48-test-coverage-of-new-functionality
plan: 03
type: execute
wave: 2
depends_on: [1, 2]
files_modified:
  - tests/scripts/manage-worktree.test.js
  - package.json
autonomous: true
must_haves:
  truths:
    - "manage-worktree.sh tests cover: precondition checks, create/list subcommands, unknown subcommand error, usage output"
    - "test:scripts npm script runs all test files in tests/scripts/"
    - "npm run test:scripts passes with all new test files included"
    - "create-draft-pr.sh is explicitly excluded from testing with documented rationale (requires gh CLI + GitHub remote)"
  artifacts:
    - path: "tests/scripts/manage-worktree.test.js"
      provides: "Script tests for manage-worktree.sh"
    - path: "package.json"
      provides: "Updated test:scripts command to glob all tests/scripts/*.test.js"
  key_links:
    - from: "tests/scripts/manage-worktree.test.js"
      to: "dist/plugin/skills/kata-configure-settings/scripts/setup-worktrees.sh"
      via: "Uses setup-worktrees.sh to create bare repo fixture"
    - from: "package.json test:scripts"
      to: "tests/scripts/*.test.js"
      via: "Glob pattern runs all script test files"
---

<objective>
Write tests for `manage-worktree.sh` (create/list subcommands + preconditions). Update `package.json` to run all script tests via glob. Verify `npm run test:scripts` passes end-to-end.

Purpose: Complete test coverage for all testable scripts and wire up the test runner.
Output: One test file + updated package.json.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing test pattern
@tests/scripts/template-system.test.js

# Script under test
@skills/kata-execute-phase/scripts/manage-worktree.sh

# Dependencies (manage-worktree.sh calls read-config.sh)
@skills/kata-configure-settings/scripts/read-config.sh
@skills/kata-configure-settings/scripts/setup-worktrees.sh

# Package.json (needs test:scripts update)
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tests for manage-worktree.sh</name>
  <files>tests/scripts/manage-worktree.test.js</files>
  <action>
Create `tests/scripts/manage-worktree.test.js`.

Setup helper: `createBareRepo(dir)` — runs `git init`, creates `.planning/config.json` with `{"pr_workflow":"true","worktree":{"enabled":"true"}}`, commits, copies built skills, then runs `setup-worktrees.sh` to convert to bare layout. After this, cwd should be the project root (which now has `.bare/`, `.git` pointer, and `main/`).

**Important:** After `setup-worktrees.sh` runs, the working directory structure changes. The script removes non-essential files from root and moves them to `main/`. The `.planning/config.json` will be inside `main/`. When running `manage-worktree.sh`, set cwd to the project root where `.bare/` is. The script reads config via `read-config.sh` which reads `.planning/config.json` — but after conversion, that file is in `main/`. You may need to also create `.planning/config.json` at the project root, or set cwd to `main/` for config reads. Test this carefully.

**Alternative approach if config path is problematic:** Create a minimal bare repo manually:
1. `git init`, commit, then: `git clone --bare . .bare`, `rm -rf .git`, `echo "gitdir: .bare" > .git`, `GIT_DIR=.bare git worktree add main main`
2. Write `.planning/config.json` at project root (for read-config.sh to find)

Test cases:

**Precondition tests (fast):**
1. Exits 1 when .bare directory missing — no bare setup, assert exit 1, stderr contains "Bare repo layout required"
2. Exits 1 when worktree.enabled is false — create .bare dir but config says false, assert exit 1
3. Exits 1 with unknown subcommand — `manage-worktree.sh badcmd`, assert exit 1, stderr contains "Unknown subcommand"
4. Shows usage when no subcommand — `manage-worktree.sh` with no args, assert exit 1, stdout contains "Usage"

**Create subcommand tests:**
5. Creates worktree for a plan — `manage-worktree.sh create 48 01`, assert output contains `WORKTREE_PATH=plan-48-01`, `WORKTREE_BRANCH=plan/48-01`, `STATUS=created`. Verify `plan-48-01/` directory exists.
6. Idempotent create — run create twice, second returns `STATUS=exists`

**List subcommand tests:**
7. Lists created worktrees — after creating one, `manage-worktree.sh list`, assert `WORKTREE_COUNT=1` and output contains `plan-48-01`
8. Empty list — no plan worktrees created, assert `WORKTREE_COUNT=0`

Skip `merge` subcommand testing — it involves checkout/merge operations that are slow and fragile in temp repos. The create + list coverage is sufficient for CI.

Set git env vars for test isolation. Use `before()` to ensure plugin is built.
  </action>
  <verify>node --test tests/scripts/manage-worktree.test.js</verify>
  <done>All 8 test cases pass. Tests run in under 15 seconds.</done>
</task>

<task type="auto">
  <name>Task 2: Wire up test:scripts and verify full suite</name>
  <files>package.json</files>
  <action>
Update `package.json` `test:scripts` command to use a glob pattern that picks up all test files in `tests/scripts/`:

Before: `"test:scripts": "node --test --test-reporter spec ./tests/scripts/template-system.test.js"`
After: `"test:scripts": "node --test --test-reporter spec ./tests/scripts/*.test.js"`

This ensures any new test file added to `tests/scripts/` is automatically included.

Also update `test:all` to use the same glob instead of listing individual files:

Before: `"test:all": "node --test --test-reporter spec ./tests/build.test.js ./tests/smoke.test.js ./tests/artifact-validation.test.js ./tests/scripts/template-system.test.js"`
After: `"test:all": "node --test --test-reporter spec ./tests/build.test.js ./tests/smoke.test.js ./tests/artifact-validation.test.js ./tests/scripts/*.test.js"`

After updating, run `npm run test:scripts` and verify all test files execute and pass.

Do NOT modify `test:affected` — it has its own detection logic.
  </action>
  <verify>npm run test:scripts</verify>
  <done>npm run test:scripts runs all files in tests/scripts/*.test.js and all pass. create-draft-pr.sh is intentionally excluded (requires gh CLI + GitHub API).</done>
</task>

</tasks>

<verification>
```bash
# Full script test suite
npm run test:scripts

# Verify glob picks up all files
node --test --test-reporter spec ./tests/scripts/*.test.js 2>&1 | tail -5
```
All test files discovered and executed. All tests pass. Total time under 30 seconds.
</verification>

<success_criteria>
- manage-worktree.test.js covers preconditions (4 tests), create (2 tests), list (2 tests)
- test:scripts uses glob pattern ./tests/scripts/*.test.js
- npm run test:scripts passes end-to-end with all 5 test files
- create-draft-pr.sh excluded from testing (documented: requires gh CLI + GitHub remote)
</success_criteria>

<output>
After completion, create `.planning/phases/48-test-coverage-of-new-functionality/48-03-SUMMARY.md`
</output>
