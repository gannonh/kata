---
phase: 44-config-foundation
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - skills/kata-configure-settings/scripts/setup-worktrees.sh
  - skills/kata-new-project/SKILL.md
  - skills/kata-configure-settings/SKILL.md
autonomous: true

must_haves:
  truths:
    - "setup-worktrees.sh converts repo to bare repo + worktree layout (.bare/ directory, .git pointer file, main/ worktree)"
    - "setup-worktrees.sh validates preconditions before acting (pr_workflow true, git repo, clean tree, not already converted)"
    - "setup-worktrees.sh creates .bare/ via git clone --bare, replaces .git with pointer file, adds main/ worktree"
    - "kata-new-project Phase 5 asks worktree question when pr_workflow is true"
    - "kata-new-project skips worktree question when pr_workflow is false"
    - "kata-configure-settings Section B includes worktree toggle"
    - "Toggling worktree on in configure-settings calls setup-worktrees.sh"
  artifacts:
    - skills/kata-configure-settings/scripts/setup-worktrees.sh
    - skills/kata-new-project/SKILL.md
    - skills/kata-configure-settings/SKILL.md
  key_links:
    - "setup-worktrees.sh writes worktree.enabled via set-config.sh from within main/ worktree"
    - "kata-new-project worktree question gated on pr_workflow selection"
    - "kata-configure-settings worktree toggle gated on pr_workflow config value"
---

<objective>
Create the worktree setup script and integrate worktree configuration into both the new-project onboarding flow and the settings skill.

Purpose: Users need three paths to enable worktrees: (1) during new project setup, (2) retroactively via settings, (3) the underlying script that converts the repo to a bare repo + worktree layout. This plan delivers all three.
Output: setup-worktrees.sh script, updated kata-new-project SKILL.md, updated kata-configure-settings SKILL.md.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/44-config-foundation/44-01-SUMMARY.md
@skills/kata-configure-settings/scripts/set-config.sh
@skills/kata-configure-settings/scripts/read-config.sh
@skills/kata-new-project/SKILL.md
@skills/kata-configure-settings/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup-worktrees.sh validation and setup script</name>
  <files>skills/kata-configure-settings/scripts/setup-worktrees.sh</files>
  <action>
Create `setup-worktrees.sh` that converts the repo to the bare repo + worktree layout. This is a one-time conversion that restructures the repo so Phase 45's `manage-worktree.sh` can create plan worktrees as sibling directories.

Target layout after conversion:
```
<project>/
  .bare/          # bare git repo (shared object store)
  .git            # text file containing "gitdir: .bare"
  main/           # worktree for main branch (working files move here)
```

Script requirements:
- `set -euo pipefail`
- `SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"` for sibling script resolution
- Validate preconditions in this order (exit 1 with descriptive message on failure):
  1. `pr_workflow` must be `true` in config: `bash "$SCRIPT_DIR/read-config.sh" "pr_workflow" "false"` — check FIRST because worktrees require PR workflow
  2. Must be in a git repo: `git rev-parse --git-dir > /dev/null 2>&1`
  3. Must have clean working tree: `[ -z "$(git status --porcelain)" ]`
  4. Must NOT already be converted: `[ ! -d .bare ]` — if `.bare/` exists, already done
- Conversion steps (only reached if all validations pass):
  1. `git clone --bare . .bare` — create bare clone with full history
  2. `rm -rf .git` — remove original git directory
  3. `echo "gitdir: .bare" > .git` — create pointer file so git commands still work from project root
  4. Configure bare repo for worktree tracking: ensure `.bare/config` has `[core] bare = true` (it should from the clone)
  5. Add `main/` worktree: `GIT_DIR=.bare git worktree add main main` — creates main/ with the main branch checked out
  6. Move working files into `main/` worktree: the files currently in the repo root (except `.bare/`, `.git`, `main/`, and any dotfiles that are part of the bare structure) need to be in `main/`. Since `git worktree add` checks out the branch content, the files are already there. Remove the duplicate working files from the project root (they now live in `main/`).
  7. Add `.bare` and `main/` to project root `.gitignore` if not already present (these are local structure, not committed)
  8. Set `worktree.enabled: true` via `bash "$SCRIPT_DIR/set-config.sh" "worktree.enabled" "true"` — note: this now operates from within the `main/` worktree context or project root
  9. Print success message: "Bare repo + worktree layout created. Working files are in main/. Plan worktrees will be created as sibling directories."
- Make executable: `chmod +x`

Safety notes:
- `.bare/` contains full git history. If conversion fails partway, user can recover by restoring `.git` from `.bare/`.
- The script should trap errors and print recovery instructions if any step after `.git` removal fails.
  </action>
  <verify>
# Script exists and is executable
ls -la skills/kata-configure-settings/scripts/setup-worktrees.sh

# Validates pr_workflow first
grep -n "pr_workflow\|read-config" skills/kata-configure-settings/scripts/setup-worktrees.sh

# Uses bare repo conversion
grep -n "bare\|clone\|gitdir" skills/kata-configure-settings/scripts/setup-worktrees.sh

# Creates main worktree
grep -n "worktree add.*main" skills/kata-configure-settings/scripts/setup-worktrees.sh

# Check that set-config.sh call uses relative path
grep "set-config.sh" skills/kata-configure-settings/scripts/setup-worktrees.sh
  </verify>
  <done>setup-worktrees.sh exists, validates preconditions (pr_workflow first, then git repo, clean tree, no existing .bare/), converts to bare repo layout (.bare/ dir, .git pointer file, main/ worktree), sets worktree.enabled via set-config.sh.</done>
</task>

<task type="auto">
  <name>Task 2: Add worktree question to kata-new-project onboarding</name>
  <files>skills/kata-new-project/SKILL.md</files>
  <action>
Add a 6th question to Phase 5 of kata-new-project, conditional on the user selecting PR workflow = Yes.

Insert AFTER the GitHub Tracking question block (question 5) and BEFORE the `# If GitHub Tracking = Yes` follow-up section:

```
# If PR Workflow = Yes, ask about worktrees:
{
  header: "Git Worktrees",
  question: "Use git worktrees for plan isolation? (each plan agent gets its own branch and working directory)",
  multiSelect: false,
  options: [
    { label: "No (Recommended)", description: "Plans share the working directory (standard git workflow)" },
    { label: "Yes", description: "Each plan gets an isolated worktree and branch (advanced)" }
  ]
}
```

If the user selected PR Workflow = No, skip this question entirely (worktrees require PR workflow).

In the config.json creation block, add the worktree key conditionally:
- If PR Workflow = Yes AND Worktrees = Yes: add `"worktree": { "enabled": true }` to config
- If PR Workflow = Yes AND Worktrees = No: add `"worktree": { "enabled": false }` to config
- If PR Workflow = No: do NOT add worktree key to config (absence = disabled)

If Worktrees = Yes, call setup-worktrees.sh AFTER config.json is written (because the script reads pr_workflow from config):
- Location: Insert the call in the "Write config.json" step of Phase 5, after the `set-config.sh` calls that write pr_workflow and other settings
- Command: `bash "skills/kata-configure-settings/scripts/setup-worktrees.sh"`
- Error handling: If setup-worktrees.sh exits non-zero, print the error and set `worktree.enabled` back to `false` via `bash "skills/kata-configure-settings/scripts/set-config.sh" "worktree.enabled" "false"`. Do NOT abort the entire project setup — worktree failure is non-fatal.

Do NOT restructure existing Phase 5 content. Insert the new question block, conditional config handling, and setup call surgically.
  </action>
  <verify>
grep -n "worktree" skills/kata-new-project/SKILL.md
grep -n "Git Worktrees" skills/kata-new-project/SKILL.md
  </verify>
  <done>kata-new-project Phase 5 asks worktree question when PR workflow enabled, skips when disabled. Config.json includes worktree.enabled based on answer. Setup script called when enabled.</done>
</task>

<task type="auto">
  <name>Task 3: Add worktree toggle to kata-configure-settings</name>
  <files>skills/kata-configure-settings/SKILL.md</files>
  <action>
Add worktree toggle to Section B (Session Settings) of kata-configure-settings.

1. In Step 2 (Read Current Values), add:
```bash
WORKTREE_ENABLED=$(bash "$SCRIPT_DIR/read-pref.sh" "worktree.enabled" "false")
PR_WORKFLOW_VAL=$(bash "$SCRIPT_DIR/read-pref.sh" "pr_workflow" "false")
```

2. In Section B AskUserQuestion, conditionally include a worktree question AFTER the PR Workflow question. The conditional logic:
   - Read `PR_WORKFLOW_VAL` in Step 2 (already added above)
   - If `PR_WORKFLOW_VAL = "true"`, include this question in the AskUserQuestion block:
     ```
     {
       question: "Enable git worktree isolation per plan?",
       header: "Git Worktrees",
       multiSelect: false,
       options: [
         { label: "No", description: "Plans share the working directory (standard)" },
         { label: "Yes", description: "Each plan gets isolated worktree and branch (advanced)" }
       ]
     }
     ```
   - If `PR_WORKFLOW_VAL = "false"`, OMIT this question entirely from the AskUserQuestion block (do not show it, do not change worktree.enabled). Add a comment in the SKILL.md like: `<!-- If pr_workflow is false, skip Git Worktrees question — worktrees require PR workflow -->`

3. In Step 4 (Write Updates), add to the Session Settings block:
```bash
bash "$SCRIPT_DIR/set-config.sh" "worktree.enabled" "$NEW_WORKTREE_ENABLED"
```

4. Add side-effect: If worktree was just enabled (changed from false to true):
```bash
# Run setup after writing the config
if ! bash "$SCRIPT_DIR/setup-worktrees.sh"; then
  echo "Error: Worktree setup failed. Reverting worktree.enabled to false."
  bash "$SCRIPT_DIR/set-config.sh" "worktree.enabled" "false"
fi
```
The explicit exit code check ensures that on setup failure, worktree.enabled is reverted to false via set-config.sh and an error message is shown. The settings flow continues (non-fatal).

5. In Step 5 (Confirm Changes), add row to Session Settings table:
```
| Git Worktrees      | {On/Off}                  |
```

Do NOT restructure existing AskUserQuestion blocks or reorder questions. Insert the worktree question and write logic surgically.
  </action>
  <verify>
grep -n "worktree" skills/kata-configure-settings/SKILL.md
grep -n "Git Worktrees" skills/kata-configure-settings/SKILL.md
grep -n "setup-worktrees" skills/kata-configure-settings/SKILL.md
  </verify>
  <done>kata-configure-settings Section B includes worktree toggle (conditional on pr_workflow). Enabling triggers setup-worktrees.sh. Confirmation table shows worktree state.</done>
</task>

</tasks>

<verification>
```bash
# All commands run from repo root

# Setup script exists and is executable
ls -la skills/kata-configure-settings/scripts/setup-worktrees.sh

# New project asks about worktrees
grep -c "worktree" skills/kata-new-project/SKILL.md

# Settings skill has worktree toggle
grep -c "worktree" skills/kata-configure-settings/SKILL.md

# Setup script implements bare repo conversion
grep -n "clone --bare\|gitdir.*bare\|worktree add.*main" skills/kata-configure-settings/scripts/setup-worktrees.sh

# Setup script checks for .bare/ directory (not .worktrees/)
grep -n "\.bare" skills/kata-configure-settings/scripts/setup-worktrees.sh

# Setup script references set-config.sh with relative path
grep "SCRIPT_DIR.*set-config.sh" skills/kata-configure-settings/scripts/setup-worktrees.sh

# Build succeeds
npm run build:plugin && npm test
```
</verification>

<success_criteria>
- [ ] setup-worktrees.sh created with precondition validation (pr_workflow first), bare repo conversion (.bare/, .git pointer, main/ worktree)
- [ ] kata-new-project Phase 5 asks worktree question (conditional on pr_workflow: true)
- [ ] kata-new-project skips worktree question when pr_workflow: false
- [ ] kata-configure-settings Section B has worktree toggle (conditional on pr_workflow)
- [ ] Enabling worktrees triggers setup-worktrees.sh
- [ ] Config.json updated with worktree.enabled via set-config.sh in all paths
- [ ] No existing behavior broken in either skill
</success_criteria>

<output>
After completion, create `.planning/phases/pending/44-config-foundation/44-02-SUMMARY.md`
</output>
