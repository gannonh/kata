---
phase: 53-worktree-safe-pr-merge
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-execute-phase/SKILL.md
  - skills/kata-review-pull-requests/SKILL.md
autonomous: true
gap_closure: true
source_issue: ".planning/v1.11.0-MILESTONE-AUDIT.md"

must_haves:
  truths:
    - kata-execute-phase offer_next Routes A and B show worktree-safe merge suggestion instead of --delete-branch
    - kata-review-pull-requests post-review merge uses worktree-safe pattern when WORKTREE_ENABLED=true
    - kata-review-pull-requests post-review merge uses standard pattern when WORKTREE_ENABLED=false
    - No occurrences of "--delete-branch" remain in either file
  artifacts:
    - skills/kata-execute-phase/SKILL.md
    - skills/kata-review-pull-requests/SKILL.md
  key_links:
    - kata-execute-phase already reads WORKTREE_ENABLED (line 73)
    - kata-review-pull-requests reads WORKTREE_ENABLED config for merge conditioning
    - Worktree-safe path calls manage-worktree.sh cleanup-phase
---

<objective>
Replace broken `--delete-branch` merge pattern in kata-execute-phase (2 display-text locations) and kata-review-pull-requests (1 executable location).

Purpose: The offer_next suggestions in kata-execute-phase give users a broken copy/paste command. The post-review merge in kata-review-pull-requests executes the broken pattern directly.

Output: Updated SKILL.md files with worktree-conditional merge patterns.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.11.0-MILESTONE-AUDIT.md

@skills/kata-execute-phase/SKILL.md
@skills/kata-review-pull-requests/SKILL.md
@skills/kata-execute-phase/scripts/manage-worktree.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix kata-execute-phase offer_next merge suggestions (2 locations)</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Two changes in the offer_next section. These are display-only suggestions, not executable code blocks. The skill already reads WORKTREE_ENABLED at line 73.

**1a. Replace Route A "Also available" merge suggestion (around line 563).**

Current text:
```
  - {If PR_WORKFLOW: `gh pr merge --merge --delete-branch` — merge PR directly}
```

Replace with:
```
  - {If PR_WORKFLOW and WORKTREE_ENABLED: `gh pr merge --merge` then `git -C main pull` and `bash skills/kata-execute-phase/scripts/manage-worktree.sh cleanup-phase workspace $PHASE_BRANCH` — merge PR (worktree-safe)}
  - {If PR_WORKFLOW and not WORKTREE_ENABLED: `gh pr merge --merge --delete-branch` then `git checkout main && git pull` — merge PR directly}
```

**1b. Replace Route B "Also available" merge suggestion (around line 598).**

Current text:
```
  - {If PR_WORKFLOW: `gh pr merge --merge --delete-branch` — merge PR directly}
```

Replace with identical conditional text as 1a above.

**Important:** These are suggestions shown to the user, not executed code. The conditional `{If ...}` syntax matches the existing pattern used throughout offer_next (e.g., line 261-262 pattern in kata-verify-work). Only one branch will display based on WORKTREE_ENABLED.
  </action>
  <verify>
```bash
# No --delete-branch in offer_next Routes A/B (check lines 560-600)
# The file may still have --delete-branch in the non-worktree branch of the conditional
grep -n "delete-branch" skills/kata-execute-phase/SKILL.md
# Should show only the "not WORKTREE_ENABLED" conditional lines

# cleanup-phase referenced in offer_next
grep -n "cleanup-phase" skills/kata-execute-phase/SKILL.md
# Should show the offer_next suggestions plus the existing line 517
```
  </verify>
  <done>kata-execute-phase offer_next Routes A and B show worktree-conditional merge suggestions. Worktree-enabled projects see the safe pattern; non-worktree projects see the standard pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Fix kata-review-pull-requests merge pattern (1 location)</name>
  <files>skills/kata-review-pull-requests/SKILL.md</files>
  <action>
Two changes needed in this file:

**2a. Add WORKTREE_ENABLED config read.**

Near line 79 where MODEL_PROFILE is read, add a second config read:
```bash
WORKTREE_ENABLED=$(bash "../kata-configure-settings/scripts/read-config.sh" "worktree.enabled" "false")
```

Place it immediately after the MODEL_PROFILE read so both config values are available.

**2b. Replace post-review merge block (around lines 275-278).**

Current text:
```
**If user chose "Merge PR":**

```bash
gh pr merge "$PR_NUMBER" --merge --delete-branch
git checkout main && git pull
```
```

Replace with:
```
**If user chose "Merge PR":**

```bash
gh pr merge "$PR_NUMBER" --merge
```

Then update local state:

```bash
if [ "$WORKTREE_ENABLED" = "true" ]; then
  # Bare repo layout: update main/ worktree, reset workspace/ to workspace-base
  git -C main pull
  bash "skills/kata-execute-phase/scripts/manage-worktree.sh" cleanup-phase workspace "$PHASE_BRANCH"
else
  git checkout main && git pull
fi
```
```

**Important:** Do NOT change any surrounding text (the AskUserQuestion, the display output, the "Next Up" section). Only replace the merge code blocks and add the config read.
  </action>
  <verify>
```bash
# No --delete-branch remaining
grep -c "delete-branch" skills/kata-review-pull-requests/SKILL.md
# Should return 0

# WORKTREE_ENABLED config read present
grep -c "worktree.enabled" skills/kata-review-pull-requests/SKILL.md
# Should return 1

# cleanup-phase referenced
grep -c "cleanup-phase" skills/kata-review-pull-requests/SKILL.md
# Should return 1

# git -C main pull referenced
grep -c "git -C main pull" skills/kata-review-pull-requests/SKILL.md
# Should return 1
```
  </verify>
  <done>kata-review-pull-requests SKILL.md has 0 occurrences of --delete-branch, reads WORKTREE_ENABLED config, and uses worktree-conditional merge with cleanup-phase.</done>
</task>

</tasks>

<verification>
```bash
# Across both files, check --delete-branch usage
grep -rn "delete-branch" skills/kata-execute-phase/SKILL.md skills/kata-review-pull-requests/SKILL.md
# kata-execute-phase: should only appear in non-worktree conditional branches
# kata-review-pull-requests: should return nothing

# Both files reference worktree-safe pattern
grep -l "cleanup-phase" skills/kata-execute-phase/SKILL.md skills/kata-review-pull-requests/SKILL.md
# Should return both files

# Full codebase scan for unconditional --delete-branch
grep -rn "delete-branch" skills/*/SKILL.md | grep -v "not WORKTREE_ENABLED" | grep -v "WORKTREE_ENABLED=false"
# Should return nothing (all remaining occurrences are in non-worktree conditional branches)
```
</verification>

<success_criteria>
- 0 unconditional occurrences of `--delete-branch` across all 4 SKILL.md files
- kata-execute-phase offer_next shows worktree-conditional merge suggestions
- kata-review-pull-requests uses worktree-conditional merge with cleanup-phase
- WORKTREE_ENABLED config read added to kata-review-pull-requests
- All worktree-safe branches reference `git -C main pull` and `cleanup-phase`
</success_criteria>

<output>
After completion, create `.planning/phases/53-worktree-safe-pr-merge/53-02-SUMMARY.md`
</output>
