---
phase: 53-worktree-safe-pr-merge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-verify-work/SKILL.md
  - skills/kata-complete-milestone/SKILL.md
autonomous: true
gap_closure: true
source_issue: ".planning/v1.11.0-MILESTONE-AUDIT.md"

must_haves:
  truths:
    - kata-verify-work merge steps use worktree-safe pattern when WORKTREE_ENABLED=true
    - kata-verify-work merge steps use standard pattern when WORKTREE_ENABLED=false
    - kata-complete-milestone release PR merge uses worktree-safe pattern when WORKTREE_ENABLED=true
    - kata-complete-milestone release PR merge uses standard pattern when WORKTREE_ENABLED=false
    - No occurrences of "--delete-branch" remain in either file
    - No occurrences of "git checkout main" remain in merge sections of either file
  artifacts:
    - skills/kata-verify-work/SKILL.md
    - skills/kata-complete-milestone/SKILL.md
  key_links:
    - kata-verify-work reads WORKTREE_ENABLED config alongside PR_WORKFLOW
    - kata-complete-milestone already reads WORKTREE_ENABLED (line 47)
    - Worktree-safe path calls manage-worktree.sh cleanup-phase
---

<objective>
Replace broken `gh pr merge --merge --delete-branch` + `git checkout main && git pull` pattern with worktree-safe merge in kata-verify-work (2 locations) and kata-complete-milestone (1 location).

Purpose: PR merge fails in bare repo worktree layout because `--delete-branch` triggers `git checkout main`, which conflicts with the `main/` worktree. Post-merge cleanup (workspace reset, branch deletion) is not surfaced.

Output: Updated SKILL.md files with conditional worktree-safe merge pattern.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.11.0-MILESTONE-AUDIT.md

@skills/kata-verify-work/SKILL.md
@skills/kata-complete-milestone/SKILL.md
@skills/kata-execute-phase/scripts/manage-worktree.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix kata-verify-work merge pattern (2 locations)</name>
  <files>skills/kata-verify-work/SKILL.md</files>
  <action>
Two changes needed in this file:

**1a. Add WORKTREE_ENABLED config read.**

In step 7.5 (around line 84), after the PR_WORKFLOW config read:
```bash
PR_WORKFLOW=$(bash "../kata-configure-settings/scripts/read-config.sh" "pr_workflow" "false")
```

Add immediately after:
```bash
WORKTREE_ENABLED=$(bash "../kata-configure-settings/scripts/read-config.sh" "worktree.enabled" "false")
```

**1b. Replace Route A merge block (around line 244-247).**

Current text:
```
If user chose "Yes, merge now":

```bash
gh pr merge "$PR_NUMBER" --merge --delete-branch
git checkout main && git pull
```
```

Replace with:
```
If user chose "Yes, merge now":

```bash
gh pr merge "$PR_NUMBER" --merge
```

Then update local state:

```bash
if [ "$WORKTREE_ENABLED" = "true" ]; then
  # Bare repo layout: update main/ worktree, reset workspace/ to workspace-base
  git -C main pull
  bash "skills/kata-execute-phase/scripts/manage-worktree.sh" cleanup-phase workspace "$PHASE_BRANCH"
else
  git checkout main && git pull
fi
```
```

**1c. Replace Route B merge block (around line 304-307).**

Same replacement as 1b. Current text:
```
If user chose "Yes, merge now":

```bash
gh pr merge "$PR_NUMBER" --merge --delete-branch
git checkout main && git pull
```
```

Replace with identical worktree-conditional block as 1b above.

**Important:** Do NOT change any other text in Routes A or B. Only replace the merge code blocks and add the config read.
  </action>
  <verify>
Verify with grep:
```bash
# No --delete-branch remaining
grep -c "delete-branch" skills/kata-verify-work/SKILL.md
# Should return 0

# No "git checkout main" in merge sections
grep -c "git checkout main" skills/kata-verify-work/SKILL.md
# Should return 0

# WORKTREE_ENABLED config read present
grep -c "worktree.enabled" skills/kata-verify-work/SKILL.md
# Should return 1

# cleanup-phase referenced
grep -c "cleanup-phase" skills/kata-verify-work/SKILL.md
# Should return 2 (one per route)

# git -C main pull referenced
grep -c "git -C main pull" skills/kata-verify-work/SKILL.md
# Should return 2 (one per route)
```
  </verify>
  <done>kata-verify-work SKILL.md has 0 occurrences of --delete-branch, 0 occurrences of "git checkout main", reads WORKTREE_ENABLED config, and has worktree-conditional merge in both Route A and Route B.</done>
</task>

<task type="auto">
  <name>Task 2: Fix kata-complete-milestone merge pattern (1 location)</name>
  <files>skills/kata-complete-milestone/SKILL.md</files>
  <action>
One change needed in this file. The skill already reads WORKTREE_ENABLED at line 47, so no config read addition required.

**Replace release PR merge block (around lines 397-408).**

Current text:
```
**If "Yes, merge now":**

```bash
gh pr merge "$PR_NUMBER" --merge --delete-branch
```

Then return to main:

```bash
git checkout main
git pull
```
```

Replace with:
```
**If "Yes, merge now":**

```bash
gh pr merge "$PR_NUMBER" --merge
```

Then update local state:

```bash
if [ "$WORKTREE_ENABLED" = "true" ]; then
  # Bare repo layout: update main/ worktree, reset workspace/ to workspace-base
  git -C main pull
  bash "skills/kata-execute-phase/scripts/manage-worktree.sh" cleanup-phase workspace "$PHASE_BRANCH"
else
  git checkout main
  git pull
fi
```
```

**Note:** kata-complete-milestone uses a separate `git checkout main` and `git pull` (two lines, no &&). Preserve that style in the else branch.

**Important:** Do NOT change any other text. Only replace the merge + checkout blocks.
  </action>
  <verify>
Verify with grep:
```bash
# No --delete-branch remaining
grep -c "delete-branch" skills/kata-complete-milestone/SKILL.md
# Should return 0

# cleanup-phase referenced
grep -c "cleanup-phase" skills/kata-complete-milestone/SKILL.md
# Should return 1

# git -C main pull referenced
grep -c "git -C main pull" skills/kata-complete-milestone/SKILL.md
# Should return 1
```
  </verify>
  <done>kata-complete-milestone SKILL.md has 0 occurrences of --delete-branch, uses worktree-conditional merge with cleanup-phase in else branch for non-worktree mode.</done>
</task>

</tasks>

<verification>
```bash
# Across both files, no --delete-branch anywhere
grep -r "delete-branch" skills/kata-verify-work/SKILL.md skills/kata-complete-milestone/SKILL.md
# Should return nothing

# Both files reference the worktree-safe pattern
grep -l "cleanup-phase" skills/kata-verify-work/SKILL.md skills/kata-complete-milestone/SKILL.md
# Should return both files

# Both files reference git -C main pull
grep -l "git -C main pull" skills/kata-verify-work/SKILL.md skills/kata-complete-milestone/SKILL.md
# Should return both files
```
</verification>

<success_criteria>
- 0 occurrences of `--delete-branch` in kata-verify-work/SKILL.md
- 0 occurrences of `--delete-branch` in kata-complete-milestone/SKILL.md
- 0 occurrences of `git checkout main` in merge sections of kata-verify-work/SKILL.md
- Worktree-conditional merge in kata-verify-work Routes A and B
- Worktree-conditional merge in kata-complete-milestone release PR merge
- WORKTREE_ENABLED config read added to kata-verify-work step 7.5
- cleanup-phase referenced in all 3 worktree-safe branches
</success_criteria>

<output>
After completion, create `.planning/phases/53-worktree-safe-pr-merge/53-01-SUMMARY.md`
</output>
