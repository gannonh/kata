---
phase: 33-skills-sh-distribution
plan: 03
type: execute
wave: 3
depends_on: [33-01, 33-02]
files_modified:
  - .github/workflows/plugin-release.yml
autonomous: false
user_setup:
  - "Create gannonh/kata-skills GitHub repo (empty, public)"
  - "Create PAT with repo scope for kata-skills and add as KATA_SKILLS_TOKEN secret in kata repo"
source_issue: ""

must_haves:
  truths:
    - CI pipeline builds skills-sh target on release
    - CI pushes dist/skills-sh/ contents to gannonh/kata-skills repo
    - Push only happens when plugin version changes (same gate as marketplace)
    - PAT token used for cross-repo push (KATA_SKILLS_TOKEN secret)
  artifacts:
    - .github/workflows/plugin-release.yml (updated with skills-sh publish steps)
  key_links:
    - .github/workflows/plugin-release.yml (CI pipeline)
---

<objective>
Extend the CI/CD pipeline to publish skills to the gannonh/kata-skills repo on release.

Purpose: Automate the second distribution channel. When a new version is published to the Claude Code marketplace, the same release also pushes updated skills to the kata-skills repo for skills.sh distribution.

Output: Updated plugin-release.yml with skills-sh build and publish steps.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.github/workflows/plugin-release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skills-sh publish steps to CI pipeline</name>
  <files>.github/workflows/plugin-release.yml</files>
  <action>
Add the following steps to the `publish-plugin` job in `plugin-release.yml`, after the "Commit and push to marketplace" step. These steps mirror the marketplace publish pattern:

```yaml
      - name: Build skills-sh distribution
        if: steps.check.outputs.should_publish == 'true'
        run: node scripts/build.js skills-sh

      - name: Checkout kata-skills
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/checkout@v4
        with:
          repository: gannonh/kata-skills
          token: ${{ secrets.KATA_SKILLS_TOKEN }}
          path: kata-skills

      - name: Update kata-skills with built files
        if: steps.check.outputs.should_publish == 'true'
        run: |
          # Clean existing skills directory
          rm -rf kata-skills/skills

          # Copy built skills-sh output to kata-skills repo
          cp -r dist/skills-sh/skills kata-skills/skills
          cp dist/skills-sh/README.md kata-skills/README.md
          cp dist/skills-sh/LICENSE kata-skills/LICENSE

      - name: Commit and push to kata-skills
        if: steps.check.outputs.should_publish == 'true'
        working-directory: kata-skills
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: update kata skills to v${{ steps.version.outputs.plugin_version }}"
          git push
```

Key design decisions:
- Uses `KATA_SKILLS_TOKEN` secret (separate from `MARKETPLACE_TOKEN`) for cross-repo push
- Same version gate as marketplace (only pushes when version changes)
- Replaces entire skills/ directory (not incremental) to ensure clean state
- README.md and LICENSE generated by build, not maintained manually in kata-skills repo
  </action>
  <verify>
Review the modified workflow file for:
- Correct `if` conditions matching existing marketplace steps
- Correct token reference (`KATA_SKILLS_TOKEN`)
- Correct path references (`dist/skills-sh/`, `kata-skills/`)
- Correct working-directory for git operations
  </verify>
  <done>
CI pipeline publishes to both marketplace and kata-skills repo on version change. Skills-sh distribution automated end-to-end.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CI pipeline extended to publish skills to gannonh/kata-skills repo. The workflow requires two manual setup steps before it will work in production.</what-built>
  <how-to-verify>
1. Create the `gannonh/kata-skills` GitHub repo (public, empty, no README)
2. Create a PAT scoped to `gannonh/kata-skills` repo with `contents: write` permission
3. Add the PAT as `KATA_SKILLS_TOKEN` secret in the `gannonh/kata` repo settings
4. Verify locally: `npm run build:skills-sh` produces correct output at dist/skills-sh/
5. Verify: `npx skills add gannonh/kata-skills` works after first manual push (or after CI runs)
  </how-to-verify>
  <resume-signal>Say "repo created" or "setup complete" to continue. If you want to defer repo creation, say "skip" and the CI will work once the repo and token are configured.</resume-signal>
</task>

</tasks>

<verification>
- .github/workflows/plugin-release.yml has skills-sh build and publish steps
- Steps are gated by same version-change check as marketplace
- Token reference uses KATA_SKILLS_TOKEN
- Build output structure matches what CI copies (dist/skills-sh/skills/, README.md, LICENSE)
</verification>

<success_criteria>
- CI/CD pipeline extended to publish to gannonh/kata-skills on release
- Publication uses same version-change gate as marketplace
- Manual setup documented (repo creation, PAT, secret)
- After setup, `npx skills add gannonh/kata-skills` installs Kata skills
</success_criteria>

<output>
After completion, create `.planning/phases/pending/33-skills-sh-distribution/33-03-SUMMARY.md`
</output>
