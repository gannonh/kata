---
phase: 46-execution-integration
plan: 02
type: execute
wave: 2
depends_on: [46-01]
files_modified:
  - skills/kata-execute-phase/SKILL.md
autonomous: true
must_haves:
  truths:
    - kata-execute-phase checks worktree.enabled config at startup
    - When worktrees enabled, each plan in a wave gets a worktree created before agent spawn
    - Executor Task() prompts include <working_directory> with worktree path when worktrees enabled
    - After wave completion, all plan worktrees merge back to base and get cleaned up
    - When worktrees disabled (default), execution flow is identical to current behavior
  artifacts:
    - skills/kata-execute-phase/SKILL.md (updated)
  key_links:
    - Step 0.7 worktree config check -> step 4 wave execution conditional
    - Step 4 worktree create -> Task() prompt <working_directory> injection
    - Step 4 post-wave merge -> manage-worktree.sh merge call
    - Worktree disabled path -> zero changes to existing flow
---

<objective>
Wire worktree lifecycle (create/execute/merge/cleanup) into the kata-execute-phase SKILL.md orchestrator.

Purpose: This is the core integration. The orchestrator must conditionally create worktrees before spawning executor agents, inject worktree paths into agent prompts, and merge/cleanup after each wave completes.

Output: Updated SKILL.md with worktree-aware wave execution that preserves existing non-worktree behavior as the default path.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@skills/kata-execute-phase/SKILL.md
@skills/kata-execute-phase/scripts/manage-worktree.sh
@skills/kata-configure-settings/scripts/read-config.sh

# Reference docs updated in Plan 01
@skills/kata-execute-phase/references/phase-execute.md
@skills/kata-execute-phase/references/executor-instructions.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worktree config check to SKILL.md startup</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Add a new step 0.7 "Check Worktree Config" between step 0.5 (Read Workflow Config) and step 1 (Pre-flight).

Content:

```
0.7. **Check Worktree Config**

Read worktree configuration for conditional worktree lifecycle:

```bash
WORKTREE_ENABLED=$(bash "../kata-configure-settings/scripts/read-config.sh" "worktree.enabled" "false")
```

Store `WORKTREE_ENABLED` for use in step 4 wave execution. When `false` (default), all worktree operations are skipped and execution proceeds identically to the current flow.
```

This is a small additive step. Do NOT modify any existing steps.
  </action>
  <verify>grep -c "WORKTREE_ENABLED" skills/kata-execute-phase/SKILL.md</verify>
  <done>SKILL.md has step 0.7 that reads worktree.enabled config into WORKTREE_ENABLED variable</done>
</task>

<task type="auto">
  <name>Task 2: Wire worktree create/merge into wave execution</name>
  <files>skills/kata-execute-phase/SKILL.md</files>
  <action>
Modify step 4 "Execute waves" in SKILL.md to add conditional worktree lifecycle around agent spawning.

**Before the wave execution loop (after step 3.5 banner), add:**

A note that the wave execution loop now has conditional worktree operations. When WORKTREE_ENABLED=true, each plan gets an isolated worktree. When false, behavior is unchanged.

**Inside step 4, add three conditional blocks:**

1. **Pre-spawn worktree creation** (before "Spawn `general-purpose` executor for each plan"):

Add after the existing "For each wave in order:" line, before spawning:

```
   - **Create worktrees (if enabled):**
     If `WORKTREE_ENABLED=true`, create a worktree for each plan in the wave:

     ```bash
     if [ "$WORKTREE_ENABLED" = "true" ]; then
       for plan_num in $WAVE_PLAN_NUMBERS; do
         WT_OUTPUT=$(bash "./scripts/manage-worktree.sh" create "$PHASE_NUM" "$plan_num")
         eval "$WT_OUTPUT"
         # Stores WORKTREE_PATH, WORKTREE_BRANCH, STATUS for each plan
         # Save per-plan: WORKTREE_PATH_${plan_num}=$WORKTREE_PATH
       done
     fi
     ```
```

2. **Working directory injection in Task() prompts:**

In the `<wave_execution>` section, update the Task() prompt template to conditionally include `<working_directory>`:

Add this note after the existing "Read these files:" list:

```
- If `WORKTREE_ENABLED=true`: For each plan, look up `WORKTREE_PATH_{plan_num}` from the pre-spawn creation step.

Add to each Task() prompt (after `</workflow_config>`):

When WORKTREE_ENABLED=true:
```
\n<working_directory>{worktree_path_for_this_plan}</working_directory>
```

When WORKTREE_ENABLED=false: Omit the `<working_directory>` block entirely (existing behavior).
```

3. **Post-wave merge and cleanup** (after "Verify SUMMARYs created", before "Update GitHub issue checkboxes"):

```
   - **Merge worktrees (if enabled):**
     After all agents in wave complete and SUMMARYs verified, merge each plan's worktree:

     ```bash
     if [ "$WORKTREE_ENABLED" = "true" ]; then
       for plan_num in $WAVE_PLAN_NUMBERS; do
         MERGE_OUTPUT=$(bash "./scripts/manage-worktree.sh" merge "$PHASE_NUM" "$plan_num")
         eval "$MERGE_OUTPUT"
         if [ "$STATUS" != "merged" ]; then
           echo "Warning: Worktree merge failed for plan $plan_num" >&2
         fi
       done
     fi
     ```

     Merge happens ONCE per wave after all agents complete (same pattern as issue checkbox updates). This ensures all plan branches are integrated before the next wave starts.

     **If merge fails:** Report the failure but continue. User can resolve merge conflicts manually and re-run. The worktree and branch remain for inspection.
```

**Update the execution banner (step 3.5):**

Add a line to the banner output when worktrees are enabled:

```
{If WORKTREE_ENABLED=true: **Worktree isolation:** enabled (each plan gets isolated worktree)}
```

**CRITICAL: Do NOT modify any non-worktree logic.** All worktree operations are wrapped in `if [ "$WORKTREE_ENABLED" = "true" ]` conditionals. The existing flow is the else/default path and must remain exactly as-is.
  </action>
  <verify>
grep -c "WORKTREE_ENABLED\|manage-worktree\|working_directory" skills/kata-execute-phase/SKILL.md
# Should return 8+ matches (config check, banner, create block, Task injection, merge block, notes)
  </verify>
  <done>SKILL.md step 4 has conditional worktree create before spawn, working_directory injection in Task() prompts, and merge after wave completion. All wrapped in WORKTREE_ENABLED conditionals. Non-worktree flow unchanged.</done>
</task>

</tasks>

<verification>
- `grep "WORKTREE_ENABLED" skills/kata-execute-phase/SKILL.md` returns matches in steps 0.7, 3.5, and 4
- `grep "manage-worktree" skills/kata-execute-phase/SKILL.md` returns matches for create and merge calls
- `grep "working_directory" skills/kata-execute-phase/SKILL.md` returns match in Task() prompt section
- Read through the wave execution flow to confirm non-worktree path is identical to current
- Verify the create/merge lifecycle: create before spawn, merge after wave, cleanup on failure documented
</verification>

<success_criteria>
- [ ] Step 0.7 reads worktree.enabled config into WORKTREE_ENABLED
- [ ] Step 3.5 banner shows worktree status when enabled
- [ ] Step 4 creates worktrees per-plan before spawning agents (conditional)
- [ ] Task() prompts include <working_directory> when worktrees enabled
- [ ] Step 4 merges worktrees per-plan after wave completion (conditional)
- [ ] Merge failure is non-fatal (warning + continue)
- [ ] All worktree operations wrapped in WORKTREE_ENABLED conditionals
- [ ] Non-worktree execution flow is byte-identical to current behavior
</success_criteria>

<output>
After completion, create `.planning/phases/46-execution-integration/46-02-SUMMARY.md`
</output>
