---
phase: 54-knowledge-architecture--consumption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/kata-map-codebase/scripts/generate-intel.js
  - skills/kata-map-codebase/references/summary-template.md
  - skills/kata-map-codebase/SKILL.md
autonomous: true
must_haves:
  truths:
    - "generate-intel.js reads .planning/codebase/*.md and produces .planning/intel/summary.md"
    - "generate-intel.js produces .planning/intel/index.json and .planning/intel/conventions.json"
    - "summary.md is 30-150 lines with Stack, Architecture, Conventions, Key Patterns, Concerns sections"
    - "kata-map-codebase runs generate-intel.js after mapper agents complete"
  artifacts:
    - skills/kata-map-codebase/scripts/generate-intel.js
    - skills/kata-map-codebase/references/summary-template.md
  key_links:
    - "kata-map-codebase SKILL.md step 5 -> generate-intel.js invocation"
    - "generate-intel.js -> reads .planning/codebase/*.md -> writes .planning/intel/"
---

<objective>
Create the generate-intel.js script that reads .planning/codebase/ docs and produces .planning/intel/ artifacts (index.json, conventions.json, summary.md). Wire the script into kata-map-codebase as a new step after mapper agents complete.

Purpose: This is the foundation for codebase intelligence. Without the generation pipeline, no agent can consume intel. The script transforms verbose human-readable codebase docs (~100-300 lines each) into a compressed agent-readable summary (~80-150 lines).

Output: generate-intel.js script, summary-template.md reference, updated kata-map-codebase SKILL.md
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Architecture research with detailed schemas for all three artifacts
@.planning/research/ARCHITECTURE.md

# Current kata-map-codebase skill (add new step after step 5)
@skills/kata-map-codebase/SKILL.md

# Existing codebase docs (the input to generate-intel.js)
# These 7 files live at .planning/codebase/ and follow known formats
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate-intel.js script</name>
  <files>skills/kata-map-codebase/scripts/generate-intel.js</files>
  <action>
Create a Node.js script at skills/kata-map-codebase/scripts/generate-intel.js that:

1. Reads all 7 files from .planning/codebase/ (STACK.md, ARCHITECTURE.md, CONVENTIONS.md, TESTING.md, STRUCTURE.md, INTEGRATIONS.md, CONCERNS.md). Graceful skip if any file missing.

2. Produces three artifacts in .planning/intel/:

**index.json** — File registry extracted from STRUCTURE.md and ARCHITECTURE.md:
```json
{
  "version": 1,
  "generated": "ISO-8601 timestamp",
  "source": "kata-map-codebase",
  "files": {
    "path/to/file.ts": {
      "exports": ["name1", "name2"],
      "imports": ["pkg", "./relative"],
      "type": "component|service|util|route|model|config|test",
      "layer": "ui|api|data|shared"
    }
  },
  "stats": {
    "total_files": N,
    "by_type": {},
    "by_layer": {}
  }
}
```
Parse file listings from STRUCTURE.md. For each file entry, attempt to classify type and layer from the path. Exports/imports extraction from STRUCTURE.md content (if listed) or empty arrays if not available.

**conventions.json** — Pattern detection from CONVENTIONS.md and TESTING.md:
```json
{
  "version": 1,
  "generated": "ISO-8601 timestamp",
  "naming": { "files": "kebab-case", "functions": "camelCase", ... },
  "directories": { "components": "src/components/", ... },
  "patterns": { "imports": "path aliases", "error_handling": "...", ... },
  "confidence": "high|medium|low"
}
```
Parse naming conventions, directory purposes, import patterns, and testing patterns from the codebase docs.

**summary.md** — Compressed agent-readable summary:
Follow the template from summary-template.md (created in Task 2). Extract key information from each codebase doc. Target 80-150 lines. Hard cap at 150 lines. Each section should be dense and actionable.

Header format: `Generated: YYYY-MM-DD | Source: .planning/codebase/`

The script must:
- Use only Node.js built-in modules (fs, path). No npm dependencies.
- Create .planning/intel/ directory if it does not exist (mkdir -p equivalent).
- Exit 0 on success, exit 1 on error.
- Print summary stats to stdout: file count, summary line count.
- Be executable: include shebang `#!/usr/bin/env node`

Detect the project root using the same pattern as other Kata scripts: check KATA_PROJECT_ROOT env var, then look for .planning/ in CWD, then try CWD/main/.planning/ (worktree layout). Import the project-root detection pattern from skills/kata-execute-phase/scripts/project-root.sh conceptually (but implement in JS since this is a Node script).
  </action>
  <verify>
Run the script against this project's own .planning/codebase/ docs:
```bash
node skills/kata-map-codebase/scripts/generate-intel.js
cat .planning/intel/summary.md | wc -l
cat .planning/intel/index.json | head -5
cat .planning/intel/conventions.json | head -5
```
Verify: summary.md exists with 30-150 lines, index.json and conventions.json are valid JSON.
  </verify>
  <done>
generate-intel.js reads .planning/codebase/*.md and produces all three .planning/intel/ artifacts. Script uses only Node.js built-ins. Exit codes are correct.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create summary template reference and wire into kata-map-codebase</name>
  <files>skills/kata-map-codebase/references/summary-template.md, skills/kata-map-codebase/SKILL.md</files>
  <action>
**Create summary-template.md** at skills/kata-map-codebase/references/summary-template.md.

This template defines the structure for generated summary.md files:

```markdown
# Codebase Intelligence Summary

Generated: {date} | Source: .planning/codebase/

## Stack
{One-liner: language + framework + database + UI}

## Architecture
{Layers, entry points, data flow — 3-10 lines}

## Conventions
{Naming patterns, import rules, directory placement, test patterns — 5-15 lines}

## Key Patterns
{Error handling, state management, auth approach, validation — 5-15 lines, bullet list}

## Concerns
{Outstanding issues, tech debt — 3-10 lines, bullet list}
```

Target: 30-80 lines typical, max 150 lines. Each section extracts the most actionable information from the corresponding codebase document.

**Update kata-map-codebase/SKILL.md** — Add step 5.5 after the existing step 5 (verify docs) and before step 6 (commit):

Add a new step between verification and commit:
```
5.5. Generate codebase intelligence artifacts

Run the intel generator script to produce machine-readable artifacts from the codebase docs:

\```bash
node "./scripts/generate-intel.js"
\```

If the script fails, warn but do not block (intel generation is non-blocking). Continue to commit step.

Verify intel artifacts were created:
\```bash
ls .planning/intel/summary.md .planning/intel/index.json .planning/intel/conventions.json 2>/dev/null
\```
```

Update step 6 (commit) to include `.planning/intel/` alongside `.planning/codebase/` in the git add.

Update the success_criteria to include:
- `- [ ] .planning/intel/ directory created with summary.md, index.json, conventions.json`

Update the objective output line:
- From: `Output: .planning/codebase/ folder with 7 structured documents about the codebase state.`
- To: `Output: .planning/codebase/ folder with 7 structured documents, plus .planning/intel/ with compressed agent-readable artifacts.`
  </action>
  <verify>
Read the updated SKILL.md and verify step 5.5 exists between step 5 and step 6. Verify the commit step includes .planning/intel/. Verify summary-template.md exists.
  </verify>
  <done>
kata-map-codebase runs generate-intel.js after mapper agents complete. Intel artifacts are included in the commit. Summary template defines the expected output format.
  </done>
</task>

</tasks>

<verification>
1. `node skills/kata-map-codebase/scripts/generate-intel.js` exits 0
2. `.planning/intel/summary.md` exists with 30-150 lines
3. `.planning/intel/index.json` is valid JSON with version and files fields
4. `.planning/intel/conventions.json` is valid JSON with version and naming fields
5. `skills/kata-map-codebase/SKILL.md` references generate-intel.js in step 5.5
6. `skills/kata-map-codebase/references/summary-template.md` exists
</verification>

<success_criteria>
- generate-intel.js produces all three .planning/intel/ artifacts from .planning/codebase/ docs
- Summary is 30-150 lines, dense and actionable
- kata-map-codebase runs the script after mapper agents and includes intel in commit
- Script uses only Node.js built-ins (no npm deps)
- Non-blocking: script failure warns but does not block kata-map-codebase
</success_criteria>

<output>
After completion, create `.planning/phases/54-knowledge-architecture--consumption/54-01-SUMMARY.md`
</output>
