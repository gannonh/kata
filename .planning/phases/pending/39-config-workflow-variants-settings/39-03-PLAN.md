---
phase: 39-config-workflow-variants-settings
plan: 03
type: execute
wave: 2
depends_on: [01]
files_modified:
  - skills/kata-configure-settings/SKILL.md
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "Settings skill uses read-pref.sh to read current config values instead of inline grep/cat"
    - "Settings skill uses set-config.sh to write config values instead of inline node script"
    - "parallelization toggle removed from settings UI"
    - "Settings skill has three sections: Project-Lifetime Preferences, Session Settings, Workflow Variants"
    - "Workflow Variants section presents execute-phase, verify-work, and complete-milestone config options"
    - "Preferences section manages preferences.json keys (release, docs, conventions)"
  artifacts:
    - skills/kata-configure-settings/SKILL.md
  key_links:
    - "Read calls use read-pref.sh from scripts/ directory (same skill)"
    - "Write calls use set-config.sh from scripts/ directory (same skill)"
---

<objective>
Update kata-configure-settings to manage preferences.json, workflow variants, and use accessor/write utilities. Remove dead parallelization key.

Purpose: Give users a single skill for configuring all Kata settings: project-lifetime preferences, session settings, and workflow variants. Replace inline JSON manipulation with the accessor scripts from Phase 37.
Output: Fully rewritten kata-configure-settings/SKILL.md with three configuration sections.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/39-config-workflow-variants-settings/39-RESEARCH.md

@skills/kata-configure-settings/SKILL.md
@skills/kata-configure-settings/scripts/read-pref.sh
@skills/kata-configure-settings/scripts/set-config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite kata-configure-settings to use accessor scripts and add three config sections</name>
  <files>skills/kata-configure-settings/SKILL.md</files>
  <action>
Rewrite `kata-configure-settings/SKILL.md` with the following structure. Preserve the YAML frontmatter (update description to mention preferences and workflow variants). Keep the skill under 500 lines.

**Updated description:** Add trigger phrases for preferences, workflow variants, and workflow config.

**New process structure:**

## 1. Validate Environment

Same as current: check `.planning/config.json` exists.

## 2. Read Current Values via Accessor Scripts

Replace all inline `cat` + `grep` parsing with `read-pref.sh` calls:

```bash
SCRIPT_DIR="${SKILL_BASE_DIR}/scripts"

# Session settings
MODE=$(bash "$SCRIPT_DIR/read-pref.sh" "mode" "yolo")
DEPTH=$(bash "$SCRIPT_DIR/read-pref.sh" "depth" "standard")
MODEL_PROFILE=$(bash "$SCRIPT_DIR/read-pref.sh" "model_profile" "balanced")
COMMIT_DOCS=$(bash "$SCRIPT_DIR/read-pref.sh" "commit_docs" "true")
PR_WORKFLOW=$(bash "$SCRIPT_DIR/read-pref.sh" "pr_workflow" "false")
STATUSLINE=$(bash "$SCRIPT_DIR/read-pref.sh" "display.statusline" "true")
RESEARCH=$(bash "$SCRIPT_DIR/read-pref.sh" "workflow.research" "true")
PLAN_CHECK=$(bash "$SCRIPT_DIR/read-pref.sh" "workflow.plan_check" "true")
VERIFIER=$(bash "$SCRIPT_DIR/read-pref.sh" "workflow.verifier" "true")

# Project-lifetime preferences
CHANGELOG_FMT=$(bash "$SCRIPT_DIR/read-pref.sh" "release.changelog_format" "keep-a-changelog")
README_ON_MS=$(bash "$SCRIPT_DIR/read-pref.sh" "docs.readme_on_milestone" "prompt")
COMMIT_FORMAT=$(bash "$SCRIPT_DIR/read-pref.sh" "conventions.commit_format" "conventional")

# Workflow variants
EXEC_POST_TASK=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.execute-phase.post_task_command" "")
EXEC_COMMIT_STYLE=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.execute-phase.commit_style" "conventional")
EXEC_SCOPE_FMT=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.execute-phase.commit_scope_format" "{phase}-{plan}")
VERIFY_EXTRA_CMDS=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.verify-work.extra_verification_commands" "[]")
MILESTONE_VERSION_FILES=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.complete-milestone.version_files" "[]")
MILESTONE_PRE_RELEASE=$(bash "$SCRIPT_DIR/read-pref.sh" "workflows.complete-milestone.pre_release_commands" "[]")
```

Do NOT read `parallelization` (dead key).

## 3. Present Settings in Three Sections

Use AskUserQuestion for each section separately. The user can modify any section.

**Section A: Project-Lifetime Preferences (preferences.json)**

These are project constants that don't change session to session.

AskUserQuestion with 3 settings:
- Changelog format: keep-a-changelog | conventional | none
- README on milestone: prompt | auto | skip
- Commit format: conventional | semantic | simple

Pre-select current values.

**Section B: Session Settings (config.json)**

AskUserQuestion with 7 settings (same as current minus parallelization):
- Model Profile: quality | balanced | budget
- Commit Docs: yes | no
- PR Workflow: yes | no
- Statusline: yes | no
- Research: yes | no
- Plan Check: yes | no
- Verifier: yes | no

Pre-select current values.

**Section C: Workflow Variants (config.json workflows section)**

AskUserQuestion with workflow config:
- Post-task command (execute-phase): text input, current value shown
- Commit style (execute-phase): conventional | semantic | simple
- Commit scope format (execute-phase): text input, show default `{phase}-{plan}`
- Extra verification commands (verify-work): text input, describe as JSON array
- Version files (complete-milestone): text input, describe as JSON array
- Pre-release commands (complete-milestone): text input, describe as JSON array

For text inputs where user can't select from a list, show current value and ask if they want to change it.

## 4. Write Updates via set-config.sh

Replace inline node JSON manipulation with `set-config.sh` calls:

```bash
SCRIPT_DIR="${SKILL_BASE_DIR}/scripts"

# Session settings → config.json
bash "$SCRIPT_DIR/set-config.sh" "mode" "$NEW_MODE"
bash "$SCRIPT_DIR/set-config.sh" "depth" "$NEW_DEPTH"
bash "$SCRIPT_DIR/set-config.sh" "model_profile" "$NEW_MODEL_PROFILE"
# ... etc for all session settings

# Workflow variants → config.json
bash "$SCRIPT_DIR/set-config.sh" "workflows.execute-phase.post_task_command" "$NEW_POST_TASK_CMD"
bash "$SCRIPT_DIR/set-config.sh" "workflows.execute-phase.commit_style" "$NEW_COMMIT_STYLE"
# ... etc for all workflow variants
```

For preferences.json writes, use a similar pattern but write to preferences.json instead of config.json. Since `set-config.sh` targets config.json, use a direct node one-liner for preferences.json writes:

```bash
KEY="$PREF_KEY" VALUE="$PREF_VALUE" node -e "
const fs=require('fs');
const f='.planning/preferences.json';
let p;try{p=JSON.parse(fs.readFileSync(f,'utf8'));}catch{p={};}
p[process.env.KEY]=process.env.VALUE;
const t=f+'.tmp';
fs.writeFileSync(t,JSON.stringify(p,null,2)+'\n');
fs.renameSync(t,f);
"
```

Keep the existing statusline toggle logic (`.claude/settings.json` update) and the commit_docs gitignore logic from current step 4.

**Remove the dead `parallelization` toggle entirely.** Do not present it to the user. Do not read or write it. If `parallelization` exists in current config.json, leave it alone (the config validator will handle it until a future cleanup).

## 5. Confirm Changes

Update the confirmation display to show all three sections:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Kata ► SETTINGS UPDATED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**Project Preferences** (preferences.json)

| Setting          | Value             |
| ---------------- | ----------------- |
| Changelog Format | {value}           |
| README on MS     | {value}           |
| Commit Format    | {value}           |

**Session Settings** (config.json)

| Setting            | Value                     |
| ------------------ | ------------------------- |
| Model Profile      | {quality/balanced/budget} |
| Commit Docs        | {On/Off}                  |
| PR Workflow        | {On/Off}                  |
| Statusline         | {On/Off}                  |
| Plan Researcher    | {On/Off}                  |
| Plan Checker       | {On/Off}                  |
| Execution Verifier | {On/Off}                  |

**Workflow Variants** (config.json)

| Setting                   | Value           |
| ------------------------- | --------------- |
| Post-task Command         | {value or none} |
| Commit Style              | {value}         |
| Commit Scope Format       | {value}         |
| Extra Verification Cmds   | {value or none} |
| Version Files             | {value or auto} |
| Pre-release Commands      | {value or none} |
```

Keep the existing "PR Workflow just enabled" branch protection notice. Keep the existing quick commands list.

**Success criteria updates:** Replace "7 settings (profile + commit_docs + pr_workflow + statusline + 3 toggles)" with "3 config sections: preferences, session settings, workflow variants". Remove "Missing keys detected" criterion.
  </action>
  <verify>
```bash
cd /Users/gannonhall/dev/kata/kata-orchestrator
# Verify read-pref.sh usage
grep -c "read-pref.sh" skills/kata-configure-settings/SKILL.md

# Verify set-config.sh usage
grep -c "set-config.sh" skills/kata-configure-settings/SKILL.md

# Verify parallelization is NOT present
grep -c "parallelization" skills/kata-configure-settings/SKILL.md

# Verify workflow variants section exists
grep -c "Workflow Variants" skills/kata-configure-settings/SKILL.md

# Verify preferences section exists
grep -c "preferences.json" skills/kata-configure-settings/SKILL.md

# Verify file is under 500 lines
wc -l < skills/kata-configure-settings/SKILL.md
```
Expected: read-pref.sh >= 5, set-config.sh >= 3, parallelization = 0, Workflow Variants >= 1, preferences.json >= 1, line count < 500.
  </verify>
  <done>kata-configure-settings uses read-pref.sh/set-config.sh for all reads/writes, has three config sections (preferences, session settings, workflow variants), and parallelization toggle is removed.</done>
</task>

</tasks>

<verification>
- Settings skill reads all values via read-pref.sh (no inline grep/cat parsing)
- Settings skill writes all values via set-config.sh or preferences.json writer (no inline node JSON manipulation)
- Dead parallelization key removed from UI
- Three configuration sections presented to user
- Existing statusline and commit_docs side-effects preserved
</verification>

<success_criteria>
- WKFL-06: kata-configure-settings manages preferences.json, workflow variants, uses accessor/write utilities, parallelization key removed
</success_criteria>

<output>
After completion, create `.planning/phases/pending/39-config-workflow-variants-settings/39-03-SUMMARY.md`
</output>
