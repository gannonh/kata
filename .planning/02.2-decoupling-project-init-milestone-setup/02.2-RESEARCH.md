# Phase 2.2: Decouple Project Init & Milestone Setup - Research

**Researched:** 2026-01-25
**Domain:** Kata skill architecture refactoring, GitHub primitive mapping
**Confidence:** HIGH

## Summary

This phase addresses a long-standing todo (2026-01-18) to separate project initialization from first milestone creation. Currently `kata-starting-projects` creates PROJECT.md, config.json, research/, REQUIREMENTS.md, ROADMAP.md, and STATE.md in one monolithic flow. This conflates two distinct concerns: project configuration (vision, constraints, workflow preferences) and milestone planning (requirements, roadmap, phases).

The refactoring splits responsibilities cleanly:
1. **`kata-starting-projects`** becomes purely project setup: PROJECT.md + config.json only
2. **`kata-adding-milestones`** (renamed from `kata-starting-milestones`) handles milestone creation: research, requirements, ROADMAP.md, STATE.md, and GitHub Milestone

The rename from `starting-milestones` to `adding-milestones` aligns with existing skill naming patterns (`kata-adding-phases`, `kata-adding-todos`). The new flow mirrors the conceptual hierarchy: project > milestones > phases > plans.

**Primary recommendation:** Implement as a 4-plan phase: (1) reduce `starting-projects` scope, (2) create `adding-milestones` skill with full milestone flow, (3) document Kata-GitHub primitive mapping, (4) update tests and documentation.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library/Tool | Version | Purpose | Why Standard |
| ------------ | ------- | ------- | ------------ |
| gh CLI | 2.x | GitHub API operations | Already used in Phase 2.1, provides `gh api` for milestones |
| jq | 1.7+ | JSON parsing | Used for parsing gh api responses |
| Bash | 5.x | Skill scripting | Standard for all Kata skill conditionals |

### Supporting
| Library | Version | Purpose | When to Use |
| ------- | ------- | ------- | ----------- |
| AskUserQuestion | N/A | Claude tool | Gathering user preferences during milestone setup |
| Task | N/A | Claude tool | Spawning researcher/roadmapper subagents |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
| ---------- | --------- | -------- |
| gh api | gh milestone create | gh api is more flexible; gh milestone requires extension |
| Separate skill | Extend existing | Clean separation wins; extending would bloat starting-projects |

## Architecture Patterns

### Recommended Skill Structure

The phase involves modifying 2 existing skills and creating documentation:

```
skills/
├── kata-starting-projects/    # MODIFY - reduce scope
│   ├── SKILL.md              # Remove Phases 6-8 (research, requirements, roadmap)
│   └── references/
│       └── project-template.md  # Keep
│       └── questioning.md       # Keep
│
├── kata-adding-milestones/    # RENAME from kata-starting-milestones
│   ├── SKILL.md              # Rename + add "first milestone" detection
│   └── references/
│       ├── requirements-template.md  # Keep (or move from starting-projects)
│       └── github-mapping.md         # NEW - document primitive mapping
│
└── kata-starting-milestones/  # DELETE after rename
```

### Pattern 1: Skill Rename via File Operations

**What:** Rename skill directory while preserving content
**When to use:** Skill name doesn't match convention but behavior is correct
**Example:**
```bash
# Source: Kata naming conventions (KATA-STYLE.md)
# Step 1: Create new directory
mkdir -p skills/kata-adding-milestones

# Step 2: Copy/modify SKILL.md
cp skills/kata-starting-milestones/SKILL.md skills/kata-adding-milestones/SKILL.md
# Update name field, description triggers, user_command

# Step 3: Copy references
cp -r skills/kata-starting-milestones/references skills/kata-adding-milestones/

# Step 4: Remove old skill
rm -rf skills/kata-starting-milestones
```

### Pattern 2: First-Milestone Detection

**What:** Detect if this is the first milestone in a project
**When to use:** Flow differs for greenfield vs subsequent milestones
**Example:**
```bash
# Source: Current implementation pattern
# First milestone: No ROADMAP.md exists yet
if [ ! -f .planning/ROADMAP.md ]; then
  FIRST_MILESTONE=true
  # Create new ROADMAP.md from scratch
else
  FIRST_MILESTONE=false
  # Continue existing ROADMAP.md numbering
fi
```

### Pattern 3: Kata-GitHub Primitive Mapping

**What:** Clear 1:1 mapping between Kata concepts and GitHub primitives
**When to use:** Any GitHub integration code
**Example:**
```markdown
| Kata Concept | GitHub Primitive | Created By | Example |
| ------------ | ---------------- | ---------- | ------- |
| Milestone | GitHub Milestone | add-milestone | v1.1.0 |
| Phase | GitHub Issue | planning-phases (future) | "Phase 3: Auth System" |
| Plan | Checklist item in Issue body | executing-phases (future) | "- [x] 03-01-PLAN.md" |
```

### Anti-Patterns to Avoid

- **Conflating project and milestone:** Project is the container; milestones are the work units. Keep separate.
- **Using `starting-*` for non-initial operations:** `starting-milestones` implies only first milestone; `adding-milestones` works for any milestone.
- **Implicit milestone creation:** Always require explicit `add-milestone` invocation for mental model clarity.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
| ------- | ----------- | ----------- | --- |
| GitHub Milestone creation | Custom API calls | `gh api` pattern from Phase 2.1 | Idempotency, error handling already solved |
| Skill renaming | Manual file edits | Copy-modify-delete pattern | Preserves references, clean history |
| Requirements gathering | New questioning flow | Existing Phase 7-8 from starting-projects | Already battle-tested, move don't rebuild |

**Key insight:** This phase is primarily about moving code between skills, not writing new functionality. The research, requirements, and roadmap flows from `kata-starting-projects` (Phases 6-8) move wholesale to `kata-adding-milestones`.

## Common Pitfalls

### Pitfall 1: Breaking Brownfield Detection

**What goes wrong:** Brownfield detection logic in starting-projects depends on ROADMAP.md existence
**Why it happens:** Removing ROADMAP.md creation from starting-projects changes the signal
**How to avoid:** Use PROJECT.md existence as project-initialized signal, ROADMAP.md as milestone-initialized signal
**Warning signs:** Brownfield offer appearing on subsequent runs after milestone created

### Pitfall 2: Lost Triggers in Rename

**What goes wrong:** Users say "start milestone" but skill doesn't trigger
**Why it happens:** Forgot to update description triggers when renaming
**How to avoid:** Copy ALL triggers from old skill, ADD new "add milestone" triggers
**Warning signs:** Natural language invocation fails; `/` menu works but conversation doesn't

### Pitfall 3: Duplicate Templates

**What goes wrong:** requirements-template.md exists in both skills
**Why it happens:** Copied references without removing from source
**How to avoid:** Move, don't copy - or explicitly document which skill owns which template
**Warning signs:** Build warnings about duplicate files, confusion about source of truth

### Pitfall 4: Phase Number Collision

**What goes wrong:** First milestone starts at Phase 1, but second milestone also tries to start at Phase 1
**Why it happens:** Starting-milestones already handles continuation; need to preserve that logic
**How to avoid:** Keep MILESTONES.md parsing logic for phase number continuation
**Warning signs:** Duplicate phase numbers in ROADMAP.md

## Code Examples

Verified patterns from existing Kata skills:

### Current starting-projects Flow (to be reduced)
```markdown
# Source: skills/kata-starting-projects/SKILL.md lines 24-31
**Creates:**
- `.planning/PROJECT.md` — project context
- `.planning/config.json` — workflow preferences
- `.planning/research/` — domain research (optional)      # MOVE to add-milestone
- `.planning/REQUIREMENTS.md` — scoped requirements       # MOVE to add-milestone
- `.planning/ROADMAP.md` — phase structure               # MOVE to add-milestone
- `.planning/STATE.md` — project memory                  # MOVE to add-milestone
```

### Target starting-projects Flow (after refactoring)
```markdown
# Proposed reduced scope
**Creates:**
- `.planning/PROJECT.md` — project context
- `.planning/config.json` — workflow preferences

**After this command:** Run `/kata:add-milestone` to define your first milestone.
```

### Skill Rename Pattern
```yaml
# Source: Existing skill naming convention (kata-adding-*)
# Old: skills/kata-starting-milestones/SKILL.md
---
name: kata-starting-milestones
description: Use this skill when starting a new milestone cycle...

# New: skills/kata-adding-milestones/SKILL.md
---
name: kata-adding-milestones
description: Use this skill when adding a milestone to an existing project, creating a new milestone cycle, or defining the first milestone after project initialization. Triggers include "add milestone", "new milestone", "create milestone", "first milestone", "next milestone", and "milestone cycle".
```

### GitHub Milestone Creation (existing, keep)
```bash
# Source: skills/kata-starting-milestones/SKILL.md lines 163-178
MILESTONE_EXISTS=$(gh api /repos/:owner/:repo/milestones 2>/dev/null | jq -r ".[] | select(.title==\"v${VERSION}\") | .number" 2>/dev/null)

if [ -z "$MILESTONE_EXISTS" ]; then
  gh api \
    --method POST \
    -H "Accept: application/vnd.github.v3+json" \
    /repos/:owner/:repo/milestones \
    -f title="v${VERSION}" \
    -f state='open' \
    -f description="${MILESTONE_DESC}" \
    2>/dev/null && echo "GitHub Milestone v${VERSION} created"
fi
```

### First Milestone Detection (new)
```bash
# Proposed pattern for add-milestone
if [ ! -f .planning/ROADMAP.md ]; then
  echo "First milestone - creating ROADMAP.md"
  STARTING_PHASE=1
else
  # Parse MILESTONES.md for continuation
  LAST_PHASE=$(grep -E "^### Phase [0-9]+" .planning/ROADMAP.md | tail -1 | grep -oE "[0-9]+" | head -1)
  STARTING_PHASE=$((LAST_PHASE + 1))
fi
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
| ------------ | ---------------- | ------------ | ------ |
| `project-new` creates everything | `project-new` + `milestone-new` | This phase | Cleaner mental model |
| `starting-milestones` name | `adding-milestones` name | This phase | Consistency with add-phase, add-todo |
| Implicit first milestone | Explicit milestone creation | This phase | Better user understanding |

**Deprecated/outdated:**
- `kata-starting-milestones` skill name — being renamed to `kata-adding-milestones`

## Kata-GitHub Primitive Mapping

This mapping documents how Kata concepts translate to GitHub primitives:

| Kata Concept | GitHub Primitive | Relationship | Notes |
| ------------ | ---------------- | ------------ | ----- |
| **Milestone** | GitHub Milestone | 1:1 | Created by `add-milestone` when `github.enabled=true` |
| **Phase** | GitHub Issue | 1:1 | Created by `planning-phases` (Phase 3 work) with `phase` label, assigned to milestone |
| **Plan** | Checklist in Issue body | N:1 | Plans become `- [ ]` items in phase issue body (Phase 4 work) |
| **Task** | N/A | Not mapped | Tasks are internal execution units, not surfaced to GitHub |

**Future extension:** If `gh-subissue` extension available, Plans could become sub-issues of Phase issues.

### Config Keys

| Key | Values | Effect |
| --- | ------ | ------ |
| `github.enabled` | `true`/`false` | Master toggle for GitHub integration |
| `github.issueMode` | `auto`/`ask`/`never` | When to create phase Issues |

## Open Questions

Things that couldn't be fully resolved:

1. **Should `add-milestone` prompt for version number or auto-detect?**
   - What we know: Current `starting-milestones` parses MILESTONES.md for last version
   - What's unclear: Whether user should always confirm version (v1.1 vs v2.0 for major)
   - Recommendation: Keep current behavior (auto-detect, suggest, allow override)

2. **Should research/ directory be milestone-scoped?**
   - What we know: Currently creates `.planning/research/`
   - What's unclear: Should it be `.planning/milestones/v1.1.0/research/`?
   - Recommendation: Keep current flat structure for v1; consider namespacing in future

3. **What happens to pending todo about this topic?**
   - What we know: `.planning/todos/pending/2026-01-18-separate-project-new-from-first-milestone.md` exists
   - What's unclear: Should it auto-complete when phase completes?
   - Recommendation: Mark todo as done when phase verification passes

## Sources

### Primary (HIGH confidence)
- `skills/kata-starting-projects/SKILL.md` — Current implementation (1307 lines)
- `skills/kata-starting-milestones/SKILL.md` — Current implementation (809 lines)
- `skills/kata-adding-phases/SKILL.md` — Naming convention reference
- `skills/kata-adding-todos/SKILL.md` — Naming convention reference
- `.planning/todos/pending/2026-01-18-separate-project-new-from-first-milestone.md` — Original todo
- `.planning/ROADMAP.md` — Phase 2.2 success criteria

### Secondary (MEDIUM confidence)
- `skills/kata-executing-phases/references/github-integration.md` — GitHub mapping documentation

### Tertiary (LOW confidence)
- None — all findings verified from codebase

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — using existing patterns from Phase 2.1
- Architecture: HIGH — clear skill structure and file operations
- Pitfalls: HIGH — derived from existing codebase analysis

**Research date:** 2026-01-25
**Valid until:** 2026-02-25 (30 days — stable internal refactoring)
